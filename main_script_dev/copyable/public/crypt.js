function addNsEvent(e,t){var i=e.split("."),n=i[0];i[1];return this.bindCache=this.bindCache||{},this.bindCache[e]?this.bindCache[e].push(t):this.bindCache[e]=[t],this.addEvent(n,t),this}function removeNsEvent(e){if(void 0===this.bindCache||!this.bindCache.hasOwnProperty(e))return this;for(var t,i=e.split(".")[0],n=0,a=this.bindCache[e];t=a[n++];)this.removeEvent(i,t);return this}function removeNsEvents(e){var t,i,n=this;return Object.each(this.bindCache,(function(a,o){if(o.contains(".")&&o.split(".").getLast()===e)for(t=0;i=a[t++];)n.removeEvent(o.split(".")[0],i)})),this}window.Travian={applicationId:"travian",Defaults:TravianDefaults||{},reloadParameter:"reload",autoreloadParameterValue:"auto",emptyFunction:function(){},redirectTo:function(e){Travian.WindowManager.getWindows().map((function(e){Travian.WindowManager.unregister(e)})),window.location.assign(e)},api:function(e,t,i,n){var a=function(e,t){return e.reload?Travian.autoreload():e.redirectTo?Travian.redirectTo(e.redirectTo):void t(e)},o=(t=t||{}).success||Travian.emptyFunction,r=t.error||Travian.emptyFunction,s=Object.assign({},Travian.Defaults.ajaxOptions||{},t,{url:"/api/v1/"+e,method:i||"POST",data:JSON.stringify(t.data),processData:!1,dataType:n||"json",contentType:"application/json; charset=UTF-8",headers:{"X-Version":"1248.8",Authorization:"Bearer "+Travian.surrendersBallplayerRefrigeratorNimbleTempests},complete:t.complete||Travian.emptyFunction,success:function(e){a(e,o)},error:function(e){a(e&&e.responseJSON||{},r)}});return jQuery.ajax(s)},getDirection:function(){return this.direction||(this.direction=jQuery("body").css("direction").toLowerCase()),this.direction},insertScript:function(){var e=[];return function(t,i){var n=this;if(t)if(t&&t.$family&&"array"===t.$family.name)jQuery.each(t,(function(e,t){n.insertScript(t)}));else{"string"==typeof t&&(t={src:t});i=i||this.emptyFunction;!function(t){return 0===e.length&&jQuery("script[src]").each((function(t,i){i=jQuery(i),e.push({src:i[0].src,id:i[0].id,defer:i[0].defer,defaultURL:!1})})),jQuery.grep(e,(function(e){return e.src===t.src})).length>0}(t)?(e.push(t),jQuery("<script>").attr("type","text/javascript").attr("id",t.id?t.id:void 0).appendTo("head").on("load",i).attr("src",t.src).attr("defer",!!t.defer)):i()}}}(),popup:function(e,t){t=t||{};var i=Object.keys(t).filter((function(e){return t[e]})).reduce((function(e,t){return e+","+t+"=yes"}),"");return window.open(e,t.id||"_blank",i,!0)},isToggleClosed:function(e,t){e=jQuery(e);var i=(t=jQuery(t)).attr("class").indexOf("Mirrored")>=0,n=e.hasClass("hide"),a=n&&t.hasClass("switchClosed");return i&&(a=n&&t.hasClass("switchClosedMirrored")),a},toggleSwitch:function(e,t){e=jQuery(e),t=jQuery(t),e.toggleClass("hide");var i=t.attr("class").indexOf("Mirrored")>=0;return t.toggleClass("switchClosed"),i&&t.toggleClass("switchClosedMirrored"),t.toggleClass("switchOpened"),i&&t.toggleClass("switchOpenedMirrored"),this},toggleSwitchDescription:function(e,t,i){return"element"==typeof e&&(e=[e]),e.each((function(){let e=jQuery(this);e.hasClass("switchClosed")?(e.attr("title",t),e.attr("alt",t)):(e.attr("title",i),e.attr("alt",i))})),this},forceDisplay:function(e){(void 0===e?jQuery(".forceDisplayElement"):e).each((function(e){e.addClass("invisible"),e.removeClass("invisible")}))},adjustButtonDisableState:function(){jQuery(".disableButtonHandler").each((function(e,t){"none"===(t=jQuery(t)).css("display")||"hidden"===t.css("visibility")?t.find("button").each((function(e,t){var i=void 0===(t=jQuery(t)).attr("olddisabled")?"true"===t.attr("disabled"):"false"!==t.attr("olddisabled");t.attr("olddisabled",i).attr("disabled",!0)})):t.find("button").each((function(e,t){var i=(t=jQuery(t)).attr("olddisabled");void 0!==i?t.attr("disabled","false"!==i):t.attr("disabled",!1)}))}))},isMobile:function(){var e=!1,t=navigator.userAgent||navigator.vendor||window.opera;return(/ipad|ipod|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|windows nt.+touch|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},parseURL:function(e){var t=document.createElement("a"),i={};return t.href=e,t.search.substr(1).split("&").forEach((function(e){var t=e.split("="),n=decodeURIComponent(t[0]);n.length>0&&(i[n]=t[1])})),{protocol:t.protocol,host:t.host,hostname:t.hostname,port:t.port,pathname:("/"!==t.pathname.charAt(0)?"/":"")+t.pathname,searchObject:i,hash:t.hash}},composeURL:function(e){var t=e.protocol+"//"+e.host;return t+=this.composeURI(e)},composeURI:function(e){var t=e.pathname,i="?";for(var n in e.searchObject)e.searchObject.hasOwnProperty(n)&&(t+=i+n+"="+e.searchObject[n],i="&");return t+=e.hash},getScript:function(e,t,i){var n=void 0===(i=i||{}).forceCallback||!!i.forceCallback,a=jQuery("script");if(a)for(var o=a.length-1;o>=0;o--)if(a[o].src&&a[o].src===e)return!!n&&t;return void 0===i.useCache||!!i.useCache?jQuery.ajax({url:e,dataType:"script",success:t,cache:!0}):jQuery.getScript(e,t),!0},getCss:function(e){var t=jQuery("link");if(t)for(var i=t.length-1;i>=0;i--)if(t[i].href&&t[i].href===e)return!1;return jQuery('<link rel="stylesheet" type="text/css" href="'+e+'"/>').appendTo("head"),!0},updateSideboxVillageHref:function(e){jQuery("#sidebarBoxVillagelist").find("li").each((function(){var t=jQuery(this).find("a"),i=Travian.parseURL(t.attr("href")),n="",a="?";for(var o in void 0!==e&&(i.searchObject.t=e),i.searchObject)i.searchObject.hasOwnProperty(o)&&(n+=a+o+"="+i.searchObject[o],a="&");t.attr("href",n)}))},dismissCookieNotice:function(){var e=jQuery("body"),t=e.find("#cookieNotice");t.length>0&&(e.hasClass("mobileOptimized")&&"fixed"===t.css("position")?t.css({transform:"rotateX(-90deg)"}):t.animate({"margin-top":-1*t.outerHeight()},250),e.hasClass("buildingsV3")&&e.animate({"background-position-y":0},250),setTimeout((function(){t.remove(),e.removeClass("cookieNoticeVisible")}),400),document.cookie="travian-dismissCookieNotice=1; Max-Age=31536000; Path=/")},autoreload:function(){let e,t=window.location.href;if(-1!==(e=t.indexOf("#"))&&(t=t.substring(0,e)),-1===t.indexOf(Travian.reloadParameter)){let e=Travian.reloadParameter+"="+Travian.autoreloadParameterValue;-1===t.indexOf("?")?t+="?"+e:t+="&"+e}window.location.href=t},removeAutoreloadParameter:function(){let e=document.location.href,t=document.location.hash;if(""!==t){let i=e.indexOf(t);e=e.substring(0,i)}let i=Travian.reloadParameter+"="+Travian.autoreloadParameterValue,n=e.indexOf(i);-1!==n&&(e=e.substring(0,n-1)+t,window.history.pushState({id:e},"",e))},decodeSpecialChars:function(e){const t={amp:"&",lt:"<",gt:">",quot:'"',"#039":"'","#60":"<","#62":">","#92":"\\","#34":'"',"#39":"'","#x27":"'"},i=new RegExp("&("+Object.keys(t).join("|")+");","g");return e=e.replace(i,(function(e,i){return t[i]||e}))},getCursorPosition:function(e){let t=e.pageX,i=e.pageY;return void 0===i&&(t=e.originalEvent.touches[0].pageX,i=e.originalEvent.touches[0].pageY),{x:t,y:i,timestamp:new Date}}},Travian.Helpers={substitute:function(e,t,i){return e.replace(i||/\\?\{([^{}]+)\}/g,(function(e,i){return"\\"===e.charAt(0)?e.slice(1):null!=t[i]?t[i]:""}))},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},mergeOne:function(e,t,i){switch(typeof i){case"object":null===i&&(e[t]=i),"object"==typeof e[t]?Travian.Helpers.deepmergeObject(e[t]||{},i):e[t]=Object.assign({},i);break;case"array":e[t]=i.slice(0);break;default:e[t]=i}return e},deepmergeObject:function(e){for(var t=1,i=arguments.length;t<i;t++){var n=arguments[t];for(var a in n)Travian.Helpers.mergeOne(e,a,n[a])}return e}},Travian.Browser=function(){var e,t={chrome:!1,mozilla:!1,opera:!1,msie:!1,safari:!1},i=navigator.userAgent.toLowerCase();return i.indexOf("chrome")>-1?t.chrome=!0:i.indexOf("safari")>-1?t.safari=!0:i.indexOf("opera")>-1?t.opera=!0:i.indexOf("firefox")>-1?t.mozilla=!0:i.indexOf("msie")>-1&&(t.msie=!0),(e=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}}(navigator.userAgent)).browser&&(t[e.browser]=!0,t.version=e.version),t.chrome&&(t.webkit=!0),t.safari&&(t.webkit=!0),t}(),Travian.Draggable=function(e,t){this.options=Object.assign({onDrag:function(e,t){},snap:6,unit:"px",grid:!1,style:!0,limit:!1,handle:!1,invert:!1,unDraggableTags:["button","input","a","textarea","select","option"],preventDefault:!0,stopPropagation:!0,compensateScroll:!1,modifiers:{x:"left",y:"top"}},t),this.attach=function(){return this.handles.on("mousedown",this.bound.start),this.handles.on("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.on("scroll",this.bound.scrollListener),this},this.detach=function(){return this.handles.off("mousedown",this.bound.start),this.handles.off("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.off("scroll",this.bound.scrollListener),this},this.scrollListener=function(){if(this.mouse.start){var e={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()};if("absolute"===this.element.css("position")){var t=this.sumValues(e,this.compensateScroll.last,-1);this.mouse.now=this.sumValues(this.mouse.now,t,1)}else this.compensateScroll.diff=this.sumValues(e,this.compensateScroll.start,-1);this.offsetParent!==window&&(this.compensateScroll.diff=this.sumValues(this.compensateScroll.start,e,-1)),this.compensateScroll.last=e,this.render(this.options)}},this.sumValues=function(e,t,i){var n={},a=this.options;for(var o in a.modifiers)a.modifiers[o]&&(n[o]=e[o]+t[o]*i);return n},this.start=function(e){if(-1===this.options.unDraggableTags.indexOf(e.target.getAttribute("tag"))){var t=this.options;if(3!==e.which&&2!==e.button){t.preventDefault&&e.preventDefault(),t.stopPropagation&&e.stopPropagation(),this.compensateScroll.start=this.compensateScroll.last={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()},this.compensateScroll.diff={x:0,y:0},this.mouse.start={x:e.pageX,y:e.pageY};var i=t.limit;this.limit={x:[],y:[]};var n,a,o=this.offsetParent===window?null:this.offsetParent;for(n in t.modifiers)if(t.modifiers.hasOwnProperty(n)){var r=this.element.css(t.modifiers[n]);if(r&&!r.match(/px$/)&&(a||(a=this.element.getCoordinates(o)),r=a[t.modifiers[n]]),t.style?this.value.now[n]=parseInt(r||0):this.value.now[n]=this.element[t.modifiers[n]],t.invert&&(this.value.now[n]*=-1),this.mouse.pos[n]=this.mouse.start[n]-this.value.now[n],i&&i[n])for(var s=2;s--;){var l=i[n][s];(l||0===l)&&(this.limit[n][s]="function"==typeof l?l():l)}}"number"==typeof this.options.grid&&(this.options.grid={x:this.options.grid,y:this.options.grid});var d={mousemove:this.bound.check,mouseup:this.bound.cancel,touchend:this.bound.cancel};this.document.on(d),document.addEventListener("touchmove",this.bound.check,{passive:!1})}}},this.check=function(e){this.options.preventDefault&&e.preventDefault(),Math.round(Math.sqrt(Math.pow(e.pageX-this.mouse.start.x,2)+Math.pow(e.pageY-this.mouse.start.y,2)))>this.options.snap&&(this.cancel(),this.document.on({mousemove:this.bound.drag,mouseup:this.bound.stop,touchend:this.bound.stop}),document.addEventListener("touchmove",this.bound.drag,{passive:!1}))},this.drag=function(e){var t=this.options;t.preventDefault&&e.preventDefault(),this.mouse.now=this.sumValues({x:e.pageX,y:e.pageY},this.compensateScroll.diff,-1),this.render(t),this.options.onDrag(this.element,e)},this.render=function(e){for(var t in e.modifiers)if(e.modifiers.hasOwnProperty(t)){if(!e.modifiers[t])continue;this.value.now[t]=this.mouse.now[t]-this.mouse.pos[t],e.invert&&(this.value.now[t]*=-1),e.limit&&this.limit[t]&&((this.limit[t][1]||0===this.limit[t][1])&&this.value.now[t]>this.limit[t][1]?this.value.now[t]=this.limit[t][1]:(this.limit[t][0]||0===this.limit[t][0])&&this.value.now[t]<this.limit[t][0]&&(this.value.now[t]=this.limit[t][0])),e.grid[t]&&(this.value.now[t]-=(this.value.now[t]-(this.limit[t][0]||0))%e.grid[t]),e.style?this.element.css(e.modifiers[t],this.value.now[t]+e.unit):this.element[e.modifiers[t]]=this.value.now[t]}},this.cancel=function(e){this.document.off({mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel})},this.stop=function(e){var t={mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop};this.document.off(t),this.mouse.start=null},this.element=jQuery(e),this.document=jQuery(document),this.handles=jQuery(this.options.handle)||this.element,this.mouse={now:{},pos:{}},this.value={start:{},now:{}},this.offsetParent=this.element.parent(),this.selection="selectstart"in document?"selectstart":"mousedown",this.compensateScroll={start:{},diff:{},last:{}},this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),scrollListener:this.scrollListener.bind(this)},this.attach()},Travian.Moveable=function(e,t){if(this.options=Object.assign({onDrop:function(e,t,i){},droppables:[],container:!1,precalculate:!1,includeMargins:!0,checkDroppables:!0},t),this.setContainer=function(e){this.container=jQuery(e)},this.start=function(e){this.container&&(this.options.limit=this.calculateLimit()),this.options.precalculate&&(this.positions=this.droppables.map((function(e){return e.getCoordinates()}))),this.parent.start.call(this,e)},this.calculateLimit=function(){var e=this.element,t=this.container,i=jQuery(e.parent()||document.body),n=t.getCoordinates(i),a={},o={},r={},s={},l={},d=i.scrollTop(),u=i.scrollLeft();["top","right","bottom","left"].each((function(n){a[n]=parseInt(e.css("margin-"+n)),o[n]=parseInt(e.css("border-"+n)),r[n]=parseInt(t.css("margin-"+n)),s[n]=parseInt(t.css("border-"+n)),l[n]=parseInt(i.css("padding-"+n))}),this);var c=e.offsetWidth+a.left+a.right,h=e.offsetHeight+a.top+a.bottom,p=0+d,m=0+u,v=n.right-s.right-c+d,f=n.bottom-s.bottom-h+u;if(this.options.includeMargins?(p+=a.left,m+=a.top):(v+=a.right,f+=a.bottom),"relative"===e.css("position")){var g=e.getCoordinates(i);g.left-=parseInt(e.css("left")),g.top-=parseInt(e.css("top")),p-=g.left,m-=g.top,"relative"!==t.css("position")&&(p+=s.left,m+=s.top),v+=a.left-g.left,f+=a.top-g.top,t!==i&&(p+=r.left+l.left,!l.left&&p<0&&(p=0),m+=i===document.body?0:r.top+l.top,!l.top&&m<0&&(m=0))}else p-=a.left,m-=a.top,t!==i&&(p+=n.left+s.left,m+=n.top+s.top);return{x:[p,v],y:[m,f]}},this.getDroppableCoordinates=function(e){var t=e.getCoordinates();if("fixed"===e.css("position")){var i=window.getScroll();t.left+=i.x,t.right+=i.x,t.top+=i.y,t.bottom+=i.y}return t},this.checkDroppables=function(){var e=this.droppables.filter((function(e,t){e=this.positions?this.positions[t]:this.getDroppableCoordinates(e);var i=this.mouse.now;return i.x>e.left&&i.x<e.right&&i.y<e.bottom&&i.y>e.top}),this).getLast();this.overed!==e&&(this.overed=e)},this.drag=function(e){this.parent.drag.call(this,e),this.options.checkDroppables&&this.droppables.length&&this.checkDroppables()},this.stop=function(e){return this.checkDroppables(),this.options.onDrop(this.element,this.overed,e),this.overed=null,this.parent.stop.call(this,e)},Travian.Draggable.call(this,e,this.options),this.droppables=jQuery(this.options.droppables),this.setContainer(this.options.container||document.body),this.options.style){if("left"===this.options.modifiers.x&&"top"===this.options.modifiers.y){var i=e.position(),n=e.css(["left","top"]);!i||"auto"!==n.left&&"auto"!==n.top||e.offset(e.position())}"static"===e.css("position")&&e.css("position","absolute")}this.overed=null},Travian.Moveable.prototype=Object.create(Travian.Draggable.prototype),Travian.Moveable.constructor=Travian.Moveable,Travian.Moveable.parent=Travian.Draggable.prototype,Travian.Storage=function(){var e=function(e){var t=e?"localStorage":"sessionStorage";return window[t]?window[t]:null},t=function(e){return"Travian."+e};return{cachingTime:31536e6,clear:function(i,n){return function(i,n){var a=e(i);n=t(n),null===a||a.removeItem(n)}(n,i),this},get:function(i,n){var a=function(i,n){var a=e(i),o=null;return n=t(n),null===a||null==(o=a.getItem(n))||void 0===o?null:JSON.decode(o)}(n,i);return null===a||!0===function(e,t){var i=e.cachingTime;return void 0!==t.cachingTime&&null!==t.cachingTime&&(i=t.cachingTime),!1!==t.time&&(new Date).getTime()-t.time>i}(this,a)?null:a.data},set:function(i,n,a,o){return function(i,n,a){var o=e(i),r=JSON.encode(a);if(n=t(n),null===o)return null;o.setItem(n,r)}(a,i,function(e,t){return{data:e,time:(new Date).getTime(),cachingTime:t}}(n,o)),this}}}(),Travian.Translation={keys:{},add:function(e,t){var i={};return"object"!=typeof e?i[e]=t:i=e,this.keys=Object.assign({},this.keys,i),this},get:function(e){return this.keys[e]},translate:function(e,t){return t=t||{},e.replace(/\\?\{([^{}]+)\}/g,(function(e,i){return Travian.Translation.keys[i]||t[i]||"{"+i+"}"}))}},Travian.Tip=function(){var e=function(e){var t={title:"",text:""};if(void 0===e)return!1;var i=e.split("||");if(1===i.length)t.text=i[0];else{if(2!==i.length)return!1;t.title=i[0],t.text=i[1]}return t},t=function(e){var t=jQuery(window),i={x:t.width(),y:t.height()},n=e.element.width(),a=e.element.height(),o=Object.assign({},e.mousePosition),r=t.scrollLeft(),s=t.scrollTop();e.mousePosition.x-r>i.x&&(e.mousePosition.x=i.x),e.mousePosition.y-s>i.y&&(e.mousePosition.y=i.y),o.x=e.mousePosition.x+e.options.offset.x,o.y=e.mousePosition.y+e.options.offset.y,o.x+n-r>i.x-e.options.windowPadding.x&&(o.x=e.mousePosition.x-e.options.offset.x-n),o.y+a-s>i.y-e.options.windowPadding.y&&(o.y=e.mousePosition.y-e.options.offset.y-a),o.x<r+e.options.windowPadding.x&&(o.x=r+e.options.windowPadding.x),o.y<s+e.options.windowPadding.y&&(o.y=s+e.options.windowPadding.y),e.element.css({left:o.x,top:o.y})};return Object.create({displayState:"hide",element:null,elementCurrent:null,elementTitle:null,elementText:null,lastText:"",lastTitle:"",mousePosition:{x:0,y:0},options:{html:'<div class="tip"><div class="tip-container"><div class="tl"></div><div class="tr"></div><div class="tc"></div><div class="ml"></div><div class="mr"></div><div class="mc"></div><div class="bl"></div><div class="br"></div><div class="bc"></div><div class="tip-contents"><div class="title elementTitle"></div><div class="text elementText"></div></div></div></div>',hideDelay:250,maxWidthInPercent:.33,minWidthInPixels:200,offset:{x:16,y:16},showDelay:100,windowPadding:{x:10,y:10},zIndex:1e4},timer:null,show:function(e){if("string"==typeof e&&(e={title:"",text:e,unescaped:!1}),!e.text&&!e.title)return this.hide(),this;this.updateContent(e);var t=this.element;return"show"!==this.displayState&&(this.displayState="show",clearTimeout(this.timer),this.timer=setTimeout((function(){t.fadeIn(400)}),this.options.showDelay)),this},hide:function(){var e=this.element;return"hide"!==this.displayState&&(this.displayState="hide",clearTimeout(this.timer),this.timer=setTimeout((function(){e.fadeOut(400)}),this.options.hideDelay)),this},init:function(){this.render(),this.refresh()},render:function(){var e=this;return this.element=jQuery("<div></div>"),this.element.css({position:"absolute",top:0,left:0,display:"none",zIndex:this.options.zIndex}),this.element.html(this.options.html),this.element.appendTo("body"),this.elementTitle=this.element.find(".elementTitle"),this.elementText=this.element.find(".elementText"),this.elementContainer=this.element.find(".tip-container"),this.elementContents=this.element.find(".tip-contents"),jQuery("body").mousemove((function(i){e.mousePosition.x=i.pageX,e.mousePosition.y=i.pageY,"show"===e.displayState&&t(e)})),this},setContent:function(t,i){jQuery(t).prop("_travianTooltip","string"==typeof i?e(i):i)},set:function(e,t){var i=this;return(e=jQuery(e)).prop("_travianTooltip")||e.on({mouseover:function(e){var t=jQuery(e.delegateTarget);i.elementCurrent=t,i.show(t.prop("_travianTooltip"))},mouseout:function(e){i.elementCurrent=null,i.hide()}}),this.setContent(e,t),this},updateContent:function(e){var i=Object.assign({},e);if(void 0!==i.title&&i.title||(i.title=""),void 0!==i.text&&i.text||(i.text=""),i.title=Travian.Translation.translate(i.title),i.text=Travian.Translation.translate(i.text),this.lastText!==i.text||this.lastTitle!==i.title){void 0===i.unescaped||i.unescaped,this.elementTitle.html(i.title),i.title.length>0?this.elementTitle.show():this.elementTitle.hide(),this.elementText.html(i.text),i.text.length>0?this.elementText.show():this.elementText.hide();var n=jQuery("body").hasClass("mobileOptimized")?.5*jQuery("body").width():jQuery("body").width()*this.options.maxWidthInPercent,a=Math.max(n,this.options.minWidthInPixels);this.elementContents.css({wordBreak:"normal",wordWrap:"normal",width:"auto",whiteSpace:"normal","max-width":a}),this.elementContents.width()>a&&this.elementContents.css({wordWrap:"break-word",wordBreak:"break-all"}),t(this),this.lastText=i.text,this.lastTitle=i.title}return this},updateAllInElement:function(t){var i,n;jQuery(t).find('[title][title!=""], path title, circle title, rect title').each((function(t,a){if(""!==a.title){if("title"===a.tagName){a=jQuery(a),n=a.parent("path")[0]||a.parent("circle")[0]||a.parent("rect")[0],i=e(a[0].textContent);var o=document.createElement("textarea");o.innerHTML=i.title,i.title=o.value,o.innerHTML=i.text,i.text=o.value,jQuery(o).remove(),a.remove()}else n=a,i=e(a.title),jQuery(a).removeAttr("title");if(!1===i)return;Travian.Tip.set(n,i)}}))},refresh:function(){this.updateAllInElement(document.body)},load:function(e,t,i){Travian.api("tooltip/"+t,{data:i,success:function(t){const i={title:t.title,text:t.text,unescaped:!1};Travian.Tip.setContent(e,i),Travian.Tip.show(i)}})}})}(),jQuery((function(){Travian.Tip.init(),Travian.Tip.show(" ").hide()})),Travian.Dialog={CLOSE_CONTEXT_FORMSUBMIT:"formSubmit",CLOSE_CONTEXT_OVERLAYBACKGROUND:"overlayBackground",CLOSE_CONTEXT_CANCELBUTTON:"cancelButton",CLOSE_CONTEXT_CLOSEONCLICKOK:"closeOnClickOk",CLOSE_CONTEXT_CLOSEONESCKEY:"closeOnEscKey"},Travian.Dialog.Dialog=function(e){this.overlay=null,this.overlaySize={width:0,height:0},this.clickedOnOverlay=!1,this.options=Object.assign({version:1,cssClass:null,id:null,buttonOk:!0,keepOpen:!1,buttonTextOk:null,buttonCloseOnClickOk:!1,buttonCancel:!0,elementFocus:".dialogButtonOk",relativeTo:null,title:null,useEscKey:!0,submitMethod:"get",submitUrl:null,preventFormSubmit:!1,overlayCancel:!0,draggable:!1,dragPosition:null,enableBackground:!0,darkOverlay:!1,savePositionForSession:{preferenceKey:null},infoIcon:null,buttonTextInfo:null,fx:{duration:400},onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,afterClose:Travian.emptyFunction,onOpen:Travian.emptyFunction,onDrag:Travian.emptyFunction},e),this.toggleFormState=function(e){return this.buttonOk.toggleClass("disabled",e).disabled=e,this},this.disableForm=function(){return this.toggleFormState(!0)},this.enableForm=function(){return this.toggleFormState(!1)},this.correctDialogPosition=function(e){let t=this.overlaySize.width,i=this.overlaySize.height,n=this.wrapper.width(),a=this.wrapper.height(),o=e.left,r=e.top;return o<0&&(o=0),o+n>=t&&(o=t-n),r<0?r=0:r+a>=i&&(r=i-a),{left:o,top:r}},this.render=function(){let e=this,t=jQuery("body");if(this.options.savePositionForSession.preferenceKey){var i=Travian.Game.Preferences.get(this.options.savePositionForSession.preferenceKey);null!==i&&(i=JSON.parse(i),this.options.savePositionForSession.position=i.position)}let n=jQuery(Travian.Templates["ButtonV"+this.options.version]),a=jQuery(Travian.Templates["DialogV"+this.options.version]);if(n.length<=0||a.length<=0)throw"Dialog.js: Unable to load required template(s).";if(n.addClass("green dialogButtonOk ok textButtonV"+this.options.version),n.attr("type","submit"),2===this.options.version&&n.addClass("buttonFramed withText rectangle"),this.overlay=a,e.options.enableBackground&&(this.overlay.addClass("enabled"),e.options.darkOverlay&&this.overlay.addClass("dark"),e.options.overlayCancel&&(this.overlay.on("mousedown touchstart",(function(t){t.target.classList.contains("dialogOverlay")&&(e.clickedOnOverlay=!0)})),this.overlay.on("click",(function(){e.clickedOnOverlay&&e.close(Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND)})))),this.wrapper=this.overlay.find(".dialogWrapper"),void 0!==this.options.context&&this.wrapper.attr("data-context",this.options.context),null===this.options.cssClass&&2===this.options.version&&(this.options.cssClass="plain"),this.wrapper.find(".dialog").addClass(this.options.cssClass),null!==this.options.id&&this.wrapper.find(".dialog").attr("id",this.options.id),this.wrapper.find(".buttons").append(n),t.prepend(this.overlay),this.overlaySize.width=this.overlay.width(),this.overlaySize.height=this.overlay.height(),jQuery(window).on("resize scroll",(function(){let t=jQuery(".dialogOverlay");e.overlaySize.width=t.width(),e.overlaySize.height=t.height(),!e.options.draggable||Travian.isMobile()?e.updatePosition(200,!0):e.options.draggable&&e.wrapper.css(e.correctDialogPosition(e.wrapper.position()))})),this.content=this.wrapper.find("div#dialogContent"),this.title=this.wrapper.find("div.title"),this.setTitle(this.options.title),this.elementContents=this.wrapper.find("div.dialogContents"),this.infoButton=this.wrapper.find("div.info"),this.dialogDragbar=this.wrapper.find("div.dialogDragBar"),this.options.infoIcon?this.setInfoIcon(this.options.infoIcon):this.infoButton.hide(),this.options.draggable&&(this.wrapper.addClass("dragWrapper"),new Travian.Moveable(this.wrapper,{droppables:this.title,handle:this.dialogDragbar,onDrop:function(t){var i=jQuery(t).position();e.options.dragPosition=e.correctDialogPosition(i),null!==e.options.savePositionForSession.preferenceKey&&(e.options.savePositionForSession.position=e.correctDialogPosition(i))},onDrag:function(t){var i=jQuery(t);i.css(e.correctDialogPosition(i.position())),e.options.onDrag(e)}}),this.title.css("drag")),this.options.draggable&&this.wrapper.on("mousedown touchdown",(function(){e.bringToFront()})),this.form=this.wrapper.find("form").on("submit",(function(t){return e.form.disabled?(t.stopPropagation(),!1):(e.disableForm(),e.options.onOkay(e,e.content),!1===e.options.keepOpen&&e.close(Travian.Dialog.CLOSE_CONTEXT_FORMSUBMIT),e.options.preventFormSubmit?(t.stopPropagation(),!1):void 0)})),this.form.disabled=!1,this.options.submitMethod&&this.form.attr("method",this.options.submitMethod),this.options.submitUrl&&this.form.attr("action",this.options.submitUrl),this.buttonOk=this.wrapper.find("button.ok"),!1===this.options.buttonOk)this.buttonOk.closest(".buttons").hide();else{let e=this.buttonOk.find("div");e.length>0?e.html(this.options.buttonTextOk):this.buttonOk.html(this.options.buttonTextOk),Travian.Tip.set(this.buttonOk,this.options.buttonTextOk)}this.options.buttonCloseOnClickOk&&this.buttonOk.click((function(t){t.preventDefault(),e.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONCLICKOK)})),this.buttonCancel=this.wrapper.find(".dialogCancelButton"),!1===this.options.buttonCancel?this.buttonCancel.hide():this.buttonCancel.on("click",(function(){e.close(Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON)})),this.bringToFront()},this.updateInfoButton=function(e){return this.options=Object.assign(this.options,e),this.options.infoIcon?this.setInfoIcon(this.options.infoIcon):this.infoButton.hide(),this},this.displayButtonOk=function(e){null==e||!0===e?(this.buttonOk.closest(".buttons").show(),this.buttonOk.show()):this.buttonOk.hide()},this.setContent=function(e){return this.content.empty(),this.content.append(e),this.updatePosition(),Travian.Tip.updateAllInElement(this.wrapper),jQuery(window).trigger("domAltered",this.wrapper),this},this.setTitle=function(e){return this.options.title=e,this.title.html(this.options.title),this.options.title||this.title.hide(),this},this.calculatePosition=function(){let e=jQuery(window),t=e.scrollLeft(),i=e.scrollTop(),n=jQuery("body"),a=this.overlaySize.width,o=this.overlaySize.height,r=this.wrapper.width(),s=this.wrapper.height(),l=jQuery(this.options.relativeTo);l.length<=0&&(l=n);let d=l.width(),u=l.height(),c={x:l.offset().left,y:l.offset().top};c.x=this.checkValue(c.x),c.y=this.checkValue(c.y);let h={left:c.x+d/2-r/2-t,top:c.y+u/2-s/2-i};return h.left=this.checkValue(h.left,5),h.top=this.checkValue(h.top,40),h.top+s>o&&(h.top=o-s),h.top<0&&(h.top=0),h.left+r>a&&(h.left=a-r),h.left<0&&(h.left=0),h},this.checkValue=function(e,t){return e<0?t||0:e},this.updatePosition=function(e,t){if(this.options.draggable||null!==this.options.relativeTo){if(jQuery("body").hasClass("ie")&&this.wrapper.addClass("iePositionException"),!this.options.savePositionForSession.preferenceKey||!this.options.savePositionForSession.position||void 0!==t&&t)if(this.options.dragPosition&&void 0!==this.options.dragPosition.x&&void 0!==this.options.dragPosition.y)this.setPosition(this.options.dragPosition);else{let t=this.calculatePosition();this.setPosition({x:t.left,y:t.top},e)}else this.setPosition(this.options.savePositionForSession.position)}},this.hide=function(){this.overlay.hide()},this.unhide=function(){this.overlay.show()},this.dispose=function(){this.options.useEscKey&&jQuery("body").off(".dialog"),void 0!==Travian.WindowManager&&Travian.WindowManager.unregister(this),jQuery(this.overlay).remove(),this.overlay=null},this.toElement=function(){return this.wrapper},this.setPosition=function(e,t){return this.wrapper.css({left:e.x,top:e.y}),e},this.bringToFront=function(){if(void 0===Travian.WindowManager)return!1;if(Travian.WindowManager.getCurrentZIndex()===parseInt(this.wrapper.css("zIndex")))return!1;var e=Travian.WindowManager.getZIndex();this.wrapper.css({zIndex:e}),this.overlay.length>0&&this.overlay.css({zIndex:e-5})},this.setInfoIcon=function(e){if(e){this.options.infoIcon=e;var t=this;this.infoButton.off("click"),this.infoButton.show(),this.infoButton.on("click",(function(){return"string"==typeof t.options.infoIcon?window.open(t.options.infoIcon,"_blank"):"function"==typeof t.options.infoIcon?t.options.infoIcon():void 0})),this.options.buttonTextInfo&&Travian.Tip.set(this.infoButton,this.options.buttonTextInfo)}else this.infoButton.hide();return this},this.updateCssClass=function(e){if(e){var t=this.options.cssClass.split(" "),i=this.wrapper.find("div.dialog");if(i){for(var n=0;n<t.length;n++)i.removeClass(t[n]);this.options.cssClass=e;for(var a=e.split(" "),o=0;o<a.length;o++)""!==a[o]&&i.addClass(a[o])}}return this},this.makeInputAmountable=function(e,t,i){var n=t||Number.MAX_VALUE,a=function(e,t,i){e=jQuery(e);var n=t||Number.MAX_VALUE,a=parseInt(e.val())||0,o=Math.max(0,Math.min(a,n));e.val(o),i&&i(o)};jQuery(e).on({keydown:function(e){var t,i,n;t=e.keyCode,i=e.ctrlKey,n=e.metaKey,8===t||46===t||65===t&&(!0===i||!0===n)||67===t&&(!0===i||!0===n)||88===t&&(!0===i||!0===n)||86===t&&(!0===i||!0===n)||t>=35&&t<=39||13===t||9===t||t>=48&&t<=57||t>=96&&t<=105||e.preventDefault()},keyup:function(){a(this,n,i)},paste:function(){a(this,n,i)},change:function(){a(this,n,i)},blur:function(){a(this,n,i)},input:function(){a(this,n,i)}})},Object.assign(this.options,e),this.animateFunction=0===this.options.fx.duration?function(e,t,i,n){e.css(t),"function"==typeof n&&n()}:function(e,t,i,n){e.animate(t,i,n)},this.options.relativeTo=this.options.relativeTo||null,null!==this.options.relativeTo&&(this.options.relativeTo=jQuery(this.options.relativeTo)),null===this.options.buttonTextOk&&(this.options.buttonTextOk=Travian.Translation.get("allgemein.ok")),this.render(),void 0!==Travian.WindowManager&&Travian.WindowManager.register(this)},Travian.Dialog.Dialog.prototype.reload=Travian.emptyFunction,Travian.Dialog.Dialog.prototype.show=function(){var e=this;return this.open=!0,this.updatePosition(),this.overlay.addClass("dialogVisible"),setTimeout((function(){e.options.onOpen(e,e.content);var t=jQuery(e.options.elementFocus);t.length>0&&t.focus()}),e.options.fx.duration),this.options.useEscKey&&jQuery("body").one("keyup.dialog",(function(t){27===t.keyCode&&e.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONESCKEY)})),Travian.TabManager.initializeOnDialogLoad(),Travian.Tip.hide(),this},Travian.Dialog.Dialog.prototype.close=function(e){var t=this;return this.open=!1,this.options.onClose(this,this.content),this.overlay&&this.overlay.length>0&&this.overlay.removeClass("dialogVisible"),setTimeout((function(){t.dispose()}),t.options.fx.duration),this.options.savePositionForSession.preferenceKey&&this.options.savePositionForSession.position&&Travian.Game.Preferences.set(this.options.savePositionForSession.preferenceKey,JSON.stringify(this.options.savePositionForSession)),Travian.Tip.hide(),this.options.afterClose(),this},Travian.Dialog.Confirmation=function(e){this.options=Object.assign({onConfirm:Travian.emptyFunction,onCancel:function(){Travian.WindowManager.closeByContext("confirmationDialog")},message:"",confirmText:"",cancelText:"",confirmClass:"green",cancelClass:"grey",buttonCancel:!1,buttonOk:!1,cssClass:"white confirmationDialog",context:"confirmationDialog"},e);var t=jQuery('<div class="confirmationDialog"></div>').append('<div class="message">'+this.options.message+"</div>").append('<div class="buttons"></div>');if(void 0!==Travian.Templates.ButtonV1){var i=jQuery(Travian.Templates.ButtonV1);i.addClass("textButtonV1 "+this.options.confirmClass),i.attr("type","button"),i.on("click",this.options.onConfirm),i.html(this.options.confirmText);var n=jQuery(Travian.Templates.ButtonV1);n.addClass("textButtonV1 "+this.options.cancelClass),n.attr("type","button"),n.on("click",this.options.onCancel),n.html(this.options.cancelText),t.find(".buttons").append(n).append(i)}return new Travian.Dialog.Dialog(this.options).setContent(t)},Travian.WindowManager={windows:[],currentZIndex:6e3,zIndexMaxValue:9900,register:function(e){return void 0===e.options.context&&(e.options.context="noContext"),e.identifier=this.__createIdentifier(),this.windows.push(e),e},unregister:function(e){this.windows=this.windows.filter((function(t){return t!==e}))},closeWindow:function(e){e.close()},hideWindow:function(e){e.hide()},showWindow:function(e){e.unhide()},hideByContext:function(e){var t=this;this.eachWindow((function(i){if(!t.checkContext(e,i))return!1;t.hideWindow(i)}))},showByContext:function(e){var t=this;this.eachWindow((function(i){if(!t.checkContext(e,i))return!1;t.showWindow(i)}))},closeByContext:function(e){var t=this;this.eachWindow((function(i){if(!t.checkContext(e,i))return!1;t.closeWindow(i)}))},getWindowsByContext:function(e){var t=this,i=[];return this.eachWindow((function(n){if(!t.checkContext(e,n))return!1;i.push(n)})),i},checkContext:function(e,t){return void 0!==t.options.context&&t.options.context===e},eachWindow:function(e){for(var t=0;t<this.windows.length;t++)e(this.windows[t])},getWindows:function(){return this.windows},reloadWindow:function(e){e.reload()},reloadWindowsByContext:function(e){var t=this;this.eachWindow((function(i){if(!t.checkContext(e,i))return!1;t.reloadWindow(i)}))},__createIdentifier:function(){return this.windows.length},cleanupZIndex:function(){var e=0;this.eachWindow((function(t){var i=jQuery(t).css("zIndex")-3e3;i>e&&(e=i),jQuery(t).css({zIndex:i})})),this.currentZIndex=e},getZIndex:function(){return this.currentZIndex>=this.zIndexMaxValue&&this.cleanupZIndex(),this.currentZIndex+=10,this.currentZIndex},getCurrentZIndex:function(){return this.currentZIndex},checkOpenWindowByContext:function(e){var t=!1,i=this;return this.eachWindow((function(n){i.checkContext(e,n)&&(t=!0)})),t},closeAllWindows:function(){var e=this;this.eachWindow((function(t){e.closeWindow(t)}))}},Travian.Dialog.Ajax=function(e,t){Travian.Dialog.Dialog.call(this,t),this.cmd=e,this.request()},Travian.Dialog.Ajax.prototype=Object.create(Travian.Dialog.Dialog.prototype),Travian.Dialog.Ajax.constructor=Travian.Dialog.Ajax,Travian.Dialog.Ajax.prototype.reload=function(){this.request()},Travian.Dialog.Ajax.prototype.request=function(){var e=this;return Travian.api(this.cmd,{data:this.options.data,success:function(t){""!==t.html?e.setContent(t.html).setTitle(t.title).setInfoIcon(t.infoIcon).updateCssClass(t.cssClass).show():e.close()}}),this},Travian.Dialog.Api=function(e){Travian.Dialog.Dialog.call(this,e),this.request()},Travian.Dialog.Api.prototype=Object.create(Travian.Dialog.Dialog.prototype),Travian.Dialog.Api.constructor=Travian.Dialog.Api,Travian.Dialog.Api.prototype.reload=function(){this.request()},Travian.Dialog.Api.prototype.request=function(){var e=this;return Travian.api(this.options.call,{data:this.options.data,success:function(t){""!==t.html?e.setContent(t.html).setTitle(t.title).setInfoIcon(t.infoIcon).updateCssClass(t.cssClass).show():e.close()}},this.options.method),this},Travian.DoubleClickPreventer=function(){this.prevent=!1,this.timeout=400,this.timerId=0,this.check=function(){if(this.prevent)return!1;this.prevent=!0;var e=this;return this.timerId=setTimeout((function(){e.prevent=!1}),this.timeout),!0},this.cancelTimer=function(){this.timerId&&(clearTimeout(this.timerId),this.timerId=0,this.prevent=!1)}},Travian.DoubleClickPreventer.globalPrevent=!1,Travian.DoubleClickPreventer.globalTimeout=400,Travian.DoubleClickPreventer.globalCheck=function(){var e=Travian.DoubleClickPreventer.prevent;return!1===e&&(Travian.DoubleClickPreventer.prevent=!0,Travian.DoubleClickPreventer.timer=setTimeout((function(){Travian.DoubleClickPreventer.prevent=!1}),Travian.DoubleClickPreventer.timeout)),!e},Travian.Form=function(){this.elements={},this.addElement=function(e,t){return t.setName(e),this.elements[e]=t,this},this.addInputElementByName=function(e,t){var i=Travian.Form.Element.Input.createElementByName(this,e,t);return this.addElement(e,i),this},this.onElementChanged=function(e){var t,i=e.isDirty();if(!1===i)for(t in this.elements)if(this.elements[t].isDirty()){i=!0;break}return this.onDirty(i),this}},Travian.Form.prototype.onClick=function(e){return this},Travian.Form.prototype.onDirty=function(e){return this},Travian.FormV2=function(e){this.form=null,this.isFormValid=!0,this.initialize=function(e){if(this.form=jQuery(e),0===this.form.length)return!1;this.bindEventListeners()},this.bindEventListeners=function(){let e=this;e.form.find("input:not([type=radio]), textarea, select").on("change",(function(){let e=jQuery(this);""!==e.val()?e.next(".label").addClass("pinned"):e.next(".label").removeClass("pinned")})).on("focus",(function(){let e=jQuery(this);e.parent("label").removeClass("valid").removeClass("invalid"),e.parent("label").find(".validation").removeClass("show")})).on("blur",(function(){e.validate(jQuery(this).parent("label"))})),e.form.find("input[type=radio]").on("click",(function(){let t=jQuery(this);jQuery("input[type=radio][name="+t.attr("name")+"]").each((function(t,i){e.validate(jQuery(i).parent("label"))}))})),e.form.on("submit",(function(t,i){void 0===i&&(t.preventDefault(),e.isFormValid=!0,e.validateForm(),e.isFormValid&&e.form.trigger("submit",[!0]))}))},this.validateForm=function(){let e=this;this.form.find("label").each((function(t,i){e.validate(jQuery(i))}))},this.highlightInvalidElement=function(e){e.addClass("show"),e.parent("label").addClass("invalid")},this.validate=function(e){let t=this,i=!0,n=e.find("input, textarea, select");e.find(".validation").each((function(e,a){let o=(a=jQuery(a)).data("rule"),r=a.data("parameter");if("function"==typeof t.validationRules[o]&&!t.validationRules[o](n,r))return i=!1,t.isFormValid=!1,t.highlightInvalidElement(a),!1})),i&&(e.find(".validation").removeClass("show"),e.removeClass("invalid").addClass("valid"))},this.validationRules={notEmpty:function(e){return""!==e.val()},checked:function(e){return e.is(":checked")},shorterThan:function(e,t){return e.val().length<=t},isEmail:function(e){return-1!==e.val().search(/^\S+@\S+\.\S+$/)}},this.initialize(e)},Travian.Form.UnloadHelper=Object.create({formQueryString:"input, textarea, select",message:null,identifierCount:0,htmlForms:{},formStates:{},initialize:function(){},isEnabled:function(){var e;for(e in this.formStates)if(this.formStates[e])return!0;for(e in this.htmlForms){var t=jQuery("#"+e);if(null!==t){if(this.htmlForms[e]!==this.generateFormHash(t))return!0}else delete this.htmlForms[e]}return!1},enableSecurity:function(e){return null===e&&(e=this.getIdentifier()),this.formStates[e]=!0,e},disableSecurity:function(e){this.formStates[e]=!1},getIdentifier:function(){return this.identifierCount++,this.identifierCount},generateFormHash:function(e){var t="";return e.find(this.formQueryString).each((function(){var e=jQuery(this),i=e.prop("tagName").toLowerCase(),n=e.attr("type");switch("string"==typeof n&&(n=n.toLowerCase()),!0){case"input"===i&&("checkbox"===n||"radio"===n):t+=e.is(":checked");break;case"input"===i||"textarea"===i:t+=e.val();break;case"select"===i:var a=e.find("option:selected");a.length>0&&(t+=a.prop("value"))}})),jQuery.md5(t)},watchHtmlForm:function(e){var t=this;e.delegate(this.formQueryString,"change keyup",(function(){t.updateSubmitButtons(e)})),this.htmlForms[e.attr("id")]=this.generateFormHash(e),e.on("submit",(function(){t.htmlForms[e.attr("id")]=t.generateFormHash(e)})),this.updateSubmitButtons(e)},unwatchHtmlForm:function(e){delete this.htmlForms[e.attr("id")]},updateSubmitButtons:function(e){var t=this.htmlForms[e.attr("id")]===this.generateFormHash(e);e.find("input[type=submit], button[type=submit]").each((function(){jQuery(this).toggleClass("disabled",t)[0].disabled=t}))}}),Travian.Form.UnloadHelper.initialize(),Travian.Form.Element=function(e){this.form=null,this.name=null,this.initialize=function(e){this.form=e},this.onClick=function(){return this.form.onClick(this),this},this.setForm=function(e){return this.form=e,this},this.setName=function(e){return this.name=e,this},this.getName=function(){return this.name},this.initialize(e)},Travian.Form.Element.prototype.onChange=function(){return this.form.onElementChanged(this),this},Travian.Form.Element.prototype.isDirty=function(){return!1},Travian.Form.Element.Input=function(e,t){this.originalValue=null,this.currentValue=null,this.type=null,this.element=null,this.initialize=function(e,t){Travian.Form.Element.call(this,e),this.element=t,this.originalValue=this.currentValue=this.getValue(),this.initEvents()},this.getInput=function(){return this.element},this.onChange=function(){return this.currentValue=this.getValue(),Travian.Form.Element.prototype.onChange.call(this),this},this.isDirty=function(){return this.originalValue!==this.currentValue},this.initialize(e,t)},Travian.Form.Element.Input.prototype=Object.create(Travian.Form.Element.prototype),Travian.Form.Element.Input.constructor=Travian.Form.Element.Input,Travian.Form.Element.Input.createElementByName=function(e,t,i){var n=null;void 0===i&&(i=jQuery(document));var a=i.find('[name="'+t+'"]');if(0===a.length)throw new Error('Element with name "'+t+'" not found.');var o=jQuery(a[0]);switch(o.prop("tagName").toLowerCase()){case"input":"radio"!==(n=o.attr("type"))&&"checkbox"!==n||(o=a);break;default:n=o.get(0).nodeName.toLowerCase()}if(n=n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),!Travian.Form.Element.Input[n])throw new Error('Element type "'+n+'" not yet implemented!');return new Travian.Form.Element.Input[n](e,o)},Travian.Form.Element.Input.prototype.initEvents=function(){var e=this;return this.element.on("change",(function(){e.onChange()})),this},Travian.Form.Element.Input.prototype.getValue=function(){return this.element.val()},Travian.Form.Element.Input.Button=function(e,t){this.initEvents=function(){var e=this;return this.element.on("click",(function(){e.onClick()})),this},this.getValue=function(){return null},Travian.Form.Element.Input.call(this,e,t)},Travian.Form.Element.Input.Button.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Button.constructor=Travian.Form.Element.Input.Button,Travian.Form.Element.Input.Checkbox=function(e,t){this.valueBefore=null,this.initEvents=function(){var e=this;return this.valueBefore=this.getValue(),this.element.on("click",(function(){e.getValue()!==e.valueBefore&&(e.valueBefore=e.getValue(),e.onChange())})),this},this.getValue=function(){var e=null;return this.element.length>0&&this.element.each((function(t,i){var n=jQuery(i);n.is(":checked")&&(e=n.val())})),e},Travian.Form.Element.Input.call(this,e,t)},Travian.Form.Element.Input.Checkbox.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Checkbox.constructor=Travian.Form.Element.Input.Checkbox,Travian.Form.Element.Input.Radio=function(e,t){this.valueBefore=null,this.initEvents=function(){var e=this;return this.valueBefore=this.getValue(),this.element.on("click",(function(){e.getValue()!==e.valueBefore&&(e.valueBefore=e.getValue(),e.onChange())})),this},this.getValue=function(){var e=null;return this.element.length>0&&this.element.each((function(t,i){var n=jQuery(i);n.is(":checked")&&(e=n.val())})),e},Travian.Form.Element.Input.call(this,e,t)},Travian.Form.Element.Input.Radio.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Radio.constructor=Travian.Form.Element.Input.Radio,Travian.Form.Element.Input.Text=function(e,t){Travian.Form.Element.Input.call(this,e,t)},Travian.Form.Element.Input.Text.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Text.constructor=Travian.Form.Element.Input.Text,Travian.Form.Element.Input.Textarea=function(e,t){Travian.Form.Element.Input.call(this,e,t)},Travian.Form.Element.Input.Textarea.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Textarea.constructor=Travian.Form.Element.Input.Textarea,Travian.Formatter=function(e){if(this.options=Object.assign({languageKey:"de-DE",formatType:"type3",decimalSeperator:",",forceDecimal:!0,showDecimalsIfThereAny:!1,minusCharacter:"â"},e),this.getFormattedNumber=function(e,t){if(isNaN(e)||null==e||""===e)return 0;parseInt(e)!==e?-1===(e=String(parseFloat(e))).indexOf(".")&&-1===e.indexOf(",")&&(e+=".0"):e=String(parseFloat(e))+".0";var i=e.match(/([\d.,\s-]*?)[.,]?(\d*)?$/),n={left:i[1],right:i[2]};n.left=n.left.replace(/[\s,.'"]*/g,"");var a=!1;n.left<0&&(a=!0),n.left=n.left.replace(/[-]*/g,"");var o=0;if(void 0===this.typeFunctions[this.options.formatType])throw"Der Zahlenformattyp"+this.options.formatType+"ist unbekannt!";if(o=this.typeFunctions[this.options.formatType].createNumberFunction(n,this.options),!0===a&&(o=this.options.minusCharacter+o),void 0!==t&&t.hasOwnProperty("unit"))switch(t.unit){case"percent":o+="%"}return o},this.setOptionLanguageKey=function(e){var t=this.getDefinitionByLanguage(e);return!1!==t&&(this.options.formatType=t.type,this.options.decimalSeperator=t.decimalSeperator,!0)},this.getAvailableTypes=function(){var e=[];return Object.each(this.typeFunctions,(function(t,i){e.push(i)})),e},this.removeNonDigits=function(e){var t=e.match(/\d/g);return t=parseInt(t.join(""))},this.getDefinitionByLanguage=function(e){var t=!1;for(var i in this.languageDefinitions){if(-1!==this.languageDefinitions[i].languages.indexOf(e)){t=this.languageDefinitions[i];break}}return t},this.languageDefinitions={1:{decimalSeperator:",",type:"type1",languages:["bg-BG","cs-CZ","et-EE","fi-FI","fr-FR","hu-HU","lt-LT","lv-LV","pl-PL","pt-PT","ru-RU","sk-SK","sv-SE","uk-UA"]},2:{decimalSeperator:".",type:"type2",languages:["bs-BA-Latn","en-US","ja-JP","ms-MY","th-TH","com"]},3:{decimalSeperator:",",type:"type3",languages:["ar-AE","da-DK","de-DE","el-GR","es-CL","es-ES","he-IL","hr-HR","id-ID","it-IT","nl-NL","no-NO","pt-BR","ro-RO","sl-SI","sr-RS-Cyrl","tr-TR","vi-VN"]},4:{decimalSeperator:".",type:"type4",languages:["in"]}},this.typeFunctions={type1:{createNumberFunction:function(e,t){for(var i="",n=e.left.split("").reverse().join(""),a=0;a<=n.length-1;a++)a%3==0&&0!==a&&(i+=" "),i+=n.charAt(a);return i=i.split("").reverse().join(""),(void 0!==e.right&&!0===t.forceDecimal||void 0!==e.right&&!0===t.showDecimalsIfThereAny&&"0"!==e.right)&&(i+=","+e.right),i}},type2:{createNumberFunction:function(e,t){for(var i="",n=e.left.split("").reverse().join(""),a=0;a<=n.length-1;a++)a%3==0&&0!==a&&(i+=","),i+=n.charAt(a);return i=i.split("").reverse().join(""),(void 0!==e.right&&!0===t.forceDecimal||void 0!==e.right&&!0===t.showDecimalsIfThereAny&&"0"!==e.right)&&(i+="."+e.right),i}},type3:{createNumberFunction:function(e,t){for(var i="",n=e.left.split("").reverse().join(""),a=0;a<=n.length-1;a++)a%3==0&&0!==a&&(i+="."),i+=n.charAt(a);return i=i.split("").reverse().join(""),(void 0!==e.right&&!0===t.forceDecimal||void 0!==e.right&&!0===t.showDecimalsIfThereAny&&"0"!==e.right)&&(i+=","+e.right),i}},type4:{createNumberFunction:function(e,t){for(var i="",n=3,a=e.left.split("").reverse().join(""),o=0,r=0;r<=a.length-1;r++)o%n==0&&0!==o&&(i+=",",n=2,o=0),i+=a.charAt(r),o++;return i=i.split("").reverse().join(""),(void 0!==e.right&&!0===t.forceDecimal||void 0!==e.right&&!0===t.showDecimalsIfThereAny&&"0"!==e.right)&&(i+="."+e.right),i}},seperatorless:{createNumberFunction:function(e,t){var i=e.left;return void 0!==e.right&&!1===t.forceDecimal&&(i+=t.decimalSeperator+e.right),i}},toInt:{createNumberFunction:function(e,t){return e.left}},toIntRounded:{createNumberFunction:function(e,t){if(void 0===e.right)return e.left;var i=e.left+"."+e.right;return Number.convert(i).round()}}},void 0!==e&&void 0!==e.languageKey||(this.options.languageKey=Travian.Game.language),void 0!==this.options.languageKey){var t=this.getDefinitionByLanguage(this.options.languageKey);!1!==t&&(this.options.formatType=t.type,this.options.decimalSeperator=t.decimalSeperator)}},Travian.Formatter.Filter={aNumber:function(e){e.value.match(/^[0-9\-\.,]+$/)||(e.value=e.value.replace(/[^0-9\-\.,]/g,""))}},Travian.Seasons=Object.create({currentSeason:null,setState:function(e){var t=jQuery("body"),i=Travian.Seasons.currentSeason.cssClassName;t.find("span.pleaseSaveYourChanges").removeClass("hidden"),e?t.addClass(i):t.removeClass(i),Travian.Seasons.currentSeason.setState(e)}}),Travian.Seasons.Season=function(){},Travian.Seasons.Season.prototype.cssClassName="",Travian.Seasons.Season.prototype.setState=function(e){},Travian.Seasons.Season.prototype.restart=function(e){},Travian.Seasons.Season.prototype.setPreferences=function(e){return e},Travian.Seasons.currentSeason=new Travian.Seasons.Season,Travian.Seasons.Winter=function(){this.cssClassName="season-winter",this.snowSettings={enabled:!1,maxFlakes:250,maxFlakeRadius:3,maxDensity:25,screenWidth:0,screenHeight:0,moveToBackground:!0},this.snowFlakes=[],this.context=null,this.wind=0,this.animationFrame=null,this.animationTime=0,this.restarting=!1,this.bodyWrapperHeight=0,this.updateState=function(){var e=jQuery("body"),t=jQuery(document);this.bodyWrapperHeight=jQuery("#bodyWrapper").height();var i=!e.hasClass("ie")||e.hasClass("ie11");if(this.snowSettings.enabled&&i){this.snowSettings.screenWidth=t.width(),this.snowSettings.screenHeight=t.height();var n=this.snowSettings.moveToBackground?"movedToBackground":"";(this.snowSettings.moveToBackground?jQuery("#background"):e).prepend('<canvas id="snowAnimation" class="'+n+'" width="'+this.snowSettings.screenWidth+'" height="'+this.snowSettings.screenHeight+'"></canvas>'),this.context=document.getElementById("snowAnimation").getContext("2d"),this.context.fillStyle="rgba(255, 255, 255, 0.8)",this.context.width=this.snowSettings.screenWidth,this.context.height=this.snowSettings.screenHeight;for(var a=0;a<this.snowSettings.maxFlakes;a++)this.snowFlakes.push({x:parseFloat((Math.random()*this.snowSettings.screenWidth).toFixed(2)),y:parseFloat((Math.random()*this.snowSettings.screenHeight).toFixed(2)),radius:parseFloat((Math.random()*this.snowSettings.maxFlakeRadius).toFixed(2)),density:parseFloat((Math.random()*this.snowSettings.maxDensity).toFixed(2))});this.animationTime=Date.now(),this.animationFrame=requestAnimationFrame(this.runAnimation),jQuery(window).on("resize.travianSnowAnimation",this.restart)}this.restarting=!1},this.runAnimation=function(){if(jQuery("#bodyWrapper").height()!==e.bodyWrapperHeight)e.restart();else if(null!==e.animationFrame){var t=Date.now();t-e.animationTime>24&&(e.drawTheSnow(),e.updateSnowFlakePositions(),e.animationTime=t),e.animationFrame=requestAnimationFrame(e.runAnimation)}},this.updateSnowFlakePositions=function(){e.wind+=.01;var t,i=6;Math.sin(e.wind)>-.1&&Math.sin(e.wind)<.1&&(i=10);for(var n=0;n<e.snowFlakes.length;n++)(t=e.snowFlakes[n]).x=parseFloat((t.x+2*Math.sin(e.wind)).toFixed(2)),t.y=parseFloat((t.y+Math.cos(e.wind+t.density)+1+t.radius/2).toFixed(2)),(t.y+t.radius>e.snowSettings.screenHeight||t.x+t.radius<-1*t.radius||t.x+t.radius>e.snowSettings.screenWidth+t.radius)&&(n%i>0?(t.x=Math.random()*e.snowSettings.screenWidth,t.y=-1*t.radius):Math.random()>.5?(t.x=-1*t.radius,t.y=Math.random()*e.snowSettings.screenHeight):(t.x=e.snowSettings.screenWidth,t.y=Math.random()*e.snowSettings.screenHeight))},this.drawTheSnow=function(){var t,i=2*Math.PI;e.context.clearRect(0,0,e.snowSettings.screenWidth,e.snowSettings.screenHeight),e.context.beginPath();for(var n=e.context,a=0;a<e.snowFlakes.length;a++)t=e.snowFlakes[a],n.moveTo(t.x,t.y),n.arc(t.x,t.y,t.radius,0,i);e.context.fill()},this.restart=function(){jQuery(window).off("resize.travianSnowAnimation"),e.restarting=!0,cancelAnimationFrame(e.animationFrame),e.animationFrame=null,e.context=null;var t=jQuery("canvas#snowAnimation");e.snowFlakes=[],t.remove(),e.updateState()},this.setState=function(e){var t=e&&jQuery("input[name=option_seasonal_snow_enabled]").is(":checked");this.setPreferences({enabled:t}),this.restart()},this.setPreferences=function(e){return this.snowSettings=Object.assign(this.snowSettings,e),this.snowSettings},this.isActive=function(){return(jQuery("body").attr("class")||"").split(" ").indexOf(this.cssClassName)>-1},Travian.Seasons.Season.call(this);var e=this,t={};try{t=JSON.parse(Travian.Game.Preferences.get("snowAnimation"))}catch(e){}this.setPreferences(t),this.isActive()&&this.restart()},Travian.Seasons.Winter.prototype=Object.create(Travian.Seasons.Season.prototype),Travian.Seasons.Winter.constructor=Travian.Seasons.Winter,Travian.Seasons.Winter.writeNewPreferences=function(e){jQuery("body").find("span.pleaseSaveYourChanges").removeClass("hidden"),jQuery("input[name=option_seasonal_snow_preferencesSettings]").val(JSON.stringify(e)).trigger("change")},Travian.Seasons.Winter.setSettingsElementState=function(e,t){var i=e.find("input, select");t?(e.removeClass("disabled"),i.prop("disabled",!1)):(e.addClass("disabled"),i.prop("disabled",!0))},Travian.Seasons.Winter.bindSettingsEvents=function(e,t){Travian.Seasons.Winter.setSettingsElementState(t,e.is(":checked")),e.on("change",(function(){Travian.Seasons.Winter.setSettingsElementState(t,this.checked)})),t.find("#option_seasonal_snow_enabled").on("change",(function(){var e=this.checked;Travian.Seasons.currentSeason.restarting||setTimeout((function(){var t=Travian.Seasons.currentSeason.setPreferences({enabled:e});Travian.Seasons.Winter.writeNewPreferences(t),Travian.Seasons.currentSeason.restart()}),100)})),t.find("#option_seasonal_snow_maxFlakes").on("change",(function(){var e=Math.min(2500,Math.max(25,parseInt(jQuery(this).val())));Travian.Seasons.currentSeason.restarting||setTimeout((function(){var t=Travian.Seasons.currentSeason.setPreferences({maxFlakes:e});Travian.Seasons.Winter.writeNewPreferences(t),Travian.Seasons.currentSeason.restart()}),100)})),t.find("#option_seasonal_snow_maxFlakeRadius").on("change",(function(){var e=Math.min(10,Math.max(3,parseInt(jQuery(this).val())));Travian.Seasons.currentSeason.restarting||setTimeout((function(){var t=Travian.Seasons.currentSeason.setPreferences({maxFlakeRadius:e});Travian.Seasons.Winter.writeNewPreferences(t),Travian.Seasons.currentSeason.restart()}),100)})),t.find("#option_seasonal_snow_moveToBackground").on("change",(function(){var e=1===parseInt(jQuery(this).val());Travian.Seasons.currentSeason.restarting||setTimeout((function(){var t=Travian.Seasons.currentSeason.setPreferences({moveToBackground:e});Travian.Seasons.Winter.writeNewPreferences(t),Travian.Seasons.currentSeason.restart()}),100)}))},jQuery((function(){"winter"===Travian.Defaults.Season&&(Travian.Seasons.currentSeason=new Travian.Seasons.Winter)})),Travian.i18n={DIRECTION_OVERRIDE_LTR:String.fromCharCode(8237),DIRECTION_OVERRIDE_RTL:String.fromCharCode(8238),DIRECTION_STOP_OVERRIDE:String.fromCharCode(8236),LTR:"ltr",RTL:"rtl",RTL_LANGUAGES:["ar-AE","he-IL"],RTL_MATHS:["ar-AE"],RTL_RATIO:["ar-AE"],ARABIC_NUMBERS:["ar-AE","he-IL"],clearDirection:function(e){return e.replace(/[\u202D\u202C\u202E]/g,"")}},Travian.i18n.Number=function(e,t){let i={mathDirection:null,unit:"",sign:!1,locale:null,grouping:null,fraction:null};return function(t){const n={"%":String.fromCharCode(37),x:String.fromCharCode(215)},a={PLUS:String.fromCharCode(43),MINUS:String.fromCharCode(45)},o="de-DE";let r=Travian.Game.language;"com"===r&&(r="en-US"),i.mathDirection=Travian.i18n.RTL_MATHS.indexOf(r)>=0?Travian.i18n.RTL:Travian.i18n.LTR,void 0!==t.unit&&(i.unit=Object.keys(n).indexOf(t.unit)>=0?n[t.unit]:t.unit),i.sign=e<0?a.MINUS:void 0!==t.alwaysShowSign&&t.alwaysShowSign?a.PLUS:"";let s=r.split("-",2).join("-");i.locale=Travian.i18n.ARABIC_NUMBERS.indexOf(s)>=0?o:s||o,i.grouping=void 0!==t.grouping&&t.grouping,i.fraction=void 0!==t.fraction?t.fraction:0}(t=void 0!==t?t:{}),function(){let t=Math.abs(e),n={};if(i.grouping||(n.useGrouping=i.grouping),void 0!==i.fraction&&(n.minimumFractionDigits=i.fraction,n.maximumFractionDigits=i.fraction),t=Travian.i18n.DIRECTION_OVERRIDE_LTR+t.toLocaleString(i.locale,n)+Travian.i18n.DIRECTION_STOP_OVERRIDE,i.unit||i.sign){let e=i.mathDirection===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL,n=i.sign;i.signWrapper&&(n=i.signWrapper.replace("SIGN",n)),t=e+n+t+i.unit+Travian.i18n.DIRECTION_STOP_OVERRIDE}return t}()},Travian.i18n.Ratio=function(e,t,i){const n="&nbsp;";e=Travian.i18n.Number(e,i),t=Travian.i18n.Number(t,i),i=void 0!==i?i:{};return function(){let a=Travian.Game.language,o=function(e){e=void 0!==e&&e;let t=Travian.Game.language,i=Travian.i18n.RTL_RATIO.indexOf(t)>=0?"\\":"/";return e&&(i=n+i+n),i}(i.useSpaces),r=Travian.i18n.RTL_RATIO.indexOf(a)>=0?Travian.i18n.RTL:Travian.i18n.LTR,s=e;void 0!==i.nominatorClass&&(s='<span class="'+i.nominatorClass+'">'+e+"</span>");let l=t;return void 0!==i.denominatorClass&&(l='<span class="'+i.denominatorClass+'">'+t+"</span>"),(r===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL)+s+o+l+Travian.i18n.DIRECTION_STOP_OVERRIDE}()},Travian.SVGHandler={get:function(e,t,i){if(i=i||{},"function"==typeof t){try{const n=JSON.parse(window.sessionStorage.getItem(e));if(n&&n.result&&JSON.stringify(n.config)===JSON.stringify(i))return t(n.result)}catch(e){}Travian.api("svg",{data:{path:e,config:i},success:function(n){void 0!==n&&(window.sessionStorage.setItem(e,JSON.stringify({result:n,config:i})),t(n))}},"POST","HTML")}}},Travian.Game={currentPage:window.location.href.split("/").pop().split(".php",2).shift(),eventJamHtml:null,speed:1,version:4,worldId:null,gotoPage:function(e,t,i,n){return Travian.api(t,{data:{data:{page:e,entries:n}},success:function(e){jQuery(i).html(e.result)}}),this},iPopupUrl:function(e,t){var i=new Travian.Dialog.Dialog({title:t,buttonOk:!1,enableBackground:!1,draggable:!0,fx:{duration:0}});return i.setContent('<iframe class="popup" frameborder="0" id="Frame" src="'+e+'" width="475" height="500" scrolling="yes" border="0" allowTransparency="true"></iframe>'),i.show(),!1},unitZoom:function(e,t){var i=new Travian.Dialog.Dialog({version:2,buttonOk:!1,cssClass:"plain"});return i.setContent('<img class="unitFull u'+e+'Full" src="/img/x.gif" alt="'+t+'">'),i.show(),!1},setLanguage:function(e){var t;switch(e){case"sr-RS-Cyrl":t="sr-Cyrl";break;case"bs-BA-Latn":t="bs-Latn";break;default:t=e}this.language=e,this.bcpLanguageCode=t}},jQuery((function(){Travian.TimersAndCounters.init(),Travian.removeAutoreloadParameter(),jQuery("*.dynamic_img").on({mouseenter:function(e){jQuery(this).addClass("over")},mouseleave:function(e){jQuery(this).removeClass("over").removeClass("clicked")},mousedown:function(e){jQuery(this).removeClass("over").addClass("clicked")}})})),Travian.Game.Preferences={preferences:{},initialize:function(e){var t=this;for(var i in e)if(e.hasOwnProperty(i))switch(e[i]){case"true":t.preferences[i]=!0;break;case"false":t.preferences[i]=!1;break;case"null":t.preferences[i]=null;break;default:t.preferences[i]=e[i]}},get:function(e){return void 0!==this.preferences[e]?this.preferences[e]:null},set:function(e,t){if(this.preferences[e]!==t){this.preferences[e]=t;var i={};i[e]=null==t?t:t.toString(),Travian.api("preferences",{data:i})}},reload:function(){var e=this;Travian.api("preferences/all",{success:function(t){e.preferences={},e.initialize(t),jQuery(window).trigger("travian.preferences.reloaded")}},"get")}},Travian.Game.Layout={states:{travian_toggle:["expanded","collapsed"]},goldIsUpdating:!1,tabChangeEventTypeName:"tabChange",tabChangeEventClassAttribute:"contentClass",toggleBox:function(e,t,i){var n=t+"_"+i,a=this.states[t],o=Travian.Game.Preferences.get(n);-1===a.indexOf(o)&&(o=a[0]);for(var r="",s=0;s<a.length;s++){var l=a[s];if(e.removeClass(l),l!==o){r=l,e.addClass(r);var d=Travian.Translation.get(i+"_"+r);e.find("button.toggle").prop("title",d),Travian.Tip.refresh()}}Travian.Game.Preferences.set(n,r),this.setInfoboxItemsRead()},setInfoboxItemsRead:function(){var e=jQuery("#sidebarBoxInfobox");if(e.length>0&&e.hasClass("toggleable")){var t=jQuery("#sidebarBoxInfobox li.unreaded");if(e.hasClass("collapsed")&&t.length>0){var i=[];t.each((function(e,t){i.push(jQuery(t).attr("id").replace("infoID_",""))})),Travian.api("infobox/read",{data:{infoIds:i},success:function(e){jQuery("#sidebarBoxInfobox li.unreaded").removeClass("unreaded");var t=jQuery("#sidebarBoxInfobox div.messageShortInfo");void 0!==e.messageCounterContent&&(t.animate({"margin-top":"15px",opacity:0},250),setTimeout((function(){t.remove(),jQuery(e.messageCounterContent).insertAfter("#sidebarBoxInfobox .boxTitle"),jQuery("#sidebarBoxInfobox div.messageShortInfo").css({"margin-top":"15px",opacity:0}).animate({"margin-top":0,opacity:1},250),Travian.Tip.refresh()}),250))}})}}},setupInfoboxItemsDeletionWithMessage:function(e,t){jQuery("a.infoboxDeleteButton").each((function(i,n){var a=jQuery(n),o=a.attr("data-id");a.click((function(i){var n=new Travian.Dialog.Dialog({preventFormSubmit:!0,buttonTextOk:t,onOkay:function(){Travian.api("infobox",{data:{id:o},success:function(){Travian.autoreload()}},"DELETE")}});return n.setContent(e),n.show(),!1}))}))},updateGold:function(e){Travian.Game.Layout.goldIsUpdating=!0;var t=parseInt(jQuery(".ajaxReplaceableGoldAmount").first().html());Travian.api("player/gold-amount",{data:{},success:function(i){var n=i.goldAmount;if(n!==t){var a=new Travian.Formatter({forceDecimal:!1});jQuery(".ajaxReplaceableGoldAmount").html(a.getFormattedNumber(n)),"function"==typeof e?e():"string"==typeof e&&"function"==typeof e.split(".").reduce((function(e,t){return e[t]}),window)&&e.split(".").reduce((function(e,t){return e[t]}),window)}Travian.Game.Layout.goldIsUpdating=!1}})},updateShopNotification:function(e,t){if(e>0){let i=jQuery("#header .shopNotification");if(void 0!==t&&t.length>0&&(i=t),i.length>0){let t=parseInt(i.html())-e;t<=0?i.addClass("read"):(i.addClass("updating"),setTimeout((function(){i.html(t)}),150),setTimeout((function(){i.removeClass("updating")}),1500))}}},updateResources:function(e){if(void 0===e)Travian.api("village/resources",{data:{},success:function(e){Travian.Game.Layout.updateResources(e)}});else{for(var t=1;t<=4;t++)resources.storage["l"+t]=parseInt(e["l"+t]);Travian.TimersAndCounters.init()}},toggleBackgroundOverlay:function(){var e=jQuery("#backgroundOverlay");e.length>0?(e.removeClass("visible"),setTimeout((function(){e.remove()}),500)):(e=jQuery('<div id="backgroundOverlay"></div>'),jQuery("body").prepend(e),e.addClass("visible"))},fixViewportWidth:function(){let e,t=jQuery("body"),i=t.hasClass("mobileOptimized"),n=t.hasClass("rtl"),a=window.outerHeight>window.outerWidth,o=window.outerWidth<=620&&a;switch(!0){case i&&o&&null!==navigator.userAgent.match(/iPhone/i):case n&&i&&o:e="width=620";break;case n&&(!i||!o):e="width=1280";break;default:e="width=device-width"}jQuery("meta[name=viewport]").attr("content",e)},initMobileOptimizations:function(){Travian.Game.Layout.fixViewportWidth(),jQuery(window).on("resize",Travian.Game.Layout.fixViewportWidth);let e=jQuery("#sidebarAfterContent"),t=jQuery("#sidebarBeforeContent"),i=jQuery("body:not(.activate):not(.login):not(.logout):not(.error_site)"),n=i.hasClass("rtl"),a=0,o=0,r=!0;i.on("touchstart",(function(e){let t=jQuery(e.target);t.hasClass("preventMobileSwipeNavigation")||0!==t.parents(".preventMobileSwipeNavigation").length||(a=e.originalEvent.changedTouches[0].pageX),o++})),i.on("touchmove",(function(){r=r&&1===o})),i.on("touchend",(function(s){if(r){let o=jQuery(s.target),r=i.find(".dialogWrapper");if(!(r.length>0&&r.is(":visible"))&&!o.hasClass("preventMobileSwipeNavigation")&&0===o.parents(".preventMobileSwipeNavigation").length&&!i.hasClass("mainLayoutDisabled")){let i=s.originalEvent.changedTouches[0].pageX-a,o=i>=0?"right":"left";Math.abs(i)>=200&&((!n&&"left"===o||n&&"right"===o)&&(t.hasClass("mobileOpened")||e.addClass("mobileOpened"),t.removeClass("mobileOpened")),(!n&&"right"===o||n&&"left"===o)&&(e.hasClass("mobileOpened")||t.addClass("mobileOpened"),e.removeClass("mobileOpened")))}}o>0&&o--,a=0,0===o&&(r=!0)})),jQuery("#sidebarAfterContent, #sidebarAfterContent *, #sidebarBeforeContent, #sidebarBeforeContent *").on("click",(function(n){let a=jQuery(n.target),o=i.find(".dialogWrapper");(!(o.length>0&&o.is(":visible"))&&0===a.parents(".sidebarBox").length||a.is("button:not(.toggleBox)")||a.is("a")||a.parents("a, button:not(.toggleBox)").length>0&&!a.is("img.del"))&&(t.removeClass("mobileOpened"),e.removeClass("mobileOpened"))}))},updateHeroExperienceBar:function(e,t){TweenLite.to(jQuery("#experienceMask path"),.5,{morphSVG:e.mask}),TweenLite.to(jQuery("#topBarHero .experience path.title"),.5,{morphSVG:e.title}),jQuery("#topBarHero .experience .title").html("<title>"+Travian.Translation.get("hero.erfahrung")+": "+t+"</title>"),Travian.Tip.refresh()},updateHeroHealthBar:function(e,t,i){TweenLite.to(jQuery("#healthMask path"),.5,{morphSVG:e.mask}),TweenLite.to(jQuery("#topBarHero .health path.title"),.5,{morphSVG:e.title});var n=jQuery("#topBarHero .health image").attr("xlink:href").replace(/^(.*\/)(\w+)(\.png)$/,"$1"+i+"$3");jQuery("#topBarHero .health image").attr("xlink:href",n),jQuery("#topBarHero .health .title").html("<title>"+Travian.Translation.get("hero.health")+": "+Travian.i18n.Number(t,{unit:"%"})+"</title>"),Travian.Tip.refresh()},disable:function(){jQuery("body").addClass("mainLayoutDisabled")},enable:function(){jQuery("body").removeClass("mainLayoutDisabled")},tabChangeEventListenerRegister:function(){let e=jQuery("#content"),t=this.tabChangeEventClassAttribute;e.on(this.tabChangeEventTypeName,(function(i){e.attr("class",i[t])}))}},jQuery((function(){Travian.Game.Layout.tabChangeEventListenerRegister()})),Travian.Game.ColorPicker=function(e,t){this.selectColor=function(e){var t=this;return this.container.find("div.moocolorcheckbox-container").removeClass(t.options.selectedClassName),this.container.find('div[colorPick="'+e+'"]').each((function(i,n){jQuery(n).parent("div").addClass(t.options.selectedClassName),t.options.onChange(e)})),this},this.draw=function(){var e=this;return this.container.empty(),this.options.colors.forEach((function(t){var i=jQuery("<div></div>").addClass(e.options.className+" moocolorcheckbox-container").css({float:"left",cursor:"pointer"}).on("click",(function(){e.selectColor(t)})).appendTo(e.container);jQuery("<div></div>").addClass("entry").html("&nbsp;").css({"background-color":t}).attr("colorPick",t).appendTo(i)})),this},this.options=Object.assign({},{colors:[],defaultColor:-1,className:"moocolorcheckbox",selectedClassName:"moocolorcheckbox_selected"},t),this.container=jQuery(e),this.container.css("overflow","hidden"),this.draw(),this.options.defaultColor>=0&&this.selectColor(this.options.colors[this.options.defaultColor])},Travian.Game.ImagePicker=function(e,t){this.selectImage=function(e){var t=this;return this.container.find("div").removeClass(t.options.selectedClassName),this.container.find('img[src$="'+e+'"]').each((function(i,n){jQuery(n).parent("div").addClass(t.options.selectedClassName),t.options.onChange(e)})),this},this.options=Object.assign({},{images:[],defaultImage:-1,className:"mooimagecheckbox",selectedClassName:"mooimagecheckbox_selected",onChange:Travian.emptyFunction},t),this.container=e,this.container.css({overflow:"hidden"});var i=this;i.container.empty(),this.options.images.forEach((function(e){jQuery("<div></div>").addClass(i.options.className).html('<img src="'+e+'" alt="" />').css({float:"left",cursor:"pointer"}).on("click",(function(){i.selectImage(e)})).appendTo(i.container)})),this.options.defaultImage>=0&&this.selectImage(this.options.images[this.options.defaultImage])},Travian.Game.SwitchDown=function(e){this.switchDownElement=jQuery(e);var t=this;this.switchDownElement.on("click",(function(e){return t.switchDownElement.children().toggleClass("hide"),e.stopPropagation(),!1}))},Travian.Game.AddLine=function(e){this.options=Object.assign({insertAfterLastEntry:!0,elements:{add:null,insert:null,table:null,template:null},entryCount:0,maxEntries:!1,selectors:{add:".addLine.addElement",insert:".addLine.insertElement",template:".addLine.templateElement"},onAddBefore:Travian.emptyFunction,onAddAfter:Travian.emptyFunction,onCloneBefore:Travian.emptyFunction,onCloneAfter:Travian.emptyFunction,onInsertBefore:Travian.emptyFunction,onInsertAfter:Travian.emptyFunction,onInsertInputBefore:Travian.emptyFunction,onInsertInputAfter:Travian.emptyFunction},e);var t=this;if(!this.options.elements.table)throw"Table element for Travian.Game.AddLine is not definied";this.options.elements.table=jQuery(this.options.elements.table),"template add insert".split(" ").forEach((function(e){if(t.options.elements[e]||(t.options.elements[e]=t.options.elements.table.find(t.options.selectors[e])),!t.options.elements[e])throw'Element "'+e+'" for Travian.Game.AddLine is not definied'})),this.options.elements.add.addClass("addLine removeElement"),this.options.elements.template=this.options.elements.template.clone(!0),this.options.elements.add.removeClass("addLine removeElement"),this.options.elements.add.on("click",(function(e){e.stopPropagation(),t.options.onAddBefore(),t.options.onCloneBefore();var i=t.options.elements.template.clone(!0);t.options.onCloneAfter(i);var n=i.find("label, input, textarea, button, select");t.options.onInsertBefore(i),n.each((function(e,n){"input"===n.tagName.toLowerCase()?"checkbox"===n.type.toLowerCase()||"radio"===n.type.toLowerCase()?n.tagName.checked=!1:"text"!==n.type.toLowerCase()&&"password"!==n.type.toLowerCase()||(n.tagName.value=""):"select"===n.tagName.toLowerCase()?n.tagName.selectedIndex=-1:"textarea"===n.tagName.toLowerCase()&&(n.tagName.value=""),t.options.onInsertInputBefore(t.options.entryCount,i,n)})),t.options.elements.insert.after(i.css({opacity:0})),i.animate({opacity:1});var a=i.find(".addLine.removeElement");a&&(a.after(t.options.elements.add),a.remove()),t.options.entryCount++,!1!==t.options.maxEntries&&t.options.maxEntries===t.options.entryCount&&(t.options.elements.add.dispose(),Travian.Tip.hide()),n.each((function(e){t.options.onInsertInputAfter(i,e)})),t.options.onInsertAfter(i),!0===t.options.insertAfterLastEntry&&(t.options.elements.insert=i),t.options.onAddAfter(i)}))},Travian.Game.InstantTabs=function(e){var t=e.find(".tabNavi .container");t.on("click",(function(i){i.preventDefault();var n=this,a=0;t.each((function(e,t){null!=n&&(t===n?n=null:a++)})),t.removeClass("active"),jQuery(this).addClass("active");var o=e.find(".tabContainer");o.addClass("hide");var r=o.get(a);return jQuery(r).removeClass("hide"),!1}))},Travian.Game.TabScrollNavigation=function(){this.navigation="",this.scrollFrom="",this.scrollTo="",this.scrollingContainer="",this.isRTL=!1,this.initialize=function(){var e=this;e.navigation=jQuery(".subNavi"),e.isRTL=jQuery("body.rtl").length>0,e.navigation.length>0&&(e.scrollFrom=e.navigation.find(".scrollFrom"),e.scrollTo=e.navigation.find(".scrollTo"),e.scrollingContainer=e.navigation.find(".scrollingContainer"),e.updateButtonStates(),e.scrollToActiveTab(),e.scrollFrom.on("click",(function(){e.isRTL?e.scrollingContainer.stop().animate({scrollLeft:e.scrollingContainer[0].scrollWidth-e.scrollingContainer[0].clientWidth},500):e.scrollingContainer.stop().animate({scrollLeft:0},500),e.scrollFrom.attr("disabled","disabled"),setTimeout((function(){e.updateButtonStates()}),550)})),e.scrollTo.on("click",(function(){e.isRTL?e.scrollingContainer.stop().animate({scrollLeft:0},500):e.scrollingContainer.stop().animate({scrollLeft:e.scrollingContainer[0].scrollWidth-e.scrollingContainer[0].clientWidth},500),e.scrollTo.attr("disabled","disabled"),setTimeout((function(){e.updateButtonStates()}),550)})))},this.updateButtonStates=function(){var e=this;e.scrollingContainer[0].scrollWidth>e.scrollingContainer[0].clientWidth&&(e.isRTL?(e.scrollFrom.attr("disabled",!(e.scrollingContainer[0].scrollLeft<e.scrollingContainer[0].scrollWidth-e.scrollingContainer[0].clientWidth)&&"disabled"),e.scrollTo.attr("disabled",!(e.scrollingContainer[0].scrollLeft>0)&&"disabled")):(e.scrollFrom.attr("disabled",!(e.scrollingContainer[0].scrollLeft>0)&&"disabled"),e.scrollTo.attr("disabled",!(e.scrollingContainer[0].scrollLeft<e.scrollingContainer[0].scrollWidth-e.scrollingContainer[0].clientWidth)&&"disabled")))},this.scrollToActiveTab=function(){var e=this,t=e.navigation.find(".tabItem.active").parent(".content");e.scrollingContainer[0].scrollWidth>e.scrollingContainer[0].clientWidth&&(!e.isRTL&&t.position().left+t.width()>e.scrollingContainer[0].clientWidth||e.isRTL&&t.position().left+t.width()<e.scrollingContainer[0].clientWidth)&&(e.isRTL?e.scrollingContainer.stop().animate({scrollLeft:e.scrollingContainer[0].clientWidth-e.scrollingContainer[0].scrollWidth},500):e.scrollingContainer.stop().animate({scrollLeft:e.scrollingContainer[0].scrollWidth-e.scrollingContainer[0].clientWidth},500),setTimeout((function(){e.updateButtonStates()}),550))},this.initialize()},Travian.Game.AutoCompleter=function(e,t,i){const n=Object.assign({minLength:2,multiple:!1,separator:"",rows:10,width:"auto"},i);let a=null,o=null,r=null;const s=function(t){t.is("li")&&t.hasClass("autocompleter")&&o!==t&&(o&&o.removeClass("autocompleter-selected"),o=t.addClass("autocompleter-selected"),function(t){const i=t.html(),a=e.val(),o=e.get(0),r=a.substr(0,o.selectionStart);let s="";if(n.multiple){const e=a.split(n.separator);e.pop(),s=e.reduce((function(e,t){return e+t+n.separator}),s)}let l=Travian.decodeSpecialChars(i);e.val(s+l),o.selectionStart=s.length+r.length,o.selectionEnd=s.length+r.length+l.length}(t))},l=function(e){if(!e.length)return o=null,void h.empty().append(jQuery("<li></li>").html(Travian.Translation.translate("{cropfinder.keine_ergebnisse}"))).show();const t=e.map((function(e){return jQuery('<li class="autocompleter"></li>').on({mouseover:function(){s(jQuery(this))}}).html(e)}));o=null,h.empty().append(t).show()},d=function(){const t=function(){const t=e.val().substr(0,e.get().selectionStart);return(n.multiple?t.split(n.separator).pop():t).trimStart()}();if(t!==a){if(a=t,t.length<n.minLength)return h.hide();r&&clearTimeout(r),r=setTimeout((()=>{c(t),r=null}),333)}},u=function(){if(!o)return;n.multiple&&e.val(e.val()+n.separator);const t=e.get(0);t.selectionStart=t.selectionEnd=e.val().length,o=null,h.hide()},c=function(e){Travian.api("autocomplete/"+t,{data:{search:e,limit:n.rows,context:n.context},success:l,error:function(){l([])}})},h=jQuery("<ul></ul>").attr("id",e.attr("id")+"-autocompleter").addClass("autocompleter-choices").css({zIndex:42,display:"none",top:e.outerHeight()}).insertAfter(e);e.prop("autocomplete","off").on("keydown",(function(e){switch(e.which){case 13:if(o)return u(),!1;break;case 38:case 40:if(h.is(":visible"))return function(e){switch(e){case"up":s(o?o.prev():h.children().last());break;case"down":s(o?o.next():h.children().first())}}(38===e.which?"up":"down"),!1;break;case 27:return h.hide(),!1}return!0})).on("keyup",(function(e){switch(e.which){case 13:case 38:case 40:case 27:return!1}return d(),!0})).on("click",u).on("focusout",(function(){h.hide()})),e.parent().css({position:"relative"})},Travian.Game.AutoCompleter.PlayerName=function(e,t){new Travian.Game.AutoCompleter(e,"playername",Object.assign({multiple:!0,separator:"; "},t))},Travian.Game.AutoCompleter.VillageName=function(e,t){new Travian.Game.AutoCompleter(e,"villagename",Object.assign({rows:20},t))},Travian.Game.Messages={check_in_progress:!1,recipients_checked:!1,technicalAccounts:["support","multihunter","plus"],checkRecipients:function(e,t){Travian.Game.Messages.check_in_progress||(Travian.Game.Messages.check_in_progress=!0,Travian.api("message/check-recipient",{data:{recipients:e},success:function(){Travian.Game.Messages.check_in_progress=!1,Travian.Game.Messages.recipients_checked=!0,t.trigger("submit")},error:function(e){Travian.Game.Messages.check_in_progress=!1;var t=new Travian.Dialog.Dialog({preventFormSubmit:!0});t.setContent(e.message),t.show()}}))},addRecipient:function(e){var t=jQuery("#receiver"),i=this.getRecipients().filter((function(e){return""!==e}));i.push(e),t.val(i.join("; ")),t.trigger("change")},getRecipients:function(e){return jQuery("#receiver").val().split(";").map((function(t){return e?t.trim().toLowerCase():t.trim()}))},checkIfRecipientsContainTechnicalAccounts:function(e){return this.technicalAccounts.reduce((function(t,i){return t||e.indexOf(i)>-1}),!1)}},Travian.Game.AddressBook={entrypoint:"addressbook",dialog:null,getDialog:function(){return null===this.dialog&&(this.dialog=new Travian.Game.AddressBook.Dialog),this.dialog},show:function(){this.dialog?this.dialog.unhide():this.getDialog().show()},hide:function(){null!==this.dialog&&this.dialog.hide()},call:function(e,t){if(t){var i=this.dialog;i.disableForm(),Travian.api(this.entrypoint+e,{data:{friend:t},success:function(e){i.setContent(e.html)},complete:function(){i.enableForm()}})}},add:function(e){return this.call("/add",e),!1},accept:function(e){return this.call("/accept",e),!1},remove:function(e){return this.call("/delete",e),!1}},Travian.Game.AddressBook.Dialog=function(e){var t=this;this.close=function(){this.hide()},Travian.Dialog.Api.call(this,Object.assign({call:Travian.Game.AddressBook.entrypoint,keepOpen:!0,context:"addressbook",draggable:!1,enableBackground:!1,preventFormSubmit:!0,title:Travian.Translation.translate("{nachrichten.adressbuch}"),buttonTextOk:Travian.Translation.translate("{allgemein.save}"),onOkay:function(){var e=t.content.find("input.friend").map((function(e,t){return t.value})).get().filter((function(e){return e}));Travian.Game.AddressBook.add(e)}},e||{}))},Travian.Game.AddressBook.Dialog.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.AddressBook.Dialog.constructor=Travian.Dialog.Api,Travian.Game.Notice=function(e,t){this.maxNotesLength=-1,this.element=jQuery("#notice"),this.initialize=function(e,t){void 0===e&&(e=-1),this.maxNotesLength=parseInt(e),void 0===t&&(t=jQuery("#notice")),this.element=t;var i=this;jQuery("#send").on("click",(function(e){i.DoubleClickPreventer||(i.DoubleClickPreventer=new Travian.DoubleClickPreventer,i.DoubleClickPreventer.timeout=250),i.DoubleClickPreventer.check()&&(i.checkMaxLength()||(e.preventDefault(),i.showNoticeTooLongMessage()))}))},this.showNoticeTooLongMessage=function(){var e=new Travian.Dialog.Dialog({preventFormSubmit:!0});e.setContent(Travian.Translation.get("nachrichten.notice_too_long")),e.show()},this.checkMaxLength=function(){return 0!==this.element.length&&(this.maxNotesLength<0||this.element.val().length<=this.maxNotesLength)},this.initialize(e,t)},Travian.Game.BBEditor=function(e,t){this.preview=null,this.textArea=null,this.id=null,this.initialize=function(e,t){var i=this;this.id=e,this.textArea=jQuery("#"+e),this.toolbar=jQuery("#"+e+"_toolbar"),this.preview=jQuery("#"+e+"_preview"),this.preview.css("display","none"),this.preview.addClass("preview"),jQuery("#"+e+"_previewButton").on("click",jQuery.proxy((function(e){i.fetchPreview(e)}),i)),jQuery("#"+e+"_resourceButton").on("click",jQuery.proxy((function(e){i.showToolbarWindow(e)}),i)),jQuery("#"+e+"_smilieButton").on("click",jQuery.proxy((function(e){i.showToolbarWindow(e)}),i)),jQuery("#"+e+"_troopButton").on("click",jQuery.proxy((function(e){i.showToolbarWindow(e)}),i)),this.textArea.on("click",jQuery.proxy((function(e){i.hideToolbarWindow(e)}),i)),this.addEvent(this.toolbar,jQuery.proxy((function(e){i.insertTag(e)}),i)),t=void 0!==t&&t,!0===Boolean(t)&&this.fetchPreview()},this.addEvent=function(e,t){for(var i=jQuery(e).children(),n=0;n<i.length;n++)Travian.Game.BBEditor.getInformationFromClass(i[n],"bbTag")&&jQuery(i[n]).on("click",t)},this.insertTag=function(e){var t,i=this;e.preventDefault(),this.hidePreview(),t=jQuery(e.target).is("button")?jQuery(e.target):jQuery(e.target).parent();var n=Travian.Game.BBEditor.getInformationFromClass(t[0],"bbTag"),a=this.textArea[0].scrollTop;switch(Travian.Game.BBEditor.getInformationFromClass(t[0],"bbType")){case"d":i.insertAroundCursor(this.textArea,"["+n+"]","[/"+n+"]");break;case"s":i.insertAtCursor(this.textArea,n);break;case"o":i.insertAtCursor(this.textArea,"["+Travian.Game.BBEditor.getInformationFromClass(t[0],"bbTag")+"]")}this.textArea[0].scrollTop=a},this.showToolbarWindow=function(e){e.preventDefault();var t=e.target,i=jQuery("#"+this.id+"_"+Travian.Game.BBEditor.getInformationFromClass(t,"bbWin")),n=!0;"block"===i.css("display")&&(n=!1),this.hideToolbarWindow(),n&&(i.show(),i.css("display","block"))},this.hideToolbarWindow=function(e){e&&e.preventDefault();for(var t=jQuery("#"+this.id+"_toolbarWindows").children(),i=0;i<t.length;i++)jQuery(t[i]).css("display","none")},this.fetchPreview=function(e){var t=this;void 0!==e&&e.preventDefault(),"none"===t.textArea.css("display")||t.textArea.val().length<1?t.hidePreview():Travian.api("bb",{data:{nl2br:1,target:t.id,message:t.textArea.val()},success:function(e){t.showPreview(e)},error:function(e){alert(e.message)}})},this.showPreview=function(e){this.preview.html(e.text),this.preview.css("display","block"),this.textArea.css("display","none")},this.hidePreview=function(){this.preview.css("display","none"),this.textArea.css("display","inline")},this.insertAroundCursor=function(e,t,i){var n=e[0].selectionStart,a=e[0].selectionEnd,o=t+e.val().substring(n,a)+i,r=e.val();e.val(r.substring(0,n)+o+r.substring(a)),e.focus(),e[0].selectionStart=n+t.length,e[0].selectionEnd=n+t.length},this.insertAtCursor=function(e,t){var i=e[0].selectionStart,n=e[0].selectionEnd,a=e.val();e.val(a.substring(0,i)+t+a.substring(n)),e.focus(),e[0].selectionStart=i+t.length,e[0].selectionEnd=i+t.length},this.initialize(e,t)},Travian.Game.BBEditor.getInformationFromClass=function(e,t){var i=jQuery(e);"img"===e.nodeName.toLowerCase()&&((e=i.parent("button")[0])||(e=i.parent("a")[0]));var n=jQuery(e).attr("class").split(" ").filter((function(e){return 0===e.indexOf(t)}));return n.length>0&&n[0].length>0&&(n=2===(n=n[0].substr(0,n[0].length-1).split("{")).length?n[1]:null),n},Travian.Game.RaidList={data:{},weAreAdding:!1,closestDropContainer:null,listsInSelectedVillage:null,captchaField:null,doubleClickPreventer:null,isRaidBeingSent:!1,onError:function(e){var t=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0});t.setContent(e.message),t.show()},startRaid:function(e){let t=this;if(null===t.doubleClickPreventer&&(t.doubleClickPreventer=new Travian.DoubleClickPreventer),t.isRaidBeingSent||!t.doubleClickPreventer.check())return;t.isRaidBeingSent=!0;let i=jQuery("#raidList .startButton");i.attr("disabled","disabled");let n=jQuery("#raidList"+e);jQuery("#raidList .attackInfoIcon").remove();let a=n.find("input[name=sort]").val(),o=n.find("input[name=direction]").val(),r=n.find("input[name=a]").val(),s=n.find(".markSlot:checked"),l=[];s.length>0&&s.each((function(e,t){l.push(jQuery(t).data("slot"))}));let d=jQuery("."+t.captchaField);Travian.api("raid-list",{data:{method:"ActionStartRaid",listId:e,slots:l,sort:a,direction:o,captcha:d.length>0?d.val():null,a:r,loadedLists:Object.keys(t.data)},success:function(r){if(r.captchaRequired)t.confirm(n.find("form:last-of-type",!0));else{let i=[];void 0!==t.data[e]&&i.push({id:e,sortField:a,sortDirection:o,startedRaids:r.startedRaids[e],errorMessages:r.errorMessages});for(let n=0;n<r.listsToUpdate.length;n++){let a=r.listsToUpdate[n];if(void 0!==t.data[a]&&parseInt(a)!==parseInt(e)){let e=jQuery("#raidList"+a).find('input[name="sort"]').val();i.push({id:a,sortField:e,sortDirection:t.data[a].directions[e]})}}t.loadLists(i);let n={success:r.startedRaids,error:r.countRaidListError};t.refreshListHeaders(!0,e,n)}void 0!==r.a&&jQuery("input[name=a]").val(r.a),r.limitReached&&t.onError({message:r.limitReached}),t.isRaidBeingSent=!1,i.attr("disabled",!1)},error:function(e){new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0,onClose:function(){Travian.autoreload()}}).setContent(e.message).show()}})},refreshListHeaders:function(e,t,i){jQuery("#raidList").length>0&&Travian.api("raid-list",{data:{method:"ActionGetListHeaders",listId:e||void 0===t?null:t,successAndErrorSummary:void 0!==i?i:null},success:function(e){for(let t=0;t<e.lists.length;t++){let i=e.lists[t],n=jQuery("#raidList"+i.id);n.find(".listName .value").html(i.name),n.find(".raidListHeadline .slots").html(i.slotsMarkup),Travian.Tip.refresh()}},error:this.onError})},addSlot:function(e,t,i,n){var a=this;n=n||null,Travian.api("raid-list",{data:{method:"ActionAddSlotForm",listId:e,weAreAdding:!!Travian.Game.RaidList.weAreAdding||null,x:t,y:i,context:n},success:function(e){return a.dialog({buttonOk:!1,context:"raidAddSlotDialog"},e.html),!0},error:a.onError}),jQuery("#raidList .attackInfoIcon").remove()},deleteSlots:function(e){var t=this;Travian.api("raid-list",{data:{method:"actionDeleteSlots",slots:e},success:function(){var e=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop();return t.refreshList(e.options.raidListId),t.refreshListHeaders(!1,e.options.raidListId),e.close(),!0},error:t.onError}),jQuery("#raidList .attackInfoIcon").remove()},editSlots:function(e,t,i){var n=this,a=jQuery("#raidList"+e+" .markSlot"),o=jQuery("#raidList"+e+" .markSlot:checked"),r=[];void 0===t?(0!==o.length?o:a).each((function(e,t){r.push(jQuery(t).data("slot"))})):r.push(t);Travian.api("raid-list",{data:{method:"actionEditSlotForm",listId:e,slots:r,context:i},success:function(t){return n.dialog({buttonOk:!1,context:"raidAddSlotDialog",raidListId:e},t.html),!0},error:n.onError}),jQuery("#raidList .attackInfoIcon").remove()},addSlotPopupWrapper:function(e,t,i){Travian.Game.RaidList.weAreAdding=!0,Travian.Game.RaidList.addSlotWrapper(e,t,i)},editSlotPopupWrapper:function(e,t){Travian.Game.RaidList.weAreAdding=!1,Travian.Game.RaidList.editSlotWrapper(e,t)},addSlotWrapper:function(e,t,i){var n=Travian.WindowManager.getWindows(),a=n.length?n[n.length-1]:null;n.length>0&&a&&n[n.length-1].close(),Travian.Game.RaidList.addSlot(e,t,i)},editSlotWrapper:function(e,t){var i=Travian.WindowManager.getWindows(),n=i.length?i[i.length-1]:null;i.length>0&&n&&i[i.length-1].close(),Travian.Game.RaidList.editSlots(e,t,!0,"map")},dialog:function(e,t){var i=new Travian.Dialog.Dialog(Object.assign({preventFormSubmit:!0},e));i.setContent(t),i.show()},saveSlot:function(e,t,i){var n=this;null!==t&&t.length>1?n.persistSlotEntry(e,t,i):(Travian.api("raid-list",{data:{method:"ActionCheckForForeignSlotEntry",listId:e,slots:t,x:i.x,y:i.y},success:function(a){if(void 0!==a&&a.hasOwnProperty("entryExists"))if(a.entryExists){var o=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!1,preventFormSubmit:!0,onOkay:function(){n.persistSlotEntry(e,t,i)}});o.setContent('<div class="centeredText">'+Travian.Translation.get("raidList.overwriteFarmListEntry")+"<br>"+Travian.Translation.get("raidList.thisWillOverwriteAnExistingFarmListEntry")+"</div>"),o.show()}else n.persistSlotEntry(e,t,i)},error:n.onError}),jQuery("#raidList .attackInfoIcon").remove())},persistSlotEntry:function(e,t,i){var n=this;jQuery("#raidListSlot #edit_form .troops").siblings(".error").remove(),Travian.api("raid-list",{data:{method:null===t||t.length<2?"ActionAddSlot":"SlotsBulkEdit",listId:e,slots:t,x:i.x,y:i.y,t1:i.t1,t2:i.t2,t3:i.t3,t4:i.t4,t5:i.t5,t6:i.t6,t7:i.t7,t8:i.t8,t9:i.t9,t10:i.t10,slotState:void 0!==i.deactivate&&i.deactivate?"inactive":"active"},success:function(){var t=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog");return t.length>0&&t.pop().close(),n.refreshAllOpenLists(),n.refreshListHeaders(!1,e),!0},error:n.onError})},refreshAllOpenLists:function(){let e=Object.keys(this.data),t=[];for(let i=0;i<e.length;i++){let n=e[i],a=jQuery("#raidList"+n).find('input[name="sort"]').val();t.push({id:parseInt(n),sortField:a,sortDirection:this.data[n].directions[a]})}this.loadLists(t)},refreshList:function(e){if(void 0!==this.data[e]){let t=jQuery("#raidList"+e).find('input[name="sort"]').val();this.loadLists([{id:e,sortField:t,sortDirection:this.data[e].directions[t]}])}},loadLists:function(e){let t=this;for(let i=e.length-1;i>=0;i--){let n=jQuery("#raidList"+e[i].id+" .expandCollapse");void 0!==t.data[e[i].id]&&n.hasClass("collapsed")?(delete t.data[e[i].id],e.splice(i,1)):n.addClass("loading")}return e.length>0&&Travian.api("raid-list/slots",{data:{listConfigs:e},success:function(i){for(let e=0;e<i.lists.length;e++){let n=i.lists[e],a=n.id,o=jQuery("#raidList"+a),r=void 0===t.data[a];t.data[a]=n.list;let s=o.find(".raidListContent");s.html(n.html);let l=o.find(".expandCollapse");l.removeClass("loading"),o.find("input[name=sort]").val(n.sort),o.find("input[name=direction]").val(n.direction),r&&s.hasClass("hide")&&(s.removeClass("hide"),l.removeClass("collapsed").addClass("expanded"))}for(var n in t.data)if(t.data.hasOwnProperty(n)){t.updateTroopSummaryForAList(n);var a=e.filter((function(e){return e.id==n})).pop();if(a&&void 0!==a.startedRaids){var o=jQuery("#raidList"+n),r=o.find(".feedback");r.find("td span").html(a.startedRaids),r.show(),o.find(".selectedTroops").hide()}}Travian.Tip.refresh()},error:t.onError}),this},showCreateNewList:function(e){var t=this;Travian.api("raid-list",{data:{method:"actionAddListForm",did:e},success:function(e){t.dialog({buttonOk:!1,context:"createNewList"},e.html)},error:t.onError})},createNewList:function(){let e=jQuery('input[name="villageId"]').val();var t={did:e,listName:jQuery('input[name="listName"]').val(),method:"actionAddList",t1:jQuery('#raidListCreate input[name="t1"]').val(),t2:jQuery('#raidListCreate input[name="t2"]').val(),t3:jQuery('#raidListCreate input[name="t3"]').val(),t4:jQuery('#raidListCreate input[name="t4"]').val(),t5:jQuery('#raidListCreate input[name="t5"]').val(),t6:jQuery('#raidListCreate input[name="t6"]').val(),t7:jQuery('#raidListCreate input[name="t7"]').val(),t8:jQuery('#raidListCreate input[name="t8"]').val(),t9:jQuery('#raidListCreate input[name="t9"]').val(),t10:jQuery('#raidListCreate input[name="t10"]').val()},i=this;Travian.api("raid-list",{data:t,success:function(t){Travian.WindowManager.closeByContext("createNewList"),jQuery("#raidList").length>0&&(jQuery("#raidList .villageWrapper[data-did="+e+"]").append(t.listHTML),i.enableDragAndDropSorting(),!0===t.maxRaidListsReached&&(jQuery("a.createNew:not(.disabled)").addClass("hidden"),jQuery("a.createNew.disabled").removeClass("hidden")))},error:function(e){void 0!==e.metadata&&e.metadata.validation_message?jQuery("#raidListCreate #error").html(e.metadata.validation_message):i.onError(e)}}),jQuery("#raidList .attackInfoIcon").remove()},deleteList:function(e){var t=this;null===t.doubleClickPreventer&&(t.doubleClickPreventer=new Travian.DoubleClickPreventer),t.doubleClickPreventer.check()&&Travian.api("raid-list",{data:{method:"actionDeleteList",listId:e},success:function(){Travian.WindowManager.closeByContext("deleteList"),Travian.WindowManager.closeByContext("updateList"),jQuery("#raidList"+e).parent(".dropContainer").remove(),delete t.data[e],jQuery("a.createNew:not(.disabled)").removeClass("hidden"),jQuery("a.createNew.disabled").addClass("hidden")},error:t.onError})},showUpdateList:function(e){var t=this;Travian.api("raid-list",{data:{method:"actionUpdateListForm",listId:e},success:function(e){t.dialog({buttonOk:!1,context:"updateList"},e.html)},error:t.onError})},updateList:function(e){let t=this,i=jQuery('#raidListUpdate input[name="sortIndex"]').val(),n={method:"actionUpdateList",listId:e,listName:jQuery('input[name="listName"]').val(),t1:jQuery('#raidListUpdate input[name="t1"]').val(),t2:jQuery('#raidListUpdate input[name="t2"]').val(),t3:jQuery('#raidListUpdate input[name="t3"]').val(),t4:jQuery('#raidListUpdate input[name="t4"]').val(),t5:jQuery('#raidListUpdate input[name="t5"]').val(),t6:jQuery('#raidListUpdate input[name="t6"]').val(),t7:jQuery('#raidListUpdate input[name="t7"]').val(),t8:jQuery('#raidListUpdate input[name="t8"]').val(),t9:jQuery('#raidListUpdate input[name="t9"]').val(),t10:jQuery('#raidListUpdate input[name="t10"]').val(),sortIndex:i};Travian.api("raid-list",{data:n,success:function(n){Travian.WindowManager.closeByContext("updateList"),t.refreshListHeaders(!1,e,null);let a=jQuery("#raidList"+e);if(a.length>0){let t=parseInt(a.parent(".dropContainer").data("sortindex")),n=parseInt(i);if(t!==n){a.parents(".villageWrapper").find(".dropContainer[data-sortindex="+n+"]").append(a);let i=a.parents(".villageWrapper").find(".raidList");n>t?i.each((function(){let i=jQuery(this);if(i.data("listid")!==e){let e=i.parent(".dropContainer"),a=e.data("sortindex");a>t&&a<=n&&e.prev(".dropContainer").append(i)}})):i.each((function(){let i=jQuery(this);if(i.data("listid")!==e){let e=i.parent(".dropContainer"),a=e.data("sortindex");a<t&&a>=n&&e.next(".dropContainer").append(i)}}))}}},error:function(e){void 0!==e.metadata&&e.metadata.validation_message?jQuery("#raidListUpdate #error").html(e.metadata.validation_message):t.onError(e)}}),jQuery("#raidList .attackInfoIcon").remove()},markSlotsOfAListForRaid:function(e,t,i){return i=void 0===i||i,jQuery.each(this.data[e].slots,(function(e,n){if(i&&n.isActive||!i){let i=jQuery("#slot"+e);void 0!==n&&(n.marked=t,i.prop("checked",t))}})),this.updateTroopSummaryForAList(e),this.toggleEditButtonText(e),this.toggleStateToggleButtonText(e),jQuery("#raidList .attackInfoIcon").remove(),this},markSlotForRaid:function(e,t,i,n){return this.data[e].slots[t].marked=i,(void 0===n||n)&&this.updateTroopSummaryForAList(e),this.toggleEditButtonText(e),this.toggleStateToggleButtonText(e),jQuery("#raidList .attackInfoIcon").remove(),this},toggleEditButtonText:function(e){var t=jQuery("#raidList"+e+" .editButton"),i=jQuery("#raidList"+e+" .markSlot").length,n=jQuery("#raidList"+e+" .markSlot:checked").length,a=n>0&&i!==n?t.data("selected-text"):t.data("default-text");t.html(a)},toggleStateToggleButtonText:function(e){var t=this.getStateToggleButtonState(e),i=jQuery("#raidList"+e).find(".stateToggleButton"),n={activateSelected:i.data("activate-selected-text"),activateAll:i.data("activate-default-text"),deactivateSelected:i.data("deactivate-selected-text"),deactivateAll:i.data("deactivate-default-text")};i.html(n[t])},getStateToggleButtonState:function(e){var t=jQuery("#raidList"+e),i=t.find(".markSlot").length,n=t.find(".markSlot:checked"),a=n.length,o=t.find(".slotInactive").length,r=0;return n.each((function(){jQuery(this).parents(".slotInactive").length>0&&r++})),a>0&&i!==a?r>0?"activateSelected":"deactivateSelected":i===a?r>0?"activateAll":"deactivateAll":o>0?"activateAll":"deactivateAll"},toggleSlotsState:function(e){var t=this,i=t.getStateToggleButtonState(e),n="activateSelected"===i||"activateAll"===i?"active":"inactive",a=jQuery("#raidList"+e),o=a.find(".markSlot"),r=a.find(".markSlot:checked"),s=r.length>0?r:o,l=[];s.each((function(){l.push(parseInt(jQuery(this).data("slot")))})),Travian.api("raid-list",{data:{method:"toggleSlotsState",slotState:n,slots:l},success:function(){t.refreshList(e)},error:t.onError})},setData:function(e){this.data=e},sort:function(e,t){return this.closeLastRaidSorting(e),this.loadLists([{id:e,sortField:t,sortDirection:"asc"!==this.data[e].directions[t]?"asc":"desc"}])},toggleList:function(e){var t=!jQuery("#raidList"+e+" .expandCollapse").hasClass("expanded");if(void 0===this.data[e])this.loadLists([{id:e}]);else{var i=jQuery("#raidList"+e);i.find(".expandCollapse").toggleClass("collapsed").toggleClass("expanded");let t=i.find(".raidListContent");t.toggleClass("hide"),t.hasClass("hide")&&i.find("input[type=checkbox]").prop("checked",!1)}return this.updateExpandedList(e,t),jQuery("#raidList .attackInfoIcon").remove(),this},collapseList:function(e){var t=jQuery("#raidList"+e);t.find(".expandCollapse").addClass("collapsed").removeClass("expanded"),t.find(".raidListContent").addClass("hide"),t.find("input[type=checkbox]").prop("checked",!1)},updateTroopSummaryForAList:function(e){var t=this,i=[0,0,0,0,0,0,0,0,0,0,0],n=0,a=jQuery("#raidList"+e);a.find(".feedback").hide();return a.find(".selectedTroops").show(),jQuery.each(this.data[e].slots,(function(e,t){if(t.marked){n++;for(var a=1;a<=10;a++)i[a]+=t.troops[a]}})),a.find(".selectedCount").html(Travian.Translation.translate("{raidList.selected}").replace("[COUNT]",n)),n>0?a.find(".equals span").show():a.find(".equals span").hide(),a.find(".troopSelectionUnit").each((function(n,a){a=jQuery(a);let o=n+1;if(i[o]>0){let n=t.data[e].troops.hasOwnProperty("t"+o)?t.data[e].troops["t"+o]:0,r="troopsInVillage";i[o]>n&&(r+=" alert"),a.find("span").html(Travian.i18n.Ratio(i[o],n,{nominatorClass:"troopSelectionValue",denominatorClass:r})),a.show()}else a.hide()})),this},confirm:function(e,t){let i=this;t=void 0!==t&&t;let n=jQuery(e).closest("form").find('input[name="lid"]').val();Travian.api("raid-list/captcha",{data:{lid:n,attempt:t?"retry":"new"},success:function(e){e.captchaIsNeeded?i.dialog({buttonOk:!1,darkOverlay:!0,context:"raidListCaptcha"},e.html):i.startRaid(n)}})},RaidSlot:function(e,t,i){this.slots=e,this.context=t,this.targets=i,this.updateRaidList=function(){var e=jQuery("#xCoordInput").val(),t=jQuery("#yCoordInput").val();this.update({listId:this.getSelectedListId(),x:e,y:t})},this.updateTargetId=function(){var e=jQuery("#target_id").val(),t=this.targets.find((function(t){return t.did==e}));t&&(jQuery("#xCoordInput").val(t.x),jQuery("#yCoordInput").val(t.y),this.update({listId:this.getSelectedListId(),x:t.x,y:t.y}))},this.update=function(e){var t=Object.assign({method:"actionCheckSlotExists",slots:this.slots,context:this.context},e);Travian.api("raid-list",{data:t,success:function(e){e.update&&Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop().setContent(e.html)},error:this.onError})},this.getSelectedListId=function(){return jQuery("select#lid option:selected").val()}},updateListSortIndex:function(e,t,i,n){Travian.api("raid-list",{data:{method:"actionUpdateListSortIndex",listId:e,indexFrom:t,indexTo:i,did:n},success:function(e){},error:this.onError})},enableDragAndDropSorting:function(){jQuery((function(){jQuery(".dragAndDrop").off("mousedown touchstart").on("mousedown touchstart",(function(t){t.preventDefault();var i=jQuery(this).parents(".raidList");Travian.Game.RaidList.collapseList(i.data("listid")),i.addClass("dragged");var n=i.clone();n.attr("id","dragElement"),n.css({width:i.width()}),i.parents(".dropContainer").prepend(n),e(t),jQuery(".villageWrapper").addClass("inactive"),i.parents(".villageWrapper").removeClass("inactive"),Travian.Game.RaidList.closestDropContainer=i.parents(".dropContainer")})),jQuery(window).on("mousemove touchmove",(function(t){var i=jQuery(".raidList.dragged");if(i.length>0){e(t);var n=Travian.getCursorPosition(t);if(Travian.Game.RaidList.closestDropContainer=i.parents(".dropContainer"),i.parents(".villageWrapper").find(".dropContainer").each((function(){var e=jQuery(this);Math.abs(n.y-e.offset().top-e.height()/2)<Math.abs(n.y-Travian.Game.RaidList.closestDropContainer.offset().top-Travian.Game.RaidList.closestDropContainer.height()/2)&&(Travian.Game.RaidList.closestDropContainer=e)})),jQuery(".dropContainer").removeClass("highlightDropSection"),parseInt(Travian.Game.RaidList.closestDropContainer.find(".raidList").data("listid"))!==parseInt(i.data("listid"))){var a=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex"))>parseInt(i.parent(".dropContainer").data("sortindex"))?"down":"up";Travian.Game.RaidList.closestDropContainer.removeClass("up").removeClass("down").addClass("highlightDropSection "+a)}}})),jQuery(window).on("mouseup touchend",(function(){var e=jQuery(".raidList.dragged");if(e.length>0){var t=parseInt(e.parents(".dropContainer").data("sortindex")),i=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex")),n=parseInt(e.parents(".villageWrapper").data("did"));Travian.Game.RaidList.closestDropContainer.append(e),Travian.Game.RaidList.updateListSortIndex(parseInt(e.data("listid")),t,i,n);var a=Travian.Game.RaidList.closestDropContainer.parents(".villageWrapper").find(".raidList");i>t?a.each((function(){var n=jQuery(this);if(n.data("listid")!==e.data("listid")){var a=n.parent(".dropContainer"),o=a.data("sortindex");o>t&&o<=i&&a.prev(".dropContainer").append(n)}})):a.each((function(){var n=jQuery(this);if(n.data("listid")!==e.data("listid")){var a=n.parent(".dropContainer"),o=a.data("sortindex");o<t&&o>=i&&a.next(".dropContainer").append(n)}}));var o=jQuery("#dragElement"),r=Travian.Game.RaidList.closestDropContainer.find(".raidList:not(#dragElement)");r.addClass("hidden");var s=r.offset(),l=jQuery(window).scrollTop();o.animate({left:s.left,top:s.top-l},250),setTimeout((function(){r.removeClass("hidden"),o.remove()}),250),jQuery(".villageWrapper").removeClass("inactive"),e.removeClass("dragged"),jQuery(".dropContainer").removeClass("highlightDropSection")}}));var e=function(e){var t=Travian.getCursorPosition(e),i=jQuery(window).scrollTop(),n=jQuery("#dragElement"),a=n.offset(),o=n.find(".dragAndDrop svg"),r=o.offset(),s=a.left-r.left+o.width()/2,l=r.top-a.top+o.height()/2+i;n.css({left:t.x+s,top:t.y-l})}}))},enableClickSorting:function(e){var t,i,n=jQuery(".sortContainer"),a=null,o=1;jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(i,n){parseInt(n.id)===parseInt(e)&&(t=n),parseInt(n.sortIndex)>o&&(o=parseInt(n.sortIndex))})),n.find(".moveUp").on("click",(function(e){e.preventDefault();var n=parseInt(t.sortIndex),o=n-1;n>1&&(i=null,a=null,jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(e,i){var a=parseInt(i.sortIndex);a<n&&a>=o&&(i.sortIndex=a+1),parseInt(i.id)===parseInt(t.id)&&(i.sortIndex=o,t.sortIndex=o)})),r())})),n.find(".moveDown").on("click",(function(e){e.preventDefault();var n=parseInt(t.sortIndex),s=n+1;n<o&&(i=null,a=null,jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(e,i){var a=parseInt(i.sortIndex);a>n&&a<=s&&(i.sortIndex=a-1),parseInt(i.id)===parseInt(t.id)&&(i.sortIndex=s,t.sortIndex=s)})),r())}));var r=function(){jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(e,n){var o=parseInt(n.sortIndex);o===t.sortIndex-1&&(i=n),o===t.sortIndex+1&&(a=n)}));var e=n.find(".listBefore");e.find(".sortIndex").html(null!==i?i.sortIndex:""),e.find(".listName").html(null!==i?i.name:""),n.find(".listCurrent").find(".sortIndex").html(t.sortIndex);var r=n.find(".listAfter");r.find(".sortIndex").html(null!==a?a.sortIndex:""),r.find(".listName").html(null!==a?a.name:"");var s=n.find(".moveUp").removeClass("disabled");1===t.sortIndex&&s.addClass("disabled");var l=n.find(".moveDown").removeClass("disabled");t.sortIndex===o&&l.addClass("disabled"),jQuery('#raidListUpdate input[name="sortIndex"]').val(t.sortIndex)}},openLastRaidSorting:function(e){var t=this,i=jQuery("#raidList"+e).find("nav.lastRaidSorting");i.addClass("open"),i.on("click",(function(n){jQuery(n.target).is(i)&&t.closeLastRaidSorting(e)}))},closeLastRaidSorting:function(e){var t=jQuery("#raidList"+e).find("nav.lastRaidSorting");t.removeClass("open"),t.off("click")},updateExpandedList:function(e,t){Travian.api("raid-list",{data:{method:"updateListExpandedStatus",listId:e,isExpanded:t},success:function(){},error:this.onError})}},Travian.Game.Reports={editRights:function(e,t){const i="report/rights/"+t.datas.reportId;return Travian.api(i,{success:function(n){t.datas=Object.assign({},t.datas||{},n||{});var a=Travian.Helpers.substitute('<div class="reports" id="editRights"><div><label><input type="checkbox" id="right1" class="check" /> {anonymOpponent}</label></div><div><label><input type="checkbox" id="right2" class="check" /> {anonymMyself}</label></div><div><label><input type="checkbox" id="right3" class="check" /> {hiddenOwnTroops}</label></div><div><label><input type="checkbox" id="right4" class="check" /> {hiddenOtherTroops}</label></div><div class="description">{description}<br /><textarea id="description"></textarea></div></div>',t.text),o=new Travian.Dialog.Dialog({relativeTo:e,buttonTextOk:t.text.buttonTextOk,title:t.text.title,preventFormSubmit:!0,onOpen:function(e,i){jQuery("#right1").prop("checked",t.datas.right1),jQuery("#right2").prop("checked",t.datas.right2),jQuery("#right3").prop("checked",t.datas.right3),jQuery("#right4").prop("checked",t.datas.right4),jQuery("#description").html(t.datas.description)},onOkay:function(e,t){return Travian.api(i,{data:{right1:jQuery("#right1").prop("checked"),right2:jQuery("#right2").prop("checked"),right3:jQuery("#right3").prop("checked"),right4:jQuery("#right4").prop("checked"),description:jQuery("#description").val()}}),!1}});o.setContent(a),o.show()}},"GET"),!1}};var shopUIV2,reload_enabled=!0,delayTimeForReload=0,resources={};function ShopUIV2(){this.allowSlidePackages=!0,this.allowSlidePaymentMethods=!0,this.goldPackagesPages=[],this.goldPackagesPagesSize=0,this.paymentMethodsPages=[],this.paymentMethodsPageSize=0,this.selectedPaymentMethod=!1,this.rtl=!1,this.initialize=function(){var e=this;$$(".paymentWizardDirectionRTL").length>0&&(this.rtl=!0),e.slidingContentInnerPackage=$$("#packageSlider .slidingContentInner")[0],e.slidingContentOuterPackage=$$("#packageSlider .slidingContentOuter")[0],e.slidingContentOuterWidthPackage=e.slidingContentOuterPackage.getDimensions(),e.slidingContentOuterWidthPackage=parseInt(e.slidingContentOuterWidthPackage.x),e.slidingContentInnerPackage.set("tween",{duration:500,transition:"linear",link:"cancel",onComplete:function(){e.allowSlidePackages=!0}}),e.slidingContentInnerPaymentMethods=$$("#paymentMethodsSlider .slidingContentInner")[0],e.slidingContentOuterPaymentMethods=$$("#paymentMethodsSlider .slidingContentOuter")[0],e.slidingContentOuterWidthPaymentMethods=e.slidingContentOuterPaymentMethods.getDimensions(),e.slidingContentOuterWidthPaymentMethods=parseInt(e.slidingContentOuterWidthPaymentMethods.x),e.slidingContentInnerPaymentMethods.set("tween",{duration:500,transition:"linear",link:"cancel",onComplete:function(){e.allowSlidePaymentMethods=!0}});var t=0;$$("#packageSlider .productsPage").each((function(i){if(e.goldPackagesPages[t]=i,0==e.goldPackagesPagesSize){var n=i.getStyle("width");n=parseInt(n.replace("px","")),e.goldPackagesPagesSize=n}t++})),e.initializePaymentMethods(),setTimeout((function(){e.packageSliderButtonCheck(),e.paymentMethodsSliderButtonCheck(),e.bindEvents(),e.updateResultBox(),setTimeout((function(){$$("#packageSlider .package.hideForLoading").removeClass("hideForLoading")}),500)}),250)},this.initializePaymentMethods=function(){var e=this;if($$("#paymentMethodsSlider .loading")[0].removeClass("hide"),void 0!==$$(".package.selected input.goldProductId")[0]){var t=parseInt($$(".package.selected input.goldProductId")[0].get("value"));$$("#paymentMethodsSlider .slidingContent")[0].empty(),e.updateResultBox(),Travian.api("paynet/payment-providers",{data:{selectedPackage:t},success:function(t){if(void 0===$$("#paymentMethodsSlider .slidingContent")[0])return!1;$$("#paymentMethodsSlider .slidingContent")[0].set("html",t.html),e.rtl?e.slidingContentInnerPaymentMethods.setStyle("margin-right",0):e.slidingContentInnerPaymentMethods.setStyle("margin-left",0),e.paymentMethodsPages=[],e.paymentMethodsPageSize=0;var i=0;$$(".methodsPage").each((function(t){if(e.paymentMethodsPages[i]=t,0==e.paymentMethodsPageSize){var n=t.getStyle("width");n=parseInt(n.replace("px","")),e.paymentMethodsPageSize=n}i++})),$$("#paymentMethodsSlider .methodItem").each((function(t){if(t.addEvent("click",e.methodItemClickEvent),!1!==e.selectedPaymentMethod&&parseInt(t.getChildren()[0].get("value"))==e.selectedPaymentMethod){$$("#paymentMethodsSlider .methodItem").removeClass("selected"),t.addClass("selected");for(var i=0;i<e.paymentMethodsPages.length;i++)if(e.paymentMethodsPages[i]==t.getParent()){var n=i*e.paymentMethodsPageSize;0==n&&(n=1),e.allowSlidePaymentMethods=!1,$$("#paymentMethodsSlider .methodsPage").removeClass("visible").addClass("hidden"),e.paymentMethodsPages[i].removeClass("hidden").addClass("visible"),e.rtl?e.slidingContentInnerPaymentMethods.tween("margin-right",-1*n):e.slidingContentInnerPaymentMethods.tween("margin-left",-1*n),e.updateResultBox()}}})),e.paymentMethodsSliderButtonCheck(),$$("#paymentMethodsSlider .loading")[0].addClass("hide")}})}},this.packageSliderButtonCheck=function(){var e=this;void 0!==e.goldPackagesPages[0]&&(e.goldPackagesPages[0].hasClass("visible")?$$("#packageSlider .slideArea.area1")[0].hasClass("inactive")||$$("#packageSlider .slideArea.area1")[0].addClass("inactive"):$$("#packageSlider .slideArea.area1")[0].removeClass("inactive"),e.goldPackagesPages[e.goldPackagesPages.length-1].hasClass("hidden")?$$("#packageSlider .slideArea.area2")[0].hasClass("inactive")&&$$("#packageSlider .slideArea.area2")[0].removeClass("inactive"):$$("#packageSlider .slideArea.area2")[0].addClass("inactive"))},this.paymentMethodsSliderButtonCheck=function(){var e=this;void 0!==e.paymentMethodsPages[0]&&(e.paymentMethodsPages[0].hasClass("visible")?$$("#paymentMethodsSlider .slideArea.area1")[0].hasClass("inactive")||$$("#paymentMethodsSlider .slideArea.area1")[0].addClass("inactive"):$$("#paymentMethodsSlider .slideArea.area1")[0].removeClass("inactive"),e.paymentMethodsPages[e.paymentMethodsPages.length-1].hasClass("hidden")?$$("#paymentMethodsSlider .slideArea.area2")[0].hasClass("inactive")&&$$("#paymentMethodsSlider .slideArea.area2")[0].removeClass("inactive"):$$("#paymentMethodsSlider .slideArea.area2")[0].addClass("inactive"))},this.bindEvents=function(){var e=this;$$("#packageSlider .slideArea.area1").addEvent("click",(function(){e.packageSlideLeft()})),$$("#packageSlider .slideArea.area2").addEvent("click",(function(){e.packageSlideRight()})),$$("#packageSlider .package").addEvent("click",(function(){this.hasClass("selected")||($$(".package").removeClass("selected"),this.addClass("selected"),e.initializePaymentMethods())})),$$("#phonePackages .package").addEvent("click",(function(){this.hasClass("selected")||($$(".package").removeClass("selected"),this.addClass("selected"),e.initializePaymentMethods())})),$$("#paymentMethodsSlider .slideArea.area1").addEvent("click",(function(){e.paymentMethodsSlideLeft()})),$$("#paymentMethodsSlider .slideArea.area2").addEvent("click",(function(){e.paymentMethodsSlideRight()})),$$("#paymentMethodsSlider .methodItem").addEvent("click",e.methodItemClickEvent),$$("#paymentMethodsSlider").addEvent("click",(function(){e.updateResultBox(),e.saveSelectedPaymentMethod()})),$$("#overview .resultBox .activeButton").addEvent("click",(function(){e.buyNowAction()})),$$(".buyGoldLocation").addEvent("change",(function(){e.changeLocation()})),$$("#vouchers .package").addEvent("click",(function(){voucherPopup()})),window.addEvent("shopUIV2RestorePreview",(function(){$$("#paymentMethodsSlider .loading")[0].removeClass("hide"),$$("#packageSlider .slidingContentInner")[0].set("html",""),$$("#paymentMethodsSlider .slidingContentInner")[0].set("html",""),$$("#phonePackages .package").destroy(),$$("#vouchers .package").destroy(),$$("#packageSlider .slideArea > div").removeClass("active").addClass("inactive"),$$("#paymentMethodsSlider .slideArea > div").removeClass("active").addClass("inactive"),$$(".resultBox .goldUnits").set("html",""),$$(".resultBox #goldBalanceNew").set("html",""),$$(".resultBox #priceToPay").set("html","")}))},this.methodItemClickEvent=function(){this.hasClass("inactive")||this.hasClass("defect")||($$("#paymentMethodsSlider .methodItem").removeClass("selected"),this.addClass("selected"))},this.updateResultBox=function(){void 0!==$$(".package.selected .goldUnits")[0]&&($$(".resultBox #packageGoldAmount .goldUnits")[0].set("html",$$(".package.selected .goldUnits")[0].get("html")),$$(".resultBox #goldBalanceNew")[0].set("html",parseInt($$(".package.selected .goldUnits")[0].get("html"))+parseInt($$(".accountBalance span")[0].get("html"))),$$(".resultBox #priceToPay")[0].set("html",$$(".package.selected .price")[0].get("html")),$$("#paymentMethodsSlider .methodItem.selected")[0]?($$(".resultBox .inactiveButton").addClass("hide"),$$(".resultBox .activeButton").removeClass("hide")):($$(".resultBox .activeButton").addClass("hide"),$$(".resultBox .inactiveButton").removeClass("hide")))},this.saveSelectedPaymentMethod=function(){$$("#paymentMethodsSlider .methodItem.selected")[0]&&(this.selectedPaymentMethod=parseInt($$("#paymentMethodsSlider .methodItem.selected input.providerId")[0].get("value")))},this.packageSlideLeft=function(){var e=this;if(e.allowSlidePackages){for(var t="",i="",n=!1,a=e.goldPackagesPages.length-1;a>=0;a--)if(e.goldPackagesPages[a].hasClass("visible")&&(t=e.goldPackagesPages[a],n=!0),n&&e.goldPackagesPages[a].hasClass("hidden")){i=e.goldPackagesPages[a];break}if(""!=i){var o=0;o=e.rtl?e.slidingContentInnerPackage.getStyle("margin-right"):e.slidingContentInnerPackage.getStyle("margin-left");var r=(o=parseInt(o.replace("px","")))+e.goldPackagesPagesSize;0==r&&(r=1),t.removeClass("visible").addClass("hidden"),i.removeClass("hidden").addClass("visible"),e.allowSlidePackages=!1,e.rtl?e.slidingContentInnerPackage.tween("margin-right",r):e.slidingContentInnerPackage.tween("margin-left",r)}}e.packageSliderButtonCheck()},this.packageSlideRight=function(){var e=this;if(e.allowSlidePackages){for(var t="",i="",n=!1,a=0;a<e.goldPackagesPages.length;a++)if(e.goldPackagesPages[a].hasClass("visible")&&(t=e.goldPackagesPages[a],n=!0),e.goldPackagesPages[a].hasClass("hidden")&&n){i=e.goldPackagesPages[a];break}if(""!=i){var o=0;o=e.rtl?e.slidingContentInnerPackage.getStyle("margin-right"):e.slidingContentInnerPackage.getStyle("margin-left");var r=-1*((o=-1*parseInt(o.replace("px","")))+e.goldPackagesPagesSize);t.removeClass("visible").addClass("hidden"),i.removeClass("hidden").addClass("visible"),e.allowSlidePaymentMethods=!1,e.rtl?e.slidingContentInnerPackage.tween("margin-right",r):e.slidingContentInnerPackage.tween("margin-left",r)}}e.packageSliderButtonCheck()},this.paymentMethodsSlideLeft=function(){var e=this;if(e.allowSlidePaymentMethods){for(var t="",i="",n=!1,a=e.paymentMethodsPages.length-1;a>=0;a--)if(e.paymentMethodsPages[a].hasClass("visible")&&(t=e.paymentMethodsPages[a],n=!0),n&&e.paymentMethodsPages[a].hasClass("hidden")){i=e.paymentMethodsPages[a];break}if(""!=i){var o=0;o=e.rtl?e.slidingContentInnerPaymentMethods.getStyle("margin-right"):e.slidingContentInnerPaymentMethods.getStyle("margin-left");var r=(o=parseInt(o.replace("px","")))+e.paymentMethodsPageSize;0==r&&(r=1),t.removeClass("visible").addClass("hidden"),i.removeClass("hidden").addClass("visible"),e.allowSlidePaymentMethods=!1,e.rtl?e.slidingContentInnerPaymentMethods.tween("margin-right",r):e.slidingContentInnerPaymentMethods.tween("margin-left",r)}}e.paymentMethodsSliderButtonCheck()},this.paymentMethodsSlideRight=function(){var e=this;if(e.allowSlidePaymentMethods){for(var t="",i="",n=!1,a=0;a<e.paymentMethodsPages.length;a++)if(e.paymentMethodsPages[a].hasClass("visible")&&(t=e.paymentMethodsPages[a],n=!0),e.paymentMethodsPages[a].hasClass("hidden")&&n){i=e.paymentMethodsPages[a];break}if(""!=i){var o=0;o=e.rtl?e.slidingContentInnerPaymentMethods.getStyle("margin-right"):e.slidingContentInnerPaymentMethods.getStyle("margin-left");var r=-1*((o=-1*parseInt(o.replace("px","")))+e.paymentMethodsPageSize);t.removeClass("visible").addClass("hidden"),i.removeClass("hidden").addClass("visible"),e.allowSlidePaymentMethods=!1,e.rtl?e.slidingContentInnerPaymentMethods.tween("margin-right",r):e.slidingContentInnerPaymentMethods.tween("margin-left",r)}}e.paymentMethodsSliderButtonCheck()},this.buyNowAction=function(){if($$("#overview .resultBox .inactiveButton.hide")[0]){var e=parseInt($$(".package.selected input.goldProductId")[0].get("value")),t=parseInt($$("#paymentMethodsSlider .methodItem.selected input.providerId")[0].get("value")),i=800,n=600;$$("#paymentMethodsSlider .methodItem.selected input.popupWidth")[0]&&(i=$$("#paymentMethodsSlider .methodItem.selected input.popupWidth")[0]),$$("#paymentMethodsSlider .methodItem.selected input.popupHeight")[0]&&(n=$$("#paymentMethodsSlider .methodItem.selected input.popupHeight")[0]);var a=(screen.width-i)/2,o=(screen.height-n)/2;window.open("/tgpay.php?product="+e+"&provider="+t,"tgpay","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width="+i+",height="+n+",left="+a+",top="+o)}},this.changeLocation=function(){var e=$$("select.buyGoldLocation")[0].getSelected()[0].get("value"),t=new Overlay(document.body,{opacity:.8,duration:250}).open();Travian.Game.PaymentWizardEventListener.PaymentWizardObject&&Travian.Game.PaymentWizardEventListener.PaymentWizardObject.close(),jQuery(window).trigger("startPaymentWizard",{data:{goldProductId:"",goldProductLocation:e,location:"",activeTab:"buyGold",formData:{}},onOpen:function(){t.close().dispose()}})},this.selectPackage=function(e){var t=this,i=(e=$$(".package input[value="+e+"]")[0].getParent()).getParent();if("phonePackages"!=i.id&&i.hasClass("hidden"))for(var n=0;n<t.goldPackagesPages.length;n++)if(t.goldPackagesPages[n]==i){var a=n*t.goldPackagesPagesSize;0==a&&(a=1),t.allowSlidePackages=!1,$$("#packageSlider .productsPage").removeClass("visible").addClass("hidden"),t.goldPackagesPages[n].removeClass("hidden").addClass("visible"),t.rtl?t.slidingContentInnerPackage.tween("margin-right",-1*a):t.slidingContentInnerPackage.tween("margin-left",-1*a)}$$(".package").removeClass("selected"),e.addClass("selected")}}Travian.TimersAndCounters={timerEndEvent:"timerEnd",timeCounters:[],resourceCounters:{},pathReload:"reload=auto",timeToInt:function(e){var t;return 3600*(t=e.split(":"))[0]+60*t[1]+1*t[2]},intToTime:function(e,t,i){var n,a,o,r;return e<0-delayTimeForReload-1?r=t?"0:00:0?":Travian.Game.eventJamHtml||"0:00:0?":(e=Math.max(0,e),n=Math.floor(e/3600),"12h"===i&&0===n&&(n=12),r=n+":",(a=Math.floor(e/60)%60)<10&&(r+="0"),r+=a+":",(o=e%60)<10&&(r+="0"),r+=o),{hour:n,minute:a,second:o,time:r}},init:function(){this.initResourcesCounters(),this.initTimers()},initTimers:function(){this.timeCounters=[],this.initTimersInContext(document)},initTimer:function(e){var t,i,n=e.getAttribute("format");switch(e.getAttribute("counting")){case"down":t=parseInt(e.getAttribute("value"))||0,i={node:e,value:t,counting:"down",startedAt:Math.floor(Date.now()/1e3),reloadDelay:t<delayTimeForReload?1e3*delayTimeForReload:0,inReload:!1,hasCallback:""!==e.id};break;default:i={node:e,value:this.timeToInt(e.innerHTML||"00:00:00"),counting:"up",startedAt:Math.floor(Date.now()/1e3),inReload:!1,format:n}}this.updateTimerValue(i),i.value>-1&&this.timeCounters.push(i)},initTimersInContext:function(e){var t,i=e.getElementsByClassName("timer");for(t=0;t<i.length;t++)this.initTimer(i[t]);this.executeTimers()},updateTimer:function(e,t){var i=this.timeCounters.find((function(t){return t.node===e}));i&&(i.value=parseInt(t),i.startedAt=Math.floor(Date.now()/1e3))},updateTimerValue:function(e){var t,i,n,a,o=Math.floor(Date.now()/1e3)-e.startedAt,r=!1;switch(e.counting){case"down":t=e.value-o,i=this.intToTime(t),e.node.innerHTML=i.time,e.node.setAttribute("value",t),t<1&&(r=!0);break;case"up":n="12h"==e.format?(e.value+o)%43200:(e.value+o)%86400,i=this.intToTime(n,null,e.format),e.node.innerHTML=i.time,"12h"==e.format&&12===i.hour&&0===i.minute&&0===i.second&&(a=jQuery(e.node).next()).length>0&&(a[0].innerHTML=-1!==a[0].innerHTML.indexOf("pm")?" am":" pm")}return r},executeTimers:function(){this.timeCounters.length>0&&window.setTimeout("Travian.TimersAndCounters.executeTimers()",1e3);for(var e=0;e<this.timeCounters.length;e++){var t=this.timeCounters[e];this.updateTimerValue(t)&&!t.inReload&&(t.inReload=!0,this.processReload(t))}},initResourcesCounters:function(){this.resourceCounters={},this.initResourcesCounter("l1","lbar1"),this.initResourcesCounter("l2","lbar2"),this.initResourcesCounter("l3","lbar3"),this.initResourcesCounter("l4","lbar4")},initResourcesCounter:function(e,t){var i=document.getElementById(e),n=document.getElementById(t);try{var a=resources.production[e];0===a?this.updateResourceCounter(i,n,resources.storage[e]):(this.resourceCounters[e]={startInMs:Date.now(),production:a,initialResources:resources.storage[e],maximumResources:resources.maxStorage[e],minimumResources:0,tickInMs:Math.max(Math.round(Math.abs(36e5/a)),100),bar:n,node:i},this.executeCounter(e))}catch(e){}},updateResourceCounter:function(e,t,i){var n=new Travian.Formatter({forceDecimal:!1});e.innerHTML=n.getFormattedNumber(i);var a=jQuery(t);if(a.length>0){var o=Math.round(100*i/resources.maxStorage[e.id]);a.removeClass("stockFull"),i>=resources.maxStorage[e.id]&&a.addClass("stockFull"),a.css({width:o+"%"})}},executeCounter:function(e){var t=this.resourceCounters[e],i=Date.now()-t.startInMs,n=Math.floor(t.initialResources+i*(t.production/36e5));switch(!0){case n>=t.maximumResources:n=t.maximumResources;break;case n<=t.minimumResources:n=t.minimumResources;break;default:window.setTimeout("Travian.TimersAndCounters.executeCounter('"+e+"')",t.tickInMs)}resources.storage[e]=n,this.updateResourceCounter(t.node,t.bar,n)},processReload:function(e){if(e.hasCallback){let t=document.createEvent("Event");t.initEvent(this.timerEndEvent,!0,!0),e.node.dispatchEvent(t)}else window.reload_enabled&&setTimeout((function(){Travian.autoreload()}),e.reloadDelay+1e3)},enableReloadEvent:function(){window.reload_enabled=!0},suppressReloadEvent:function(){window.reload_enabled=!1}},Travian.Game.Hero={},Travian.Game.Hero.Editor=function(){var e=null;return function(t){this.unloadIdentifier=null,this.options=Object.assign({element:null,command:null,attributes:null,urlHeroImage:null,elementHeroImage:null},t),this.hideAll=function(){return this.options.element.find(".attributes .container .infoOpen").removeClass("infoOpen").find(".headline").removeClass("switchOpened").addClass("switchClosed"),this.options.element.find(".attributes .container .details").hide(),this},this.initialize=function(){var t=this;t.initializeAttributes();var i=t.options.element.find("#save");null!==i&&i.on("click",(function(e){t.sendAction("save",(function(){var e=Travian.parseURL(t.options.urlHeroImage);delete e.searchObject.code,e.searchObject.time=(new Date).getTime(),jQuery("."+t.options.elementHeroImage).attr("src",Travian.composeURI(e))})),e.preventDefault()}));var n=t.options.element.find("#random");null!==n&&(n.off("click",e),e=function(e){t.sendAction("random"),e.preventDefault()},n.on("click",e)),this.bindGenderSwitch(),this.storeAttributesInInput(this.options.attributes)},this.initializeAttributes=function(){var e=this;"object"!=typeof e.options.element&&(e.options.element=jQuery("#"+this.options.element)),this.hideAll(),this.options.element.find(".attributes .container .info .headline").on("click",(function(t){t.preventDefault(),e.showAttribute(jQuery(this).parent(".info"))})),this.options.element.find(".attributes .container .attribute").on("click",(function(t){var i=parseInt(t.target.id.split("attribute_button_")[1]),n=jQuery(t.target).parents(".info").attr("id");e.options.attributes[n]=i,e.sendAction("show"),t.preventDefault()}))},this.sendAction=function(e,t){"save"===e?Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier):this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier);var i=this;return Travian.api(this.options.command,{data:{action:e,attribs:this.options.attributes},success:function(e){jQuery(".hero_head .image").html(e.html),e.attributesHtml&&(jQuery("#attributesContainer").html(e.attributesHtml),i.initializeAttributes()),i.options.attributes=e.attributes,i.storeAttributesInInput(e.attributes),(t||Travian.emptyFunction)()}}),this},this.showAttribute=function(e){var t=(e=jQuery(e)).hasClass("infoOpen");return this.hideAll(),t||(e.addClass("infoOpen"),e.find(".headline").removeClass("switchClosed").addClass("switchOpened"),e.find(".details").show()),this},this.storeAttributesInInput=function(e){var t=this.options.element.find("input[name=attributes]");return null!==t&&t.val(encodeURI(JSON.stringify(e))),this},this.switchGender=function(e){this.options.element.hasClass("genderSwitch")&&(jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").removeClass("iconActive disabled"),"male"===e?(this.options.element.removeClass("female").addClass("male"),jQuery("#heroEditorActivateMale").addClass("iconActive disabled")):(this.options.element.removeClass("male").addClass("female"),jQuery("#heroEditorActivateFemale").addClass("iconActive disabled"))),this.options.attributes.gender=e,this.sendAction("gender")},this.bindGenderSwitch=function(){var e=this;jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").on("click",(function(t){"heroEditorActivateMale"===jQuery(this).attr("id")&&!1===e.options.element.hasClass("male")?e.switchGender("male"):"heroEditorActivateFemale"===jQuery(this).attr("id")&&!1===e.options.element.hasClass("female")&&e.switchGender("female"),t.preventDefault()}))},this.initialize()}}(),Travian.Game.Hero.Editor.constructor=Travian.Game.Hero.Editor,Travian.Game.Hero.Inventory=function(e){this.dragStatus=!1,this.isClicked=!1,this.dropOnSlotFailed=!1,this.items=[],this.options=Object.assign({did:null,c:null,gender:"male",heroState:{},isInVillage:!0,isDead:!1,data:[],heroBodyHash:!1,images:"img/hero/items/item{typeId}.png",text:{}},e),this.startDrop=!1,this.DoubleClickPreventer=null,this.createAndAddItem=function(e){var t=Object.assign({placeElement:void 0,html_id:"item_"+e.id},e||{});return-1===JSON.stringify(this.items).indexOf(JSON.stringify(t))&&this.items.push(t),this},this.createDivs=function(){var e=this,t=jQuery("#placeHolder"),i=function(t){if(e.dropOnSlotFailed)e.dropOnSlotFailed=!1;else{e.DoubleClickPreventer||(e.DoubleClickPreventer=new Travian.DoubleClickPreventer);var i=Travian.isMobile()||e.DoubleClickPreventer.check();t.isUseable&&i&&(!Travian.isMobile()||t.clickedFirstTime&&Travian.isMobile()?(Travian.Tip.hide(),e.moveToMatchingPlace(t)):(!0!==e.startDrop&&e.mark(t.slot),t.clickedFirstTime=!0))}},n=function(t){e=this,t.isUseable&&!0!==e.startDrop&&e.mark(t.slot)},a=function(t){e=this,t.isUseable&&!0!==e.startDrop&&e.unMark(t.slot)};return jQuery.each(this.items,(function(o,r){r.isUseable=e.options.isInVillage||r.isConsumable||"bag"===r.slot,e.options.isDead&&!r.isUsableIfDead&&(r.isUseable=!1);var s="";r.isUseable||(s=(e.options.isDead?e.options.text.notMoveableTextDead:e.options.text.notMoveableText)+"<br />"),s+=r.attributes.join("<br />");var l=jQuery("<div></div>").attr("id","item_"+r.id).addClass("item "+e.options.gender+"_item_"+r.typeId+" "+(r.isUseable?"":"disabled")).css("position","relative").html('<div class="amount">'+r.amount+"</div>").on({click:jQuery.proxy(i,e,r),mouseover:jQuery.proxy(n,e,r),mouseout:jQuery.proxy(a,e,r)}).appendTo(t);Travian.Tip.set(l,{unescaped:!0,title:"("+r.amount+") "+r.name,text:s}),l[0].item=r,l[0].item.element=l;var d=null;r.placeId<0?(d=jQuery("#"+r.slot),l.addClass("onHero")):d=jQuery("#inventory_"+r.placeId),d.addClass(r.isUseable?"":"disabled"),e.moveToDrop(l,d,!0)})),this.makeDraggable(),this.options.elementHeroBody[0].src=String(this.options.urlBodyImage).replace(/\\?\{([^{}]+)\}/g,jQuery.proxy(this.substitute,{heroBodyHash:e.options.heroBodyHash})),this},this.substitute=function(e,t){return"\\"===e.charAt(0)?e.slice(1):null!=this[t]?this[t]:""},this.dialog=function(e,t){var i=this,n=e.text,a=e.amount,o=e.amount,r=e.calculate;delete e.text,delete e.amount,delete e.calculate,e.onOpen=function(e,t){var n=t.children("input#amount.text");if(n.length>0){var s=function(e){if(r){var i,n=1+r.bonusPercent/100,a=e*Math.round(r.valuePerItem*n),o=e*r.valuePerItem,s=a-o,l=t.find(".displayUseValue"),d=t.find(".displayUseBonusP"),u=t.find(".displayUseBonus"),c=t.find(".displayAfterUse");l.length>0&&l.html(o),d.length>0&&d.html(r.bonusPercent),u.length>0&&u.html(s),c.length>0&&(i=r.maxValue?Math.min(r.currentValue+a,r.maxValue):r.currentValue+a,c.html(i))}};n.val(a),s(a),e.makeInputAmountable(n,o,s.bind(i))}return!0},e.onClose=function(){i.isClicked=!1,i.resetItemDrop(t)},e=Object.assign(e,{buttonTextOk:this.options.text.buttonOk}),n=String(n).replace(/\\?\{([^{}]+)\}/g,jQuery.proxy(this.substitute,{inputField:'<input class="text" id="amount" type="text" value="0" autocomplete="off" />',equipmentBonus:'<span class="displayUseBonusP">0</span>'}));var s=new Travian.Dialog.Dialog(e);return s.setContent(n),s.show(),this},this.executeMovement=function(e,t,i){var n=this;return Travian.api("inventory",{data:{action:"inventory",id:e,drid:t,amount:i,clicked:n.isClicked,did:this.options.did,c:this.options.c},success:function(e){n.isClicked=!1,n.options.c=e.checkSum,n.options.heroState=Object.assign(n.options.heroState,e.heroState||{}),e.heroBodyHash&&(n.options.heroBodyHash=e.heroBodyHash),jQuery.each(n.items,(function(e,t){jQuery("#"+t.html_id).remove()})),n.items=[],jQuery.each(e.items,(function(e,t){n.createAndAddItem(t)})),jQuery(".inventory").each((function(e,t){jQuery(t).remove()}));var t=e.inventorySize;e.heroData.freePoints>0&&jQuery("div.hero_inventory .attribute .setPoint").show();for(var a=1;a<=t;a++)jQuery("<div></div>").attr("id","inventory_"+a).addClass("inventory draggable").insertBefore(jQuery("#itemsToSale").find(".market"));n.createDivs();var o=jQuery("#attributes"),r=jQuery(".heroHealthBarBox"),s=jQuery(".heroXpBarBox");if(jQuery.each(e.heroData,(function(e,t){var i=o.find("."+e);if(i.length>0){var n=i.find(".current"),a=i.find(".progress .bar").not(".setted"),r=i.find(".points"),s=i.find(".tooltip");if(i.hasClass("res")){var l=jQuery("#setResource").find(".resource label .current");jQuery(l).each((function(e,i){jQuery(i).html(t["resourceHero"+e])}))}if(i.hasClass("tooltip")&&s.push(i),n.length>0&&n.find(".value").length>0&&(n=n.find(".value")),void 0!==t.current&&n.length>0&&n.html(t.current),void 0!==t.percent&&a.length>0){var d="experience"!==e?t.percent:Math.ceil(t.percent);a.css("width",d+"%"),void 0!==t.backgroundColor&&a.css("backgroundColor",t.backgroundColor),void 0!==t.points&&r.length>0&&(r.find("input").length>0?r.find("input").val(t.points):r.html(t.points)),void 0!==t.tooltip&&s.length&&jQuery.each(s,(function(e,i){jQuery(i).attr("title",t.tooltip),Travian.Tip.refresh()}))}}})),"hero-dead"!==o[0].className){o.find(".experience").find(".value").html(e.heroData.experience.current);var l=o.find(".health");l.length>0&&(l.find(".value").html(e.heroData.health.percent+"%"),l.find(".bar").css("width",e.heroData.health.percent+"%")),r.prop("title",e.heroData.health.tooltipSidebar),r.find(".bar").css("width",e.heroData.health.percent+"%"),s.prop("title",e.heroData.experience.tooltipSidebar),s.find(".bar").css("width",e.heroData.experience.percent+"%")}void 0!==n.DoubleClickPreventer&&n.DoubleClickPreventer.cancelTimer(),n.dragStatus=!1,n.options.afterRequestCallback[e.itemTypeId]&&n.options.afterRequestCallback[e.itemTypeId](n,n.options,i,e)},error:function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}}),this},this.initialize=function(){var e=this;jQuery.each(this.options.data,(function(t,i){e.createAndAddItem(i)})),this.createDivs()},this.isInventoryId=function(e){return"inventory"===e.substr(0,9)},this.makeDraggable=function(){var e=this,t=jQuery(".draggable");jQuery("#text");return jQuery(".item").each((function(i,n){!1!==n.item.isUseable&&(Travian.isMobile()||(jQuery(n).on("mousedown",(function(t){e.dropOnSlotFailed=!1,t.preventDefault(),e.startDrop=!0;var i=this;i.item.dragOrigin=jQuery(this).parent(".draggable"),jQuery("body").on("mousemove.inventoryItem",(function(n){if(e.startDrop&&(e.dragStatus||t.pageX!==n.pageX||t.pageY!==n.pageY)){e.dragStatus=!0,jQuery("#content").children().css({userSelect:"none"});var a=jQuery(i);a.offset({left:n.pageX-a.width()/2,top:n.pageY-a.height()/2}),a.addClass("whileDragging").removeClass("onHero")}}))})),jQuery(n).on("mouseup",(function(i){if(jQuery("#content").children().css({userSelect:"auto"}),jQuery("body").off("mousemove.inventoryItem"),!e.dragStatus)return e.startDrop=!1,!1;var n=jQuery(this),a=this.item,o=i.pageX,r=i.pageY,s=!1,l=!1;jQuery(t).each((function(t,i){if(!l){var d=(i=jQuery(i)).offset(),u=d.left,c=d.left+i.width(),h=d.top,p=d.top+i.height();o>=u&&o<=c&&r>=h&&r<=p&&(l=!0,e.isInventoryId(i.prop("id"))?(e.moveToDrop(n,i,!1),s=!0):a.slot===i.attr("id")&&(e.moveToDrop(n,jQuery("#"+a.slot),!1),s=!0))}})),s||(e.isInventoryId(a.dragOrigin[0].id)||n.addClass("onHero"),e.dragStatus=!1,e.dropOnSlotFailed=!0,e.moveToDrop(n,a.dragOrigin,!0)),n.removeClass("whileDragging"),Travian.Tip.hide(),s=!1,e.startDrop=!1}))))})),this},this.mark=function(e){return jQuery("#"+e).addClass("heroMarked"),this},this.moveItem=function(e,t,i){return i?this.executeMovement(e[0].item.id,t.attr("id"),i):(e.detach().appendTo(t),this.resetItemDrop(e),e[0].item.placeElement=jQuery(t)),this},this.moveToDrop=function(e,t,i){var n=this,a={title:"",text:"",executeAfterOkay:!0,show:!0,onOpen:Travian.emptyFunction,onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,relativeTo:e[0],amount:e[0].item.amount,preventFormSubmit:!0},o=!1;e[0].item.dragOrigin=null;var r=function(){if(a.executeAfterOkay){var r;if(i)r=!1;else if(!0===o){var s=jQuery("#amount");r=s.length>0?s.val():1}else r=e[0].item.amount;n.moveItem(e,t,r)}else n.resetItemDrop(e)};return!0!==i&&(e[0].item.isConsumable||"bag"===e[0].item.slot)&&(n.isClicked||t&&"bag"===t.attr("id").substr(0,3))?(this.options.useOneDialogTitleCallbacks[e[0].item.typeId]&&(a=Object.assign(a,this.options.useOneDialogTitleCallbacks[e[0].item.typeId](e[0].item,this.options,a)||{})),o=!0,""===a.title&&(a.title=e[0].item.name),""===a.text&&(e[0].item.isConsumable?1===e[0].item.amount?a.text=this.options.text.useOneDialogTitle:a.text=this.options.text.useDialogDescription:a.text=this.options.text.moveDialogDescription),a.show&&(a.onOkay=function(){return r(),!0},this.dialog(a,e))):r(),this},this.moveToMatchingPlace=function(e){if(!1===this.dragStatus){var t=jQuery("#"+(e.place===e.slot?"inventory":e.slot));this.isClicked=!0,this.moveToDrop(e.element,t,!1),this.unMark(e.slot)}else this.dragStatus=!1;return this},this.resetItemDrop=function(e){return e.css({left:0,top:0}),this},this.unMark=function(e){return jQuery("#"+e).removeClass("heroMarked"),this},this.initialize()},Travian.Game.Hero.SilverExchange=function(e){this.options=Object.assign({exchangeOptions:{directionType:"SilverToGold",showExchangeTypeElement:null,inputElement:null,resultValueElements:[],inputValueElements:[],baseMultiplier:1,maxAmount:null,submitButton:null,submitButton2:null,handleMaxFunction:null,submitButtonClickListener:null},messages:{notEnoughGold:null,autoCorrect:null,disabledSubmitTooltip:null,enabledSubmitTooltip:null,maxAmountTooltip:null},maxAmountChangedFunction:null},e),this.isWaiting=!1,this.lastUseTimestamp=0,this.initialize=function(){if(this.checkFileInputExtension(),this.options.exchangeOptions.showExchangeTypeElement.length>0&&this.assignListenerToShowExchangeType(this.options.exchangeOptions.showExchangeTypeElement),this.options.exchangeOptions.submitButton.length>0&&"SilverToGold"===this.options.exchangeOptions.directionType){var e=this;this.options.exchangeOptions.submitButton.on("click",(function(t){e.sendAction(jQuery(this)),t.preventDefault()}))}this.options.exchangeOptions.inputElement.length>0&&this.assignListenerToExchangeInput(this.options.exchangeOptions.inputElement)},this.checkFileInputExtension=function(){if(void 0!==jQuery.fn.filterInputTG)return!1;jQuery.fn.extend({filterInputTG:function(e){var t=e.regex,i=this;function n(n){n=n||event;var a=i.val(),o=0,r=0;"keypress"==n.type?o=n.charCode|o:r=n.keyCode|r;var s=function(e){var t,i,n,a,o,r=0,s=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(r=e.selectionStart,s=e.selectionEnd):(e.focus(),(i=document.selection.createRange())&&i.parentElement()==e&&(a=e.value.length,t=e.value.replace(/\r\n/g,"\n"),(n=e.createTextRange()).moveToBookmark(i.getBookmark()),(o=e.createTextRange()).collapse(!1),n.compareEndPoints("StartToEnd",o)>-1?r=s=a:(r=-n.moveStart("character",-a),r+=t.slice(0,r).split("\n").length-1,n.compareEndPoints("EndToEnd",o)>-1?s=a:(s=-n.moveEnd("character",-a),s+=t.slice(0,s).split("\n").length-1)))),{start:r,end:s}}(n.target);if(0==o&&8!=r&&46!=r)return!0;if(0==o&&(8==r||46==r)&&"function"==typeof e.success){var l="";return 0==s.start&&s.end-s.start>0?l=a.substr(0,s.start-1)+a.substr(s.end):s.end==a.length&&s.end-s.start>0?l=a.substr(0,s.start)+a.substr(s.end+1):s.end-s.start>0?l=a.substr(0,s.start)+a.substr(s.end):s.end-s.start==0&&(8==r&&(l=a.substr(0,s.start-1)+a.substr(s.end)),46==r&&(l=a.substr(0,s.start)+a.substr(s.end+1))),e.success.call(this,l)}var d=a.substr(0,s.start),u=a.substr(s.end);return a=d+String.fromCharCode(o)+u,o>0&&t.test(a)?"function"!=typeof e.success||e.success.call(this,a):"function"==typeof e.failure&&e.failure.call(this,a)}return this.on("keydown",n)&&this.on("keypress",n)}})},this.assignListenerToExchangeInput=function(e){var t=this;return e.filterInputTG({regex:/^[1-9][0-9]{0,6}$/,success:function(e){return t.hideAllMessages(),t.options.exchangeOptions.submitButton.length>0&&t.options.exchangeOptions.submitButton2&&t.options.exchangeOptions.submitButton2.length>0&&(t.options.exchangeOptions.submitButton2.addClass("hide"),t.options.exchangeOptions.submitButton.removeClass("hide")),t.updateExchangeValue(e)}}),this},this.updateExchangeValue=function(e){this.setLastUseTimestamp();var t=this.options.exchangeOptions,i=parseInt(e,10)||0,n=0,a="enabledSubmitTooltip",o=t.handleMaxFunction,r=!0;return null!==t.maxAmount&&"function"==typeof o&&i>t.maxAmount?(n=o.call(this,i),a="maxAmountTooltip",this.updateElementsTooltip(t.submitButton,"maxAmountTooltip"),t.submitButton2&&t.submitButton2.length>0&&this.updateElementsTooltip(t.submitButton2,"maxAmountTooltip"),jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType+" input").val(i),r=!1):n=i,n=Math.floor(n*t.baseMultiplier),t.submitButton.length>0&&0===n?(this.disableElement(t.submitButton),a="disabledSubmitTooltip",t.submitButton2&&t.submitButton2.length>0&&this.disableElement(t.submitButton2)):t.submitButton.length>0&&(this.enableElement(t.submitButton),t.submitButton2&&t.submitButton2.length>0&&this.enableElement(t.submitButton2)),this.updateElementsTooltip(t.submitButton,a),t.submitButton2&&t.submitButton2.length>0&&this.updateElementsTooltip(t.submitButton2,a),this.setElementsValue(t.resultValueElements,n),this.setElementsValue(t.inputValueElements,i),r},this.setElementsValue=function(e,t){if("object"==typeof e&&e instanceof Array)for(var i=0;i<e.length;i++){var n=e[i].setType;switch(!0){case-1!==jQuery.inArray(n,["html","val","text"]):e[i].element[n](t);break;case"object"==typeof n&&n.hasOwnProperty("attr"):e[i].element.attr(n.attr,t);break;case"object"==typeof n&&n.hasOwnProperty("prop"):e[i].element.prop(n.prop,t)}}return this},this.assignListenerToShowExchangeType=function(e){var t=this;return e.on("click",(function(e){t.switchToExchangeType(),e.preventDefault()})),this},this.switchToExchangeType=function(){return this.setLastUseTimestamp(),this.inactivateEach("#silverExchange .directionButtons .directionButton"),this.activate(this.options.exchangeOptions.showExchangeTypeElement),this.inactivateEach(jQuery("#silverExchange .exchangeType")),this.activate(jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType)),this.hideAllMessages(),this.updateExchangeValue(jQuery("#silverExchange .exchangeType"+this.options.exchangeOptions.directionType+" input").val()),this},this.inactivateEach=function(e){jQuery(e).each((function(e,t){var i=jQuery(t);i.removeClass("active"),i.addClass("disabled")}))},this.activate=function(e){return e.addClass("active"),e.removeClass("disabled"),this},this.showMessageByKey=function(e){var t=this.options.messages[e];return this.showMessage(t),this},this.showMessage=function(e){var t='<span class="'+e.type+'">'+e.message+"</span>";return jQuery("#silverExchange .exchangeMessageLine").html(t),this},this.hideAllMessages=function(){return jQuery("#silverExchange .exchangeMessageLine").html(""),this},this.updateElementsTooltip=function(e,t){this.options.messages[t]&&this.options.messages[t].message&&Travian.Tip.set(e,this.options.messages[t].message)},this.sendAction=function(e){var t=this;if(t.setLastUseTimestamp(),this.isButtonInactive(e))return!1;if(!0===this.isWaiting)return!1;this.isWaiting=!0,this.disableElement(e);var i=jQuery("#silverExchange .exchangeType input.text");i.each((function(){t.disableElement(jQuery(this))}));var n=(new Date).getTime(),a=this.options.exchangeOptions.directionType,o=i.filter("input[class^=silverInput]").val(),r=i.filter("input[class^=goldInput]").val();return Travian.api("silver/exchange",{data:{exTyp:a,s:o,g:r},success:function(a){if(a.errorMessage)t.setError(a);else{var o=Math.max(0,500-((new Date).getTime()-n));setTimeout(function(n){n.message&&(t.isWaiting=!1,t.hideAllMessages(),t.overrideGoldAndSilver(n.oldGold,n.oldSilver,n.newGold,n.newSilver),t.enableElement(e),i.each((function(){t.enableElement(jQuery(this))})),"SilverToGold"===t.options.exchangeOptions.directionType?t.options.exchangeOptions.maxAmount=n.newSilver:t.options.exchangeOptions.maxAmount=n.newGold,"function"==t.options.maxAmountChangedFunction&&t.options.maxAmountChangedFunction.call(this,{oldGold:n.oldGold,oldSilver:n.oldSilver,newGold:n.newGold,newSilver:n.newSilver}),jQuery(document).trigger("TG:changeMaxGoldToSilverAmounts",{oldGold:n.oldGold,oldSilver:n.oldSilver,newGold:n.newGold,newSilver:n.newSilver}),t.updateExchangeValue(jQuery("#silverExchange .exchangeType"+t.options.exchangeOptions.directionType+" input").val()),t.showMessage(n.message))}.bind(t),o,a)}}}),this},this.setMaxAmounts=function(e){return"SilverToGold"===this.options.exchangeOptions.directionType?this.options.exchangeOptions.maxAmount=e.newSilver:this.options.exchangeOptions.maxAmount=e.newGold,this},this.disableElement=function(e){return e.addClass("disabled"),this},this.enableElement=function(e){return e.removeClass("disabled"),this},this.isButtonInactive=function(e){return e.hasClass("disabled")},this.overrideGoldAndSilver=function(e,t,i,n){if(void 0===i&&void 0===n)return this;var a,o,r=function(r,s){s=jQuery(s),"gold"===this.type?(a=parseInt(e),o=parseInt(i)):(a=parseInt(t),o=parseInt(n));var l=s.html();l=new Travian.Formatter({forceDecimal:!1}).removeNonDigits(l);var d=a-l;s.html(o+d)};return jQuery(".ajaxReplaceableSilverAmountDiff").each(jQuery.proxy(r,{type:"silver"})),jQuery(".ajaxReplaceableGoldAmountDiff").each(jQuery.proxy(r,{type:"gold"})),jQuery(".ajaxReplaceableSilverAmount").each((function(e,t){jQuery(t).html(Travian.i18n.Number(n,{grouping:!0}))})),jQuery(".ajaxReplaceableGoldAmount").each((function(e,t){jQuery(t).html(Travian.i18n.Number(i,{grouping:!0}))})),this},this.setLastUseTimestamp=function(){window.lastTimestampUseSilverExchange=(new Date).getTime()},this.initialize()},Travian.Game.Hero.Properties={},Travian.Game.Hero.Properties.PropertyForm=function(){this.unloadIdentifier=null,this.onDirty=function(e){var t=this.elements.saveHeroAttributes.getInput(),i=jQuery(".heroAttributesFormMessage");return e?(i.removeClass("hide"),t.removeClass("disabled")[0].disabled=!1,this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier)):(i.addClass("hide"),t.addClass("disabled")[0].disabled=!0,Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier)),this},this.onClick=function(e){switch(e.getName()){case"saveHeroAttributes":this.saveHeroAttributes();break;default:return}return this},this.saveHeroAttributes=function(){var e={resource:this.elements.resource.getValue(),attackBehaviour:this.elements.attackBehaviour.getValue()};void 0!==this.elements.properties&&(e.attributes=this.elements.properties.getPropertyValues()),Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier),Travian.api("hero/attributes",{data:e})},Travian.Form.call(this)},Travian.Game.Hero.Properties.PropertyForm.prototype=Object.create(Travian.Form.prototype),Travian.Game.Hero.Properties.PropertyForm.constructor=Travian.Game.Hero.Properties.PropertyForm,Travian.Game.Hero.PropertySetter=function(e,t){this.options=Object.assign({availablePoints:0,element:null,selectorBtnMinus:".pointsValueSetter.sub a",selectorBtnPlus:".pointsValueSetter.add a",elementAvailablePoints:""},t),this.getAvailablePoints=function(){return this.options.availablePoints-this.getSettedPoints()},this.getPropertyValues=function(){var e={};return jQuery.each(this.options.attributes,(function(t,i){e[i.getId()]=i.getSettedPoints()})),e},this.isDirty=function(){return this.getSettedPoints()>0},this.initialize=function(e){var t=this;Travian.Form.Element.call(this,e),jQuery.each(this.options.attributes,(function(e,i){i.setPropertySetter(t)})),this.options.element=jQuery("#"+this.options.element),this.options.elementAvailablePoints=jQuery("#"+this.options.elementAvailablePoints),this.update()},this.getSettedPoints=function(){var e=0;return jQuery.each(this.options.attributes,(function(t,i){e+=i.getSettedPoints()})),e},this.update=function(){jQuery.each(this.options.attributes,(function(e,t){t.updateButtons()}));var e=this.getAvailablePoints()+"/"+this.options.availablePoints;return this.options.elementAvailablePoints.html(e),this.onChange(),this},this.initialize(e)},Travian.Game.Hero.PropertySetter.prototype=Object.create(Travian.Form.Element.prototype),Travian.Game.Hero.PropertySetter.constructor=Travian.Game.Hero.PropertySetter,Travian.Game.Hero.PropertySetter.Attribute=function(e){this.options=Object.assign({id:null,element:null,value:null,usedPoints:null,maxPoints:null,elementBtnMinus:".pointsValueSetter.sub a",elementBtnPlus:".pointsValueSetter.add a",elementInput:".points input",elementProgressBar:".progress .bar.setted",elementValue:".current .value"},e),this.propertySetter=null,this.settedPoints=0,this.getId=function(){return this.options.id},this.getMaxPoints=function(){return this.options.maxPoints},this.getPropertySetter=function(){if(null===this.propertySetter)throw"missing propertySetter in Travian.Game.Hero.PropertySetter.Attribute";return this.propertySetter},this.getSettedPoints=function(){return this.settedPoints},this.getTotalPoints=function(){return this.settedPoints+this.options.usedPoints},this.initialize=function(){var e=this;this.options.element=jQuery("#"+this.options.element),this.options.elementBtnMinus=this.options.element.find(this.options.elementBtnMinus),this.options.elementBtnPlus=this.options.element.find(this.options.elementBtnPlus),this.options.elementInput=this.options.element.find(this.options.elementInput),this.options.elementProgressBar=this.options.element.find(this.options.elementProgressBar),this.options.elementValue=this.options.element.find(this.options.elementValue);var t=null,i=!1,n=function(t,n){return n.preventDefault(),!1===i&&e[t+"Point"](),i=!1,!1},a=function(e){return e.preventDefault(),t&&clearInterval(t),jQuery(e.target).removeClass("click"),!1},o=function(n,o){o.preventDefault(),t&&clearInterval(t),i=!0,jQuery(o.target).addClass("click");var r=jQuery(document.body);return r.off("mouseup",a),r.on("mouseup",a),e[n+"Point"](),t=setInterval(e[n+"Point"].bind(e),200),!1},r=function(i){var n=null,a=i.originalEvent.wheelDelta>0?1:-1;return i.preventDefault(),t&&clearInterval(t),e.setSettedPoints(e.getSettedPoints()+a),a>0?(n=e.options.elementBtnPlus,e.options.elementBtnMinus.removeClass("click")):(n=e.options.elementBtnMinus,e.options.elementBtnPlus.removeClass("click")),n.addClass("click"),t=setTimeout((function(){n.removeClass("click")}),100),!1};this.options.elementBtnMinus.on({click:jQuery.proxy(n,this,"sub"),mousedown:jQuery.proxy(o,this,"sub"),mousewheel:r}),this.options.elementBtnPlus.on({click:jQuery.proxy(n,this,"add"),mousedown:jQuery.proxy(o,this,"add"),mousewheel:r}),this.options.elementInput.on({change:function(t){var i=parseInt(e.options.elementInput.val());isNaN(i)&&(i=e.getTotalPoints()),e.setSettedPoints(i-e.options.usedPoints)},mousewheel:r})},this.setPropertySetter=function(e){return this.propertySetter=e,this},this.setSettedPoints=function(e){e=parseInt(e),isNaN(e)&&(e=this.settedPoints),e<0&&(e=0),e>this.getMaxPoints()-this.options.usedPoints&&(e=this.getMaxPoints()-this.options.usedPoints);var t=this.getPropertySetter().getAvailablePoints();return this.settedPoints<e&&t<e-this.settedPoints&&(e=this.settedPoints+t),this.settedPoints=e,this.update()},this.addPoint=function(e){return null!=e&&""!==e||(e=1),e<0&&(e=0),this.setSettedPoints(this.getSettedPoints()+e)},this.subPoint=function(e){return null!=e&&""!==e||(e=1),e<0&&(e=0),this.setSettedPoints(this.getSettedPoints()-e)},this.updateButtons=function(){return this.options.elementBtnPlus.toggleClass("disabled",this.getTotalPoints()>=this.getMaxPoints()||0===this.getPropertySetter().getAvailablePoints()),this.options.elementBtnMinus.toggleClass("disabled",0===this.getSettedPoints()),this},this.initialize()},Travian.Game.Hero.PropertySetter.Attribute.prototype.calculateValue=function(){return 0},Travian.Game.Hero.PropertySetter.Attribute.prototype.update=function(){return this.options.elementValue.html(this.calculateValue()),this.options.elementInput.val(this.options.usedPoints+this.getSettedPoints()),this.options.elementProgressBar.css("width",Math.max(0,Math.min(100,Math.round(100/Math.min(this.getMaxPoints()+4,100)*this.getSettedPoints())))+"%"),this.getPropertySetter().update(),this},Travian.Game.Hero.PropertySetter.Attribute.Power=function(e){this.options=Object.assign({valueOfItems:0,valueBonus:0},e),this.calculateValue=function(){return 100+this.getTotalPoints()*this.options.valueBonus+this.options.valueOfItems},Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options)},Travian.Game.Hero.PropertySetter.Attribute.Power.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.Power.constructor=Travian.Game.Hero.PropertySetter.Attribute.Power,Travian.Game.Hero.PropertySetter.Attribute.OffBonus=function(e){this.calculateValue=function(){return Math.round(.2*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,e)},Travian.Game.Hero.PropertySetter.Attribute.OffBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.OffBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.OffBonus,Travian.Game.Hero.PropertySetter.Attribute.DefBonus=function(e){this.calculateValue=function(){return Math.round(.2*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,e)},Travian.Game.Hero.PropertySetter.Attribute.DefBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.DefBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.DefBonus,Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints=function(e){this.calculateValue=function(){return this.getTotalPoints()},this.options=Object.assign({pointWorth:[6,20,20,20,20]},e),this.elementResources=[],this.getPossibleBonusProductionForResource=function(e){return 0===e?this.calculateValue()*this.options.pointWorth[0]*Travian.Game.speed:e<=4?this.calculateValue()*this.options.pointWorth[e]*Travian.Game.speed:0},this.initialize=function(){Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options);var e=this,t=jQuery("#setResource");t.length>0&&t.find("div.resource label:not(.baseCrop) span.current").each((function(t){e.elementResources[t]=this}))},this.update=function(){var e=this;return jQuery.each(this.elementResources,(function(t,i){var n=jQuery(i);n.length>0&&n.html(e.getPossibleBonusProductionForResource(t))})),Travian.Game.Hero.PropertySetter.Attribute.prototype.update.call(this)},this.initialize()},Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.constructor=Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints,Travian.Game.Hero.PropertySetter.Attribute.RegenBonus=function(e){this.calculateValue=function(){return Math.round(.5*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,e)},Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.RegenBonus,Travian.Game.ActivationWithSectors=function(){this.arrowShapes={tribe1:"",tribe2:"",tribe3:"",tribe4:"",tribe5:""},this.basicShape="M10 10 V230 H[ARROW_POSITION] l20 20 l20 -20 H530 V10 Z",this.initialize=function(){var e=this;e.createArrowShapes(),e.updateArrowPositions(),e.bindEvents()},this.bindEvents=function(){var e=this;jQuery("#tribeSelectors").find('input[name="vid"]').on("change",(function(){e.updateArrowPositions()}))},this.createArrowShapes=function(){for(var e,t=jQuery("#tribeSelectors"),i=t.find("label").outerWidth(!0),n=t.find('input[name="vid"]').length,a=(t.width()-n*i)/2,o=0;o<n;o++)e=a+o*i+i/3.3333,this.arrowShapes["tribe"+(o+1)]=this.basicShape.replace("[ARROW_POSITION]",e)},this.updateArrowPositions=function(){var e=jQuery("#tribeSelectors").find('input[name="vid"]');jQuery("body.rtl").length>0&&(e=e.toArray().reverse());for(var t=0;t<e.length;t++)!0===e[t].checked&&TweenLite.to(jQuery("#presentation svg .inner, #presentation svg .outer"),.25,{morphSVG:this.arrowShapes["tribe"+(t+1)]})},this.initialize()},Travian.Game.ActivationWithFactions=function(e,t){this.factionsTribesMapping={},this.sortedTribes=[],this.activationWrapper=null,this.dynamicTitles=null,this.initialize=function(){var i=this;i.activationWrapper=jQuery(".activateWithFactions"),i.dynamicTitles=jQuery(".dynamicTitles"),i.factionsTribesMapping=e,i.sortedTribes=t,i.bindEvents(),i.updateSelection()},this.bindEvents=function(){var e=this;e.activationWrapper.find(".buttonWrapper.selectTribe button").on("click",(function(t){if(t.preventDefault(),jQuery(this).hasClass("update"))e.changeStep("confirm");else{for(var i,n=e.activationWrapper.find("form:visible"),a=parseInt(n.find("input[name=vid]:checked").val()),o=0;o<e.sortedTribes.length;o++){var r=e.sortedTribes[o];if(r!==a&&e.factionsTribesMapping.hasOwnProperty(r)){i=e.factionsTribesMapping[r];break}}void 0!==i&&n.find('input[value="'+i+'"][name="faction"]').attr("checked","checked"),e.changeStep("selectFaction")}})),e.activationWrapper.find(".buttonWrapper.selectFaction button").on("click",(function(t){t.preventDefault(),e.changeStep("confirm")})),e.activationWrapper.find("a.change.backToFaction").on("click",(function(t){t.preventDefault(),e.changeStep("selectFaction",!0)})),e.activationWrapper.find("a.change.backToTribe").on("click",(function(t){t.preventDefault(),e.changeStep("selectTribe",!0)})),e.activationWrapper.find("input[name=vid]").on("change",(function(){e.updateSelection()})),e.activationWrapper.find("input[name=faction]").on("change",(function(){e.updateSelection()}))},this.changeStep=function(e,t){var i=this,n=["selectTribe","selectFaction","confirm"];t=void 0!==t&&t,-1!==n.indexOf(e)&&(t&&i.activationWrapper.addClass("isEditing"),jQuery(n).each((function(e,t){i.activationWrapper.removeClass(t)})),i.dynamicTitles.find(".active").removeClass("active"),i.activationWrapper.addClass(e),i.dynamicTitles.find("."+e).addClass("active"))},this.updateSelection=function(){var e=this.activationWrapper.find("form:visible"),t=e.find("input[name=vid]:checked").val(),i=e.find("input[name=faction]:checked").val().toLowerCase();e.find(".selection.confirm .confirmTribe").removeClass("selected"),e.find(".selection.confirm .confirmTribe.tribe"+t).addClass("selected"),e.find(".selection.confirm .confirmFaction").removeClass("selected"),e.find(".selection.confirm .confirmFaction."+i).addClass("selected")},this.initialize()},Travian.AdventureList=function(){this.openDurationsCalulator=function(){var e=jQuery("#durationCalculations");e.toggleClass("hide"),e.hasClass("hide")||this.calculateDurations()},this.calculateDurations=function(){var e=jQuery("#adventureListForm"),t=jQuery("#changeVillage").val();Travian.api("adventure/calculate-duration",{data:{adventureKids:jQuery.map(e.find("input[name*=adventureKid]"),(function(e){return e.value})),currentKidAndDid:t,originalWalkTimes:jQuery.map(e.find("input[name*=adventureWalktimeOriginalVillage]"),(function(e){return e.value}))},success:function(e){if(!1===e.noAdventures)for(var t in e.responseArray)e.responseArray.hasOwnProperty(t)&&jQuery("#"+t).html(e.responseArray[t])}})}},Travian.Game.BuildingUpgradeView={initialize:function(){jQuery("#build .buildingDescription .headline .openedClosedSwitch").on("click",(function(){var e=jQuery(this),t=jQuery("#build .buildingDescription");t.hasClass("collapsed")?(t.removeClass("collapsed"),e.removeClass("switchClosed"),e.addClass("switchOpened"),Travian.Game.Preferences.set("buildingDescriptionCollapsed",!1)):(t.addClass("collapsed"),e.addClass("switchClosed"),e.removeClass("switchOpened"),Travian.Game.Preferences.set("buildingDescriptionCollapsed",!0))}))}},Travian.Game.TrainingTroops={did:null,favouriteTroops:[],trainTroopsContainer:null,favouriteTroopsContainer:null,nonFavouriteTroopsContainer:null,isAnimating:!1,initialize:function(){var e=this;e.trainTroopsContainer=jQuery(".trainUnits"),e.favouriteTroopsContainer=jQuery("#favouriteTroops"),e.nonFavouriteTroopsContainer=jQuery("#nonFavouriteTroops"),e.did=parseInt(e.trainTroopsContainer.find("input[name=did]").val()),e.loadFavouriteTroops(),e.trainTroopsContainer.find(".troop button.favourite").on("click",(function(){if(!e.isAnimating){e.isAnimating=!0;var t=jQuery(this);t.attr("disabled","disabled");var i=parseInt(t.attr("data-troopID"));t.hasClass("faved")?(e.removeFromFavourites(i),t.removeClass("faved")):(e.addToFavourites(i),t.addClass("faved"))}}))},loadFavouriteTroops:function(){var e=Travian.Game.Preferences.get("favouriteTroopsInVillage"+this.did);null!==e&&(this.favouriteTroops=e.split(","))},saveFavouriteTroops:function(){Travian.Game.Preferences.set("favouriteTroopsInVillage"+this.did,this.favouriteTroops.join(","))},addToFavourites:function(e){this.favouriteTroops.push(""+e),this.favouriteTroops.sort(),this.trainTroopsContainer.find(".innerTroopWrapper.troop"+e).addClass("favourite"),this.orderTroopSection(e),this.saveFavouriteTroops()},removeFromFavourites:function(e){var t=this.favouriteTroops.indexOf(""+e);-1!==t&&this.favouriteTroops.splice(t,1),this.favouriteTroops.sort(),this.trainTroopsContainer.find(".innerTroopWrapper.troop"+e).removeClass("favourite"),this.orderTroopSection(e),this.saveFavouriteTroops()},orderTroopSection:function(e){var t,i=this,n=i.favouriteTroopsContainer.find(".action.troop"+e),a=i.nonFavouriteTroopsContainer.find(".action.troop"+e),o=n.offset(),r=a.offset(),s=i.trainTroopsContainer.find(".innerTroopWrapper.troop"+e),l=s.offset(),d=s.find("button.favourite"),u=s.parent().height();s.hasClass("favourite")?(t=Math.round(l.top-o.top+u))>u?(s.addClass("moving"),n.removeClass("empty"),a.addClass("empty"),s.animate({top:-1*t},1e3),setTimeout((function(){s.detach(),s.appendTo(n),s.animate({top:0},0),setTimeout((function(){s.removeClass("moving"),d.attr("disabled",!1),i.isAnimating=!1}),50)}),1e3)):(n.addClass("noAnimation").removeClass("empty"),a.addClass("noAnimation").addClass("empty"),s.detach(),s.appendTo(n),setTimeout((function(){n.removeClass("noAnimation"),a.removeClass("noAnimation"),d.attr("disabled",!1),i.isAnimating=!1}),50)):-1*(t=Math.round(l.top-r.top+u))>=u?(s.addClass("moving"),a.removeClass("empty"),n.addClass("empty"),s.animate({top:-1*t},1e3),setTimeout((function(){s.detach(),s.appendTo(a),s.animate({top:0},0),setTimeout((function(){s.removeClass("moving"),d.attr("disabled",!1),i.isAnimating=!1}),50)}),1e3)):(a.addClass("noAnimation").removeClass("empty"),n.addClass("noAnimation").addClass("empty"),s.detach(),s.appendTo(a),setTimeout((function(){a.removeClass("noAnimation"),n.removeClass("noAnimation"),d.attr("disabled",!1),i.isAnimating=!1}),50))}},Travian.Game.Marketplace=function(e){this.merchantsAvailable=0,this.capacityPerMerchant=0,this.merchantCapacity=0,this.merchantsMax=0,this.initialize=function(e){this.merchantsAvailable=Math.max(e.merchantsAvailable,0),this.capacityPerMerchant=e.capacityPerMerchant,this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant,this.autoCompleter=e.autoCompleter,this.merchantsMax=e.merchantsMax,this.updateAutoCompleter(),this.shortcutListener()},this.refresh=function(e){this.merchantsAvailable=Math.max(e,0),this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant,jQuery("#merchantCapacityValue").html(this.merchantCapacity),jQuery(".merchantsAvailable").html(this.merchantsAvailable),this.visualizeMerchantCapacity()},this.enableAllLinks=function(){var e;for(e=1;e<=4;e++)linkToUpdate=jQuery("#addRessourcesLink"+e),linkToUpdate.removeClass("notClickable"),linkToUpdate[0].disabled=!1},this.enableAllInputFields=function(){var e=0;for(e=1;e<5;e++)jQuery("#r"+e).removeClass("disabled"),jQuery("#r"+e)[0].readOnly=0},this.disableAllLinks=function(){var e;for(e=1;e<=4;e++)linkToUpdate=jQuery("#addRessourcesLink"+e),linkToUpdate.addClass("notClickable"),linkToUpdate[0].disabled=!0},this.disableAllInputFields=function(){var e=0;for(e=1;e<5;e++)jQuery("#r"+e).addClass("disabled"),jQuery("#r"+e)[0].readOnly=1},this.shortcutListener=function(){jQuery((function(){Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(e,t,i,n,a){jQuery("#xCoordInput").val(t),jQuery("#yCoordInput").val(i),jQuery("#trade_route_destination").val(n),jQuery("#enterVillageName").val(a)}))}))},this.setNotice=function(e){if(e.notice&&e.formular){jQuery("#note").html(e.notice),jQuery(".destination").html(e.formular),this.enableAllLinks(),this.enableAllInputFields();var t=1;for(t=1;t<5;t++)jQuery("#r"+t).val("");e.button&&jQuery("#button").html(e.button),jQuery(".run_dropdown").removeClass("hide")}},this.setError=function(e){e.errorMessage&&(jQuery("#prepareError").html(e.errorMessage),jQuery("#note").html(""))},this.sendRessources=function(){var e=this;Travian.api("marketplace/prepare",{data:{t:jQuery("#t").val(),id:jQuery("#id").val(),a:jQuery("#a").val(),sz:jQuery("#sz").val(),kid:jQuery("#kid").val(),c:jQuery("#c").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val()},success:function(t){t.errorMessage?e.setError(t):t.notice&&(jQuery(".run_dropdown").removeClass("hide"),jQuery("div .destination").html(t.formular),e.setNotice(t),e.reloadMarketPlace(),Travian.Game.Layout.updateResources(),e.updateAutoCompleter())}})},this.prepare=function(){var e=this,t=1;if(jQuery("#x2").length){var i=jQuery("#x2").first();t="checkbox"==i.attr("type")?i[0].checked?2:1:i.val()}Travian.api("marketplace/prepare",{data:{r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val(),dname:jQuery("#enterVillageName").val(),x:jQuery("#xCoordInput").val(),y:jQuery("#yCoordInput").val(),id:jQuery("#id").val(),t:jQuery("#t").val(),x2:t},success:function(t){return t.errorMessage?e.setError(t):t.formular&&(e.disableAllLinks(),e.disableAllInputFields(),jQuery(".destination").html(t.formular),jQuery(".run_dropdown").addClass("hide"),jQuery("#prepareError").html(""),jQuery("#note").html(""),jQuery("#r1").focus()),t.button&&jQuery("#button").html('<div id="prepareError" class="error">'+jQuery("#prepareError").html()+"</div>"+t.button+'<div class="clear"></div>'),!1}})},this.goBack=function(){var e=this;this.enableAllLinks(),this.enableAllInputFields(),Travian.api("marketplace/back",{data:{kid:jQuery("#kid").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,dname:jQuery("#dname")?jQuery("#dname").val():""},success:function(t){jQuery(".destination").html(t.formular),jQuery("#button").html('<div id="prepareError" class="error"></div>'+t.button+'<div class="clear"></div>'),jQuery(".run_dropdown").removeClass("hide"),e.updateAutoCompleter()}})},this.reloadMarketPlace=function(){var e=this;Travian.api("marketplace/reload",{data:{},success:function(t){jQuery("#merchantsOnTheWayFormular").html(t.merchantsOnTheWay),Travian.Game.Layout.updateResources(t.storage),e.refresh(t.merchantsAvailable)}})},this.visualizeMerchantCapacity=function(){this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant;var e=this.summarizeInput();this.setSelectedRessourcesInfo(e),this.setNotEnoughMerchantsError(e),this.updateLinks()},this.validateAndVisualizeMerchantCapacity=function(e){this.validateResources(e),this.visualizeMerchantCapacity()},this.validateResources=function(e){var t=this.getValue(e),i=t+this.clipToStorageMaximum(e,t),n=t;t>i&&(n=i),this.setValue(e,n)},this.validateTradeRouteResources=function(e){var t=Math.max(0,this.getValue(e));this.setValue(e,t);var i=this.summarizeInput(),n=this.merchantsMax*this.capacityPerMerchant,a={},o=jQuery("#tradeSaveButton"),r=jQuery("#tradeRouteError");i>n?(a={MERCHANTS_NEEDED:Math.ceil(i/this.capacityPerMerchant),MERCHANTS_AVAILABLE:this.merchantsMax},r.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),a,/\\?\[([^\[\]]+)\]/g)),o.addClass("disabled").attr("disabled",!0)):(r.removeClass("error").html(""),o.removeClass("disabled").attr("disabled",!1))},this.validateTradeRouteResourcesSanity=function(){for(var e=1;e<=4;e++){var t=Math.max(0,this.getValue(e));this.setValue(e,t)}return 0!=this.summarizeInput()||(jQuery("#tradeRouteError").addClass("error").html(Travian.Translation.translate("{resourcesNumberInvalid}")),!1)},this.validateTradeRouteSendTime=function(){var e=jQuery("#tradeSaveButton"),t=jQuery("#tradeRouteError");return this.validateTradeRouteSendTimeSanity()?(t.removeClass("error").html(""),e.removeClass("disabled").attr("disabled",!1),!0):(t.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}")),e.addClass("disabled").attr("disabled",!0),!1)},this.validateTradeRouteSendTimeSanity=function(){var e=jQuery("#tradeRouteEdit").find(".timeSelector"),t=jQuery("#tradeRouteError"),i=e.find("input[name=hour]"),n=e.find("input[name=minute]");i=i.val(),n=n.val();var a=jQuery.isNumeric(i)&&i>=0&&i<=23&&(""===n||jQuery.isNumeric(n)&&n>=0&&n<=59);return!a&&t.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}")),a},this.furtherMerchantsAvailable=function(){return this.merchantCapacity-this.summarizeInput()>=0},this.updateLinks=function(){var e;for(e=1;e<=4;e++)jQuery("#addRessourcesLink"+e).toggleClass("notClickable",0==this.getValueToAddToRessources(e))},this.addRessources=function(e){if(!jQuery("#addRessourcesLink"+e)[0].disabled){var t=this.getValueToAddToRessources(e),i=this.getValue(e);0!=t&&this.setValue(e,t+i),this.visualizeMerchantCapacity()}},this.getValueToAddToRessources=function(e){var t=0,i=this.summarizeInput(),n=this.merchantCapacity-i;return n>0?n<this.capacityPerMerchant?t=n:n>=this.capacityPerMerchant&&(t=this.capacityPerMerchant):t=0==n?0:n,t=this.clipToStorageMaximum(e,t)},this.clipToStorageMaximum=function(e,t){var i=this.getStorageFor(e),n=this.getValue(e);return t>0?t=Math.min(t,i-n):n+t>i&&(t=i-n),t},this.getStorageFor=function(e){var t="l"+e;return window.resources.storage[t]},this.setValue=function(e,t){var i=parseInt(t);isNaN(i)||jQuery("#r"+e).val(Math.max(i,0))},this.setSelectedRessourcesInfo=function(e){jQuery("#sumResources").toggleClass("notEnoughMerchants",e>this.merchantCapacity).html(e)},this.setNotEnoughMerchantsError=function(e){var t={},i=this.getNeededMerchants(e),n=jQuery("#prepareError"),a=null;if(jQuery("#merchantsNeededNumber").html(i),jQuery(".prepare").length>0&&(a=jQuery(".prepare").first()),i>this.merchantsAvailable)t={MERCHANTS_NEEDED:i,MERCHANTS_AVAILABLE:this.merchantsAvailable},n.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),t,/\\?\[([^\[\]]+)\]/g)),a.addClass("disabled").attr("disabled",!0),jQuery("#note").html(""),jQuery("#merchantsNeeded").addClass("error"),jQuery(".merchantCapacity").addClass("error"),jQuery("#sumResources").addClass("error");else{if(jQuery("#merchantsNeeded").removeClass("error"),jQuery(".merchantCapacity").removeClass("error"),jQuery("#sumResources").removeClass("error"),n.length>0)n.html("");else{var o=jQuery("#button").html();jQuery("#button").html('<div id="prepareError" class="error"></div>'+o+'<div class="clear"></div>')}a.removeClass("disabled").attr("disabled",!1)}},this.getNeededMerchants=function(e){return Math.ceil(e/this.capacityPerMerchant)},this.getValue=function(e){var t=parseInt(jQuery("#r"+e).val());return isNaN(t)?0:t},this.summarizeInput=function(){for(var e=0,t=1;t<=4;t++)e+=this.getValue(t);return e},this.updateAutoCompleter=function(){var e=jQuery("#enterVillageName");return this.autoCompleter&&e.length>0&&Travian.Game.AutoCompleter.VillageName(e),this},this.initialize(e)},Travian.Game.Marketplace.getPreferences=function(){var e,t,i=Travian.Game.Preferences.get("tradeRoutesOrder");return null!=i?(e=i.charAt(0),t=i.charAt(1)):(e="2",t="a"),{sortingColumn:e,sortingOrder:t}},Travian.Game.Marketplace.toggleSorting=function(e){var t,i=Travian.Game.Marketplace.getPreferences();t=e==i.sortingColumn?i.sortingColumn+("a"==i.sortingOrder?"d":"a"):e+"a",Travian.Game.Preferences.set("tradeRoutesOrder",t)},Travian.Game.Marketplace.toggleTradeRoutes=function(e,t){var i=t.checked?1:0;return Travian.api("trade-route/toggle",{data:{routeId:e,enabled:i}}),!1},Travian.Game.Marketplace.updateVillageListLinks=function(e){var t=["dname","x","y"],i=jQuery(e).serializeArray().reduce((function(e,t){return e[t.name]=encodeURIComponent(t.value),e}),{});jQuery("#sidebarBoxVillagelist").find("li").each((function(e,n){for(var a=jQuery(n).find("a"),o=Travian.parseURL(a.attr("href")),r=0;r<t.length;r++)void 0!==i[t[r]]&&(o.searchObject[t[r]]=i[t[r]]);a.attr("href",Travian.composeURL(o))}))},Travian.Game.Marketplace.onLoad=function(){var e=Travian.Game.Marketplace.getPreferences();jQuery("a.sorting#sorting"+e.sortingColumn).addClass("a"==e.sortingOrder?"asc":"desc")},Travian.Game.Marketplace.constructor=Travian.Game.Marketplace,Travian.Game.Marketplace.ExchangeResources=function(e){var t=e;this.calculateRest=function(){var e=t.find('span[id^="org"]'),i=t.find("span#sum").html(),n=t.find('input[name^="desired"]'),a=t.find('span[id^="diff"]'),o=0;n.each((function(t,i){var n=parseInt(i.value||0),r=n-parseInt(e[t].innerHTML);a[t].innerHTML=r>0?"+"+r:r,o+=n})),jQuery("#newsum").text(o),jQuery("#remain").text(i-o),this.testSum()},this.fillup=function(e){jQuery('input[name="desired'+e+'"]').val(resources.maxStorage["l"+(e+1)]||0),this.calculateRest()},this.testSum=function(){"0"!==document.getElementById("remain").innerHTML?(document.getElementById("submitText").style.display="block",document.getElementById("submitButton").style.display="none"):(document.getElementById("submitText").style.display="none",document.getElementById("submitButton").style.display="block"),Travian.adjustButtonDisableState()},this.distribute=function(e){var i=[],n=t.find('span[id^="org"]'),a=t.find('input[name^="desired"]'),o=t.find("span#sum");a.each((function(e,t){i[e]=t.value}));var r=this;return Travian.api("marketplace/exchange-resources",{data:{did:e,desired:i},success:function(e){a.each((function(t,i){n[t].innerHTML=e.resources[t],i.value=e.distributed[t]})),o.html(e.resources.reduce((function(e,t){return e+t}),0)),r.calculateRest()},error:function(e){(new Travian.Dialog.Dialog).setContent(e.message).show()}}),!1},this.calculateRest()},Travian.Game.RallyPoint={initialize:function(e){e.find("input[type=text]").each((function(e,t){(t=jQuery(t)).on({keydown:function(e){const t=e.keyCode,i=e.ctrlKey,n=e.metaKey;if(8===t||46===t||65===t&&(!0===i||!0===n)||67===t&&(!0===i||!0===n)||88===t&&(!0===i||!0===n)||86===t&&(!0===i||!0===n)||t>=35&&t<=39||9===t||13===t)return!0;t>=48&&t<=57||t>=96&&t<=105||e.preventDefault()},input:function(e){let i=parseInt(t.val().replace(/^0+/,""))||0;(isNaN(i)||0===i||i<0)&&(i=""),t.val(i)}})})),Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(e,t,i,n,a){jQuery("#xCoordInput").val(t),jQuery("#yCoordInput").val(i),jQuery("#enterVillageName").val(a)}))},updateTravelTime:function(e){const t=jQuery(e).closest("form"),i=t.find("div#in");if(0===i.length)return;const n=t.find('input[name="from"]').val(),a=t.find('input[name="to"]').val();let o={};t.find("td.unit input").each((function(e,t){o["t"+t.name.replace(/[t\[\]]/g,"")]=parseInt(t.value)||0})),Travian.api("troop/"+n+"/distanceSpeedAndDuration",{data:{to:a,troops:o},success:function(e){const n=e.data;i.html(n.durationString);const a=t.find("span#at"),o=(new Date).getTime()/1e3%86400-n.offset+n.duration;Travian.TimersAndCounters.updateTimer(a.get(0),Math.round(o))}})}},Travian.AttackSymbol={markAttackSymbol:function(e){var t=jQuery("img#markSymbol_"+e),i=t.prop("class"),n=parseInt(i.replace(/[^0-9]/gi,""))||0;n=(n+1)%4,t.removeClass().addClass("markAttack markAttack"+n),Travian.api("troop/mark-attack",{data:{data:{id:e,state:n}}})}},Travian.Game.RallyPoint.CoordinatesInputHelper=function(e){this.options=Object.assign({coordinateXInputId:"xCoordInput",coordinateYInputId:"yCoordInput",allowedPattern:/^([0-9\-.,]+)([|/])([0-9\-.,]+)$/},e)},Travian.Game.RallyPoint.CoordinatesInputHelper.prototype.insertCoordinates=function(e){let t;t=void 0!==e.clipboardData?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text"),t=t.replace(/[\u202D\u202C\u202E]/g,"").replace(/â/g,"-").replace(/[^0-9\-|/]/g,"");let i=t.match(this.options.allowedPattern);e.preventDefault(),null!==i?(jQuery("#"+this.options.coordinateXInputId).val(i[1]),jQuery("#"+this.options.coordinateYInputId).val(i[3]).focus()):jQuery(e.target).val(t.replace(/[^0-9\-]/g,""))},Travian.Game.AllianceMembers=function(e){this.options=Object.assign({data:{}},e),this.initialize=function(){Travian.Dialog.Ajax.call(this,"alliance/player-note",this.options)},this.request=function(){var e=this;return Travian.api("alliance/player-note",{data:this.options.data,success:function(t){t.close||""===t.html?(e.close(),Travian.WindowManager.closeAllWindows(),Travian.autoreload()):(e.setContent(t.html).setTitle(t.title).setInfoIcon(t.infoIcon).updateCssClass(t.cssClass),e.show())},error:function(e,t){jQuery("#playerNotePopupError").innerHTML=t}}),this},this.reload=function(){this.request()},this.initialize()},Travian.Game.AllianceMembers.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.AllianceMembers.constructor=Travian.Game.AllianceMembers,Travian.Game.AllianceDonation={dialog:null,bonusSelected:!1,getDonationParams:function(e){return this.calculateSum(e),{bid:jQuery("#bid").val(),did:jQuery("#did").val(),r1:jQuery("#"+e+"1").val(),r2:jQuery("#"+e+"2").val(),r3:jQuery("#"+e+"3").val(),r4:jQuery("#"+e+"4").val(),amount:this.toNaturalNumber(jQuery("#"+e+"Sum").html())}},wasGoldUsed:function(e){return-1!==["donate_gold","donate_gold_confirm"].indexOf(e)},calculateSum:function(e){for(var t=0,i=1;i<=4;i++)t+=this.toNaturalNumber(jQuery("#"+e+i).val());jQuery("#"+e+"Sum").html(t.toString()),this.checkAndChangeScalingPopup(e,t),this.checkButtonState(e)},updateBID:function(e){jQuery("#bid").val(e)},checkButtonState:function(e){for(var t=0!=jQuery("#"+e+"Sum").html(),i=!1,n=document.getElementsByName("bonus"),a=0;a<n.length;a++)if(n[a].checked){i=!0,jQuery("#bonusNotSelectedMessage").hide(),this.updateBID(jQuery(n[a]).val());break}var o=1==jQuery("#limitReached").val(),r=t&&i&&!o;if(i||this.updateBID(null),this.bonusSelected=i,1==jQuery("#gold").val()){var s=0!=jQuery("#canTriple").val();r&&s?jQuery("#donate_gold").removeClass("disabled"):jQuery("#donate_gold").addClass("disabled")}r?jQuery("#donate_green").removeClass("disabled"):jQuery("#donate_green").addClass("disabled")},fillUp:function(e,t,i){!0!==e.disabled&&(t=Math.max(t,0),jQuery(e).val(t),this.checkAndChange(e,t,i))},checkAndChange:function(e,t,i){e=jQuery(e);var n=Math.min(this.toNaturalNumber(e.val()),t);e.val()!==n.toString()&&e.val(n),this.calculateSum(i)},toNaturalNumber:function(e){return e=parseInt(e),isNaN(e)&&(e=0),e<0&&(e=0),e},donate:function(e,t,i){var n=jQuery("#donate_gold_confirm");if("donate_gold"!==t&&(jQuery("#contributeButtons").find("button").addClass("disabled"),n.length>0)){if(n.hasClass("disabled"))return;n.off("click").addClass("disabled")}jQuery(".bonus-donation-response").removeClass("visible"),Travian.api("alliance/bonus-donation",{data:{params:i,action:t},success:function(e){""!==e.html?Travian.Game.AllianceDonation.showDialog(e.html):Travian.Game.AllianceDonation.closeDialog();var n=Travian.Game.AllianceDonation.wasGoldUsed(t),a=Travian.Game.AllianceDonation.getResourceAnimationSpeed(i.amount,n);e.newTotal>0&&(Travian.Game.AllianceDonation.refreshDailyDonation(e.newTotal,t,i.amount,n),Travian.Game.AllianceDonation.refreshProgressBarTitle(e.limit-e.newTotal)),!0===e.reloadAjax&&(Travian.Game.AllianceDonation.countDownResources(i.amount,!1),setTimeout((function(){Travian.Game.AllianceDonation.refreshDonationForm(e.limitReached),jQuery(".bonus-donation-response").html(e.responseText),Travian.Game.AllianceDonation.refreshAllianceBonusOverview()}),a)),!0===e.goldChanged&&Travian.Game.Layout.updateGold(),!0===e.resourcesChanged&&Travian.Game.Layout.updateResources()},error:function(e){return Travian.Game.AllianceDonation.checkButtonState("donate"),Travian.Game.AllianceDonation.showErrorDialog(e.message),!1}})},closeDialog:function(){null!==this.dialog&&this.dialog.close()},showDialog:function(e){var t=this;this.closeDialog(),this.dialog=new Travian.Dialog.Dialog({buttonOk:!1,onClose:function(){t.checkButtonState("donate")}}),this.dialog.setContent(e),this.dialog.show()},showErrorDialog:function(e){var t=this,i=new Travian.Dialog.Dialog({buttonOk:!0,onClose:function(){t.closeDialog(),t.refreshDonationForm(!0),t.refreshDonationLimitBar(),t.refreshAllianceBonusOverview()}});i.setContent(e),i.show()},showScaleDown:function(e){var t=document.getElementById(e).innerHTML;this.showDialog(t),this.scaleDown("scale")},scaleDown:function(e){var t=parseInt(jQuery("#leftResources").val()),i=parseInt(jQuery("#multiplicationFactor").val());t=parseInt(t/i);for(var n=0,a=new Array(5),o=new Array(5),r=1;r<=4;r++)o[r]=this.toNaturalNumber(jQuery("#"+e+r).val()),a[r]=o[r],n+=a[r];0===n&&this.closeDialog(),t>=n&&this.closeDialog();var s=t/n;for(n=0,r=1;r<=4;r++)a[r]>0&&(a[r]=Math.floor(a[r]*s),n+=a[r]);for(var l=t-n;l>0;)for(r=1;r<=4&&l>0;r++)o[r]>0&&(a[r]++,l--);for(r=1;r<=4;r++)jQuery("#"+e+r).val(a[r]),jQuery("#donate"+r).val(a[r]);jQuery("#"+e+"Sum").html(t.toString()),jQuery("#donateSum").html(t.toString()),this.checkAndChangeScalingPopup(e,t),setTimeout((function(){Travian.Game.AllianceDonation.changeScaleButton(!0)}),250)},checkAndChangeScalingPopup:function(e,t){var i=jQuery("#"+e+"SumMultiplied"),n=t;if(i.length>0&&(n=this.toNaturalNumber(i[0].dataset.multiplicator)*t,i.html(n.toString())),"scale"===e){var a=this.toNaturalNumber(jQuery("#resourcesUntilLimit")[0].dataset.limit);this.changeScaleButton(a>=n)}},changeScaleButton:function(e){e?(jQuery("#buttonScale").hide(),jQuery("#scale").addClass("disabled"),jQuery(".bonus-scaleDown").addClass("scaled"),jQuery("#buttonDonate").show()):(jQuery("#buttonDonate").hide(),jQuery("#scale").removeClass("disabled"),jQuery(".bonus-scaleDown").removeClass("scaled"),jQuery("#buttonScale").show())},donateScaled:function(e,t){var i=this.getDonationParams(t);this.closeDialog(),this.donate(t,e.id,i)},refreshGoldConfirmation:function(){var e=jQuery("#donate_gold");e.addClass("disabled");var t=Travian.Game.AllianceDonation.getDonationParams("donate");Travian.Game.AllianceDonation.donate("donate",e.id,t)},refreshDonationForm:function(e){var t=jQuery("#contributionForm"),i=this;t&&(setTimeout((function(){jQuery("#contributionForm").find("input:checked").prop("checked",!1)}),100),Travian.api("alliance/donation-form",{data:{},success:function(n){t.html(n.form),jQuery(window).trigger("domAltered",jQuery("#contributionForm")),e&&Travian.TimersAndCounters.init(),jQuery(".bonus-donation-response").addClass("visible"),i.initBonusIcons(),Travian.Tip.refresh(),i.bonusSelected=!1,i.initContributeDisabledAction()}}))},refreshDonationLimitBar:function(){var e=jQuery("#myDailyContributionLimit");e&&(e.addClass("hidden"),Travian.api("alliance/donation-limit",{data:{},success:function(t){e.html(t.limitBar),jQuery(window).trigger("domAltered",jQuery("#myDailyContributionLimit")),Travian.Tip.refresh(),e.removeClass("hidden")}}))},refreshAllianceBonusOverview:function(){var e=jQuery("#allianceBonusOverview"),t=this;e&&Travian.api("alliance/bonus-overview",{data:{},success:function(i){e.html(i.overview),t.initBonusOverview(),Travian.Tip.refresh()}})},refreshDailyDonation:function(e,t,i,n){var a=jQuery("#donatedToday"),o=jQuery("#dailyContributionTitleText"),r=jQuery("#dailyContributionTitleArrow"),s=parseInt(a.val()),l=parseInt(jQuery("#dailyLimit").val()),d=Math.min(100,e/l*100),u="lightGreen";"donate_gold"!==t&&"donate_gold_confirm"!==t||(u="gold"),r.addClass(u);var c=this.getResourceAnimationSpeed(i,n);i=n?3*i:i;var h=Math.round(i/20),p=c/20;r.css({transition:"width "+c+"ms, opacity 500ms",width:d.toString()+"%"});var m=1,v=setInterval((function(){(s+=h)<e&&o.html(Travian.i18n.Ratio(s,l,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"})),20===m&&(o.html(Travian.i18n.Ratio(e,l,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"})),r.removeClass(u),clearInterval(v)),m++}),p);100===d&&(jQuery(".bonus-donation-response").addClass("white"),r.css({width:"100%"}),jQuery("#limitReached").val(1),setTimeout((function(){r.addClass("complete"),o.addClass("complete").removeClass("white"),jQuery(".bonus-donation-response").addClass("complete")}),c+500)),a.val(e)},countDownResources:function(e,t){var i=this.getResourceAnimationSpeed(e,t),n=[],a=[];jQuery("#contributeButtons").find("button").addClass("disabled");var o=0;jQuery(".resourceInput input").each((function(e,t){var i=parseInt(jQuery(t).val());n[o]=i;var r=i/20;r<1&&(r=1),a[o]=r,o++}));var r=1,s=setInterval((function(){for(var e=0;e<n.length;e++){var t=n[e]-a[e];t>0&&(n[e]=t,jQuery(jQuery(".resourceInput input")[e]).val(parseInt(t)))}if(20===r){for(var i=0;i<n.length;i++)jQuery(jQuery(".resourceInput input")[i]).val(0);clearInterval(s)}r++}),i/20)},getResourceAnimationSpeed:function(e,t){t&&(e*=3);var i=500+1500*e/parseInt(jQuery("#dailyLimit").val());return i=Math.max(500,Math.min(2e3,i))},initBonusIcons:function(){var e=jQuery("#contributionBox").find("#bonusSelection .bonusButtonRound");e.off("click"),e.on("click",(function(e){e.preventDefault();var t=jQuery("#bonusBox"+jQuery(this).attr("data-index"));t.find(".bonusInfo").hasClass("hide")&&t.find("button").trigger("click"),jQuery("html, body").animate({scrollTop:t.offset().top},250)}))},initBonusOverview:function(){var e,t=jQuery(".bonusCollapse");try{e=JSON.parse(Travian.Game.Preferences.get("allianceBonusesOverview")||"{}")}catch(t){e={}}t.length>0&&t.each((function(i,n){jQuery(n).on("click",(function(i){var n=jQuery(this).attr("ref"),a=jQuery(this).children("img.openedClosedSwitch");if(n.length>0&&a.length>0){var o=jQuery(".bonusInfo."+n);Travian.toggleSwitch(o[0],a[0]),t.each((function(t,i){var n=jQuery(i).attr("ref"),a=jQuery(i).children("img.openedClosedSwitch");if(n.length>0&&a.length>0){var o=jQuery(".bonusInfo."+n);e[n]=!Travian.isToggleClosed(o[0],a[0])}})),Travian.Game.Preferences.set("allianceBonusesOverview",JSON.stringify(e))}}))}))},playLevelUpRewardAnimation:function(e,t,i,n){Travian.Game.Layout.toggleBackgroundOverlay();var a=jQuery("#backgroundOverlay"),o=jQuery("#bonusLevelUpRewardTemplate").html();a.prepend(o),a.find(".bonusLevelUpReward .bonusRepresentation > div").addClass(e),a.find(".bonusLevelUpReward .banner .description p:first-of-type").html(i),a.find(".bonusLevelUpReward .banner .description p:last-of-type").html(n),setTimeout((function(){a.find(".stoneDisplay").addClass("visible"),a.find(".stoneDisplayHeader").addClass("visible"),a.find(".banner").addClass("visible"),a.find(".swords").addClass("visible").addClass("locked"),setTimeout((function(){a.find(".bonusRepresentation .stage1").addClass("visible"),setTimeout((function(){a.find(".bonusRepresentation .glow").addClass("visible"),setTimeout((function(){a.find(".bonusRepresentation .stage2").addClass("visible"),setTimeout((function(){a.find(".bonusRepresentation .stage1").removeClass("visible"),a.find(".bonusRepresentation .glow").removeClass("visible"),a.find(".banner").addClass("enlarged"),setTimeout((function(){a.find(".stoneDisplayHeader .level1 .glow").addClass("visible"),a.find(".stoneDisplayHeader .level1 .star").addClass("visible"),setTimeout((function(){a.find(".stoneDisplayHeader .level1 .glow").removeClass("visible")}),150),t>=2&&setTimeout((function(){a.find(".stoneDisplayHeader .level2 .glow").addClass("visible"),a.find(".stoneDisplayHeader .level2 .star").addClass("visible"),setTimeout((function(){a.find(".stoneDisplayHeader .level2 .glow").removeClass("visible")}),150),t>=3&&setTimeout((function(){a.find(".stoneDisplayHeader .level3 .glow").addClass("visible"),a.find(".stoneDisplayHeader .level3 .star").addClass("visible"),setTimeout((function(){a.find(".stoneDisplayHeader .level3 .glow").removeClass("visible")}),250),t>=4&&setTimeout((function(){a.find(".stoneDisplayHeader .level4 .glow").addClass("visible"),a.find(".stoneDisplayHeader .level4 .star").addClass("visible"),setTimeout((function(){a.find(".stoneDisplayHeader .level4 .glow").removeClass("visible")}),250),t>=5&&setTimeout((function(){a.find(".stoneDisplayHeader .level5 .glow").addClass("visible"),a.find(".stoneDisplayHeader .level5 .star").addClass("visible"),setTimeout((function(){a.find(".stoneDisplayHeader .level5 .glow").removeClass("visible")}),250)}),500)}),500)}),500)}),500),setTimeout((function(){a.find(".bonusRepresentation .glow").addClass("step2 visible"),setTimeout((function(){a.find(".bonusRepresentation .glow").removeClass("visible"),a.find(".banner").removeClass("enlarged"),a.find(".bonusLevelUpReward").addClass("faded"),setTimeout((function(){Travian.Game.Layout.toggleBackgroundOverlay()}),750)}),750)}),2800-500*(5-t))}),1250)}),100)}),300)}),800)}),750)}),250)},refreshProgressBarTitle:function(e){var t=jQuery("div.progressBarDailyLimit"),i=t.attr("data-tooltip").match(/(^.*)(\[AMOUNT\])(.*$)/);t.title=i[1]+e+i[3],Travian.Tip.refresh()},initContributeDisabledAction:function(){var e=this;jQuery("#contributeButtons").find("button").on("click",(function(){e.calculateSum("donate"),!e.bonusSelected&&parseInt(jQuery("#donateSum").html())>0&&jQuery("#bonusNotSelectedMessage").show()}))}},Travian.Game.AllianceLeave=function(e){this.options=Object.assign({data:{}},e),this.initialize=function(){Travian.Dialog.Ajax.call(this,"alliance/leave",this.options)},this.reload=function(){this.request()},this.initialize()},Travian.Game.AllianceLeave.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.AllianceLeave.constructor=Travian.Game.AllianceLeave,Travian.Game.PaymentWizard=function(e){var t=this;this.options=Travian.Helpers.deepmergeObject({shopUIVersion:0,data:{goldProductId:"",goldProductLocation:"",location:"",activeTab:"buyGold",formData:{}},keepOpen:!0,buttonCancel:!0,buttonOk:!1,context:"paymentWizard",cssClass:"",draggable:!1,infoIcon:!0,version:2,reloadOnClose:!1,darkOverlay:!0,overlayCancel:!1,useCallback:!1,callback:Travian.emptyFunction(),callbackScope:null,onClose:function(e){Travian.Game.PaymentWizardEventListener.PaymentWizardObject=null,!0===t.options.useCallback&&"function"==typeof t.options.callback&&t.options.callback({scope:t.options.callbackScope}),jQuery(window).trigger("paymentWizardOnCloseEvent"),Travian.Game.Layout.updateGold(t.options.callback),Travian.TimersAndCounters.enableReloadEvent(),t.options.reloadOnClose&&Travian.autoreload()}},e),this.request=function(){var e=this;return Travian.api(this.cmd,{data:this.options.data,success:function(t){""!==t.html?e.setReloadOnClose(t.reloadOnClose).setContent(t.html).setInfoIcon(t.infoIcon).show():e.close()},error:function(t){e.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}}),this},this.initialize=function(){var e=this;Travian.TimersAndCounters.suppressReloadEvent();var t=function(t){var i=e.options.shopUIVersion<4?jQuery(t.target).parent(".tabButton").attr("class").split(" ")[1]:jQuery(t.target).data("tabname");return"pros"===i&&(e.options.callback=null),e.options.data.activeTab=i,e.options.data.goldProductId=null,e.reload(),t.stopPropagation(),!1},i=e.options.onOpen;return e.options.onOpen=function(){var n=jQuery("#paymentWizard"),a=e.options.shopUIVersion<4?".header .tabButton":".header .tabItem";n.find(a).each((function(e,i){(i=jQuery(i)).off("click.paymentWizard"),i.on("click.paymentWizard",t)}),this),n.length>0&&(n.find(".iconButton.info").attr("title",Travian.Translation.get("paymentWizard.infoButtonLabel")),e.updateInfoButton({buttonTextInfo:Travian.Translation.get("paymentWizard.infoButtonLabel"),infoIcon:function(){window.open(n.find(".paymentWizardAnswersLink").val())}})),"buyGold"===e.options.data.activeTab||""===e.options.data.activeTab?e.initializeBuyGoldTab():"pros"===e.options.data.activeTab?e.initializeProsTab():"earnGold"===e.options.data.activeTab?e.initializeEarnGoldTab():"vouchers"===e.options.data.activeTab&&e.initializeVouchersTab(),i&&"function"==typeof i&&i()},Travian.Dialog.Ajax.call(this,"payment-wizard",e.options),this},this.initializeBuyGoldTab=function(){var e=this,t=jQuery("#paymentWizard"),i=t.find(".contentWrapper .infoArea"),n=t.find(".contentWrapper .contentArea"),a=function(e,t){return e.hasClass(t)||(e=e.parent("."+t)),e},o=function(t){var i=a(jQuery(t.target),"goldProduct");if(null!=i){if(i.find(".goldProductId").attr("data-voucher"))return voucherPopup(),t.stopPropagation(),!1;e.options.data.goldProductId=i.find(".goldProductId").val(),e.reload()}return t.stopPropagation(),!1},r=function(t){var i=a(jQuery(t.target),"providerLink");if(null!=i){var n,o,r=i.find(".providerId").val();try{n=i.find(".popupWidth").val()}catch(e){n=800}try{o=i.find(".popupHeight").val()}catch(e){o=600}e.options.useCallback=!0,e.openProvider(e.options.data.goldProductId,r,n,o)}return t.stopPropagation(),!1},s=function(t){if(e.DoubleClickPreventer||(e.DoubleClickPreventer=new Travian.DoubleClickPreventer,e.DoubleClickPreventer.timeout=2e3),!e.DoubleClickPreventer.check())return t.stopPropagation(),!1;var i=n.find(".paymentOpenOffersResult")[0];i&&i.destroy();var a=jQuery(t.target);a.hide();var o=a.parent(".footerItem");return!0===a.hasClass("ordersHide")?(o.find(".ordersShow").fadeIn(),n.find(".buyGoldContent").fadeOut(),n.find(".openOffers").fadeOut(),t.stopPropagation(),!1):(o.down(".ordersHide").fadeIn(),n.down(".buyGoldContent").fadeOut(),n.down(".openOffers").fadeIn(),Travian.api("payment-wizard/open-offers",{data:{},success:function(e){var t=n.find(".openOffers")[0];t.empty(),!1===e.noResult?t.html(e.html):t.html(e.message)}}),t.stopPropagation(),!1)};i.find(".buyGoldLocation").length>0&&i.find(".buyGoldLocation")[0].on("change",(function(t){var n=i.find(".buyGoldLocation")[0];return e.options.data.goldProductLocation=n.options[n.selectedIndex].value,e.options.data.goldProductId="",e.reload(),t.stopPropagation(),!1})),i.find("a").length>0&&i.find("a")[0].on("click",(function(e){return i.find(".buyGoldInfoStep.locationStep").each((function(e){e.fadeOut()})),i.find(".buyGoldInfoStep.locationStep.buyGoldFormStep").fadeIn(),e.stopPropagation(),!1}));var l=i.find(".changeGoldProduct");return l.length>0&&l[0].on("click",(function(t){return e.options.data.goldProductId="",e.reload(),t.stopPropagation(),!1})),n.find(".goldProduct").each((function(e,t){t.on("click",o)})),n.find(".paymentProvider").each((function(e,t){t.on("click",r)})),i.find(".openOrdersLink").each((function(e,t){t.on("click",s)})),this},this.updatePosition=function(e,t){var i=this.calculatePosition();this.setPosition({x:i.left,y:i.top},e)},this.initializeEarnGoldTab=function(){var e=this,t=jQuery("#paymentWizard.earnGold"),i=t.find(".contentWrapper .earnGoldPage").parent(),n=function(e){return e&&""!==e&&void 0!==e||(e="earnGoldOverview"),i.children().hide(),i.children("."+e).show(),this};t.find("a.showEarnGoldPage").on("click",(function(e){for(var t=void 0,i=jQuery(e.target).attr("class").split(" "),a=0;a<i.length;a++)if(0===i[a].indexOf("earnGold")){t=i[a];break}return n(t),e.stopPropagation(),!1}));i.find(".earnGoldAddLink").on("click",(function(e){var t=i.find(".receiverLines").children().length;if(t<6){var n=Travian.Translation.translate("{earnGoldContentMailSendReceiverCount}").replace("[RECEIVER_COUNT]",t+1);jQuery('<div class="receiverLine">'+n+'<input type="text" class="text" name="receiver[]" /></div>').appendTo(i.find(".receiverLines")),t>=5&&i.find(".receiverLinkLine").hide()}return e.stopPropagation(),!1})),i.find(".earnGoldSendMailCancel").on("click",(function(){e.options.data.formData={},e.options.data.location="",e.reload()})),i.find(".earnGoldSendMailSubmit").on("click",(function(){var t={receiver:[]};i.find(".receiverLines input").each((function(e,i){t.receiver.push(jQuery(i).val())})),t.message=i.find(".earnGoldSendMailMessage").val(),e.options.data.formData=t,e.options.data.location="earnGoldMailSend",e.reload()}));var a=!1,o=function(t){return a||(a=!0,Travian.api("payment-wizard/advertised-persons",{data:{page:t},success:function(n){n.errorMessage?e.setError(n):n.html&&(a=!1,i.find(".earnGoldAdvertisedPersonsList").html(n.html),i.find(".paginator a").on("click",(function(e){var i=jQuery(e.target);return"a"!==i.prop("tagName").toLowerCase()&&(i=i.parent("a")),t=i.attr("href").toString().split("=")[1],o(t),e.stopPropagation(),!1})))}})),this},r=i.find("a.showEarnGoldPage.earnGoldDrumUps");null!==r&&r.on("click",(function(e){o()})),n(e.options.data.location)},this.initializeProsTab=function(){var e=this,t=jQuery("#featureCollectionWrapper");t.find(".prosButton").each((function(t,i){(i=jQuery(i)).off("click"),i.on("click",(function(t){return e.options.useCallback=!0,e.options.callback=function(){Travian.autoreload()},e.requestSend=!0,jQuery(this).hasClass("productionboostWood")?jQuery(window).trigger("startWayOfPayment",["productionboostWood","paymentWizard"]):jQuery(this).hasClass("productionboostClay")?jQuery(window).trigger("startWayOfPayment",["productionboostClay","paymentWizard"]):jQuery(this).hasClass("productionboostIron")?jQuery(window).trigger("startWayOfPayment",["productionboostIron","paymentWizard"]):jQuery(this).hasClass("productionboostCrop")?jQuery(window).trigger("startWayOfPayment",["productionboostCrop","paymentWizard"]):jQuery(this).hasClass("plus")?jQuery(window).trigger("startWayOfPayment",["plus","paymentWizard"]):jQuery(this).hasClass("goldclub")&&jQuery(window).trigger("startWayOfPayment",["goldclub","paymentWizard"]),!1}))})),t.find(".checkbox").each((function(t,i){(i=jQuery(i)).off("click"),i.on("click",(function(t){return jQuery(this).hasClass("prolongProductionboostWood")?e.toggleAutoprolong("productionboostWood","productionBoost"):jQuery(this).hasClass("prolongProductionboostClay")?e.toggleAutoprolong("productionboostClay","productionBoost"):jQuery(this).hasClass("prolongProductionboostIron")?e.toggleAutoprolong("productionboostIron","productionBoost"):jQuery(this).hasClass("prolongProductionboostCrop")?e.toggleAutoprolong("productionboostCrop","productionBoost"):jQuery(this).hasClass("prolongPlus")?e.toggleAutoprolong("plus","plus"):(t.stopPropagation(),!1)}))})),4===e.options.shopUIVersion?(t.find(".feature").on("mouseover",(function(t){var i=jQuery(this).find(".premiumFeatureName").val();if(!i||i===e.lastFeatureName)return t.stopPropagation(),!1;var n=jQuery("#paymentWizard");n.find(".infoArea .premiumFeature").removeClass("show"),n.find(".infoArea .premiumFeature").filter("."+i).addClass("show");var a=n.find("#featureIndicator"),o=jQuery(this),r=o.get(0).offsetTop+o.height()/2-a.height()/2;a.stop().addClass("moving").animate({top:r},250,"linear",(function(){jQuery(this).removeClass("moving")})),e.lastFeatureName=i})),t.find(".feature.preSelected").trigger("mouseover")):t.find(".feature").on("mouseover",(function(t){var i=jQuery(this).find(".premiumFeatureName").val();if(!i||i===e.lastFeatureName)return t.stopPropagation(),!1;var n=jQuery("#paymentWizard");n.find(".infoArea .premiumFeature").hide(),n.find(".contentArea .feature .dynamicContent").hide(),jQuery(this).find(".dynamicContent").show(),n.find(".infoArea .premiumFeature").filter("."+i).show(),e.lastFeatureName=i})),t.length>0&&Travian.TimersAndCounters.initTimersInContext(t[0])},this.initializeVouchersTab=function(){return!1},this.toggleAutoprolong=function(e,t){var i=this,n={featureKey:e,toggleAutoprolong:1};Travian.api("premium",{data:n,success:function(e){i.reload()}})},this.setReloadOnClose=function(e){return this.options.reloadOnClose=!1===this.options.reloadOnClose&&!0===e?e:this.options.reloadOnClose,this},this.openProvider=function(e,t,i,n){window.open("/tgpay.php?product="+e+"&provider="+t,"tgpay","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width="+i+",height="+n)},this.initialize()},Travian.Game.PaymentWizard.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.PaymentWizard.constructor=Travian.Game.PaymentWizard;var shopUIV4=new ShopUIV4;function ShopUIV4(){this.paymentShop=null,this.paymentWizard=null,this.packages=null,this.countrySelection=null,this.countrySelectionTemplate=null,this.paymentMethods=null,this.selectedPackage=null,this.continueButton=null,this.closeButton=null,this.loader=null,this.progressSteps=null,this.activeTab=null,this.currentProgressStep="selectPackage",this.country=null,this.goldProductId=null,this.goldProductLocation=null,this.notificationPreferencesKey=null,this.goldBookingListenerInterval=null,this.initialize=function(e){var t=this;t.paymentShop=jQuery(".dialog.paymentShopV4"),t.paymentWizard=jQuery("#paymentWizard"),t.paymentWizard.addClass("selectPackage"),t.showLoader(!0),t.goldProductId=void 0!==Travian.Game.PaymentWizardEventListener.PaymentWizardObject?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductId:null,t.goldProductLocation=void 0!==Travian.Game.PaymentWizardEventListener.PaymentWizardObject?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductLocation:null,t.notificationPreferencesKey="goldBookingNotification."+e,Travian.api("paynet/init",{success:function(e){void 0!==e.html&&(jQuery(window).off("travian.preferences.reloaded"),t.paymentWizard.hasClass("buyGold")&&(t.paymentWizard.find(".contentWrapper").empty().append(e.html),t.countrySelection=t.paymentShop.find(".countrySelection"),t.countrySelectionTemplate=t.paymentShop.find("#countrySelectionTemplate"),t.billingWrapper=t.paymentShop.find(".billingWrapper"),t.packages=t.paymentShop.find("input[name=package]"),t.paymentMethods=t.paymentShop.find("input[name=paymentMethod]"),t.continueButton=t.paymentShop.find("button.buyButton"),t.closeButton=t.paymentShop.find("#backToGame"),t.progressSteps=t.paymentShop.find(".buyProgress .step"),t.selectedPackage=null,t.initializePaymentMethods(),t.bindEvents(),t.setProgressStep("selectPackage",!1),Travian.Tip.refresh(),Travian.TimersAndCounters.initTimersInContext(t.paymentShop.find(".specialOffersPackages")[0]),null!==t.goldProductLocation&&""!==t.goldProductLocation&&t.countrySelectionTemplate.find("input[name=country]:checked").val()!==t.goldProductLocation?(t.hideLoader(),t.changeCountry(t.goldProductLocation)):(t.preselectPackage(),t.hideLoader())))},error:function(e){t.paymentWizard.find(".contentWrapper").empty(),t.errorDialog(e.message),t.hideLoader()}},"get")},this.preselectPackage=function(){let e=this;null!==e.goldProductId&&""!==e.goldProductId&&e.paymentWizard.find("input[value="+e.goldProductId+"]").prop("checked","checked").trigger("change")},this.initializePaymentMethods=function(){var e=this;null!==e.selectedPackage&&(e.hideLoader(),e.showLoader(),Travian.api("paynet/cart",{data:{productID:e.selectedPackage},success:function(t){if(void 0!==t.html){jQuery(".paymentMethods").html(t.html),e.paymentShop.find("input[name=paymentMethod]").on("change.paymentShopV4",(function(){e.paymentShop.find("input[name=paymentMethod]:checked").length>0&&e.continueButton.removeClass("disabled")})),e.setProgressStep("selectPaymentMethod",!1),e.hideLoader(),Travian.Tip.refresh(),e.paymentWizard.find(".paymentMethods .paymentMethod.back").on("click.paymentShopV4",(function(){e.setProgressStep("selectPaymentMethod",!0)}));var i=e.paymentShop.find("input[name=paymentMethod]");if(1===i.length)i.prop("checked","checked"),e.continueButton.removeClass("disabled");else{var n=Travian.Game.Preferences.get("lastUsedPaymentMethod");if(null!==n){var a=e.paymentShop.find("input[name=paymentMethod][data-code="+n+"]");a.length>0&&(a.prop("checked","checked"),a.find("+ label").is(":visible")||jQuery("#togglePaymentMethods").prop("checked","checked"),e.continueButton.removeClass("disabled"))}}}},error:function(t){e.hideLoader(),e.errorDialog(t.message)}},"put"))},this.bindEvents=function(){var e=this;e.countrySelection.off("click.paymentShopV4").on("click.paymentShopV4",(function(t){t.preventDefault(),e.renderCountryDialog()})),e.packages.off("change.paymentShopV4").on("change.paymentShopV4",(function(){e.continueButton.addClass("disabled"),e.selectedPackage=e.paymentShop.find("input[name=package]:checked").val(),e.initializePaymentMethods()})),e.packages.off("click.paymentShopV4").on("click.paymentShopV4",(function(){"insertBillingInformation"===e.currentProgressStep&&e.setProgressStep("selectPackage",!0)})),e.paymentWizard.find(".paymentWrapper .smsPayment a").off("click.paymentShopV4").on("click.paymentShopV4",(function(t){t.preventDefault(),e.paymentWizard.addClass("sms")})),e.progressSteps.off("click.paymentShopV4").on("click.paymentShopV4",(function(){var t=jQuery(this);["selectPackage","selectPaymentMethod"].forEach((function(i){t.hasClass(i)&&e.setProgressStep(i,!0)}))})),e.continueButton.off("click.paymentShopV4").on("click.paymentShopV4",(function(){var t=jQuery(this);if(!t.hasClass("disabled")&&"disabled"!==t.prop("disabled")){var i=e.paymentShop.find("input[name=paymentMethod]:checked");if(0===i.length)return!1;var n=!1;switch(e.currentProgressStep){case"selectPaymentMethod":e.setProgressStep("insertBillingInformation",!1);break;case"insertBillingInformation":e.showLoader(),n=!0}if(n){var a=i.data("code");Travian.api("paynet/create-payment",{data:{paymentMethodCode:a},success:function(t){if(e.hideLoader(),void 0!==t.url){var i=jQuery(window),n=(i.width()-900)/2+window.screenX,o=(i.height()-800)/2;if(window.open(t.url,"paynet","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width=900,height=800,left="+n+",top="+o),e.setProgressStep("confirmed"),e.paymentShop.find(".confirmation.forwarded").addClass("visible"),Travian.Game.Preferences.set(e.notificationPreferencesKey,null),Travian.Game.Preferences.set("lastUsedPaymentMethod",a),jQuery("input[name=package][value="+e.selectedPackage+"]").parent(".specialOffersPackages").length>0){jQuery("#oneTimeOfferNotification").removeClass("firstTimeAnimation").addClass("dismissed");let e=jQuery(".tabItem.specialOffers").find(".shopNotification");e.length>0&&!e.hasClass("read")&&Travian.Game.Layout.updateShopNotification(1,e)}}else e.errorDialog("Error: The payment method could not be loaded.")},error:function(t){e.hideLoader(),e.errorDialog(t.message)}},"post")}}})),e.closeButton.off("click.paymentShopV4").on("click.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentWizard")}))},this.changeCountry=function(e){var t=this;t.country=e,t.showLoader();let i=t.countrySelectionTemplate.find("input[name=country][value="+e+"]").parent("label"),n=t.paymentWizard.find("h1.countrySelection");n.find(".inlineIcon .value").html(i.data("country-native")),n.find(".inlineIcon").find("svg").remove(),n.find(".inlineIcon").prepend(i.find("svg").clone()),Travian.api("paynet/productsByCountry/"+t.country,{success:function(e){t.hideLoader(),void 0!==e.renderedPackages&&void 0!==e.renderedSmsPackages&&void 0!==e.renderedSpecialOffersPackages&&(t.paymentWizard.find(".packages:not(.smsPackages):not(.specialOffersPackages").empty().append(e.renderedPackages),t.paymentWizard.find(".smsPackages").empty().append(e.renderedSmsPackages),t.paymentWizard.find(".specialOffersPackages").empty().append(e.renderedSpecialOffersPackages),Travian.TimersAndCounters.initTimersInContext(t.paymentShop.find(".specialOffersPackages")[0]),t.packages=t.paymentShop.find("input[name=package]"),""===e.renderedSmsPackages?t.paymentWizard.find(".smsPayment").removeClass("available"):t.paymentWizard.find(".smsPayment").addClass("available"),t.setProgressStep("selectPackage",!1),t.bindEvents(),t.preselectPackage())},error:function(e){t.hideLoader(),t.errorDialog(e.message)}},"get")},this.showLoader=function(e){var t=this;t.loader=t.paymentShop.find(".loading"),void 0!==e&&!0===e?t.loader.addClass("visible").addClass("preview"):(t.loader.addClass("visible"),t.paymentShop.find(".contentNavi .content.active .tabItem .shopNotification.read").remove()),t.paymentShop.find("h1.countrySelection").addClass("disabled"),t.paymentShop.find(".contentNavi .tabItem").attr("disabled","disabled"),t.paymentShop.find("div:not(#dialogContent) .iconButton").addClass("disabled"),t.activeTab=t.paymentShop.find(".contentNavi .content.active"),t.activeTab.removeClass("active")},this.hideLoader=function(){var e=this;e.loader.removeClass("visible"),e.paymentShop.find("h1.countrySelection").removeClass("disabled"),e.paymentShop.find(".contentNavi .tabItem").attr("disabled",!1),e.paymentShop.find("div:not(#dialogContent) .iconButton").removeClass("disabled"),e.activeTab.addClass("active")},this.setProgressStep=function(e,t){var i=this,n={selectPackage:1,selectPaymentMethod:2,insertBillingInformation:3,confirmed:4};if(t&&(n={selectPackage:1,selectPaymentMethod:2}),void 0===n[e])return!1;if(t&&n[i.currentProgressStep]<n[e])return!1;i.progressSteps.removeClass("locked"),i.progressSteps.removeClass("done"),i.progressSteps.removeClass("active");var a=!1;switch(i.progressSteps.each((function(t,i){i=jQuery(i),a?i.addClass("locked"):i.hasClass(e)?(a=!0,i.addClass("active")):i.addClass("done")})),e){case"selectPackage":i.paymentWizard.removeClass("sms").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPackage"),i.paymentShop.find("input[name=package]:checked").prop("checked",!1),i.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",!1),i.paymentShop.find("input[name=paymentMethod]").attr("disabled","disabled"),i.paymentWizard.removeClass("forwarded").removeClass("successful"),i.paymentWizard.find(".silwia").addClass("normal").removeClass("success"),i.continueButton.addClass("disabled");break;case"selectPaymentMethod":i.paymentWizard.removeClass("selectPackage").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPaymentMethod"),i.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",!1),i.continueButton.addClass("disabled");break;case"insertBillingInformation":var o=i.paymentShop.find("input[name=paymentMethod]:checked").val();i.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("confirmed").addClass("insertBillingInformation"),"SMART2PAY_VTC"===o&&i.paymentShop.find(".vatInfo").html("*&nbsp;"+Travian.Translation.get("paymentWizard.pricesAreFinalExceptExtraTaxes"));break;case"confirmed":i.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").addClass("confirmed").addClass("forwarded"),i.goldBookingListener()}i.currentProgressStep=e},this.goldBookingListener=function(){var e=this;jQuery(window).on("travian.preferences.reloaded",(function(){var t=Travian.Game.Preferences.get(e.notificationPreferencesKey);null!==t&&parseInt(t)>0&&(e.paymentWizard.find(".confirmation .confirmationText .value").html(t),e.paymentWizard.removeClass("forwarded").addClass("successful"),e.paymentWizard.find(".silwia").removeClass("normal").addClass("success"),Travian.Game.Layout.updateGold(),Travian.Game.Preferences.set(e.notificationPreferencesKey,null),clearInterval(e.goldBookingListenerInterval))})),e.goldBookingListenerInterval=setInterval((function(){e.paymentWizard.is(":visible")&&e.paymentWizard.hasClass("confirmed")&&e.paymentWizard.hasClass("forwarded")?Travian.Game.Preferences.reload():clearInterval(e.goldBookingListenerInterval)}),3e3)},this.errorDialog=function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error centeredText errorMessage">'+e+"</div>").show()},this.initializeVouchers=function(){var e=this;e.paymentShop=jQuery(".dialog.paymentShopV4"),e.paymentWizard=jQuery("#paymentWizard");var t=e.paymentShop.find("form"),i=e.paymentWizard.find(".voucherForm");if(i.length>0){var n=e.paymentWizard.find(".silwia"),a=i.find("input[name=voucher]"),o=i.find(".errorMessageContainer"),r=i.find("#redeemVoucher");a.on("keyup input",(function(e){if("Enter"===e.key)return e.preventDefault(),!1;a.removeClass("invalid"),""===jQuery(this).val().trim()?r.addClass("disabled"):r.removeClass("disabled")})),t.off("submit"),t.on("submit",(function(t){if(t.preventDefault(),r.hasClass("disabled"))return!1;e.showLoader(),Travian.api("paynet/redeem-voucher",{data:{code:a.val().trim()},success:function(t){e.paymentWizard.find(".packages label .amount .value").html(t.data.value),e.paymentWizard.find(".confirmation .confirmationText .value").html(t.data.value),e.paymentShop.find("#backToGame").on("click.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentWizard")})),e.hideLoader(),e.paymentWizard.addClass("confirmed"),n.removeClass("normal").addClass("success"),jQuery(window).on("travian.preferences.reloaded",(function(){var t=Travian.Game.Preferences.get(e.notificationPreferencesKey);null!==t&&parseInt(t)>0&&(Travian.Game.Layout.updateGold(),Travian.Game.Preferences.set(e.notificationPreferencesKey,null),clearInterval(e.goldBookingListenerInterval))})),e.goldBookingListenerInterval=setInterval((function(){e.paymentWizard.hasClass("confirmed")?Travian.Game.Preferences.reload():clearInterval(e.goldBookingListenerInterval)}),1e3)},error:function(t){e.hideLoader(),t.code&&t.code>=4001&&t.code<=4008?(a.addClass("invalid"),o.html(t.message),Travian.TimersAndCounters.initTimers()):e.errorDialog(t.message)}},"post")}))}},this.renderSmallestPackageDialog=function(e){var t=this;Travian.api("paynet/smallestPackageDialog/"+e,{success:function(e){if(void 0!==e.html){var t=Travian.WindowManager.getWindowsByContext("smallestPackage")[0];void 0!==t&&t.setContent(e.html)}},error:function(e){t.errorDialog(e.message)}},"get")},this.renderTransactionHistoryDialog=function(){var e=this;e.showLoader(),Travian.api("paynet/transactionHistoryDialog",{success:function(t){e.hideLoader();var i=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,cssClass:"plain scrollable transactionHistory"});i.setContent(t.html),i.show()},error:function(t){e.hideLoader(),e.errorDialog(t.message)}},"get")},this.copyOrderCodeListener=function(){var e=jQuery(".copyOrderCode");e.off("click.paymentShopV4"),e.on("click.paymentShopV4",(function(e){e.preventDefault();var t=jQuery(e.target);jQuery(".copiedNotice").removeClass("success");var i=jQuery("<input/>");jQuery("body").append(i),i.val(t.data("order-id")).select(),document.execCommand("copy"),i.remove(),t.parent(".orderCode").find(".copiedNotice").removeClass("success").addClass("success")}))},this.renderCountryDialog=function(){var e=this,t=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,infoIcon:!1,cssClass:"plain scrollable countrySelection",context:"paymentShopV4CountrySelection"});t.setContent('<div id="countrySelection" class="'+e.countrySelectionTemplate.prop("class")+'">'+e.countrySelectionTemplate.html()+"</div>"),t.show();var i=jQuery("#countrySelection");i.find("input[name=country][value="+e.country+"]").prop("checked","checked"),i.find("input[name=country]").off("change.paymentShopV4").on("change.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentShopV4CountrySelection"),e.changeCountry(jQuery(this).val())})),i.find(".filterCountry input").off("keyup").on("keyup",(function(){var e=jQuery(this).val().toUpperCase();i.find(".countryListItem").each((function(t,i){-1!==(i=jQuery(i)).data("country-native").toUpperCase().indexOf(e)||-1!==i.data("country-english").toUpperCase().indexOf(e)||-1!==i.find("input").val().toUpperCase().indexOf(e)?i.show():i.hide()})),0===i.find(".countryListItem:visible").length?i.find(".noCountryFound").removeClass("hide"):i.find(".noCountryFound").addClass("hide")}))}}Travian.Game.VideoFeatureShowVideo=function(e){this.request=function(){var e=this;return Travian.api(this.options.call,{data:this.options.data,success:function(t){e.setContent(t.html),e.show(),e.updateInfoButton({buttonTextInfo:Travian.Translation.get("videoFeature.infoButtonLabel"),infoIcon:function(){window.open(jQuery("#videoFeature").find(".videoFeatureAnswersLink").val())}})}}),this},this.close=function(e){if(void 0!==this.requestSend&&!0===this.requestSend)return Travian.autoreload();[Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND,Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON].indexOf(e)>-1?new Travian.Game.VideoFeatureAbort:(Travian.TimersAndCounters.enableReloadEvent(),Travian.Dialog.Api.prototype.close.call(this))},Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo",buttonOk:!1,context:"videoFeatureShowVideo",version:2,darkOverlay:!0,cssClass:"videoFeature",onClose:function(e){Travian.Game.VideoFeatureEventListener.VideoFeatureObject=null}},e))},Travian.Game.VideoFeatureShowVideo.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureShowVideo.constructor=Travian.Game.VideoFeatureShowVideo,Travian.Game.VideoFeatureInfo=function(e){this.request=function(){var e=this;return Travian.api(this.options.call,{data:this.options.data,success:function(t){e.setContent(t.html),e.show(),e.updateInfoButton({buttonTextInfo:Travian.Translation.get("videoFeature.infoButtonLabel"),infoIcon:function(){window.open(jQuery("#videoFeature").find(".videoFeatureAnswersLink").val())}})}}),this},Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/info",buttonOk:!1,context:"videoFeatureInfo",version:2,darkOverlay:!0,cssClass:"videoFeature"},e))},Travian.Game.VideoFeatureInfo.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureInfo.constructor=Travian.Game.VideoFeatureInfo,Travian.Game.VideoFeatureAbort=function(e){this.abortVideo=function(){Travian.autoreload(),Travian.WindowManager.closeByContext("videoFeatureAbort"),Travian.WindowManager.closeByContext("videoFeatureShowVideo")},Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/abort",buttonOk:!1,buttonCancel:!1,context:"videoFeatureAbort",darkOverlay:!0,overlayCancel:!1},e)),jQuery(window).one("videoFeatureAbortConfirm",this.abortVideo)},Travian.Game.VideoFeatureAbort.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureAbort.constructor=Travian.Game.VideoFeatureAbort,Travian.Game.VideoFeatureSuccess=function(e){Travian.Dialog.Api.call(this,Object.assign({call:"adSalesVideo/success",context:"videoFeatureSuccess",darkOverlay:!0,overlayCancel:!0,preventFormSubmit:!0,onOkay:function(){Travian.Game.Preferences.set("adSalesVideoSuccessDialogDisabled",jQuery("input#dontShowThisAgain").is(":checked")?1:0)}},e))},Travian.Game.VideoFeatureSuccess.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureSuccess.constructor=Travian.Game.VideoFeatureSuccess,Travian.Game.MoreGames=function(e){this.activeCounterElement=null,this.activeCounter=0,this.autoHoverDelay=3e3,this.timeoutId=0,this.elements=null,this.options=Object.assign({countOfGamesToShow:0},e),this.initialize=function(){this.elements=jQuery("div.moreGames .game.game-image"),this.options.countOfGamesToShow&&this.events().toggleChildren(this.activeCounter).autoHover()},this.autoHover=function(){var e=this;return e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout(function(){e.toggleChildren(e.activeCounter),e.toggleChildren((e.activeCounter+1)%e.options.countOfGamesToShow),e.autoHover()}.bind(e),e.autoHoverDelay),e},this.events=function(){var e=this,t=function(t){e=this,clearTimeout(e.timeoutId),t!==e.activeCounter&&(e.activeCounterElement.length>0&&e.toggleChildren(e.activeCounter),e.toggleChildren(t))},i=function(){(e=this).autoHover()};return this.elements.each((function(n,a){jQuery(a).on({mouseenter:jQuery.proxy(t,e,n),mouseleave:jQuery.proxy(i,e)})})),this},this.toggleChildren=function(e){return this.activeCounter=e,this.activeCounterElement=jQuery(this.elements[e]),this.activeCounterElement.find("img").each((function(e,t){jQuery(t).toggleClass("hide")})),this},this.initialize()},Travian.Game.VideoFeatureEventListener=Object.create({VideoFeatureObject:null,options:null,infoScreenEnabled:!0,videoOptions:{},initialize:function(e){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=1e3,this.bindEvents();var t=Travian.Game.Preferences.get("adSalesVideoInfoScreen");return this.infoScreenEnabled=null===t||"enabled"===t,this},bindEvents:function(){var e=this;jQuery(window).on("showVideoWindow",(function(t,i){if(void 0===e.VideoFeatureObject||null===e.VideoFeatureObject){if(!e.DoubleClickPreventer.check())return!1;e.infoScreenEnabled?(e.videoOptions=i,e.showVideoInfoDialog()):e.VideoFeatureObject=e.startVideoDialog(i)}else e.VideoFeatureObject.options=Object.assign({},e.VideoFeatureObject.options,i||{}),e.VideoFeatureObject.reload()})),jQuery(window).on("showVideoWindowAfterInfoScreen",(function(){Travian.WindowManager.closeByContext("videoFeatureInfo"),void 0===e.VideoFeatureObject||null===e.VideoFeatureObject?e.VideoFeatureObject=e.startVideoDialog(e.videoOptions):(e.VideoFeatureObject.options=Object.assign({},e.VideoFeatureObject.options,options||{}),e.VideoFeatureObject.reload())})),jQuery(window).on("toggleAdSalesVideoInfoScreen",(function(t,i){Travian.Game.Preferences.set("adSalesVideoInfoScreen",i),e.infoScreenEnabled="enabled"===i})),jQuery(window).on("message",(function(e){Travian.Game.VideoFeatureEventListener.onMessage(e)}))},addEvent:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)},onMessage:function(e){if("http://media.oadts.com"===e.originalEvent.origin||"https://media.oadts.com"===e.originalEvent.origin){var t=e.originalEvent.data;if("videoStart"===t){var i=jQuery('input[name="vrid"]').val();i&&Travian.api("adSalesVideo/start",{data:{vrid:i}})}else if("noVideo"===t);else if("videoEnds"===t);else if(0===t.indexOf("videoEnds:")){var n=t.replace("videoEnds:",""),a=n.indexOf(":");Travian.api("adSalesVideo/build",{data:{vrid:n.substring(0,a),hash:n.substring(a+1)},success:function(e){window.location.href=e.redirectTo}})}}},startVideoDialog:function(e){return Travian.TimersAndCounters.suppressReloadEvent(),new Travian.Game.VideoFeatureShowVideo(e)},showVideoInfoDialog:function(){new Travian.Game.VideoFeatureInfo}}),jQuery((function(){Travian.Game.VideoFeatureEventListener.initialize()})),Travian.Game.PaymentWizardEventListener=Object.create({DoubleClickPreventer:null,PaymentWizardObject:null,defaultOptions:{},initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=2e3,this.bindEvents()},bindEvents:function(){var e=this;jQuery(window).on("paymentWizardOnCloseEvent",(function(t){e.PaymentWizardObject=null})),jQuery(window).on("startPaymentWizard",(function(t,i){if(i=Travian.Helpers.deepmergeObject({},e.defaultOptions,i||{}),!e.DoubleClickPreventer.check())return!1;void 0===e.PaymentWizardObject||null===e.PaymentWizardObject?e.PaymentWizardObject=e.startPaymentWizard(i):(e.PaymentWizardObject.options=Travian.Helpers.deepmergeObject({},e.PaymentWizardObject.options,i||{}),e.PaymentWizardObject.reload())}))},startPaymentWizard:function(e){return new Travian.Game.PaymentWizard(e)}}),jQuery((function(){Travian.Game.PaymentWizardEventListener.initialize()})),Travian.Game.WayOfPaymentEventListener=Object.create({WayOfPaymentObject:null,initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=500,this.bindEvents()},bindEvents:function(){var e=this;jQuery(window).on("buttonClicked",(function(t,i,n){"object"==typeof n.wayOfPayment&&e.DoubleClickPreventer.check()&&!jQuery(i).hasClass("disabled")&&(e.WayOfPaymentObject=e.startWayOfPayment(n.wayOfPayment.featureKey,n.wayOfPayment.context,n.wayOfPayment.dataCallback,n.wayOfPayment.confirmPopup,n.wayOfPayment.closeAllDialogs))})),jQuery(window).on("startWayOfPayment",(function(t,i,n,a,o,r){if(!e.DoubleClickPreventer.check())return!1;e.WayOfPaymentObject=e.startWayOfPayment(i,n,a,o,r)}))},startWayOfPayment:function(e,t,i,n,a){return new Travian.Game.WayOfPayment(e,t,i,n,a)}}),jQuery((function(){Travian.Game.WayOfPaymentEventListener.initialize()})),Travian.Game.ButtonEventListener={bindEvents:function(){jQuery(window).on("buttonClicked",(function(e,t,i){return jQuery(t).blur(),"object"==typeof i.dialog&&i.dialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Dialog.Ajax(i.dialog.cmd,i.dialog):"object"==typeof i.plusDialog&&i.plusDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.PlusDialog(i.plusDialog):"object"==typeof i.productionBoostDialog&&i.productionBoostDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.ProductionBoostDialog(i.productionBoostDialog):"object"==typeof i.reportSpamMessagesDialog&&i.reportSpamMessagesDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.ReportSpamMessagesDialog(i.reportSpamMessagesDialog):"object"==typeof i.goldclubDialog&&i.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.GoldclubDialog(i.goldclubDialog):void 0!==i.questButtonGainReward&&i.questButtonGainReward?Travian.Game.Quest.rewardButtonClick(i.questId):void 0!==i.questButtonOverview&&i.questButtonOverview?Travian.Game.Quest.openTodoListDialog():void 0!==i.questButtonOverviewAchievements&&i.questButtonOverviewAchievements?Travian.Game.Quest.openTodoListDialog("",!0):void 0!==i.questButtonCloseOverlay&&i.questButtonCloseOverlay?Travian.Game.Quest.closeDialog():void 0!==i.villageDialog&&i.villageDialog&&Travian.DoubleClickPreventer.globalCheck()?Travian.Game.showEditVillageDialog(i.villageDialog.title,i.villageDialog.description,i.villageDialog.saveText,i.villageDialog.villageId):void 0})),jQuery(window).on("tabClicked",(function(e,t,i){return"object"==typeof i.dialog&&i.dialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Dialog.Ajax(i.dialog.cmd,i.dialog):"object"==typeof i.plusDialog&&i.plusDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.PlusDialog(i.plusDialog):"object"==typeof i.goldclubDialog&&i.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.GoldclubDialog(i.goldclubDialog):void 0}))}},jQuery((function(){Travian.Game.ButtonEventListener.bindEvents()})),Travian.Game.WayOfPayment=function(e,t,i,n,a){this.featureKey=null,this.context=null,this.confirmPopup=null,this.closeAllDialogs=null,this.initialize=function(e,t,i,n,a){if(void 0===e)throw"Feature Key must not be empty!";var o={};"string"==typeof i&&"function"==typeof this[i]&&(o=this[i]()),"string"==typeof i&&"function"==typeof i.split(".").reduce((function(e,t){return e[t]}),window)&&(o=i.split(".").reduce((function(e,t){return e[t]}),window)()),"function"==typeof i&&(o=i()),this.featureKey=e,this.context=t,this.confirmPopup=n,this.closeAllDialogs=a,void 0!==n&&"object"==typeof n?this.checkConfirmation(o):this.bookPremiumFeature(o)},this.checkConfirmation=function(e){var t=this;Travian.api("player/gold-amount",{data:{},success:function(i){var n=i.goldAmount,a=e.coins;n>0&&a<=n?t.showCustomConfirmationPopup(t.confirmPopup,e):t.bookPremiumFeature(e)}})},this.showCustomConfirmationPopup=function(e,t){new Travian.Dialog.Ajax(e.name,{buttonOk:!1,data:{goldAmount:t.coins},context:this.context,elementFocus:e.options.elementFocus||".dialogButtonOk"})},this.bookPremiumFeature=function(e){var t={featureKey:this.featureKey,context:this.context,additionalData:e},i=this;Travian.api("premium",{data:t,success:function(e){e.hasOwnProperty("functionToCall")&&("function"==typeof i[e.functionToCall]?i[e.functionToCall](e.options,e.context):"function"==typeof window[e.functionToCall]&&window[e.functionToCall](e.options,e.context))},error:function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}})},this.renderDialog=function(e){var t=e.dialogOptions,i=e.html;return Travian.WindowManager.getWindowsByContext("convertGoldPopup")&&Travian.WindowManager.closeByContext("convertGoldPopup"),void 0!==this.closeAllDialogs&&null!==this.closeAllDialogs&&this.closeAllDialogs&&Travian.WindowManager.closeAllWindows(),e.context=this.featureKey,$dialog=new Travian.Dialog.Dialog(t),$dialog.setContent(i),$dialog.show(),$dialog},this.closeDialog=function(e,t){Travian.WindowManager.closeByContext(t)},this.hideDialog=function(e,t){Travian.WindowManager.hideByContext(t)},this.unhideDialog=function(e,t){Travian.WindowManager.showByContext(t)},this.reloadDialog=function(e,t){null===t&&void 0!==e.scope&&(t=e.scope.context),Travian.WindowManager.reloadWindowsByContext(t)},this.reloadUrl=function(){Travian.autoreload()},this.submitForm=function(e,t){var i=document.getElementById(e.buttonId);i&&"BUTTON"===i.tagName&&(i.type="submit",i.click())},this.openPaymentWizard=function(e,t){var i,n=Travian.emptyFunction;void 0!==e.goldProductId&&(i=e.goldProductId),void 0!==e.callback&&"function"==typeof e.callback&&(n=e.callback),"string"==typeof e.callback&&"function"==typeof e.callback.split(".").reduce((function(e,t){return e[t]}),window)&&(n=e.callback.split(".").reduce((function(e,t){return e[t]}),window)),this.closeDialog(e,"smallestPackage"),jQuery(window).trigger("startPaymentWizard",{data:{goldProductId:i,activeTab:"buyGold"},callback:n,callbackScope:this})},this.openPaymentWizardWithProsTab=function(){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:"pros"}})},this.initialize(e,t,i,n,a)},Travian.Game.WayOfPayment.constructor=Travian.Game.WayOfPayment,Travian.Game.PlusDialog=function(e){this.requestSent=!1,this.contentReloaded=!1,this.request=function(){var e=this;this.options.data.context=this.context;var t=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(t){case 1:default:e.setContent(e.createContent(e,i));break;case 2:e.setContent(i.html)}e.show()},error:function(t){e.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}}),this},this.createContent=function(e,t){var i=this,n=jQuery('<div class="paymentPopupDialogWrapper"></div>'),a=jQuery("<h1></h1>"),o=jQuery('<span class="headlineText">'+t.title+"</span>");a.append(o);var r=jQuery('<span class="goldWrapper">'+t.gold+"</span>");a.append(r),a.append(jQuery('<div class="clear"></div>'));var s=jQuery('<h2 class="subHeadline">'+t.subHeadLine+"</h2>"),l=jQuery('<div class="goldButtonWrapper"></div>'),d=jQuery("<div>"+t.goldButton+"</div>"),u=jQuery('<div class="buttonSubTitle">'+t.buttonSubtitle+"</div>");l.append(d),l.append(u);var c=jQuery('<h3 class="extraFeatures">'+t.plusPopupButtonExtraFeatures+"</h3>"),h=jQuery("<div></div>"),p=jQuery('<div class="furtherFeatures"></div>');jQuery.each(t.features,(function(e,t){e===i.options.featureKey?h.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(t.title,t.text,e)+"</div>")):p.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(t.title,t.text,e)+"</div>"))}));var m=jQuery('<p class="furtherInfos">'+t.furtherInfos+"</p>");return n.append(a),n.append(h),n.append(s),n.append(l),n.append(c),n.append(p),n.append(m),d.on("click",(function(){i.goldButtonClicked()})),n},this.reload=function(){this.contentReloaded=!0,Travian.Dialog.Ajax.prototype.reload.call(this)},this.goldButtonClicked=function(){return this.requestSent=!0,jQuery(window).trigger("startWayOfPayment",["plus","plus"]),!1},this.close=function(){if(this.requestSent&&this.contentReloaded)return Travian.autoreload();Travian.Dialog.Ajax.prototype.close.call(this)},Travian.Dialog.Ajax.call(this,"plus",Object.assign({data:{featureKey:e.featureKey},buttonOk:!1,context:"plus",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(e,t,i){return['<div class="featureImage '+i+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+e+"</h3>",'<div class="featureText">'+t+"</div>","</div>",'<div class="clear"></div>'].join("")}},e))},Travian.Game.PlusDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.PlusDialog.constructor=Travian.Game.PlusDialog,Travian.Game.GoldclubDialog=function(e){this.options=Object.assign({data:{featureKey:e.featureKey},buttonOk:!1,context:"goldclub",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(e,t,i){return['<div class="featureImage '+i+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+e+"</h3>",'<div class="featureText">'+t+"</div>","</div>",'<div class="clear"></div>'].join("")}},e),this.request=function(){var e=this;this.options.data.context=this.context;var t=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(t){case 1:default:e.setContent(e.createContent(e,i));break;case 2:e.setContent(i.html)}e.show()},error:function(t){e.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}}),this},this.initialize=function(){Travian.Dialog.Ajax.call(this,"goldclub",this.options)},this.createContent=function(e,t){var i=this,n=jQuery('<div class="paymentPopupDialogWrapper"></div>'),a=jQuery("<h1></h1>"),o=jQuery('<span class="headlineText">'+t.title+"</span>");a.append(o);var r=jQuery('<span class="goldWrapper">'+t.gold+"</span>");a.append(r),a.append(jQuery('<div class="clear"></div>'));var s=jQuery('<h2 class="subHeadline">'+t.subHeadLine+"</h2>"),l=jQuery('<div class="goldButtonWrapper"></div>'),d=jQuery("<div>"+t.goldButton+"</div>"),u=jQuery('<div class="buttonSubTitle">'+t.buttonSubtitle+"</div>");l.append(d),l.append(u);var c=jQuery('<h3 class="extraFeatures">'+t.goldclubPopupButtonExtraFeatures+"</h3>"),h=jQuery("<div></div>"),p=jQuery('<div class="furtherFeatures"></div>');jQuery.each(t.features,(function(e,t){e===i.options.featureKey?h.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(t.title,t.text,e)+"</div>")):p.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(t.title,t.text,e)+"</div>"))}));var m=jQuery('<p class="furtherInfos">'+t.furtherInfos+"</p>");return n.append(a),n.append(h),n.append(s),n.append(l),n.append(c),n.append(p),n.append(m),d.on("click",(function(){i.goldButtonClicked()})),n},this.goldButtonClicked=function(){return this.requestSend=!0,jQuery(window).trigger("startWayOfPayment",["goldclub","goldclub"]),!1},this.initialize()},Travian.Game.GoldclubDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.GoldclubDialog.constructor=Travian.Game.GoldclubDialog,Travian.Game.ProductionBoostDialog=function(e){this.options=Object.assign({data:{},buttonOk:!1,context:"productionBoost",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(e,t,i,n,a,o){return['<div class="featureImage '+e+'"></div>','<div class="featureContent">','<h3 class="featureTitle productionBoostTitle">'+t+"</h3>",'<div class="featureRemainingTime productionBoostSubtitle subtitle '+n+'">'+i+"</div>",'<div class="featureButton productionBoostButtonPos">'+a+"</div>",'<div class="featureDuration featureRenewal productionBoostButtonSubtitle subtitle">'+o+"</div>","</div>",'<div class="clear"></div>'].join("")}},e),this.request=function(){var e=this;this.options.data.context=this.context;var t=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(t){case 1:default:e.setContent(e.createContent(e,i)),e.bindElements();break;case 2:e.setContent(i.html),e.bindEvents()}e.show()},error:function(t){e.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}}),this},this.toggleAutoprolong=function(e,t){var i=this,n={featureKey:e,toggleAutoprolong:1};Travian.api("premium",{data:n,success:function(){Travian.WindowManager.reloadWindowsByContext(t)},error:function(){i.reload()}})},this.createContent=function(e,t){var i=jQuery('<div class="paymentPopupDialogWrapper"></div>'),n=jQuery('<h1 class="headline"></h1>').html(t.title),a=jQuery('<span class="goldWrapper"></span>').html(t.gold);n.append(a);var o=jQuery('<h3 class="subHeadLine"></h3>').html(t.productionBoostChooseText),r=jQuery('<div class="featureCollection" id="featureCollectionWrapper"></div>');for(var s in t.features){var l=jQuery('<div class="feature featureBooking">').html(e.options.featureMarkup(s,t.features[s].title,t.features[s].subtitle,t.features[s].subtitleClassExtension,t.features[s].button,t.features[s].buttonSubtitle));r.append(l)}var d=jQuery('<p class="furtherInfos"></p>').html(t.furtherInfos);return i.append(n),i.append(o),i.append(r),i.append(d),i},this.bindElements=function(){var e=this,t=jQuery("#featureCollectionWrapper");t.find("button.productionBoostButton").each((function(t,i){var n=jQuery(i);n.off("click"),n.on("click",(function(t){e.requestSend=!0;var i=jQuery(window),n=jQuery(this);return n.hasClass("wood")?i.trigger("startWayOfPayment",["productionboostWood","productionBoost"]):n.hasClass("clay")?i.trigger("startWayOfPayment",["productionboostClay","productionBoost"]):n.hasClass("iron")?i.trigger("startWayOfPayment",["productionboostIron","productionBoost"]):n.hasClass("crop")&&i.trigger("startWayOfPayment",["productionboostCrop","productionBoost"]),!1}))})),t.find(".checkbox").each((function(t,i){var n=jQuery(i);n.off("click"),n.on("click",(function(t){return n.hasClass("prolongProductionboostWood")?e.toggleAutoprolong("productionboostWood","productionBoost"):n.hasClass("prolongProductionboostClay")?e.toggleAutoprolong("productionboostClay","productionBoost"):n.hasClass("prolongProductionboostIron")?e.toggleAutoprolong("productionboostIron","productionBoost"):n.hasClass("prolongProductionboostCrop")?e.toggleAutoprolong("productionboostCrop","productionBoost"):!!n.hasClass("prolongPlus")&&e.toggleAutoprolong("plus","plus")}))}))},this.bindEvents=function(){var e=this,t=jQuery("#featureCollectionWrapper");t.find(".featureButton button").each((function(){var t=jQuery(this);t.off("click.productionBoost"),t.on("click.productionBoost",(function(){e.requestSend=!0}))}));var i=["Wood","Clay","Iron","Crop"];t.find("input[type=checkbox]").each((function(){var t=jQuery(this);t.off("change.productionBoost"),t.on("change.productionBoost",(function(){for(var t=jQuery(this),n=0;n<i.length;n++)if(t.hasClass("prolongProductionboost"+i[n])){e.toggleAutoprolong("productionboost"+i[n],"productionBoost");break}}))}))},this.close=function(){if(void 0!==this.requestSend&&!0===this.requestSend)return Travian.autoreload();Travian.Dialog.Ajax.prototype.close.call(this)},Travian.Dialog.Ajax.call(this,"premium/production-boost",this.options)},Travian.Game.ProductionBoostDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.ProductionBoostDialog.constructor=Travian.Game.ProductionBoostDialog,Travian.Game.GoldTransferDialog=function(e,t,i){this.request=function(){var e=this;return this.options.data.context=this.context,Travian.api(this.cmd,{data:this.options.data,success:function(t){if(!0===t.showDialog)return e.setContent(e.createContent(e,t)),e.show(),!0;Travian.autoreload()}}),this},this.createContent=function(e,t){return t.statusText},this.close=function(){Travian.autoreload()},Travian.Dialog.Ajax.call(this,"gtl",{data:{code:t,messageId:e,accept:i?1:0,refuse:i?0:1}})},Travian.Game.GoldTransferDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.GoldTransferDialog.constructor=Travian.Game.GoldTransferDialog,Travian.Game.Quest=Object.create({options:{listData:{},dialogListData:{}},setOptions:function(e){this.options=Object.assign({},this.options,e)},dialog:{quest:null,achievement:null},mentorClick:function(e){Travian.WindowManager.getWindowsByContext("quest").length>0?Travian.WindowManager.closeByContext("quest"):this.openTodoListDialog(this.options.dialogListData.answersLink)},rewardButtonClick:function(e){Travian.WindowManager.closeByContext("quest");var t="tasks",i={questTutorialId:e,action:"reward"};-1!==e.search(/DailyQuest/)&&(t="daily-quest",i={questId:e,action:"reward"}),Travian.api(t,{data:i})},openInformationDialog:function(e,t,i){var n="quest";-1===e.search(/Achievement/)&&-1===e.search(/DailyQuest/)||(n="achievement");var a=this;null===this.dialog[n]?(Travian.WindowManager.closeByContext("quest"),this.dialog[n]=new Travian.Dialog.Ajax("tasks",{data:{questTutorialId:e,action:i},context:n,buttonOk:!1,enableBackground:!1,darkOverlay:!1,draggable:!0,savePositionForSession:{preferenceKey:"QuestDialogPosition"},overlayCancel:!1,infoIcon:t,cssClass:"white questInformation "+e+" quest",preventFormSubmit:!0,buttonTextInfo:Travian.Translation.get("answers."+e.toLowerCase()+"_title")||"Answers",fx:{duration:0},onClose:function(){a.dialog[n]=null}})):(-1!==e.search(/DailyQuest/)?(this.dialog[n].cmd="daily-quest",this.dialog[n].options.data.questId=e):(this.dialog[n].cmd="tasks",this.dialog[n].options.data.questTutorialId=e),this.dialog[n].displayButtonOk(!1),this.dialog[n].options.data.action=i,this.dialog[n].options.infoIcon=t,this.dialog[n].options.buttonTextInfo=Travian.Translation.get("answers."+e.toLowerCase()+"_title")||"Answers",this.dialog[n].request()),this.dialog[n].wrapper.find("form").off("submit"),this.dialog[n].wrapper.find("form").on("submit",(function(e){return e.stopPropagation(),!1}))},openTodoListDialog:function(e,t){var i=this,n="tasks",a="quest",o=!1,r="",s=!1;null!=t&&(n="daily-quest",a="achievement",o=!0,r=Travian.Translation.get("allgemein.close_with_capital_c"),s=!0),null===this.dialog[a]?(Travian.WindowManager.closeByContext(n),this.dialog[a]=new Travian.Dialog.Ajax(n,{data:{},context:a,buttonOk:o,buttonTextOk:r,buttonCloseOnClickOk:s,enableBackground:!1,draggable:!0,infoIcon:e,savePositionForSession:{preferenceKey:"QuestDialogAchievementPosition"},overlayCancel:!1,cssClass:"white questTodoList",preventFormSubmit:!0,fx:{duration:0},onClose:function(){i.dialog[a]=null}})):(this.dialog[a].cmd=n,this.dialog[a].displayButtonOk(o),this.dialog[a].options.infoIcon=null,this.dialog[a].options.data.questId=void 0,this.dialog[a].options.data.questTutorialId=void 0,this.dialog[a].options.data.action=void 0,this.dialog[a].request())},bindListDelegation:function(e){var t=this;e.on("click",(function(e){e.stopPropagation();var i=jQuery(e.delegateTarget),n=i.attr("data-questId"),a=i.attr("data-category");a&&n&&t.openInformationDialog(n,t.options.listData[a].quests[n].answersLink)}))},addListData:function(e){for(var t in e=e||{})e.hasOwnProperty(t)&&(this.options.listData[t]=e[t])},closeDialog:function(){null!==this.dialog.quest&&this.dialog.quest.close()}}),Travian.Game.ReportSpamMessagesDialog={reportSpam:function(e,t,i,n,a){var o=[],r='<select size="1" id="spamReason">';for(var s in a)a.hasOwnProperty(s)&&(r+='<option value="'+s+'">'+a[s]+"</option>");r+='</select><br/><br/><span class="notice">'+n+"</span>";var l=new Travian.Dialog.Dialog({title:t,keepOpen:!0,buttonTextOk:i,preventFormSubmit:!0,onOpen:function(){l.disableForm()},onOkay:function(){o.length>0&&Travian.api("message/spam-report",{data:{messageId:e,spamReason:o.val()},success:function(e){void 0!==e.reportingSuccessful&&e.reportingSuccessful&&(l.setContent(e.reportingSuccessful),jQuery(".dialog button").html(e.closeButtonText),jQuery("#reportSpam").addClass("disabled").off("click").attr("onclick",(function(){return!1})),l.enableForm(),jQuery(".dialog form").on("submit",(function(e){e.stopPropagation(),l.close()})))}})}});l.setContent(r),l.show(),(o=jQuery("#spamReason")).on("change",(function(){var e="not_chosen"===o.val();l.toggleFormState(e)}))}},Travian.Game.Village={toggleBuildingLevels:function(){var e,t=jQuery("#levelSwitch"),i=t.find("svg.plusMinusToggle path");t.toggleClass("minus").toggleClass("plus"),(e=t.hasClass("plus"))?Travian.Game.Preferences.set("t4level",1):Travian.Game.Preferences.set("t4level",null);var n=new TimelineLite,a=jQuery(".buildingSlot .level");e?(TweenLite.to(i,.3,{morphSVG:"M5 0L5 5L0 5L0 10L5 10L5 15L10 15L10 10L15 10L15 5L10 5L10 0Z"}),n.staggerTo(".buildingSlot .level",.3,{opacity:0,marginTop:"20px",ease:Power4.easeOut},.02,"+=0",(function(){a.find("div.labelLayer").each((function(e,t){var i=jQuery(t),n=i.html(),a=i.parent();i.remove(),i=jQuery("<span></span>").html(n),a.html(i).removeClass("colorLayer")})),n.staggerTo(".buildingSlot .level",.3,{opacity:1,marginTop:0,ease:Power4.easeOut},.02)}))):(TweenLite.to(i,.3,{morphSVG:"M0 5L0 10L15 10L15 5Z"}),n.staggerTo(".buildingSlot .level",.3,{opacity:0,marginTop:"20px",ease:Power4.easeOut},.02,"+=0",(function(){a.find("span").each((function(e,t){var i=jQuery(t),n=i.html(),a=i.parent();i.remove(),i=jQuery("<div></div>").addClass("labelLayer").html(n),a.html(i).addClass("colorLayer")})),n.staggerTo(".buildingSlot .level",.3,{opacity:1,marginTop:0,ease:Power4.easeOut},.02)})))},initializeWallStates:function(){var e=jQuery(".a40 .level"),t=jQuery(".a40.bottom svg, .a40.top svg"),i=jQuery(t.find("path"));e.on("focus",(function(){t.addClass("hover focus")})),e.on("blur",(function(){t.removeClass("hover focus ")})),i.hover((function(){t.addClass("hover")}),(function(){t.removeClass("hover")})),i.on("mousedown touchstart",(function(){t.addClass("active")})),i.on("mouseup mouseleave touchend",(function(){t.removeClass("active")}))},toggleMobileUnitDisplay:function(){var e=Travian.Game.Preferences.get("mobileUnitDisplay");Travian.Game.Preferences.set("mobileUnitDisplay","expanded"===e?"collapsed":"expanded")},enableVillageListShortcuts:function(){let e=jQuery("#sidebarBoxVillagelist .content .villageList"),t=e.find(".listEntry:not(.active) .coordinatesGrid")[0];void 0!==t&&t.hasAttribute("data-x")&&t.hasAttribute("data-y")&&t.hasAttribute("data-did")&&t.hasAttribute("data-villagename")&&(e.addClass("shortcutsEnabled"),e.find(".listEntry:not(.active)").on("click",(function(e){let t=jQuery(e.target);if(t.is(".coordinatesGrid")||t.parents(".coordinatesGrid").length>0){e.preventDefault();let t=jQuery(this).find(".coordinatesGrid");if(t.length>0){let e=parseInt(t.data("x")),i=parseInt(t.data("y")),n=parseInt(t.data("did")),a=t.data("villagename");jQuery(window).trigger("travian.villageList.coordinatesShortcut",[e,i,n,a]),jQuery(this).parents(".sidebar.mobileOpened").removeClass("mobileOpened")}}})))}},Travian.Game.VillageList={closestDropContainer:null,enableDragAndDropSorting:function(){jQuery((function(){jQuery(".villageList .dragAndDrop").off("mousedown touchstart").on("mousedown touchstart",(function(t){t.preventDefault();let i=jQuery(this).parents(".listEntry");i.addClass("dragged");let n=i.clone();n.attr("id","dragElement"),n.css({width:i.width()}),i.parents(".dropContainer").prepend(n),e(t),Travian.Game.VillageList.closestDropContainer=i.parents(".dropContainer")})),jQuery(window).on("mousemove touchmove",(function(t){let i=jQuery(".villageList .listEntry.dragged");if(i.length>0){e(t);let n=Travian.getCursorPosition(t);if(Travian.Game.VillageList.closestDropContainer=i.parents(".dropContainer"),i.parents(".villageList").find(".dropContainer").each((function(){let e=jQuery(this);Math.abs(n.y-e.offset().top-e.height()/2)<Math.abs(n.y-Travian.Game.VillageList.closestDropContainer.offset().top-Travian.Game.VillageList.closestDropContainer.height()/2)&&(Travian.Game.VillageList.closestDropContainer=e)})),jQuery(".villageList .dropContainer").removeClass("highlightDropSection"),parseInt(Travian.Game.VillageList.closestDropContainer.find(".listEntry").data("did"))!==parseInt(i.data("did"))){let e=parseInt(Travian.Game.VillageList.closestDropContainer.data("sortindex"))>parseInt(i.parent(".dropContainer").data("sortindex"))?"down":"up";Travian.Game.VillageList.closestDropContainer.removeClass("up").removeClass("down").addClass("highlightDropSection "+e)}}})),jQuery(window).on("mouseup touchend",(function(e){let t=jQuery(".villageList .listEntry.dragged");if(t.length>0){let i=parseInt(t.parents(".dropContainer").data("sortindex")),n=parseInt(Travian.Game.VillageList.closestDropContainer.data("sortindex")),a=parseInt(t.data("did"));Travian.Game.VillageList.closestDropContainer.append(t),i!==n&&Travian.Game.VillageList.updateVillageSortIndex(a,n+ +(i<n));let o=Travian.Game.VillageList.closestDropContainer.parents(".villageList").find(".listEntry");n>i?o.each((function(){let e=jQuery(this);if(e.data("did")!==t.data("did")){let t=e.parent(".dropContainer"),a=t.data("sortindex");a>i&&a<=n&&t.prev(".dropContainer").append(e)}})):o.each((function(){let e=jQuery(this);if(e.data("did")!==t.data("did")){let t=e.parent(".dropContainer"),a=t.data("sortindex");a<i&&a>=n&&t.next(".dropContainer").append(e)}}));let r=jQuery("#dragElement"),s=Travian.Game.VillageList.closestDropContainer.find(".listEntry:not(#dragElement)");s.addClass("hidden");let l=s.offset(),d=jQuery(window).scrollTop();if("auto"===jQuery("#sidebarAfterContent").css("overflow")){let t=jQuery(e.target).parents(".sidebarBoxWrapper").css("transform").match(/-?[\d.]+/g);if(null!==t){t=parseFloat(t[0]);let e=jQuery(".villageList");d=0,l.left=e.position().left-10,l.top=s.parents(".sidebarBox").position().top/t+s.parent(".dropContainer").position().top/t+10}}r.animate({left:l.left,top:l.top-d},250),setTimeout((function(){s.removeClass("hidden"),r.remove()}),250),t.removeClass("dragged"),jQuery(".villageList .dropContainer").removeClass("highlightDropSection")}else jQuery("#dragElement").remove()}));let e=function(e){let t=Travian.getCursorPosition(e),i=jQuery("#sidebarAfterContent");const n="auto"===i.css("overflow");let a=jQuery(window).scrollTop();n&&(a=a-i.scrollTop()+i.offset().top);let o=jQuery("#dragElement"),r=o.offset(),s=o.find(".dragAndDrop svg"),l=s.offset(),d=r.left-l.left+s.width()/2,u=l.top-r.top+s.height()/2+a;if(n){let i=jQuery(e.target).parents(".sidebarBoxWrapper").css("transform").match(/-?[\d.]+/g);null!==i&&(i=parseFloat(i[0]),jQuery("body").hasClass("rtl")?t.x=(t.x+o.width()/2)/i+10:t.x=(t.x-o.parents(".sidebarBox").offset().left)/i-10,t.y/=i,u=u/i+u-a)}o.css({left:t.x+d,top:t.y-u})}}))},updateVillageSortIndex:function(e,t){Travian.api("village/update-sort-index/"+e,{data:{to:t},success:Travian.emptyFunction(),error:this.onError})},onError:function(e){const t=new Travian.Dialog.Dialog({buttonOk:!0,buttonCancel:!1,buttonCloseOnClickOk:!0,preventFormSubmit:!0,version:2,cssClass:"plain"});t.setContent(e.message),t.show()}},Travian.Game.Village.RearrangeBuildings={did:null,step:1,slotFrom:null,slotTo:null,hash:null,buildingSlotPositions:{},isMousedown:!1,isDragging:!1,isDropping:!1,dragObject:null,lastCursorPosition:{x:null,y:null},closestBuildingSlot:null,initialize:function(e){this.did=e,Travian.Game.Layout.disable(),Travian.Game.contextHelpData={},jQuery("body").addClass("rearrangeBuildings"),jQuery("#contentOuterContainer .rearrangeBuildings").prependTo("#background");let t=jQuery("#background .rearrangeBuildings").removeClass("hide");setTimeout((function(){t.addClass("show")}),1),this.hash=jQuery.md5(JSON.stringify(this.getBuildingPositions())),this.bindEvents(),this.calculateBuildingSlotPositions(),this.enableDragAndDrop()},bindEvents:function(){let e=this,t=jQuery("#villageContent");t.find(".buildingSlot.movable[data-aid]").off("mouseup touchend").on("mouseup touchend",(function(){if(!e.isDragging){let t=jQuery(this),i=parseInt(t.data("aid")),n=parseInt(t.data("gid"));switch(e.step){case 1:0!==n&&(e.slotFrom=i,e.step=2);break;case 2:e.slotTo=i,e.step=3;break;default:e.slotFrom=null,e.slotTo=null,e.step=1}e.executeStep()}}));let i=t.find(".buildingSlot svg path, .buildingSlot .level");i.off("hover").off("mousedown touchstart").off("mouseup mouseleave blur touchend"),i.hover((function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("hover")}),(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("hover")})),i.on("mousedown touchstart",(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("active")})),i.on("mouseup mouseleave blur touchend",(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("active")})),jQuery(window).on("resize",(function(){e.calculateBuildingSlotPositions()}))},executeStep:function(){let e=this,t=jQuery("#villageContent"),i=jQuery("#background .rearrangeBuildings").find(".instructions"),n=i.find(".step1"),a=i.find(".step2");switch(e.step){case 2:let o=t.find(".buildingSlot.aid"+e.slotFrom).addClass("selected"),r=o.data("name"),s=o.find(".level").data("level");a.html(Travian.Translation.get("gid15.rearrangeBuildings_step2").replace("[NAME]","<strong>"+r+"</strong>").replace("[LEVEL]",s)),n.removeClass("active"),a.addClass("active"),t.addClass("selectTarget");break;case 3:e.animateMovement(),t.removeClass("selectTarget"),i.find(".step.active").removeClass("active"),n.addClass("active")}},animateMovement:function(){let e=this,t=e.slotFrom===e.slotTo;if(!e.isDragging&&e.slotFrom===e.slotTo)return void e.animationCallback();let i=jQuery("#villageContent"),n=jQuery("body").hasClass("rtl")?"right":"left",a=i.find(".buildingSlot.aid"+e.slotFrom),o=i.find(".buildingSlot.aid"+e.slotTo),r=e.isDragging?i.find(".dragContainer"):i.find(".animationContainer.buildingFrom"),s=i.find(".animationContainer.buildingTo");a.addClass("animating"),o.addClass("animating"),e.isDragging||(r.empty(),a.find("img.building").clone().appendTo(r),a.find(".level").clone().appendTo(r)),t||(s.empty(),o.find("img.building").clone().appendTo(s),o.find(".level").clone().appendTo(s));let l={};e.isDragging||(l[n]=a.css(n),l.top=a.css("top"),r.css(l)),l[n]=o.css(n),l.top=o.css("top"),s.css(l),r.animate(l,e.isDragging?150:300),t||(l[n]=a.css(n),l.top=a.css("top"),s.animate(l,300)),setTimeout((function(){e.animationCallback(),a.removeClass("animating"),o.removeClass("animating"),r.empty(),s.empty()}),300)},animationCallback:function(){let e=this;if(e.move(),e.isDragging){let t=jQuery("#villageContent"),i=t.find(".dragContainer");e.dragObject.removeClass("dragged"),e.dragObject=null,e.isDragging=!1,e.isDropping=!1,t.removeClass("dragMode"),i.removeClass("enabled"),i.empty()}},move:function(){let e=this,t=jQuery("#villageContent"),i=t.find(".buildingSlot.aid"+e.slotFrom),n=t.find(".buildingSlot.aid"+e.slotTo);if(i.length>0&&n.length>0){let t=i.html(),a=n.html(),o=i.data("building-id"),r=n.data("building-id"),s=i.data("gid"),l=n.data("gid"),d=i.data("name"),u=n.data("name");i.html(a),n.html(t),i.data("gid",l),i.data("building-id",r),i.removeClass("g"+s).addClass("g"+l),n.data("gid",s),n.data("building-id",o),n.removeClass("g"+l).addClass("g"+s),i.data("name",u),n.data("name",d),jQuery(".buildingSlot .hover").removeClass("hover"),e.bindEvents(),i.removeClass("selected"),e.step=1,e.slotFrom=null,e.slotTo=null,e.updateProceedButton()}},getBuildingPositions:function(){let e=jQuery("#villageContent").find(".buildingSlot[data-aid]"),t={};return e.each((function(e,i){let n=jQuery(i);t[n.data("aid")]=n.data("building-id")||null})),t},isAllowedToProceed:function(){return this.hash!==jQuery.md5(JSON.stringify(this.getBuildingPositions()))},updateProceedButton:function(){let e=jQuery("#background .rearrangeBuildings").find("button.confirm");this.isAllowedToProceed()?(e.removeClass("disabled"),Travian.Tip.setContent(e,Travian.Translation.get("gid15.rearrangeBuildings"))):(e.addClass("disabled"),Travian.Tip.setContent(e,Travian.Translation.get("gid15.rearrangeToContinue")))},proceed:function(){if(this.isAllowedToProceed()){let e=new Travian.Dialog.Dialog({context:"rearrangeBuildingsConfirm",cssClass:"rearrangeBuildingsConfirmDialog",preventFormSubmit:!0,buttonOk:!1,relativeTo:jQuery("#background .rearrangeBuildings button.confirm")});e.setContent(jQuery("#background .rearrangeBuildings .proceedDialog").html()),e.show()}},wayOfPaymentDataCallback:function(){return{did:Travian.Game.Village.RearrangeBuildings.did,buildingPositions:Travian.Game.Village.RearrangeBuildings.getBuildingPositions()}},abort:function(){if(this.isAllowedToProceed()){let e=new Travian.Dialog.Dialog({context:"rearrangeBuildingsAbort",cssClass:"rearrangeBuildingsAbortDialog",preventFormSubmit:!0,buttonOk:!1,buttonCancel:!1,overlayCancel:!1,relativeTo:jQuery("#background .rearrangeBuildings .container .close svg")});e.setContent(jQuery("#background .rearrangeBuildings .abortDialog").html()),e.show()}else window.location.href="/dorf2.php"},enableDragAndDrop:function(){let e=this,t=jQuery("#background .rearrangeBuildings").find(".instructions"),i=jQuery("#villageContent"),n=jQuery("body").hasClass("rtl")?"right":"left";jQuery(".buildingSlot.movable[data-aid]").on("mousedown touchstart",(function(t){if(t.preventDefault(),e.isMousedown=!0,!e.isDragging&&!e.isDropping){let i=jQuery(this);0!==parseInt(i.data("gid"))?(e.dragObject=i,e.lastCursorPosition=Travian.getCursorPosition(t)):e.dragObject=null}})),jQuery(window).on("mousemove touchmove",(function(a){if(e.isMousedown&&1===e.step&&null!==e.dragObject){let o=Travian.getCursorPosition(a);if((!("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)||new Date-e.lastCursorPosition.timestamp>200)&&(o.x!==e.lastCursorPosition.x||o.y!==e.lastCursorPosition.y)){e.isDragging=!0,i.addClass("dragMode");let a=i.find(".dragContainer");if(!a.hasClass("enabled")){let a=jQuery(e.dragObject);a.addClass("dragged");let o=i.find(".dragContainer");o.empty(),o.addClass("enabled"),a.find("img.building").clone().appendTo(o),a.find(".level").clone().appendTo(o),a.find("svg.buildingShape:not(.iso)").clone().appendTo(o);let r={};r[n]=a.css(n),r.top=a.css("top"),o.css(r),t.find(".step.active").removeClass("active");let s=a.data("name"),l=a.find(".level").data("level");t.find(".dragAndDrop").html(Travian.Translation.get("gid15.rearrangeBuildings_dragAndDrop").replace("[NAME]","<strong>"+s+"</strong>").replace("[LEVEL]",l)).addClass("active")}let r=i.offset(),s=r.left+a.width()/2,l=r.top+a.height()/2,d={};d[n]="left"===n?o.x-s:jQuery(window).outerWidth()-o.x-s+10,d.top=o.y-l,a.css(d),e.closestBuildingSlot=e.dragObject;let u=null;Object.keys(e.buildingSlotPositions).map((function(t){let i=e.buildingSlotPositions[t],n=o.y-a.height()/2,r=o.x-a.width()/2,s=Math.sqrt(Math.pow(i.left-r,2)+Math.pow(i.top-n,2));(null===u||s<u)&&(e.closestBuildingSlot=jQuery(".buildingSlot.aid"+t),u=s)})),jQuery(".dropTarget").removeClass("dropTarget"),e.closestBuildingSlot.addClass("dropTarget")}}})),jQuery(window).on("mouseup touchend",(function(){!e.isDropping&&e.isDragging&&null!==e.dragObject&&e.dragObject.length>0&&e.closestBuildingSlot.length>0&&(e.isDropping=!0,e.slotFrom=e.dragObject.data("aid"),e.slotTo=e.closestBuildingSlot.data("aid"),e.step=3,e.executeStep()),e.isMousedown=!1}))},calculateBuildingSlotPositions:function(){let e=this;e.buildingSlotPositions={},jQuery("#villageContent .buildingSlot.movable[data-aid]").each((function(){let t=jQuery(this),i=t.data("aid"),n=t.offset();e.buildingSlotPositions[i]={left:n.left,top:n.top}}))}},Travian.TabManager={initializeOnPageLoad:function(){var e=window.location.hash.trim();""!==e&&Travian.TabManager.applyAnchor(e)},initializeOnDialogLoad:function(){jQuery(".dialog .contentNavi .tabItem:not([id])").off("click.tabManger").on("click.tabManger",(function(e){e.preventDefault();var t=jQuery(this),i=t.attr("href");"#"!==i&&Travian.api(i,{success:function(e){var i=Travian.WindowManager.getWindowsByContext(t.parents(".dialogWrapper").data("context"))[0];i.updateInfoButton(e.options),i.setContent(e.content),void 0!==e.options.cssClass&&i.updateCssClass(e.options.cssClass),Travian.TabManager.initializeOnDialogLoad()},error:function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error">'+e.status+" "+e.statusText+"</div>").show()}},"GET")}))},handlers:{payment:function(e){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:e}})}},applyAnchor:function(e){var t=e.split("-"),i=t[0].substring(1);delete t[0],t.length&&void 0!==Travian.TabManager.handlers[i]&&Travian.TabManager.handlers[i](t.join(""))}},jQuery((function(){Travian.TabManager.initializeOnPageLoad()})),Travian.Game.Vacation={dialog:null,updateVacationTime:function(e,t){var i=parseInt(Date.now())+864e5*parseInt(e);jQuery("#vacationTime").html(function(e,t){var i=function(e){return e<10?"0"+e:e},n=new Date(e.getTime()+6e4*e.getTimezoneOffset()+1e3*t);return i(n.getDate())+"."+i(n.getMonth()+1)+"."+i(n.getFullYear()%100)+", "+i(n.getHours())+":"+i(n.getMinutes())}(new Date(i),t))},closeDialog:function(){null!==this.dialog&&this.dialog.close()},showDialog:function(e){this.dialog=new Travian.Dialog.Dialog({buttonOk:!1,submitMethod:"post",submitUrl:"/options/vacation",keepOpen:!0}),this.dialog.setContent(e),this.dialog.show()},openConfirmation:function(){Travian.api("vacation-mode/confirmation",{data:{params:jQuery("#dayInput").val()},success:function(e){""!==e.html?Travian.Game.Vacation.showDialog(e.html):Travian.Game.Vacation.closeDialog()}})}},Travian.Game.Arifact={setAutoProlongue:function(e,t){Travian.api("artifact",{data:{id:e,action:"reactivate",state:t?1:0}})}},Travian.Game.ContextualHelp={groupName:[],helpData:[],stickyElements:[],documentDimensions:{width:0,height:0},currentStep:0,isRTL:!1,isInitialized:!1,isMousedown:!1,isKeydown:!1,keyDownInterval:null,overlay:!1,initialize:function(){this.reset();var e=this,t=jQuery(document);jQuery((function(){e.documentDimensions.width=t.width(),e.documentDimensions.height=t.height(),e.isRTL=jQuery("body").hasClass("rtl");var i=Travian.Game.contextHelpData,n=i.steps||[];e.groupName=i.groupName,e.restartableGroup=i.restartableGroup,n.forEach((function(t){var i=t.stickToElement;e.addStep(t.content,i,t.boxPosition,t.arrowPosition,!!t.dismissButton,t.delay,t.teaser)}))})),jQuery(window).on("resize scroll click keyup travian.map.zoomed travian.map.imageLoaded travian.toggleMapDialog",(function(){e.updateStickyElements(),e.updateElements()})),t.on("mousedown touchstart",(function(){e.isMousedown=!0})),t.on("mouseup touchend",(function(){e.isMousedown=!1})),t.on("keydown",(function(){e.isKeydown=!0,e.keyDownInterval&&clearInterval(e.keyDownInterval),e.keyDownInterval=setInterval((function(){e.updateStickyElements(),e.updateElements()}),25)})),t.on("keyup",(function(){e.isKeydown=!1,clearInterval(e.keyDownInterval)})),t.on("mousemove",(function(){e.isMousedown&&(e.updateStickyElements(),e.updateElements())})),jQuery(window).on("travian.contextualHelp.add",(function(t,i,n,a,o,r,s,l){e.addStep(i,n,a,o,r,s,l)}))},addStep:function(e,t,i,n,a,o,r){var s=this,l=0===s.helpData.length;o=void 0!==o?o:0,r=void 0!==r?r:null,!1!==s.registerStickyElement(t)&&(s.helpData.push({content:e,stickToElement:t,boxPosition:i,arrowPosition:n,dismissButton:a,delay:o,teaser:r,active:l,dimensions:{width:0,height:0}}),setTimeout((function(){l&&(s.initialRender(),jQuery(".contextualHelp .helpBody nav svg").on("click",(function(){jQuery(this).hasClass("chevronForward")?s.currentStep+=1:s.currentStep-=1,s.updateElements()})),jQuery(".contextualHelp .helpBody nav button").on("click",(function(){s.close()})),s.isInitialized=!0),jQuery("<div></div>").appendTo(".contextualHelp .helpBody .steps").html(e),jQuery("<div></div>").appendTo(".contextualHelp .helpBody .progress"),null!==r&&!1!==s.registerStickyElement(r.stickToElement)&&jQuery("<div></div>").insertAfter(".contextualHelp .helpBody .steps").addClass("teaser hide").html(r.content),l||jQuery(".contextualHelp .helpBody .steps div:last-of-type").addClass("hide"),s.updateElements()}),1e3*o))},close:function(){var e=this;jQuery("#contextualHelp").addClass("close").fadeOut(150),setTimeout((function(){Travian.api("contextHelp/finish/"+e.groupName,{success:function(){e.reset()}},"GET")}),150)},restart:function(){var e=this;this.restartableGroup!=this.groupName&&Travian.api("contextHelp/restart/"+this.restartableGroup,{success:function(t){var i=t.helpData;i.groupName&&i.steps&&i.steps.length>0&&(e.reset(),e.groupName=i.groupName,i.steps.forEach((function(t){var i=t.stickToElement;e.addStep(t.content,i,t.boxPosition,t.arrowPosition,!!t.dismissButton,t.delay,t.teaser)})))}},"GET")},reset:function(){this.groupName="",this.helpData=[],this.stickyElements=[],this.currentStep=0,jQuery("#contextualHelp").remove()},updateElements:function(e){void 0===e&&(e=!1);var t=this;if(!t.isInitialized||0===t.helpData.length)return;var i=t.helpData[t.currentStep],n=jQuery(window),a=jQuery(".contextualHelp .helpBody"),o=a.find(".steps div"),r=a.find("nav"),s=r.find("svg"),l=r.find(".chevronForward"),d=r.find(".chevronBack"),u=r.find("button"),c=a.find(".progress div"),h=jQuery(".contextualHelp .pointingArrow"),p=a.find(".teaser:eq("+t.currentStep+")");r.removeClass("hide"),1!==t.helpData.length||t.helpData[0].dismissButton||r.addClass("hide");var m=p.length>0&&!p.hasClass("hide");o.addClass("hide"),c.removeClass("active"),s.addClass("hide"),u.addClass("hide"),m||(a.find(".steps div:nth-of-type("+(t.currentStep+1)+")").removeClass("hide"),a.find(".progress div:nth-of-type("+(t.currentStep+1)+")").addClass("active"),t.helpData.length>1&&(t.currentStep>0&&d.removeClass("hide"),t.currentStep+1<t.helpData.length&&l.removeClass("hide")),i.dismissButton&&u.removeClass("hide"));var v=jQuery("#contextualHelp .contextualHelp"),f=v.outerWidth(),g=v.outerHeight();v.offset();let y=parseInt(v.data("currentstep"));v.removeClass("hide");var b=t.stickyElements.filter((function(e){return e.selector===i.stickToElement}))[0];if(null===i.teaser||jQuery(b.selector).is(":visible")){if(m)return p.addClass("hide"),void t.updateElements()}else{var T=t.stickyElements.filter((function(e){return e.selector===i.teaser.stickToElement}))[0];if(jQuery(T.selector).length>0&&(b=T,!m))return p.removeClass("hide"),void t.updateElements()}var C=b.isMapElement?b.mapSelector:b.selector;if(jQuery(C).is(":visible")){var w,x,k,S=27,j=m?i.teaser.boxPosition:i.boxPosition,M=m?i.teaser.arrowPosition:i.arrowPosition;let a=y!==t.currentStep;if(b.y1-5>n.height()+n.scrollTop()){var P=j;switch(j="above",k="from",x=n.height()-g,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100),P){case"before":M=100,w=b.x1-f+S;break;case"after":M=0,w=b.x2-S}v.addClass("teasing")}else switch(v.removeClass("teasing"),j){case"above":x=b.y1-g-5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100),k="from",x<0&&(j="below",x=b.y2+5),w<0&&(j="after",w=b.x2+5,x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100),k="top"),w+f>t.documentDimensions.width&&(j="before",w=b.x1-f-5,x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100),k="top");break;case"below":x=b.y2+5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100),k="from",x+g>n.height()+n.scrollTop()&&(j="above",x=b.y1-g-5),w<0&&(j="after",w=b.x2+5,x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100),k="top"),w+f>t.documentDimensions.width&&(j="before",w=b.x1-f-5,x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100),k="top");break;case"before":w=b.x1-f-5,k="top",(x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100))<0&&(j="below",x=b.y2+5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100),k="from"),x+g>n.height()+n.scrollTop()&&(j="above",k="from",M=100,x=b.y1-g-5,w=b.x1-f+S),w<0&&(j="after",w=b.x2+5),(w+f>t.documentDimensions.width||e&&v.hasClass("above"))&&(j="above",k="from",M=50,x=b.y1-g-5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100));break;case"after":w=b.x2+5,k="top",(x=b.y1-(g-b.height)/2+(g-54)*(.5-M/100))<0&&(j="below",x=b.y2+5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100),k="from"),x+g>n.height()+n.scrollTop()&&(j="above",k="from",M=0,x=b.y1-g-5,w=b.x2-S),w+f>t.documentDimensions.width&&(j="before",w=b.x1-f-5),(w<0||e&&v.hasClass("above"))&&(j="above",k="from",M=50,x=b.y1-g-5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100))}if(b.isMapElement){var D=jQuery("body.map.fullScreen");if(D.length<=0&&(D=jQuery("#content.map")),D.length>0){var I=D.outerWidth(),Q=D.outerHeight(),O=D.offset();b.x2<=O.left||b.x1>=O.left+I||b.y2<=O.top||b.y2>=O.top+Q?v.addClass("hide"):D.hasClass("fullScreen")||(M=b.x2<=O.left+I/2?80:20,x="below"===(j=b.y2<=O.top+Q/2?"above":"below")?b.y2+5:b.y1-g-5,w=b.x1-(f-b.width)/2+(f-54)*(.5-M/100))}}var L=!v.hasClass(j);v.removeClass("above").removeClass("below").removeClass("before").removeClass("after").addClass(j),L||(t.isRTL?a?v.stop().animate({right:w+"px",top:x+"px"},250):v.css({right:w+"px",top:x+"px"}):a?v.stop().animate({left:w+"px",top:x+"px"},250):v.css({left:w+"px",top:x+"px"}),"from"===k?t.isRTL?h.css({top:0,right:M+"%"}):h.css({top:0,left:M+"%"}):t.isRTL?h.css({right:0,top:M+"%"}):h.css({left:0,top:M+"%"}),v.data("currentstep",t.currentStep)),L&&t.updateElements(!0)}else v.addClass("hide")},registerStickyElement:function(e){var t=this,i=[];i.selector=e,i.isMapElement=/^MapID/.test(e),i.mapSelector="."+Travian.Game.Map.mapIds[e.replace("MapID.","")],jQuery("#contextualHelp").removeClass("overlay"),/\.dialog/.test(e)&&(this.overlay=!0);var n=jQuery(i.isMapElement?i.mapSelector:e);if(!(n.length>0))return!1;var a=n.offset();i.width=n.outerWidth(),i.height=n.outerHeight();var o=jQuery(window),r=t.documentDimensions.width-o.width();t.isRTL?(i.x1=t.documentDimensions.width-r-a.left-i.width,i.x2=t.documentDimensions.width-r-a.left):(i.x1=a.left,i.x2=a.left+i.width),i.y1=a.top,i.y2=a.top+i.height,t.stickyElements.push(i)},updateStickyElements:function(){var e=this,t=jQuery(window),i=e.documentDimensions.width-t.width();e.stickyElements.map((function(t){var n=jQuery(t.isMapElement?t.mapSelector:t.selector);if(n.length>0){var a=n.offset();t.width=n.outerWidth(),t.height=n.outerHeight(),e.isRTL?(t.x1=e.documentDimensions.width-i-a.left-t.width,t.x2=e.documentDimensions.width-i-a.left):(t.x1=a.left,t.x2=a.left+t.width),t.y1=a.top,t.y2=a.top+t.height}else t.isMapElement&&(t.mapSelector="."+Travian.Game.Map.mapIds[t.selector.replace("MapID.","")])}));var n=jQuery(document);e.documentDimensions.width=n.width(),e.documentDimensions.height=n.height()},initialRender:function(){jQuery('<div id="contextualHelp"></div>').prependTo("body"),this.overlay&&jQuery("#contextualHelp").addClass("overlay");let e='<div class="contextualHelp" data-currentstep="0"><div class="arrowContainer"><svg class="pointingArrow" viewBox="0 0 20 20"><path d="M20 0L1 10L20 20"/></svg></div> <div class="helpBody"><div class="progress"></div><div class="steps"></div><nav>   <svg class="chevronBack" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M19 1L1 10L19 19"/>   </svg>   <svg class="chevronForward" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M1 1L19 10L1 19"/>   </svg>   <button type="button" class="textButtonV1">'+Travian.Translation.get("allgemein.ok")+"</button></nav></div></div>";jQuery(e).appendTo("#contextualHelp")}},Travian.Game.Profile={},Travian.Game.Profile.Languages={init:function(e,t,i,n){var a,o={},r=!1,s=!1,l="",d=jQuery(e),u=jQuery(e+" #playerLanguages"),c=jQuery(e+" .addLanguageButton"),h=function(){r=Object.keys(o).length>1,s=Object.keys(o).length<4,r?u.addClass("deletable"):u.removeClass("deletable"),s?d.addClass("addable"):d.removeClass("addable")};let p=function(t){if(void 0!==t&&!o.hasOwnProperty(t)){let n=i[t],a=n.langNative+" ("+n.countryNative+")";Travian.SVGHandler.get("flags/"+n.flag+".svg",(function(i){u.append(jQuery('<div class="flagContainer" title="'+a+'" data-flag="'+t+'" >'+i+'<input value="'+t+'" type="hidden" name="languages[]"/></div>')),Travian.Tip.updateAllInElement(e)}),{attributes:{title:a,class:"languageFlag"},titleFollowsPath:!1}),o[t]=t}};var m=function(t,i){Object.values(t).length>0&&(p(t.language),h()),i.close(),Travian.Tip.updateAllInElement(e),Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(n))};t.forEach((function(e){p(e)})),h(),u.on("click",".flagContainer",(function(e){var t=jQuery(e.target);if(1===Object.keys(o).length)return!0;var i=t.data("flag");delete o[i],t.remove(),h(),Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(n))})),c.on("click","",(function(e){e.preventDefault();var t={},i=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,cssClass:"profileLanguages"});i.form.keydown((function(e){13===e.keyCode&&m(t,i)}));var n=function(e,t){var i=Object.values(o),n="profile-languages?"+jQuery.param({query:t,languages:i});Travian.api(n,{success:function(t){e(t)}},"GET","html")};jQuery("body").off("keyup",'#dialogLanguagesList input[type="text"]').on("keyup",'#dialogLanguagesList input[type="text"]',(function(e){clearTimeout(a),a=setTimeout((function(){l=jQuery(e.target).val(),n((function(e){i.setContent(e),jQuery('#dialogLanguagesList input[type="text"]').val(l),jQuery('#dialogLanguagesList input[type="text"]').focus()}),jQuery(e.target).val())}),700)})),jQuery("body").off("click","#dialogLanguagesList label").on("click","#dialogLanguagesList label",(function(e){var i=jQuery(this).data("language");t={language:i}})),jQuery("body").off("click","#dialogLanguagesList button").on("click","#dialogLanguagesList button",(function(e){m(t,i)})),n((function(e){i.setContent(e).show(),jQuery('#dialogLanguagesList input[type="text"]').focus()}))}))}},Travian.Game.ReferAFriend={navigate:function(e,t){Travian.api(e,{success:function(e){var i=Travian.WindowManager.getWindowsByContext(t)[0];i.updateInfoButton(e.options),i.setContent(e.content),void 0!==e.options.cssClass&&i.updateCssClass(e.options.cssClass),Travian.TabManager.initializeOnDialogLoad()},error:function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error">'+e.status+" "+e.statusText+"</div>").show()}},"GET")},initInviteForm:function(){var e=jQuery(".referAFriend .sendForm"),t=e.find(".receiverBlock"),i=t.find(".receiverLine"),n=e.find(".addReceiver"),a=e.parents(".dialogContents form");n.off("click").on("click",(function(e){if(i.length<6){var a=Travian.Translation.translate("{earnGoldContentMailSendReceiverCount}").replace("[RECEIVER_COUNT]",i.length+1),o=jQuery('<label class="receiverLine added"><span>'+a+'</span> <input type="text" class="text" name="receiver[]" /></label>');t.append(o),6===(i=t.find(".receiverLine")).length&&n.addClass("hide")}})),a.off("submit").on("submit",(function(t){t.preventDefault(),e.find("#inviteFormSubmit").prop("disabled","disabled");var i=[];e.find('input[name="receiver[]"]').each((function(e,t){i.push(jQuery(t).val())})),Travian.api("referAFriendDialog/sendInvites",{data:{receiver:i,message:e.find("textarea.earnGoldSendMailMessage").val()},success:function(e){var t=Travian.WindowManager.getWindowsByContext("plusSupport")[0];t.updateInfoButton(e.options),t.setContent(e.content),void 0!==e.options.cssClass&&t.updateCssClass(e.options.cssClass),Travian.TabManager.initializeOnDialogLoad()},error:function(e){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error">'+e.status+" "+e.statusText+"</div>").show()}},"POST")}))}},Travian.Game.Manual={dialog:null,position:null,open:function(e,t){void 0===e&&(e=0),void 0===t&&(t=0);let i=this;new Travian.api("manual/"+e+"/"+t,{success:function(e){let t=jQuery(".dialogWrapper[data-context=manual]");0===t.length?(i.dialog=new Travian.Dialog.Dialog({context:"manual",title:Travian.Translation.translate("{allgemein.anleitung}"),buttonOk:!1,enableBackground:!1,draggable:!0,cssClass:"manual"}),i.position=null):i.position=t.position(),i.dialog.setContent(e.html),i.dialog.show(),null!==i.position&&i.dialog.setPosition({x:i.position.left,y:i.position.top})},error:function(e){let t=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0});t.setContent(e.message),t.show()}},"GET")}},Travian.Game.Map=function(){var e=0;return{_map:null,Containers:null,version:1,getNewId:function(){return"mapId"+ ++e},mapIds:{},isPositionInRect:function(e,t){return e.x0<=t.x&&e.y0<=t.y&&t.x<=e.x1&&t.y<=e.y1},register:function(e){},wrapCoordinate:function(e,t){var i=Travian.Defaults.Map.Size;return{$x:((e-i.left)%i.width+i.width)%i.width+i.left,$y:((t-i.bottom)%i.height+i.height)%i.height+i.bottom}},xy2id:function(e,t){var i=this.wrapCoordinate(e,t),n=Travian.Defaults.Map.Size;return(n.top-i.$y)*n.width+(i.$x-n.left)+1}}}(),Travian.Game.Map.Base=function(e,t){var i;for(i in this.options=Object.assign({},e),e)e.hasOwnProperty(i)&&(this[i]=e[i]);if(null==this.id&&(this.id=Travian.Game.Map.getNewId()),t){this.parentContainer=t;for(var n=0;n<this.globalProperties.length;n++)i=this.globalProperties[n],this.parentContainer[i]&&(this[i]=this.parentContainer[i]);"Travian.Game.Map.Container"===t.classType?this.mapContainer=t:t.mapContainer&&(this.mapContainer=this.parentContainer.mapContainer)}},Travian.Game.Map.Base.prototype.classType="Travian.Game.Map.Base",Travian.Game.Map.Base.prototype.id=null,Travian.Game.Map.Base.prototype.element=null,Travian.Game.Map.Base.prototype.position=null,Travian.Game.Map.Base.prototype.mapCoordinates=null,Travian.Game.Map.Base.prototype.contextMenu=null,Travian.Game.Map.Base.prototype.transition=null,Travian.Game.Map.Base.prototype.updater=null,Travian.Game.Map.Base.prototype.globalProperties=["cookie","dataStore","transition","updater","contextMenu"],Travian.Game.Map.Base.prototype.parentContainer=null,Travian.Game.Map.Base.prototype.render=function(e){return(e=e||{}).nodeType||(e.nodeType="<div/>"),this.element=jQuery(e.nodeType).prop("unselectable","on"),this},Travian.Game.Map.Base.prototype.destroy=function(){this.element&&this.element.remove()},Travian.Game.Map.Base.prototype.isCoordinatesInRect=function(e){return this.mapCoordinates.x<=e.x&&this.mapCoordinates.y<=e.y&&e.x<=this.mapCoordinates.right&&e.y<=this.mapCoordinates.top},Travian.Game.Map.Base.prototype.isPositionInRect=function(e){return Travian.Game.Map.isPositionInRect({x0:this.position.x,y0:this.position.y,x1:this.position.x+this.position.width,y1:this.position.y+this.position.height},e)},Travian.Game.Map.Dialog=function(){this.lowRes=!1,this.open=function(e,t,i){var n=this;n.lowRes&&i.disableEvents(),new Travian.Dialog.Ajax("map/tile-details",Object.assign({},e,{context:"map",stickToUrlOnRestore:!0,data:{x:t.x,y:t.y},onOpen:function(e,t){null!=i&&(jQuery(t).find('a[href^="/karte.php"]').on("click",(function(t){t.preventDefault();var n=Travian.parseURL(t.target.href);return i.moveTo({x:parseInt(n.searchObject.x||"0"),y:parseInt(n.searchObject.y||"0")}),e.close(),!1})),setTimeout((function(){jQuery(window).trigger("travian.toggleMapDialog")}),500))},onClose:function(){n.lowRes&&i.enableEvents(),setTimeout((function(){jQuery(window).trigger("travian.toggleMapDialog")}),500)}}))}},Travian.Game.Map.Container=function(){var e=function(e){this.blocks=null,this.classType="Travian.Game.Map.Container",this.containerRender=null,this.containerSize=null,this.containerViewSize=null,this.currentMousePosition={browserAbsolute:{x:null,y:null},browser:{x:null,y:null},map:{x:null,y:null}},this.element=null,this.elementSize=null,this.eventsEnabled=!0,this.noGrid=!1,this.loading=!1,this.forcedUpdates=0,this.savedURL={},this.mapMarks={},this.addSymbol=function(e){var t=this.blocks.find((function(t){return t.isCoordinatesInRect(e.position)}));return t&&t.addSymbol(e),this},this.deleteSymbol=function(e){var t=this.blocks.find((function(t){return t.isCoordinatesInRect(e.position)}));return t&&t.deleteSymbol(e),this},this.disableEvents=function(){return this.eventsEnabled=!1,this},this.enableEvents=function(){return this.eventsEnabled=!0,this},this.forceUpdateBlocksLayer=function(e){return this.forcedUpdates=this.forcedUpdates+1,this.blocks.forEach((function(t){t.forceUpdateLayer(e)})),this},this.forceUpdateBlocksSymbols=function(e,t){return this.blocks.forEach((function(i){i.forceUpdateSymbols(e,t)})),this},this.getContentForTooltip=function(e){var t=this.blocks.find((function(t){return t.isPositionInRect(e)}));return!!t&&t.getContentForTooltip(e)},this.setContainerSizes=function(e){this.containerViewSize={x:e.x,y:e.y,width:e.width,height:e.height,right:e.x+e.width,bottom:e.y+e.height},this.containerSize={x:this.containerViewSize.x,y:this.containerViewSize.y,width:Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,height:Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height,right:this.containerViewSize.x+Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,bottom:this.containerViewSize.y+Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height}},this.positionChange=function(){var e=Object.assign(this.containerRender.getDimensions({computeSize:!0}),this.containerRender.getPosition()),t={x:this.containerViewSize.x-e.x,y:this.containerViewSize.y-e.y};this.setContainerSizes(e),this.miniMap.containerPosition=this.miniMap.container.getPosition(),this.transition.containerPositionChange(t)},this.invalidateBlockVersionCache=function(){for(var e in this.blocks)this.blocks.hasOwnProperty(e)&&this.blocks[e].invalidateVersionCache();return this},this.isEventsEnabled=function(){return this.eventsEnabled},this.updateBrowserURL=function(e){this.savedURL.searchObject=Object.assign(this.savedURL.searchObject,e),window.history.replaceState(this.savedURL,document.title,Travian.composeURI(this.savedURL)),jQuery(document).trigger("toolbar.updateCoordinates",[e])},this.move=function(e){return this.transition.move(e),null!==this.blocks&&this.blocks.forEach((function(t){t.move(e)})),this.loading&&(this.blockInitialDelta||(this.blockInitialDelta={x:0,y:0}),this.blockInitialDelta.x+=e.x,this.blockInitialDelta.y+=e.y),this.onMove(this,e),this},this.moveDown=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:0,y:e}):this},this.moveLeft=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:e,y:0}):this},this.moveLeftDown=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:e,y:e}):this},this.moveLeftUp=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:e,y:-e}):this},this.moveRight=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:-e,y:0}):this},this.moveRightDown=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:-e,y:e}):this},this.moveRightUp=function(e){return"string"==typeof e&&(e=this.speeds[e]),e?this.move({x:-e,y:-e}):this},this.moveTo=function(e){var t=this.transition.translateToBrowser({x:Math.floor(e.x),y:Math.floor(e.y)});return t.x+=this.blockSize.width/this.transition.elementsPerBlock.x/2,t.y+=this.blockSize.height/this.transition.elementsPerBlock.y/2,t.x+=(this.containerSize.width-this.containerViewSize.width)/2,t.y+=(this.containerSize.height-this.containerViewSize.height)/2,this.updateBrowserURL(e),this.move({x:this.elementSize.width/2-t.x,y:-(this.elementSize.height/2-t.y)})},this.moveUp=function(e){if("string"==typeof e&&(e=this.speeds[e]),e)return this.move({x:0,y:-e})},this.openDialog=function(e,t,i){(new Travian.Game.Map.Dialog).open(e,t,i)},this.render=function(){return this.container=jQuery("<div></div>").css({overflow:"hidden",position:"relative",left:0,top:0,width:"100%",height:"100%",right:0,bottom:0}).prop("unselectable","on").attr("oncontextmenu","return false;").prependTo(this.containerRender),this.elementSize={x:-this.blockSize.width*this.blockOverflow,y:-this.blockSize.height*this.blockOverflow,width:this.containerSize.width+this.blockSize.width*this.blockOverflow*2,height:this.containerSize.height+this.blockSize.height*this.blockOverflow*2},Travian.Game.Map.Base.prototype.render.call(this),this.element.css({position:"absolute",left:this.elementSize.x,top:this.elementSize.y,width:this.elementSize.width,height:this.elementSize.height}).prependTo(this.container),this.containerMover=jQuery("<div></div>").css({overflow:"hidden",position:"absolute",left:0,top:0,width:this.containerViewSize.width,height:this.containerViewSize.height,zIndex:100,backgroundColor:"transparent",opacity:1}).prop("unselectable","on").appendTo(this.container),this.onRender(this),this.moveTo(this.mapInitialPosition),this.renderBlocks(),this.updateGrid(),function(e){var t=!1,i=!1,n=null,a={count:0,shift:!1,control:!1,alt:!1,keys:{},fn:null};for(var o in e.keyboard)e.keyboard.hasOwnProperty(o)&&(e.keyboard[o],"string"==typeof e.keyboard[o]&&(e.keyboard[o]={fn:e.keyboard[o]}),e.keyboard[o]=Object.assign({periodical:1},e.keyboard[o]),"string"==typeof e.keyboard[o].fn&&(a.keys[o]=!1));var r=e.containerRender.css("cursor"),s=function(e){return jQuery(e.target).closest("div.dialogContainer").length},l=function(a,o,r,l){if(!s(a)&&e.isEventsEnabled()){var d=3===a.which||2===a.button;e.containerViewSize.x<=o&&e.containerViewSize.y<=r&&o<=e.containerViewSize.right&&r<=e.containerViewSize.bottom&&l===e.containerMover.get(0)&&!d&&(t=!0,i=!1,n={x:o,y:r},a.stopPropagation())}},d=function(a,o,r){if(e.containerViewSize.x<=o&&e.containerViewSize.y<=r&&o<=e.containerViewSize.right&&r<=e.containerViewSize.bottom?(e.currentMousePosition.browserAbsolute.x=o,e.currentMousePosition.browserAbsolute.y=r,e.currentMousePosition.browser.x=o-e.containerSize.x-e.elementSize.x,e.currentMousePosition.browser.y=r-e.containerSize.y-e.elementSize.y,e.currentMousePosition.map=e.transition.translateToMap(e.currentMousePosition.browser,{})):(e.currentMousePosition.browserAbsolute.x=null,e.currentMousePosition.browserAbsolute.y=null,e.currentMousePosition.browser.x=null,e.currentMousePosition.browser.y=null,e.currentMousePosition.map.x=null,e.currentMousePosition.map.y=null),t&&e.isEventsEnabled()){var s={x:o-n.x,y:-(r-n.y)};Math.abs(s.x)+Math.abs(s.y)>0&&(n={x:o,y:r},i=!0,e.containerRender.css({cursor:"move"}),e.move(s)),a.stopPropagation()}},u=function(n,a,o){if(!s(n)&&e.isEventsEnabled()){var l=3===n.which||2===n.button;if(null!==a&&null!==o&&e.containerViewSize.x<=a&&e.containerViewSize.y<=o&&a<=e.containerViewSize.right&&o<=e.containerViewSize.bottom&&!l&&!i&&t&&!Travian.WindowManager.checkOpenWindowByContext("map")){var d=e.transition.translateToMap({x:a-e.containerViewSize.x-e.elementSize.x,y:o-e.containerViewSize.y-e.elementSize.y},{});"dialog"===e.tileDisplayInformation.type?e.openDialog(e.tileDisplayInformation.optionsDialog,d,e):Travian.popup(Travian.Helpers.substitute(e.tileDisplayInformation.optionsPopup.url,d),e.tileDisplayInformation.optionsPopup.windowOptions)}e.containerRender.css({cursor:r}),i&&(n.stopPropagation(),e.updateBrowserURL(e.transition.getPointOfCenterInView())),t=!1,i=!1}},c=null;jQuery(window).on({selectstart:function(t){if(!s(t)&&e.isEventsEnabled()&&i)return t.stopPropagation(),!1},dragstart:function(t){if(!$(t.target).closest("div.dialogContainer").length&&e.isEventsEnabled()&&i)return t.stopPropagation(),!1},mousedown:function(e){l(e,e.pageX,e.pageY,e.target)},mousemove:function(e){s(e)||(d(e,e.pageX,e.pageY),e.preventDefault())},mouseup:function(e){u(e,e.pageX,e.pageY)},wheel:function(t){if(e.isEventsEnabled()&&e.containerViewSize.x<=t.pageX&&e.containerViewSize.y<=t.pageY&&t.pageX<=e.containerViewSize.right&&t.pageY<=e.containerViewSize.bottom&&t.target===e.containerMover.get(0)){var i=e.transition.translateToMap({x:t.pageX-e.containerViewSize.x-e.elementSize.x,y:t.pageY-e.containerViewSize.y-e.elementSize.y},{});t.originalEvent.deltaY>0?e.zoomOut(i):t.originalEvent.deltaY<0&&e.zoomIn(i),t.preventDefault()}},touchstart:function(e){c=e,l(e,e.touches[0].pageX,e.touches[0].pageY,e.touches[0].target)},touchend:function(t){var i=c.touches[0].pageX,n=c.touches[0].pageY;if(c=null,u(t,i,n),t.target===e.containerMover.get(0))return!1},keydown:function(t){e.isEventsEnabled()&&(t.shiftKey&&(a.shift=!0),t.ctrlKey&&(a.control=!0),t.altKey&&(a.alt=!0),!1===a.keys[t.keyCode]&&"input"!==t.target.nodeName.toLowerCase()&&(a.count++,a.keys[t.keyCode]=!0,t.stopPropagation(),a.fnTimer||(a.fn=function(){var t=0;for(var i in a.keys)if(a.keys.hasOwnProperty(i)&&a.keys[i]){if(a.keys[i]){if(!e.keyboard[i])return;var n=e.keyboard[i].fn;if(!1===n||!e[n])return;var o="";if("move"===n.substring(0,4)){o="normal";var r=e.keyboard.speed.slow,s=e.keyboard.speed.fast;a[r]&&!a[s]?o="slow":!a[r]&&a[s]&&(o="fast")}else"zoom"===n.substring(0,4)&&(o=null);e[n](o)}t+=e.keyboard[i].periodical}t>0&&(a.fnTimer=requestAnimationFrame(a.fn))},0===e.keyboard[t.keyCode].periodical?a.fn():e.keyboard[t.keyCode].periodical>0&&(a.fnTimer=requestAnimationFrame(a.fn)))))},keyup:function(t){e.isEventsEnabled()&&(t.shift||(a.shift=!1),t.control||(a.control=!1),t.alt||(a.alt=!1),a.keys[t.keyCode]&&(a.count--,a.keys[t.keyCode]=!1,t.stopPropagation(),0===a.count&&a.fnTimer&&(cancelAnimationFrame(a.fnTimer),a.fnTimer=null,e.updateBrowserURL(e.transition.getPointOfCenterInView()))))}}),window.addEventListener("touchmove",(function(t){return t.target===e.containerMover.get(0)&&t.preventDefault(),d(t,t.touches[0].pageX,t.touches[0].pageY),!1}),{passive:!1})}(this),this},this.renderBlocks=function(){if(this.blocks)return this;this.blocks=[];var e=Math.ceil(this.elementSize.width/this.blockSize.width),t=Math.ceil(this.elementSize.height/this.blockSize.height),i=Object.assign({x:0,y:0},this.blockInitialDelta);delete this.blockInitialDelta;for(var n=null,a=null,o=null,r=0,s=0;r<t;r++)for(var l=0;l<e;l++)n=Travian.Game.Map.Layer.Block.getCorrectPosition({x:l*this.blockSize.width+i.x,y:r*this.blockSize.height-i.y,width:this.blockSize.width,height:this.blockSize.height},this).position,a=this.transition.translateToMap(n,{}),o={id:s++,version:0},this.data.blocks[a.x]&&this.data.blocks[a.x][a.y]&&this.data.blocks[a.x][a.y][a.right]&&this.data.blocks[a.x][a.y][a.right][a.top]&&(o=Object.assign({},o,this.data.blocks[a.x][a.y][a.right][a.top])),this.blocks.push(new Travian.Game.Map.Layer.Block(Object.assign({},this.options.block,{id:o.id,symbolTypes:this.symbolTypes,position:n,mapCoordinates:a,version:o.version}),this));return this},this.toggleMiniMap=function(){return this.miniMap.animate()},this.toggleOutline=function(){return this.outline.animate()},this.toggleGrid=function(){var e=!this.noGrid;Travian.Game.Preferences.set("grid",e),this.noGrid=e,this.updateGrid()},this.updateGrid=function(){var e=!this.noGrid&&this.grid[this.transition.zoomLevel];return this.element.find(".imageMark").each((function(t,i){jQuery(i).css({backgroundColor:"transparent",backgroundImage:!1!==e?"url("+e+")":"none",backgroundPosition:"left top",backgroundRepeat:"repeat"})})),this},this.updateSymbolData=function(e){var t=this.blocks.find((function(t){return t.isCoordinatesInRect(e.position)}));return t&&t.updateSymbolData(e),this},this.zoom=function(e,t){var i=this.transition.zoomLevel;return this.transition.zoom(e)&&(this.savedURL.searchObject.zoom=this.transition.zoomLevel,this.onZoom(this),(T4_feature_flags.territory&&3===i||3===this.transition.zoomLevel)&&this.dataStore.removeAllOfType(Travian.Game.Map.DataStore.TYPE_TOOLTIP),this.moveTo(t),this.updateGrid(),jQuery(window).trigger("travian.map.zoomed")),this},this.zoomIn=function(e){return e||(e=this.transition.getPointOfCenterInView()),this.zoom(-1,e)},this.zoomOut=function(e){return e||(e=this.transition.getPointOfCenterInView()),this.zoom(1,e)},this.loading=!0,void 0===e&&(e=Travian.Game.Map.Options.Default),Travian.Game.Map.Base.call(this,e),this.onMove=this.onMove||Travian.emptyFunction,this.onCreate=this.onCreate||Travian.emptyFunction,this.onRender=this.onRender||Travian.emptyFunction,this.onZoom=this.onZoom||Travian.emptyFunction,Travian.Game.Map.register(this),this.containerRender=this.container=jQuery(this.container),Travian.Game.Map._map=this;var t={x:this.containerRender.offset().left,y:this.containerRender.offset().top,width:this.containerRender.width(),height:this.containerRender.height()};this.setContainerSizes(t);for(var i=0;i<this.globalProperties.length;i++){var n=this.globalProperties[i],a=Travian.Helpers.capitalizeFirstLetter(n);Travian.Game.Map[a]&&(this[n]=new Travian.Game.Map[a](this[n]||{},this))}this.data.elements&&this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,this.data.elements),this.noGrid=!!Travian.Game.Preferences.get("grid"),this.onCreate(this),this.savedURL=Travian.parseURL(window.location.href),this.render(),this.loading=!1,jQuery("window").on({resize:this.positionChange.bind(this)})};return e.prototype=Object.create(Travian.Game.Map.Base.prototype),e.constructor=e,e}(),Travian.Game.Map.Transition=function(){var e=[],t=function(e){e.elementsPerBlock=e.zoomOptions.sizes[e.zoomLevel-1],e.pixelPerTile={x:e.mapContainer.blockSize.width/e.elementsPerBlock.x,y:e.mapContainer.blockSize.height/e.elementsPerBlock.y},e.elementsInView={x:e.elementsPerBlock.x*e.mapContainer.containerSize.width/e.mapContainer.blockSize.width,y:e.elementsPerBlock.y*e.mapContainer.containerSize.height/e.mapContainer.blockSize.height}},i=function(i,n){this.classType="Travian.Game.Map.Transition",this.elementsPerBlock=null,this.pixelPerTile=null,this.zoomLevel=null,this.zoomOptions=null,this.border=null,this.mapContainer=null,this.getPointOfCenterInView=function(){var e={x:this.mapContainer.containerViewSize.x+this.mapContainer.containerViewSize.width/2,y:this.mapContainer.containerViewSize.y+this.mapContainer.containerViewSize.height/2};return e.x-=this.mapContainer.containerSize.x,e.y-=this.mapContainer.containerSize.y,e.x-=this.mapContainer.elementSize.x,e.y-=this.mapContainer.elementSize.y,this.translateToMap(e,{})},this.containerPositionChange=function(e){this.positionOrigin.browser.x-=e.x,this.positionOrigin.browser.y+=e.y},this.move=function(e){return this.positionOrigin.browser.x+=e.x,this.positionOrigin.browser.y-=e.y,this.onMove(this,e),this},this.registerCallbackOnZoom=function(t){return e.push(t),this},this.translateToBrowser=function(e){var t=this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,i=this.mapContainer.containerSize.y+this.mapContainer.elementSize.y,n=this.mapContainer.blockSize.height/this.elementsPerBlock.y;return{x:(e.x-this.positionOrigin.map.x)*this.pixelPerTile.x+this.positionOrigin.browser.x-t,y:(this.positionOrigin.map.y-e.y)*this.pixelPerTile.y-n-i+this.positionOrigin.browser.y}},this.translateToMap=function(e,t){t=Object.assign({round:!0,correct:!0},t||{});var i=this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,n=this.mapContainer.containerSize.y+this.mapContainer.elementSize.y,a=this.mapContainer.blockSize.height/this.elementsPerBlock.y;void 0!==e.height&&(a=e.height);var o=null;return o=t.round?{x:Math.floor((e.x+i-this.positionOrigin.browser.x)/this.pixelPerTile.x)+this.positionOrigin.map.x,y:this.positionOrigin.map.y-Math.floor((e.y+a+(n-this.positionOrigin.browser.y))/this.pixelPerTile.y)}:{x:(e.x+i-this.positionOrigin.browser.x)/this.pixelPerTile.x+this.positionOrigin.map.x-1,y:this.positionOrigin.map.y-(e.y+a+(n-this.positionOrigin.browser.y))/this.pixelPerTile.y},e.width&&(o.right=o.x+e.width/this.pixelPerTile.x-1),e.height&&(o.top=o.y+e.height/this.pixelPerTile.y-1),t.correct&&(o=function(e,t){var i=!1;do{i=!1,Math.round(e.x)>t.border.right?(e.x=t.border.left+(e.x-t.border.right)-1,i=!0):Math.round(e.x)<t.border.left&&(e.x=t.border.right-(t.border.left-e.x)+1,i=!0),Math.round(e.right)>t.border.right?(e.right=t.border.left+(e.right-t.border.right)-1,i=!0):Math.round(e.right)<t.border.left&&(e.right=t.border.right-(t.border.left-e.right)+1,i=!0),Math.round(e.y)>t.border.top?(e.y=t.border.bottom+(e.y-t.border.top)-1,i=!0):Math.round(e.y)<t.border.bottom&&(e.y=t.border.top-(t.border.bottom-e.y)+1,i=!0),Math.round(e.top)>t.border.top?(e.top=t.border.bottom+(e.top-t.border.top)-1,i=!0):Math.round(e.top)<t.border.bottom&&(e.top=t.border.top-(t.border.bottom-e.top)+1,i=!0)}while(i);return e}(o,this)),o},this.zoom=function(i){if(0===i||i<0&&this.zoomLevel+i<1||i>0&&this.zoomLevel+i>this.zoomOptions.sizes.length)return!1;this.zoomLevel+=i,t(this),this.onZoom(this);for(var n=0;n<e.length;n++)e[n](this);return!0},Travian.Game.Map.Base.call(this,i,n),this.onMove=this.onMove||Travian.emptyFunction,this.onCreate=this.onCreate||Travian.emptyFunction,this.onZoom=this.onZoom||Travian.emptyFunction,this.zoomLevel=this.zoomOptions.level,this.positionOrigin={browser:{x:this.mapContainer.containerSize.x,y:this.mapContainer.containerSize.y+this.mapContainer.containerSize.height},map:{x:0,y:0}},t(this),this.onCreate(this)};return i.prototype=Object.create(Travian.Game.Map.Base.prototype),i.constructor=i,i}(),Travian.Game.Map.Transition.Precision=2,Travian.Game.Map.Updater=function(){var e=function(t){t.requestCountImages>=t.maxRequestCount||Object.keys(t.objects.images).map((function(e,i){return{imageId:e,priority:t.objects.images[e].getPriority()}})).sort((function(e,t){return e.priority-t.priority})).some((function(i,n){var a=t.objects.images[i.imageId];return delete t.objects.images[a.updaterId],t.requestCountImages++,t.updateWorking(1),a.imageLoader||(a.imageLoader=jQuery(new Image).on("load",(function(){!function(t,i){i.element.attr("src",i.srcUrl),i.finishedLoading&&i.finishedLoading(),delete t.loadings[i.blockContainer.updaterId][i.updaterId],0===Object.keys(t.loadings[i.blockContainer.updaterId]).length&&i.blockContainer.layers.loading.hide(),t.requestCountImages--,t.updateWorking(-1),e(t),jQuery(window).trigger("travian.map.imageLoaded")}(t,a)}))),a.refreshSrcUrl(),a.imageLoader.attr("src",a.srcUrl),t.requestCountImages>=t.maxRequestCount}))},t=function(t,i){this.lastRequestPosition={x:null,y:null},this.loadings={},this.requestCount=0,this.requestCountImages=0,this.maxRequestCount=5,this.requestDelayId={multiple:null,position:null},this.requestObject={multiple:null,position:null},this.classType="Travian.Game.Map.Updater",this.register=function(e,t){return this.objects[e]?(t.updaterId||(t.updaterId=Travian.Game.Map.getNewId()),this.objects[e][t.updaterId]||(this.objects[e][t.updaterId]=t),"images"===e&&(t.blockContainer.updaterId||(t.blockContainer.updaterId=Travian.Game.Map.getNewId()),this.loadings[t.blockContainer.updaterId]||(this.loadings[t.blockContainer.updaterId]={}),this.loadings[t.blockContainer.updaterId][t.updaterId]=!0,t.blockContainer.layers.loading.show()),this.request(),this):this},this.request=function(){var t=this;return this.requestObject.multiple&&this.requestObject.multiple.cancel&&(this.requestObject.multiple.cancel(),this.requestObject.multiple=null,this.updateWorking(-1)),this.requestDelayId.multiple&&(clearTimeout(this.requestDelayId.multiple),this.requestDelayId.multiple=null),this.requestDelayId.multiple=setTimeout((function(){!1===function(t){if(Object.keys(t.objects.ajax).length<=0)return!1;t.updateWorking(1);var i=[];for(var n in t.objects.ajax)if(t.objects.ajax.hasOwnProperty(n)){var a=t.objects.ajax[n].getRequestData();!1!==a&&i.push(a)}return t.requestObject.multiple=Travian.api("map/info",{data:Object.assign({},t.parameters.multiple,{data:i,zoomLevel:t.transition.zoomLevel}),success:function(i){t.updateWorking(-1),t.setContentDataAndRefresh(i),e(t)},error:function(i){t.updateWorking(-1),t.setContentDataAndRefresh(i),e(t)}}),!0}(t)&&e(t)}),this.requestDelayTime.multiple),this},this.requestPosition=function(e){var t=this;return this.lastRequestPosition.x===e.position.x&&this.lastRequestPosition.y===e.position.y||(this.lastRequestPosition.x=e.position.x,this.lastRequestPosition.y=e.position.y,this.requestObject.position&&this.requestObject.position.cancel&&(this.requestObject.position.cancel(),this.requestObject.position=null,this.updateWorking(-1)),this.requestDelayId.position&&(clearTimeout(this.requestDelayId.position),this.requestDelayId.position=null),this.requestDelayId.position=setTimeout((function(){!function(e,t){e.updateWorking(1);var i={x0:t.position.x+e.options.positionOptions.areaAroundPosition[e.transition.zoomLevel].left,y0:t.position.y+e.options.positionOptions.areaAroundPosition[e.transition.zoomLevel].bottom,x1:t.position.x+e.options.positionOptions.areaAroundPosition[e.transition.zoomLevel].right,y1:t.position.y+e.options.positionOptions.areaAroundPosition[e.transition.zoomLevel].top};e.requestObject.position&&(e.requestObject.position.abort(),e.requestObject.position=null,e.updateWorking(-1)),e.requestObject.position=Travian.api("map/position",{data:Object.assign({},e.parameters.position,{data:Object.assign({},t.position,{zoomLevel:e.transition.zoomLevel,ignorePositions:e.dataStore.getPositionsOfData(t.dataStoreType).filter((function(e){return Travian.Game.Map.isPositionInRect(i,e)})).map((function(e){return Travian.Game.Map.xy2id(e.x,e.y)}))})}),success:function(i){e.updateWorking(-1),(t.onSuccess||Travian.emptyFunction)(i)},error:function(i){e.updateWorking(-1),(t.onError||Travian.emptyFunction)(i)}})}(t,e)}),this.requestDelayTime.position)),this},this.setContentDataAndRefresh=function(e){if(e.blocks){for(var t in e.blocks)if(e.blocks.hasOwnProperty(t))for(var i in e.blocks[t])if(e.blocks[t].hasOwnProperty(i))for(var n in e.blocks[t][i])if(e.blocks[t][i].hasOwnProperty(n))for(var a in e.blocks[t][i][n])if(e.blocks[t][i][n].hasOwnProperty(a)){var o={x:t,y:i,right:n,top:a},r=Object.assign({},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,o,"block")||{},e.blocks[t][i][n][a]);this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:o,index:"block",data:r})}this.mapContainer.invalidateBlockVersionCache()}for(var s in e.elements&&this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,e.elements),this.objects.ajax)this.objects.ajax.hasOwnProperty(s)&&(this.objects.ajax[s].refreshContent&&this.objects.ajax[s].refreshContent(),delete this.objects.ajax[s]);return this},this.updateWorking=function(e){return this.requestCount+=e,this.elementWorking.length>0&&(this.requestCount>0?this.elementWorking.css({visibility:"visible"}):this.elementWorking.css({visibility:"hidden"}),this.elementWorking.html(this.requestCount)),this},Travian.Game.Map.Base.call(this,t,i),this.objects={ajax:{},images:{}},this.elementWorking=jQuery(this.elementWorking)};return t.prototype=Object.create(Travian.Game.Map.Base.prototype),t.constructor=t,t}(),Travian.Game.Map.ContextMenu=function(e,t){for(var i in this.classType="Travian.Game.Map.ContextMenu",this.addAction=function(e){var t=this;if(e.element=jQuery(e.element),e.element.length>0){var i=e.element.find("a");i.length>0?(i.on("click",(function(i){e.fn(t,t.mapPosition,t.contentData)})),this.actions.push(e)):e.element.hide()}return this},this.disable=function(){return this.options.disabled=!0,this},this.enable=function(){return this.options.disabled=!1,this},this.hide=function(){return this.shown&&(this.fx(this.menu,!1),this.parentContainer.enableEvents(),this.menu.hide(),this.shown=!1),this},this.show=function(){return this.fx(this.menu,!0),this.parentContainer.disableEvents(),this.menu.show(),this.shown=!0,this},this.startListener=function(){var e=this;return this.targets.each((function(t,i){jQuery(i).on(e.options.trigger,(function(t){t.target!==e.parentContainer.containerMover.get(0)||e.options.disabled||(e.options.stopEvent&&t.stopPropagation(),e.options.element=jQuery(i),e.menu.css({left:t.pageX+e.options.offsets.x,top:t.pageY+e.options.offsets.y,position:"absolute"}),e.show())}))})),jQuery("body").on("click",(function(){e.hide()})),this},this.update=function(){var e=this;return this.options.disabled||!this.shown||(this.menu.find("div.separator").each((function(e,t){var i=jQuery(t);i.prev().show(),i.show()})),this.contentData=this.parentContainer.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,this.mapPosition),this.actions.forEach((function(t){null!=e.contentData&&t.shouldDisplay(e.contentData)?t.element.show():t.element.hide()})),this.menu.find("div.separator").each((function(e,t){var i=jQuery(t),n=i.prev();0===n.find(".entry:visible").length&&(n.hide(),i.hide())}))),this},this.options=Object.assign({actions:{},menu:"#contextmenu",stopEvent:!0,targets:"#mapContainer",trigger:"contextmenu",offsets:{x:0,y:0},onShow:Travian.emptyFunction,onHide:Travian.emptyFunction,onClick:Travian.emptyFunction,fadeSpeed:200},e),this.parentContainer=t,this.mapPosition=null,this.menu=jQuery(this.options.menu),this.targets=jQuery(this.options.targets),this.fx=function(e,t){e.animate({opacity:t?1:0},this.options.fadeSpeed,(function(){e.css({display:t?"block":"none"})}))},this.hide().startListener(),this.menu.css({position:"absolute",top:"-900000px",display:"block"}),this.menu.detach().appendTo("body"),this.actions=[],this.options.actions)this.options.actions.hasOwnProperty(i)&&this.addAction(this.options.actions[i]);var n=this;this.targets.each((function(e,t){jQuery(t).on(n.options.trigger,(function(e){n.mapPosition=n.parentContainer.transition.translateToMap({x:e.pageX-n.parentContainer.containerSize.x-n.parentContainer.elementSize.x,y:e.pageY-n.parentContainer.containerSize.y-n.parentContainer.elementSize.y}),n.update()}))}))},Travian.Game.Map.DataStore=function(){var e=0,t=function(e){for(var t in e.options.useStorageForType)e.options.useStorageForType.hasOwnProperty(t)&&e.options.useStorageForType[t]&&Travian.Storage.set("mapDataContainer."+t,e.data[t],e.options.persistentStorage)},i=function(t,i,n){var a=n.x,o=n.y,r=void 0!==n.right?n.right:a,s=void 0!==n.top?n.top:o;return t.data[i]||(t.data[i]={all:{}}),t.data[i][a]||(t.data[i][a]={}),t.data[i][a][o]||(t.data[i][a][o]={}),t.data[i][a][o][r]||(t.data[i][a][o][r]={}),t.data[i][a][o][r][s]||(t.data[i][a][o][r][s]={}),t.data[i][a][o][r][s].id||(e++,t.data[i][a][o][r][s].id=e),t.data[i][a][o][r][s].position=n,t.data[i][a][o][r][s]},n=function(e,t,i){var n=i.x,o=i.y,r=void 0!==i.right?i.right:n,s=void 0!==i.top?i.top:o;return e.data[t]&&e.data[t][n]&&e.data[t][n][o]&&e.data[t][n][o][r]&&e.data[t][n][o][r][s]?a(e,e.data[t][n][o][r][s],t)?null:e.data[t][n][o][r][s]:null},a=function(e,t,i){return!1!==t.time&&(new Date).getTime()-t.time>e.cachingTimeForType[i]},o=function(o,r){var s;for(s in this.classType="Travian.Game.Map.DataStore",this.data={},this.get=function(e,t,i){var a=n(this,e,t);return null==a?null:void 0!==i?a.data[i]?a.data[i]:null:a.data},this.getDataForArea=function(e,t,i){var n=[],o=Object.assign({},t);if(!this.data[e]||!this.data[e].all)return n;for(var r in o.x>o.right&&(o.right+=this.parentContainer.transition.border.width),o.y>o.top&&(o.top+=this.parentContainer.transition.border.height),this.data[e].all)if(this.data[e].all.hasOwnProperty(r)){var s=this.data[e].all[r],l={x:s.position.x,y:s.position.y};if(o.x>l.x&&(l.x+=this.parentContainer.transition.border.width),o.y>l.y&&(l.y+=this.parentContainer.transition.border.height),!1===a(this,s,e)&&o.x<=l.x&&l.x<=o.right&&o.y<=l.y&&l.y<=o.top)if(i)for(var d in s.data)s.data.hasOwnProperty(d)&&n.push(s.data[d]);else n.push(s.data)}return n},this.getPositionsOfData=function(e){var t=this;return this.data[e]&&this.data[e].all?Object.keys(this.data[e].all).filter((function(i){return!1===a(t,t.data[e].all[i],e)})).map((function(i){return t.data[e].all[i].position})):[]},this.push=function(e){void 0===e.time&&(e.time=(new Date).getTime()),-1===e.time&&(e.time=!1);var t=i(this,e.type,e.position);return t.data||(t.data={}),t.data[e.index]=e.data,t.time=e.time,this.data[e.type].all[t.id]=t,this},this.refresh=function(e){var t=n(this,e.type,e.position);return null!=t&&(void 0===e.time&&(e.time=(new Date).getTime()),-1===e.time&&(e.time=!1),t.time=e.time),this},this.remove=function(e,t,i){var a=n(this,e,t);return null==a?this:void 0!==i?(a.data[i]&&delete a.data[i],this):(a.time=0,this)},this.removeAllOfType=function(e){void 0!==this.data[e]&&delete this.data[e]},this.saveDataToStorage=function(){return t(this),this},this.set=function(e){void 0===e.time&&(e.time=(new Date).getTime()),-1===e.time&&(e.time=!1);var t=i(this,e.type,e.position);if(t.data=e.data,t.time=e.time,this.data[e.type].all[t.id]=t,e.data.symbols)for(var n in e.data.symbols)if(e.data.symbols.hasOwnProperty(n)){var a=e.data.symbols[n];a.dataId||(a.dataId=a.type+"-"+n),this.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:e.position,data:a,index:a.dataId,time:!1})}return this},this.setMultiple=function(e,i,n){for(var a=0;a<i.length;a++){var o=i[a];this.set({type:e,position:o.position,data:o,time:n})}return t(this),this},Travian.Game.Map.Base.call(this,o,r),this.options.clearStorageForType)this.options.clearStorageForType.hasOwnProperty(s)&&this.options.clearStorageForType[s]&&Travian.Storage.clear("mapDataContainer."+s,this.options.persistentStorage);for(s in this.options.useStorageForType)if(this.options.useStorageForType.hasOwnProperty(s)&&this.options.useStorageForType[s])if(this.data[s]=Travian.Storage.get("mapDataContainer."+s,this.options.persistentStorage)||{},this.data[s].all){var l=Math.max(Object.keys(this.data[s].all).map((function(e){return parseInt(e)})));l>e&&(e=l)}else this.data[s].all={}};return o.TYPE_BLOCKS="blocks",o.TYPE_SYMBOL="symbol",o.TYPE_TILE="tile",o.TYPE_TOOLTIP="tooltip",o.prototype=Object.create(Travian.Game.Map.Base.prototype),o.constructor=o,o}(),Travian.Game.Map.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',render:function(e,t){var i=this;return Travian.Tip.set(t,{title:"",text:""}),jQuery(t).on("mousemove",(function(t){var n={x:t.pageX-e.containerSize.x-e.elementSize.x,y:t.pageY-e.containerSize.y-e.elementSize.y},a=e.getContentForTooltip(n);!1===a&&(a={title:"",text:Travian.Helpers.substitute(i.tooltipHtml,e.transition.translateToMap(n))}),i.lastText===a.text&&i.lastTitle===a.title||(a.unescaped=!0,Travian.Tip.show(a),i.lastText=a.text,i.lastTitle=a.title)})),this}},Travian.Game.Map.Rulers=function(){var e=function(e){e.elements.moverX.css({backgroundImage:"url("+Travian.Helpers.substitute(e.imgSource.x,{zoomLevel:e.transition.zoomLevel})+")"}),e.elements.moverY.css({backgroundImage:"url("+Travian.Helpers.substitute(e.imgSource.y,{zoomLevel:e.transition.zoomLevel})+")"})},t=function(e){e.elements.coordinates&&(e.elements.coordinates.x.forEach((function(e){e.remove()})),e.elements.coordinates.y.forEach((function(e){e.remove()}))),e.elements.coordinates={x:[],y:[]};for(var t=e.transition.elementsInView.x+2*e.transition.elementsPerBlock.x,n=e.steps.x[e.transition.zoomLevel],a=0,o=null;a<t;a+=n)(o=jQuery("<div></div>").addClass("coordinate zoom"+e.transition.zoomLevel).css({position:"absolute",left:a*e.mapContainer.blockSize.width/e.transition.elementsPerBlock.x,top:0,width:n*e.mapContainer.blockSize.width/e.transition.elementsPerBlock.x,height:e.containerSize.height}).appendTo(e.elements.moverX)).rulerLeft=a*e.mapContainer.blockSize.width/e.transition.elementsPerBlock.x,e.elements.coordinates.x[a]=o;var r=e.transition.elementsInView.y+2*e.transition.elementsPerBlock.y,s=e.steps.y[e.transition.zoomLevel];for(a=0,o=null,null;a<r;a+=s)(o=jQuery("<div></div>").addClass("coordinate zoom"+e.transition.zoomLevel).css({position:"absolute",left:0,top:a*e.mapContainer.blockSize.height/e.transition.elementsPerBlock.y,width:e.containerSize.width,height:s*e.mapContainer.blockSize.height/e.transition.elementsPerBlock.y}).appendTo(e.elements.moverY)).rulerTop=a*e.mapContainer.blockSize.height/e.transition.elementsPerBlock.y,e.elements.coordinates.y[a]=o;i(e,!0,!0)},i=function(e,t,i){var n=!1;do{n=!1,e.position.x<-2*e.mapContainer.blockSize.width&&(e.position.x+=1*e.mapContainer.blockSize.width,t=!0,n=!0),e.position.x>0&&(e.position.x+=-1*e.mapContainer.blockSize.width,t=!0,n=!0),e.position.y<-2*e.mapContainer.blockSize.height&&(e.position.y+=1*e.mapContainer.blockSize.height,i=!0,n=!0),e.position.y>0&&(e.position.y+=-1*e.mapContainer.blockSize.height,i=!0,n=!0)}while(n);e.elements.moverX.css({left:e.position.x}),e.elements.moverY.css({top:e.position.y}),t&&e.elements.coordinates&&jQuery(e.elements.coordinates.x).each((function(t,i){if(i&&i.length>0){var n=e.transition.translateToMap({x:e.position.x+i.rulerLeft-e.mapContainer.elementSize.x,y:0});i.html(function(e,t){return(t+=e.delta.x[e.transition.zoomLevel])<e.transition.border.left?t=e.transition.border.right-(e.transition.border.left-t)+1:t>e.transition.border.right&&(t=e.transition.border.left+(t-e.transition.border.right)-1),t}(e,n.x))}})),i&&e.elements.coordinates&&jQuery(e.elements.coordinates.y).each((function(t,i){if(i&&i.length>0){var n=e.transition.translateToMap({x:0,y:e.position.y+i.rulerTop-e.mapContainer.elementSize.y});i.html(function(e,t){return(t+=e.delta.y[e.transition.zoomLevel])<e.transition.border.bottom?t=e.transition.border.top-(e.transition.border.bottom-t)+1:t>e.transition.border.top&&(t=e.transition.border.bottom+(t-e.transition.border.top)-1),t}(e,n.y))}}))},n=function(n,a){this.classType="Travian.Game.Map.Rulers",this.destroy=function(){return this.elements.containerX.remove(),this.elements.containerY.remove(),this},this.render=function(n){return this.position={x:this.mapContainer.blockSize.width,y:this.mapContainer.blockSize.height},this.elements={containerX:jQuery("<div></div>").addClass(this.cls.x).css({position:"absolute",left:0,right:0,width:this.mapContainer.containerViewSize.width,overflow:"hidden"}).appendTo(this.mapContainer.containerRender),containerY:jQuery("<div></div>").addClass(this.cls.y).css({position:"absolute",top:0,bottom:0,height:this.mapContainer.containerViewSize.height,overflow:"hidden"}).appendTo(this.mapContainer.containerRender)},this.containerSize={width:this.elements.containerY.width(),height:this.elements.containerX.height()},this.elements.containerX.css({height:this.containerSize.height}),"ltr"===this.direction.toLowerCase()?this.elements.containerY.css({left:-this.containerSize.width}):"rtl"===this.direction.toLowerCase()&&this.elements.containerY.css({right:-this.containerSize.width}),this.elements.moverX=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:this.mapContainer.containerSize.width+2*this.mapContainer.blockSize.width,height:"100%",backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-x"}).appendTo(this.elements.containerX),this.elements.moverY=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:"100%",height:this.mapContainer.containerSize.height+2*this.mapContainer.blockSize.height,backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-y"}).appendTo(this.elements.containerY),e(this),t(this),i(this),this},this.move=function(e){return this.position.x+=e.x,this.position.y-=e.y,i(this),this},this.zoom=function(){return e(this),t(this),i(this),this},n.direction||(n.direction=jQuery("body").css("direction")),Travian.Game.Map.Base.call(this,n,a),this.position={x:0,y:0}};return n.prototype=Object.create(Travian.Game.Map.Base.prototype),n.constructor=n,n}(),Travian.Game.Map.MiniMap=function(){var e=function(e){var t=e.transition.translateToMap({x:-e.mapContainer.elementSize.x,y:-e.mapContainer.elementSize.y},{}),i=e.transition.translateToMap({x:0,y:0,width:e.mapContainer.containerViewSize.width,height:e.mapContainer.containerViewSize.height},{round:!1,correct:!1});i.width=i.right-i.x,i.height=i.top-i.y;var n=e.containerSize.width/e.transition.border.width,a=e.containerSize.height/e.transition.border.height;e.position={x:t.x*n+e.containerSize.width/2-1,y:t.y*a+e.containerSize.height/2-i.height*a-1,width:i.width*n,height:i.height*a};var o=e.position;o.width>=e.containerSize.width&&(o.x=-1),o.height>=e.containerSize.height&&(o.y=-1),e.element.css({left:o.x,bottom:o.y,width:o.width,height:o.height});var r=Object.assign({},o);o.x<0?o.x+=e.containerSize.width:o.x+o.width>e.containerSize.width&&(o.x-=e.containerSize.width),o.y<0?o.y+=e.containerSize.height:o.y+o.height>e.containerSize.height&&(o.y-=e.containerSize.height),e.elementHelpers[0].css({left:o.x,bottom:o.y,width:o.width,height:o.height}),e.elementHelpers[1].css({left:r.x,bottom:o.y,width:o.width,height:o.height}),e.elementHelpers[2].css({left:o.x,bottom:r.y,width:o.width,height:o.height})},t=function(e,t){var i=t.containerSize.width/t.transition.border.width,n=t.containerSize.height/t.transition.border.height;return{x:Math.floor((e.pageX-t.containerPosition.x)/i-Math.abs(t.transition.border.left)),y:-Math.floor((e.pageY-t.containerPosition.y)/n-Math.abs(t.transition.border.bottom))}},i=function(i,n){this.classType="Travian.Game.Map.MiniMap",this.expanded=!0,this.animate=function(){var e=this;this.elements.container.stop(!0),this.expanded=!!Travian.Game.Preferences.get("minimap-expanded");var t=function(){return e.expanded?e.elements.container._height.max:e.elements.container._height.min};return this.expanded=!this.expanded,Travian.Game.Preferences.set("minimap-expanded",this.expanded),this.elements.headlineExpander.toggleClass("expand collapse"),this.elements.container.animate({height:t()},200),this.parentContainer.outline.update(this.elements.container.height()-t()),this},this.getContentForTooltip=function(e,i){var n=t(i,this);return{text:Travian.Helpers.substitute(this.tooltipHtml,n)}},this.render=function(i){var n=this;this.container=jQuery(this.container).css({overflow:"hidden"}).prop("unselectable","on").on("click",(function(e){n.mapContainer.moveTo(t(e,n))})),Travian.Game.Map.Base.prototype.render.call(this,i),this.element.addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container),jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:.25,width:"100%"}).appendTo(this.element),this.elementHelpers=[];for(var a=0;a<3;a++){var o=jQuery("<div></div>").addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container);jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:.25,width:"100%"}).appendTo(o),this.elementHelpers.push(o)}this.containerSize={width:this.container.width(),height:this.container.height()},this.containerPosition={x:this.container.offset().left,y:this.container.offset().top},this.elementSize={width:this.element.width(),height:this.element.height()},this.showToolTip&&Travian.Game.Map.MiniMap.Tips.render(this,this.container.find("img")),e(this);var r=jQuery(this.containerContent);this.elements={container:r,headline:r.find(".headline"),headlineExpander:r.find(".iconButton"),background:r.find(".background")},this.expanded=!!Travian.Game.Preferences.get("minimap-expanded"),this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");n.elements.container._height={max:n.elements.container.height(),min:n.elements.headline.height()+parseInt(n.elements.headline.css("margin-top"))+parseInt(n.elements.headline.css("margin-bottom"))},!0!==n.expanded&&n.elements.container.css({height:n.elements.container._height.min}),n.elements.headline.on("click",(function(e){n.animate()}))},this.move=function(){return e(this),this},this.zoom=function(){return e(this),this},Travian.Game.Map.Base.call(this,i,n),this.position={x:0,y:0,width:0,height:0}};return i.prototype=Object.create(Travian.Game.Map.Base.prototype),i.constructor=i,i}(),Travian.Game.Map.MiniMap.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',render:function(e,t){var i=this;return Travian.Tip.set(t,{title:"",text:""}),jQuery(t).on("mousemove",(function(t){var n={x:t.pageX-e.containerSize.width-e.elementSize.width,y:t.pageY-e.containerSize.height-e.elementSize.height},a=e.getContentForTooltip(n,t);!1===a&&(a={title:"",text:Travian.Helpers.substitute(i.tooltipHtml,e.transition.translateToMap(n))}),i.lastText===a.text&&i.lastTitle===a.title||(a.unescaped=!0,Travian.Tip.show(a),i.lastText=a.text,i.lastTitle=a.title)})),this}},Travian.Game.Map.Toolbar=function(e,t){this.classType="Travian.Game.Map.Toolbar",this.render=function(e){var t=this;this.element=jQuery(this.element),this.zoomIn=this.element.find(".iconButton.zoomIn").on("click",(function(e){t.mapContainer.zoomIn()})),this.zoomOut=this.element.find(".iconButton.zoomOut").on("click",(function(e){t.mapContainer.zoomOut()}));var i=function(){t.zoomDropDownDataContainer._dropped=!1,t.zoomDropDownDataContainer.css({height:t.zoomDropDownDataContainer._styleBackup.height}),t.zoomDropDownEntries.each((function(e,t){var i=jQuery(t);i.hasClass("selected")&&i.addClass("display"),i.addClass("hide").removeClass("selected")})),jQuery(t.zoomDropDownEntries[t.transition.zoomLevel-1]).removeClass("hide").addClass("display")};this.zoomDropDownDataContainer=this.element.find(".dropdown .dataContainer"),this.zoomDropDownEntries=this.zoomDropDownDataContainer.find(".entry"),this.zoomDropDownDataContainer._styleBackup={height:this.zoomDropDownDataContainer.height(),maxHeight:this.zoomDropDownEntries.toArray().reduce((function(e,t){return e+jQuery(t).height()}),0)},this.zoomDropDownClick=this.element.find(".dropdown .iconButton.dropDownImage").on("click",(function(e){t.mapContainer.isEventsEnabled()&&(e.stopPropagation(),t.zoomDropDownDataContainer._dropped?i():(t.zoomDropDownDataContainer._dropped=!0,t.zoomDropDownEntries.each((function(e,t){var i=jQuery(t);i.hasClass("display")&&i.addClass("selected"),i.removeClass("display").removeClass("hide")})),t.zoomDropDownDataContainer.css({height:t.zoomDropDownDataContainer._styleBackup.maxHeight})))})),this.zoomDropDownEntries.each((function(e,i){var n=jQuery(i);n.on("click",(function(i){i.stopPropagation(),t.zoomDropDownDataContainer._dropped&&(t.zoomDropDownDataContainer._dropped=!1,t.zoomDropDownDataContainer.css({height:t.zoomDropDownDataContainer._styleBackup.height}),t.zoomDropDownEntries.each((function(e,t){jQuery(t).addClass("hide").removeClass("selected")})),n.removeClass("hide").addClass("display"),t.mapContainer.zoom(e+1-t.mapContainer.transition.zoomLevel,t.mapContainer.transition.getPointOfCenterInView()))}))})),jQuery("body").on("click",(function(){t.zoomDropDownDataContainer._dropped&&i()}));var n=this.element.find(".viewFull");n.length>0&&(this.viewFull=n.on("click",(function(e){window.location.href=Travian.Helpers.substitute(t.viewFullScreenUrl,Object.assign({},t.mapContainer.transition.getPointOfCenterInView(),{zoom:t.mapContainer.transition.zoomLevel}))}))),(n=this.element.find(".iconButton.viewNormal")).length>0&&(this.viewNormal=this.element.find(".iconButton.viewNormal").on("click",(function(e){window.location.href=Travian.Helpers.substitute(t.viewNormalUrl,Object.assign({},t.mapContainer.transition.getPointOfCenterInView(),{zoom:t.mapContainer.transition.zoomLevel}))}))),this.filterPlayer=this.element.find(".iconButton.filterMy").on("click",(function(e){Travian.api("map/setting",{data:{data:{type:"outline",outline:"user"}},success:function(e){t.filterPlayer[e.result?"addClass":"removeClass"]("checked"),t.filterPlayer.checked=e.result,t.mapContainer.forceUpdateBlocksLayer("imageMark"),t.mapContainer.forceUpdateBlocksSymbols("player",e.result)}})})),this.filterPlayer.checked=this.filterPlayer.hasClass("checked"),this.filterAlliance=this.element.find(".iconButton.filterAlliance"),this.filterAlliance.hasClass("disabled")||(this.filterAlliance.on("click",(function(e){Travian.api("map/setting",{data:{data:{type:"outline",outline:"alliance"}},success:function(e){t.filterAlliance[e.result?"addClass":"removeClass"]("checked"),t.filterAlliance.checked=e.result,t.mapContainer.forceUpdateBlocksLayer("imageMark"),t.mapContainer.forceUpdateBlocksSymbols("alliance",e.result)}})})),this.filterAlliance.checked=this.filterAlliance.hasClass("checked")),(n=this.element.find(".iconButton.linkCropfinder")).length>0&&!n.parent().hasClass("iconRequireGold")&&n.on("click",(function(e){window.location.href="/cropfinder.php"})),this.coordinateEnter=jQuery("#mapCoordEnter").on("submit",(function(e){var i={x:parseInt(t.coordinateEnter.find("input.coordinates.x").val()),y:parseInt(t.coordinateEnter.find("input.coordinates.y").val())};return isNaN(i.x)||isNaN(i.y)||t.mapContainer.moveTo(i),e.stopPropagation(),!1})),jQuery(document).on("toolbar.updateCoordinates",(function(e,t){var i=jQuery("#mapCoordEnter");i.find("input.coordinates.x").val(t.x),i.find("input.coordinates.y").val(t.y)})),this.update()},this.update=function(){var e=this;1===this.transition.zoomLevel?(this.zoomIn.addClass("disabled"),this.zoomOut.removeClass("disabled")):this.transition.zoomLevel===this.transition.zoomOptions.sizes.length?(this.zoomIn.removeClass("disabled"),this.zoomOut.addClass("disabled")):(this.zoomIn.removeClass("disabled"),this.zoomOut.removeClass("disabled")),this.zoomDropDownEntries.each((function(t,i){var n=jQuery(i);e.zoomDropDownDataContainer._dropped?n.removeClass("selected"):n.addClass("hide").removeClass("display")})),jQuery(this.zoomDropDownEntries[this.transition.zoomLevel-1]).removeClass("hide").addClass(this.zoomDropDownDataContainer._dropped?"selected":"display")},this.zoom=function(){this.update()},Travian.Game.Map.Base.call(this,e,t)},Travian.Game.Map.Toolbar.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.Toolbar.constructor=Travian.Game.Map.Toolbar,Travian.Game.Map.Outline=function(){var e=function(e,t){this.classType="Travian.Game.Map.Outline",this.expanded=!1,this.animate=function(){var e=this;return this.element.stop(!0),!1===this.expanded?(this.expanded=!0,this.elements.tabContainer.show(),Travian.Game.Preferences.set("outline-expanded",!0),this.elements.headlineExpander.removeClass("expand").addClass("collapse"),this.element.animate({height:this.element._height.max},200,(function(){for(var t in e.parentContainer.mapMarks)e.parentContainer.mapMarks.hasOwnProperty(t)&&e.parentContainer.mapMarks[t].update(!1)}))):(this.expanded=!1,Travian.Game.Preferences.set("outline-expanded",!1),this.elements.headlineExpander.removeClass("collapse").addClass("expand"),this.element.animate({height:this.element._height.min},200,(function(){e.elements.tabContainer.hide()}))),this},this.render=function(e){var t=this;this.element=jQuery(this.element),this.elements={headline:this.element.find(".headline"),headlineExpander:this.element.find(".headline").find(".iconButton"),tabContainer:this.element.find(".tabContainer"),mapMarks:this.element.find("#mapMarks"),background:this.element.find(".background")},this.expanded=!!Travian.Game.Preferences.get("outline-expanded"),this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");return function(){if(t.element._height={max:t.parentContainer.containerViewSize.height-parseInt(t.element.css("bottom"))-t.parentContainer.miniMap.elements.container.height()-2,min:t.element.height()},t.elements.tabContainer.hide(),!0===t.expanded)for(var e in t.elements.tabContainer.show(),t.element.css({height:t.element._height.max}),t.parentContainer.mapMarks)t.parentContainer.mapMarks.hasOwnProperty(e)&&t.parentContainer.mapMarks[e].update(!1);t.elements.headlineExpander.on("click",(function(e){t.animate()}))}(),this},this.update=function(e){var t=this;return this.element._height.max+=e,this.expanded&&(this.element.stop(!0),this.element.animate({height:this.element._height.max},200,(function(){for(var e in t.parentContainer.mapMarks)t.parentContainer.mapMarks.hasOwnProperty(e)&&t.parentContainer.mapMarks[e].update(!1)}))),this},Travian.Game.Map.Base.call(this,e,t),this.render(e)};return e.prototype=Object.create(Travian.Game.Map.Base.prototype),e.constructor=e,e}(),Travian.Game.Map.Layer=function(e,t){Travian.Game.Map.Base.call(this,e,t),null===this.position&&null!==this.parentContainer&&(this.position={x:0,y:0,width:Math.ceil(this.parentContainer.element.width()),height:Math.ceil(this.parentContainer.element.height())}),"Travian.Game.Map.Layer.Block"===this.parentContainer.classType?this.blockContainer=this.parentContainer:this.parentContainer.blockContainer&&(this.blockContainer=this.parentContainer.blockContainer),void 0!==e.version&&this.setVersion(e.version),this.render()},Travian.Game.Map.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.prototype.classType="Travian.Game.Map.Layer",Travian.Game.Map.Layer.prototype.parentContainer=null,Travian.Game.Map.Layer.prototype.position=null,Travian.Game.Map.Layer.prototype.render=function(e){return Travian.Game.Map.Base.prototype.render.call(this,e),null!==this.id&&this.element.addClass(this.id),this.position&&this.element.css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height}),this.zIndex&&this.element.css({zIndex:this.zIndex+1}),this.parentContainer&&this.parentContainer.element&&this.element.appendTo(this.parentContainer.element),this},Travian.Game.Map.Layer.prototype.finishedLoading=function(){return this},Travian.Game.Map.Layer.prototype.forceUpdateContent=function(){return this},Travian.Game.Map.Layer.prototype.getContentForTooltip=function(e){return!1},Travian.Game.Map.Layer.prototype.getRequestData=function(){return!1},Travian.Game.Map.Layer.prototype.hide=function(){return this.element.hide(),this},Travian.Game.Map.Layer.prototype.refreshContent=function(){return this},Travian.Game.Map.Layer.prototype.setVersion=function(e){return this},Travian.Game.Map.Layer.prototype.show=function(){return this.element.show(),this},Travian.Game.Map.Layer.prototype.update=function(){return this.element.css({left:this.position.x+"px",top:this.position.y+"px"}),this},Travian.Game.Map.Layer.prototype.updateContent=function(){return this},Travian.Game.Map.Layer.Block=function(){var e=function(e,t,i){return t.position=t.position||i,void 0===t.text&&void 0===t.title&&(t.text=Travian.Helpers.substitute(e.tooltipHtml,{x:t.position.x,y:t.position.y})),t},t=function(e,t){if(!t.type)throw"Missing symbol type for symbol: "+t.dataId;t.position&&(t.x=t.position.x,t.y=t.position.y);var i=e.symbolTypes[t.type];if(i&&i.class&&i.visibleInZoom[e.transition.zoomLevel]){e.symbols[t.x]||(e.symbols[t.x]={}),e.symbols[t.x][t.y]||(e.symbols[t.x][t.y]={});var n=function(e,t){var i=Object.assign({},t),n=e.transition.getPointOfCenterInView(),a=Object.assign({},e.mapCoordinates);i.x=parseFloat(i.x),i.y=parseFloat(i.y),n.x=parseFloat(n.x),n.y=parseFloat(n.y),a.x=parseFloat(a.x),a.y=parseFloat(a.y);var o=function(e){return e>0?1:e<0?-1:0},r=e.transition.border.right-Math.abs(i.x)<e.transition.border.right/2,s=e.transition.border.top-Math.abs(i.y)<e.transition.border.top/2,l=e.transition.border.right-Math.abs(n.x)<e.transition.border.right/2,d=e.transition.border.top-Math.abs(n.y)<e.transition.border.top/2,u=e.transition.border.right-Math.abs(a.x)<e.transition.border.right/2,c=e.transition.border.top-Math.abs(a.y)<e.transition.border.top/2,h=o(i.x),p=o(n.x);(r||l)&&h+p===0&&h!==p&&(i.x+=p*e.transition.border.width);var m=o(i.y),v=o(n.y);(s||d)&&m+v===0&&m!==v&&(i.y+=v*e.transition.border.height);var f=o(a.x);(u||l)&&f+p===0&&f!==p&&(a.x+=p*e.transition.border.width);var g=o(a.y);return(c||d)&&g+v===0&&g!==v&&(a.y+=v*e.transition.border.height),{x:(i.x-a.x)*e.transition.pixelPerTile.x,y:(e.transition.elementsPerBlock.y-(i.y-a.y)-1)*e.transition.pixelPerTile.y}}(e,{x:t.x,y:t.y}),o=e.symbols[t.x][t.y],r=a(e,i,o);o[t.dataId]=new i.class(Object.assign({},i,t,{positionOfTile:{x:n.x,y:n.y},positionInTile:r,position:{x:n.x+r.x,y:n.y+r.y,width:i.sizes[e.transition.zoomLevel].width,height:i.sizes[e.transition.zoomLevel].height},positionDefault:{x:n.x+r.x,y:n.y+r.y,width:i.sizes[e.transition.zoomLevel].width,height:i.sizes[e.transition.zoomLevel].height},symbolSize:{width:i.sizes[e.transition.zoomLevel].width,height:i.sizes[e.transition.zoomLevel].height}}),e)}},i=function(e){n(e),e.dataStore.getDataForArea(Travian.Game.Map.DataStore.TYPE_SYMBOL,e.mapCoordinates,!0).forEach((function(i){t(e,i)}))},n=function(e){for(var t in e.symbols)if(e.symbols.hasOwnProperty(t))for(var i in e.symbols[t])if(e.symbols[t].hasOwnProperty(i))for(var n in e.symbols[t][i])e.symbols[t][i].hasOwnProperty(n)&&e.symbols[t][i][n].destroy();e.symbols={}},a=function(e,t,i){var n={x:!1,y:!1},a=t.sizes[e.transition.zoomLevel].width,o=Object.keys(i).reverse().find((function(e){var t=i[e].position.x===i[e].positionDefault.x;return t=(t=(t=t&&i[e].position.y===i[e].positionDefault.y)&&i[e].position.width===i[e].positionDefault.width)&&i[e].position.height===i[e].positionDefault.height}));return o&&(n.x=i[o].positionInTile.x,n.x+=a),!1===n.x&&(n.x=0),n.x+a>e.position.width/e.transition.elementsPerBlock.x&&(n.x=0,n.y+=t.sizes[e.transition.zoomLevel].height),n},o=function(a,o){this.mapCoordinates=null,this.layers=null,this.symbols={},this.dataStore=null,this.versionCache=null,this.classType="Travian.Game.Map.Layer.Block",this.addSymbol=function(e){return t(this,e),this},this.deleteSymbol=function(e){return this.symbols&&this.symbols[e.position.x]&&this.symbols[e.position.x][e.position.y]?(this.symbols[e.position.x][e.position.y][e.dataId]&&(this.symbols[e.position.x][e.position.y][e.dataId].destroy(),delete this.symbols[e.position.x][e.position.y][e.dataId]),this):this},this.forceUpdateLayer=function(e){return this.layers[e]&&this.layers[e].forceUpdateContent(),this},this.forceUpdateSymbols=function(e,t){if(this.symbols)for(var i in this.symbols)if(this.symbols.hasOwnProperty(i))for(var n in this.symbols[i])if(this.symbols[i].hasOwnProperty(n))for(var a in this.symbols[i][n])if(this.symbols[i][n].hasOwnProperty(a)){var o=this.symbols[i][n][a];o.layer===e&&o.forceUpdate(t)}return this},this.getContentForTooltip=function(e){var t=this,i=this.transition.translateToMap(e);if(this.symbols&&this.symbols[i.x]&&this.symbols[i.x][i.y]&&0!==this.symbols[i.x][i.y]){var n=!1;if(function(i){for(var a in i)if(i.hasOwnProperty(a)){var o=i[a];if(!1!==(n=o.getContentForTooltip())&&o.isPositionInRect({x:e.x-t.position.x,y:e.y-t.position.y}))return o}}(this.symbols[i.x][i.y])&&!1!==n)return n}var a=this.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,i);return null==a||void 0===a.text&&void 0===a.title?(a={title:"",text:Travian.Translation.translate(this.tooltipHtml,i)},this.requestDataForPosition(i)):a={text:a.text,title:a.title},a},this.getData=function(){return Object.assign({loaded:!1,version:0},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,this.mapCoordinates,"block")||{})},this.getRequestData=function(){return{position:{x0:this.mapCoordinates.x,y0:this.mapCoordinates.y,x1:this.mapCoordinates.right,y1:this.mapCoordinates.top}}},this.getVersion=function(){return null==this.versionCache&&(this.versionCache=this.getData().version),this.versionCache},this.invalidateVersionCache=function(){return this.versionCache=null,this},this.move=function(e){if(0===e.x&&0===e.y)return this;this.position.x+=e.x,this.position.y-=e.y;var t=Travian.Game.Map.Layer.Block.getCorrectPosition(this.position,this.mapContainer);return this.position=t.position,this.mapCoordinates=this.transition.translateToMap(this.position),this.update(t.updateInnerContent),this},this.refreshContent=function(e){if(e){var t=this.getData();t.loaded=!0,this.setData(t)}for(var n in Travian.Game.Map.Layer.prototype.refreshContent.call(this),this.layers)this.layers.hasOwnProperty(n)&&this.layers[n].refreshContent();return i(this),this},this.render=function(e){var t=this;for(var n in this.layers={},Travian.Game.Map.Layer.prototype.render.call(this,e),this.mapCoordinates=this.transition.registerCallbackOnZoom((function(){t.mapCoordinates=t.transition.translateToMap(t.position),t.update(!0)})).translateToMap(this.position),this.mapContainer.layers)if(this.mapContainer.layers.hasOwnProperty(n)){var a=this.mapContainer.layers[n];if(!a.class)continue;var o=Object.assign({},a,{index:n});this.layers[o.id]=new a.class(o,this)}var r=this.getData();return r.loaded=!0,this.setData(r),i(this),this},this.requestDataForPosition=function(t){var i=this;return this.updater.requestPosition({dataStoreType:Travian.Game.Map.DataStore.TYPE_TOOLTIP,position:t,onSuccess:function(n,a){!function(t,i,n){if(void 0===n&&(n={}),void 0!==n.tiles&&0!==n.tiles.length){for(var a in n.tiles)if(n.tiles.hasOwnProperty(a)){var o=n.tiles[a];(o=e(t,o,i)).position.x===i.x&&o.position.y===i.y&&(n.tile=o),t.dataStore.set({position:o.position,type:Travian.Game.Map.DataStore.TYPE_TOOLTIP,data:o})}t.dataStore.saveDataToStorage()}if(i.x===t.mapContainer.currentMousePosition.map.x&&i.y===t.mapContainer.currentMousePosition.map.y){t.mapContainer.contextMenu.update();var r=Object.assign({unescaped:!0},t.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,i));Travian.Tip.set(t.mapContainer.containerMover,r),Travian.Tip.show(r)}}(i,t,n)},onError:function(e,n){!function(e,t,i){null!=e.mapContainer.currentMousePosition.map.x&&null!=e.mapContainer.currentMousePosition.map.y&&t.x===e.mapContainer.currentMousePosition.map.x&&t.y===e.mapContainer.currentMousePosition.map.y&&e.mapContainer.containerMover.setTitle({title:"",text:Travian.Helpers.substitute("{x}|{y}",t)})}(i,t)}}),this},this.setData=function(e){return this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:this.mapCoordinates,index:"block",data:Object.assign({loaded:!1,version:0},e)}),this},this.setVersion=function(e){var t=this.getData();return t.version=e,this.setData(t)},this.update=function(e){return Travian.Game.Map.Layer.prototype.update.call(this),this.updateContent(e),this},this.updateContent=function(e){for(var t in Travian.Game.Map.Layer.prototype.updateContent.call(this),this.layers)this.layers.hasOwnProperty(t)&&this.layers[t].updateContent(e);return e&&(n(this),this.getData.loaded?this.refreshContent(!1):this.updater.register("ajax",this)),this},this.updateSymbolData=function(e){return this.symbols&&this.symbols[e.position.x]&&this.symbols[e.position.x][e.position.y]?(this.symbols[e.position.x][e.position.y][e.dataId]&&this.symbols[e.position.x][e.position.y][e.dataId].updateData(e),this):this},Travian.Game.Map.Layer.call(this,a,o)};return o.prototype=Object.create(Travian.Game.Map.Layer.prototype),o.constructor=o,o}(),Travian.Game.Map.Layer.Block.getCorrectPosition=function(e,t){var i={position:e,updateInnerContent:!1,updateBlockPosition:!1};do{i.updateBlockPosition=!1,i.position.x<0&&Math.abs(i.position.x)>=t.blockSize.width?(i.position.x=t.elementSize.width+i.position.x,i.updateInnerContent=!0,i.updateBlockPosition=!0):i.position.x+i.position.width>t.elementSize.width&&(i.position.x=i.position.x-t.elementSize.width,i.updateInnerContent=!0,i.updateBlockPosition=!0),i.position.y<0&&Math.abs(i.position.y)>=t.blockSize.height?(i.position.y=t.elementSize.height+i.position.y,i.updateInnerContent=!0,i.updateBlockPosition=!0):i.position.y+i.position.height>t.elementSize.height&&(i.position.y=i.position.y-t.elementSize.height,i.updateInnerContent=!0,i.updateBlockPosition=!0)}while(i.updateBlockPosition);return i},Travian.Game.Map.Layer.Image=function(e,t){this.image=null,this.srcUrl=null,this.getPriority=function(){var e=this.blockContainer.mapCoordinates.x+(this.blockContainer.mapCoordinates.right-this.blockContainer.mapCoordinates.x)/2,t=this.blockContainer.mapCoordinates.y+(this.blockContainer.mapCoordinates.top-this.blockContainer.mapCoordinates.y)/2,i=this.transition.getPointOfCenterInView(),n={x:i.x-e,y:i.y-t};return Math.pow(n.x,2)+Math.pow(n.y,2)},this.getSrcUrl=function(){return Travian.Helpers.substitute(this.src,{x:this.parentContainer.mapCoordinates.x,y:this.parentContainer.mapCoordinates.y,right:this.parentContainer.mapCoordinates.right,top:this.parentContainer.mapCoordinates.top,suffix:"?t="+this.time})},this.refreshSrcUrl=function(){return this.srcUrl=this.getSrcUrl(),this},this.render=function(e){return Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:'<img src="'+this.srcInit+'">'}),this.time=(new Date).getTime(),this.updateContent(),this},Travian.Game.Map.Layer.call(this,e,t)},Travian.Game.Map.Layer.Image.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.Image.constructor=Travian.Game.Map.Layer.Image,Travian.Game.Map.Layer.Image.prototype.classType="Travian.Game.Map.Layer.Image",Travian.Game.Map.Layer.Image.prototype.updateContent=function(e){var t=this.getSrcUrl();return(this.srcUrl!==t||e)&&(this.refreshSrcUrl(),this.updater.register("images",this)),this},Travian.Game.Map.Layer.ImageMark=function(e,t){this.classType="Travian.Game.Map.Layer.ImageMark",this.finishedLoading=function(){return Travian.Game.Map.Layer.Image.prototype.finishedLoading.call(this),this.show(),this},this.forceUpdateContent=function(){return this.time=(new Date).getTime(),this.updateContent(!0),this},this.updateContent=function(e){return Travian.Game.Map.Layer.Image.prototype.updateContent.call(this,e),e&&this.hide(),this},Travian.Game.Map.Layer.Image.call(this,e,t)},Travian.Game.Map.Layer.ImageMark.prototype=Object.create(Travian.Game.Map.Layer.Image.prototype),Travian.Game.Map.Layer.ImageMark.constructor=Travian.Game.Map.Layer.Image,Travian.Game.Map.Layer.Loading=function(e,t){this.classType="Travian.Game.Map.Layer.Loading",this.render=function(e){return Travian.Game.Map.Layer.prototype.render.call(this,e),this.element.css(this.styles).hide(),this},this.updateContent=function(e){return this},Travian.Game.Map.Layer.call(this,e,t)},Travian.Game.Map.Layer.Loading.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.Loading.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.Symbol=function(e,t){this.byUser=!1,this.visible=!0,this.destroy=function(){return this.element&&this.element.remove(),this},this.forceUpdate=function(e){return this.byUser&&(this.visible=e,this.element[e?"show":"hide"]()),this},e.mapCoordinates=e.mapCoordinates||t.transition.translateToMap({x:e.position.x+t.position.x,y:e.position.y+t.position.y}),e.id=e.id||Travian.Game.Map.getNewId(),e.parameters=e.parameters||{},Travian.Game.Map.mapIds[e.dataId]=e.id,Travian.Game.Map.Layer.call(this,e,t)},Travian.Game.Map.Layer.Symbol.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.Symbol.prototype.classType="Travian.Game.Map.Layer.Symbol",Travian.Game.Map.Layer.Symbol.prototype.updateData=function(e){this.title=e.title,this.text=e.text},Travian.Game.Map.Layer.Symbol.prototype.getContentForTooltip=function(){return!(!this.visible||!this.title&&!this.text)&&{title:this.title,text:this.text}},Travian.Game.Map.Layer.Symbol.prototype.render=function(e){return Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:"<img/>"},e),this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{width:this.symbolSize.width,height:this.symbolSize.height,zoomLevel:this.transition.zoomLevel}))).css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height}),this},Travian.Game.Map.Layer.Symbol.Flag=function(e,t){this.classType="Travian.Game.Map.Layer.Symbol.Flag",this.index=null,this.render=function(e){this.parameters.index=this.index||1,Travian.Game.Map.Layer.Symbol.prototype.render.call(this,e);var t=Travian.Game.Map.Options.Toolbar,i="alliance"===this.layer?"filterAlliance":"filterPlayer";return this.mapContainer.toolbar&&(t=this.mapContainer.toolbar),this.forceUpdate(t[i].checked),this},this.updateData=function(e){Travian.Game.Map.Layer.Symbol.prototype.updateData.call(this,e),this.parameters.index=this.index=e.index,this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{zoomLevel:this.transition.zoomLevel,width:this.symbolSize.width,height:this.symbolSize.height})))},Travian.Game.Map.Layer.Symbol.call(this,e,t)},Travian.Game.Map.Layer.Symbol.Flag.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.constructor=Travian.Game.Map.Layer.Symbol,Travian.Game.Map.Layer.Symbol.Attack=function(e,t){this.classType="Travian.Game.Map.Layer.Symbol.Attack",Travian.Game.Map.Layer.Symbol.call(this,e,t)},Travian.Game.Map.Layer.Symbol.Attack.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Attack.constructor=Travian.Game.Map.Layer.Symbol,Travian.Game.Map.Layer.Symbol.BattleGround=function(e,t){this.classType="Travian.Game.Map.Layer.Symbol.BattleGround",this.getContentForTooltip=function(){return!1},this.render=function(e){return this.position={x:this.positionOfTile.x,y:this.positionOfTile.y,width:this.transition.pixelPerTile.x,height:this.transition.pixelPerTile.y},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,e),this},Travian.Game.Map.Layer.Symbol.call(this,e,t)},Travian.Game.Map.Layer.Symbol.BattleGround.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.BattleGround.constructor=Travian.Game.Map.Layer.Symbol.BattleGround,Travian.Game.Map.Layer.Symbol.Adventure=function(e,t){this.classType="Travian.Game.Map.Layer.Symbol.Adventure",this.render=function(e){return this.position={x:this.positionOfTile.x+this.transition.pixelPerTile.x-this.position.width,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,e),this},Travian.Game.Map.Layer.Symbol.call(this,e,t)},Travian.Game.Map.Layer.Symbol.Adventure.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Adventure.constructor=Travian.Game.Map.Layer.Symbol.Adventure,Travian.Game.Map.Layer.Symbol.Reinforcement=function(e,t){this.classType="Travian.Game.Map.Layer.Symbol.Reinforcement",this.render=function(e){return this.position={x:this.positionOfTile.x,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,e),this},Travian.Game.Map.Layer.Symbol.call(this,e,t)},Travian.Game.Map.Layer.Symbol.Reinforcement.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Reinforcement.constructor=Travian.Game.Map.Layer.Symbol.Reinforcement,Travian.Game.Map.MapMark=function(e,t){this.classType="Travian.Game.Map.MapMark",this.render=function(){for(var e in this.element=jQuery(this.element),this.layers)if(this.layers.hasOwnProperty(e)){var t=this.layers[e];this.layers[e]=new t.class(t,this)}this.update();for(var i=0;i<this.data.length;i++){var n=this.data[i];n.layer&&this.layers[n.layer]&&this.layers[n.layer].addData(n)}return this},this.update=function(){var e=[],t=this.element.height();for(var i in this.layers)if(this.layers.hasOwnProperty(i)){var n=this.layers[i];e.push({data:n.elements.data,expandContainer:n.elements.expandContainer,expanded:n.expanded}),t-=n.element.outerHeight()-n.elements.expandContainer.outerHeight()}for(var a=0;a<e.length;a++){var o=e[a];o.data.parent().css({height:t}),o.expandContainer.css({height:o.expanded?t:0})}},Travian.Game.Map.Base.call(this,e,t),this.render()},Travian.Game.Map.MapMark.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.MapMark.constructor=Travian.Game.Map.MapMark,Travian.Game.Map.MapMark.Layer=function(e,t){Travian.Game.Map.Base.call(this,e,t);var i=Travian.Game.Preferences.get("markLayer-"+this.parentContainer.typeId+"-"+this.typeId+"-expanded");null!=i&&(this.expanded=i),this.datas={},this.render()},Travian.Game.Map.MapMark.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.MapMark.Layer.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.prototype.classType="Travian.Game.Map.MapMark.Layer",Travian.Game.Map.MapMark.Layer.prototype.addData=function(e){return this},Travian.Game.Map.MapMark.Layer.prototype.deleteData=function(e){return this.datas[e.id]&&delete this.datas[e.id],this},Travian.Game.Map.MapMark.Layer.prototype.render=function(e){var t=this;return this.element=jQuery("<div></div>").addClass("collapseContainer").html(Travian.Helpers.substitute(this.html,Object.assign({},e||{},{data:"scroll-dataContainer",add:"addButton",expandButton:"expandButton",expandContainer:"expandContainer",title:this.title}))).appendTo(this.parentContainer.element),this.elements={data:this.element.find(".scroll-dataContainer"),title:this.element.find(".title"),add:this.element.find(".addButton"),expandButton:this.element.find(".expandButton"),expandContainer:this.element.find(".expandContainer")},!this.editable&&this.elements.add&&this.elements.add.hide(),this.elements.expandButton&&(this.elements.expandButton.addClass(this.expanded?"collapse":"expand"),this.elements.expandButton.on("click",(function(e){if(!t.expanded){for(var i in t.parentContainer.layers)if(t.parentContainer.layers.hasOwnProperty(i)){var n=t.parentContainer.layers[i];n.expanded=!1,n.elements.expandButton.removeClass("collapse").addClass("expand"),Travian.Game.Preferences.set("markLayer-"+n.parentContainer.typeId+"-"+n.typeId+"-expanded",n.expanded)}t.expanded=!0,t.elements.expandButton.removeClass("expand").addClass("collapse"),Travian.Game.Preferences.set("markLayer-"+t.parentContainer.typeId+"-"+t.typeId+"-expanded",!0)}t.parentContainer.update()}))),this},Travian.Game.Map.MapMark.Layer.Mark=function(e,t){for(var i in this.classType="Travian.Game.Map.MapMark.Layer.Mark",this.dialogInstance=null,this.addData=function(e){var t=new Travian.Game.Map.MapMark.Layer.Data.Mark(Object.assign({},e,this.optionsData,{editable:this.editable}),this);return this.datas[t.id]=t,this},this.add=function(e){var t=this;return this.editable?(Travian.api("map/multi-mark",{data:{data:{x:e.position.x,y:e.position.y,type:this.typeId,color:e.color||0,owner:this.parentContainer.typeId,text:e.text||void 0,title:e.title||void 0}},success:function(e){t.addData(e),t.mapContainer.forceUpdateBlocksLayer("imageMark"),t.dialogInstance.close(),t.dialogInstance=null},error:function(e){return t.dialogInstance.enableForm().toElement().find(".errorMessage").html(e.message),!1}}),this):this},this.render=function(e){var t=this;return Travian.Game.Map.MapMark.Layer.prototype.render.call(this,e),this.elements.add.on("click",(function(e){t.showDialog()})),this},this.showDialog=function(e){var t=this;e=Object.assign({color:this.color,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,position:{x:"",y:""}},e||{}),this.color=e.color;var i=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY"});return this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:!0,relativeTo:this.mapContainer.container,elementFocus:""===e.position.x?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:!0,onOpen:function(i,n){n.find("input.inputX").val(e.position.x),n.find("input.inputY").val(e.position.y);var a=new Travian.Game.ColorPicker(n.find(".select"),{colors:t.colorsArray,defaultColor:t.color,onChange:function(e,i){t.colorsArray.map((function(i,n){i===e&&(t.color=n)}))}});e.onOpen(i,n,a)},onOkay:function(i,n){e.onOkay({color:t.color,position:{x:n.find("input.inputX").val(),y:n.find("input.inputY").val()}},i,n)}}),this.dialogInstance.setContent(i),this.dialogInstance.show(),this},Travian.Game.Map.MapMark.Layer.call(this,e,t),this.colorsArray=[],this.colors)this.colors.hasOwnProperty(i)&&"string"==typeof this.colors[i]&&this.colorsArray.push(this.colors[i])},Travian.Game.Map.MapMark.Layer.Mark.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Mark.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Flag=function(e,t){this.classType="Travian.Game.Map.MapMark.Layer.Flag",this.dialogInstance=null,this.add=function(e){var t=this;return this.editable?(e.index<this.indexes.min&&(e.index=this.indexes.max),e.index>this.indexes.max&&(e.index=this.indexes.min),Travian.api("map/flag",{data:{data:{x:e.position.x,y:e.position.y,color:e.index||this.indexes.min,owner:this.parentContainer.typeId,text:e.text||void 0,title:e.title||void 0}},success:function(i){i.type="flag",t.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,index:i.dataId,position:i.position,data:i,time:!1}),t.addData(i),i.position=e.position,i.layer=t.parentContainer.typeId,t.mapContainer.addSymbol(i),t.dialogInstance.close(),t.dialogInstance=null},error:function(e){return t.dialogInstance.enableForm().toElement().find(".errorMessage").html(e.message),!1}}),this):this},this.addData=function(e){var t=new Travian.Game.Map.MapMark.Layer.Data.Flag(Object.assign({},e,this.optionsData,{editable:this.editable}),this);return this.datas[t.id]=t,this},this.render=function(e){Travian.Game.Map.MapMark.Layer.prototype.render.call(this,e);var t=this;return this.elements.add.on("click",(function(i){t.showDialog(e)})),this},this.showDialog=function(e){var t=this;e=Object.assign({index:this.index,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,text:"",position:{x:"",y:""}},e||{}),this.index=e.index;var i=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY",inputText:"inputText"});return this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:!0,relativeTo:this.mapContainer.container,elementFocus:""===e.position.x?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:!0,onOpen:function(i,n){n.find("input.inputX").val(e.position.x),n.find("input.inputY").val(e.position.y),n.find("input.inputText").val(e.text);var a=new Travian.Game.ImagePicker(n.find(".select"),{images:t.imagesArray,defaultImage:t.index-t.indexes.min,onChange:function(e){t.imagesArray.map((function(i,n){i===e&&(t.index=n+1)}))}});e.onOpen(i,n,a)},onOkay:function(i,n){t.index<t.indexes.min&&(t.index+=t.indexes.min-1),e.onOkay({index:t.index,text:n.find("input.inputText").val(),position:{x:n.find("input.inputX").val(),y:n.find("input.inputY").val()}},i,n)}}),this.dialogInstance.setContent(i),this.dialogInstance.show(),this},Travian.Game.Map.MapMark.Layer.call(this,e,t),this.imagesArray=[];for(var i=this.indexes.min;i<=this.indexes.max;i++)this.imagesArray.push(Travian.Helpers.substitute(this.imgSource,{index:i}))},Travian.Game.Map.MapMark.Layer.Flag.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Flag.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Data=function(e,t){Travian.Game.Map.MapMark.Layer.call(this,e,t)},Travian.Game.Map.MapMark.Layer.Data.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Data.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Data.prototype.classType="Travian.Game.Map.MapMark.Layer.Data",Travian.Game.Map.MapMark.Layer.Data.prototype.del=function(){return this.destroy(),this.parentContainer.deleteData(this),this},Travian.Game.Map.MapMark.Layer.Data.prototype.render=function(e){var t=this;return this.element=jQuery("<div></div>").html(Travian.Helpers.substitute(this.html,Object.assign({},e||{},{entry:this.id,text:"textContainer",delete:"deleteButton",select:"selectLink",editDelete:"editDeleteContainer"}))).appendTo(this.parentContainer.elements.data),this.elements={text:this.element.find(".textContainer"),delete:this.element.find(".deleteButton"),select:this.element.find(".selectLink"),editDelete:this.element.find(".editDeleteContainer")},this.elements.delete.on("click",(function(e){t.del()})),this.elements.text.html(this.text),!this.editable&&this.elements.editDelete&&this.elements.editDelete.hide(),this},Travian.Game.Map.MapMark.Layer.Data.Mark=function(){var e=function(e){e.elements.color.css({backgroundColor:e.parentContainer.colors[e.color]})},t=function(t,i){this.classType="Travian.Game.Map.MapMark.Layer.Data.Mark",this.del=function(){var e=this;return this.editable?(Travian.api("map/flag",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"mark"}},success:function(t){t.result&&(e.destroy(),e.mapContainer.forceUpdateBlocksLayer("imageMark"))}},"DELETE"),this):this},this.render=function(t){var i=this;return Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{color:"colorContainer",urlLink:"urlLink"}),this.elements.color=this.element.find(".colorContainer"),this.elements.urlLink=this.element.find(".urlLink"),this.elements.urlLink&&(this.elements.urlLink.href=Travian.Helpers.substitute(this.urlLink,{markId:this.markId})),this.editable&&this.elements.select.on("click",(function(e){i.parentContainer.showDialog({color:i.color,onOpen:function(e,t,n){t.find(".coord").each((function(e,t){jQuery(t).hide()})),t.find(".textDisplay").show().html(i.text)},onOkay:function(e,t,n){i.setColor(e.color)}})})),this.elements.urlLink.on("click",(function(e){i.elements.urlLink&&(window.location.href=i.elements.urlLink.href)})),e(this),this},this.setColor=function(t){var i=this;return this.editable?("number"!=typeof t||(t<this.parentContainer.colors.min&&(t=this.parentContainer.colors.max),t>this.parentContainer.colors.max&&(t=this.parentContainer.colors.min),Travian.api("map/multi-mark",{data:{data:{color:t,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(n){n&&(i.color=t,e(i),i.mapContainer.forceUpdateBlocksLayer("imageMark")),i.parentContainer.dialogInstance.close(),i.parentContainer.dialogInstance=null},error:function(e){return i.parentContainer.dialogInstance.enableForm().toElement().find(".errorMessage").html(e.message),!1}},"PATCH")),this):this},t.color=Number(t.color),Travian.Game.Map.MapMark.Layer.Data.call(this,t,i)};return t.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype),t.constructor=t,t}(),Travian.Game.Map.MapMark.Layer.Data.Flag=function(){var e=function(e){e.elements.text.html(e.text),e.elements.index.html('<img src="'+Travian.Helpers.substitute(e.parentContainer.imgSource,{index:e.index})+'" alt="" />')},t=function(t,i){this.classType="Travian.Game.Map.MapMark.Layer.Data.Flag",this.del=function(){var e=this;return this.editable?(Travian.api("map/flag",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"flag"}},success:function(t){t.result&&(e.destroy(),e.dataStore.remove(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:e.x,y:e.y},e.dataId),e.mapContainer.deleteSymbol({position:{x:e.x,y:e.y},dataId:e.dataId}))}},"DELETE"),this):this},this.render=function(t){var i=this;return Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{index:"indexContainer",urlLink:"urlLink"}),this.elements.index=this.element.find(".indexContainer"),this.elements.urlLink=this.element.find(".urlLink"),this.editable&&this.elements.select.on("click",(function(e){i.parentContainer.showDialog({index:i.index,text:i.text,position:{x:i.x,y:i.y},onOpen:function(e,t,n){i.dialogInstance=e,t.find("input.inputX").prop("disabled",!0),t.find("input.inputY").prop("disabled",!0)},onOkay:function(e,t,n){i.setIndex(e.index,e.text)}})})),this.elements.urlLink.on("click",(function(e){i.mapContainer.isEventsEnabled()&&i.mapContainer.moveTo({x:i.x,y:i.y})})),e(this),this},this.setIndex=function(t,i){var n=this;return this.editable?("number"!=typeof t||(t<this.parentContainer.indexes.min&&(t=this.parentContainer.indexes.max),t>this.parentContainer.indexes.max&&(t=this.parentContainer.indexes.min),Travian.api("map/flag",{data:{data:{index:t,text:i,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(a){if(a){n.index=t,n.text=i,e(n);var o=n.dataStore.get(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:n.x,y:n.y},n.dataId);o.index=n.index,o.text=n.text,n.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:{x:n.x,y:n.y},index:n.dataId,data:o,time:!1}),n.mapContainer.updateSymbolData({position:{x:n.x,y:n.y},dataId:n.dataId,index:n.index,text:n.text})}n.dialogInstance.close(),n.dialogInstance=null},error:function(e){return n.parentContainer.dialogInstance.enableForm().toElement().down(".errorMessage").html(e.message),!1}},"PATCH")),this):this},t.index=Number(t.index),Travian.Game.Map.MapMark.Layer.Data.call(this,t,i)};return t.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype),t.constructor=t,t}(),Travian.Game.Map.Options={},Travian.Game.Map.Options.Symbols={flag:{class:Travian.Game.Map.Layer.Symbol.Flag,imgSource:"img/map/flag/flag-{index}/{width}x{height}.png",byUser:!0,zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},attack:{class:Travian.Game.Map.Layer.Symbol.Attack,imgSource:"img/map/attack/attack-{attackType}/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},battleGround:{class:Travian.Game.Map.Layer.Symbol.BattleGround,imgSource:"img/map/battleground/battleground-{center}-{north}-{east}-{south}-{west}-{width}x{height}.png",zIndex:9,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:4,height:4},4:{width:4,height:4}}},adventure:{class:Travian.Game.Map.Layer.Symbol.Adventure,imgSource:"img/map/adventure/difficulty-{difficulty}/{width}x{height}.png",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:6,height:6},4:{width:4,height:4}}},reinforcement:{class:Travian.Game.Map.Layer.Symbol.Reinforcement,imgSource:"img/map/reinforcement/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}}},Travian.Game.Map.Options.Rulers={direction:null,imgSource:{x:"img/map/rulers/x-{zoomLevel}.gif",y:"img/map/rulers/y-{zoomLevel}.gif"},cls:{x:"ruler x",y:"ruler y"},steps:{x:{1:1,2:1,3:10,4:20},y:{1:1,2:1,3:10,4:20}},delta:{x:{1:0,2:0,3:0,4:0},y:{1:0,2:0,3:-9,4:-19}}},Travian.Game.Map.Options.MiniMap={container:"#miniMap",containerContent:"#minimapContainer",showToolTip:!0,classLines:{x:"lines",y:"lines"},tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>'},Travian.Game.Map.Options.Toolbar={element:"#toolbar",viewFullScreenUrl:"/karte.php?fullscreen=1&x={x}&y={y}&zoom={zoom}",viewNormalUrl:"/karte.php?x={x}&y={y}&zoom={zoom}",filterPlayer:{checked:!0},filterAlliance:{checked:!0}},Travian.Game.Map.Options.Outline={element:"#outline"},Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{},Travian.Game.Map.Options.MapMark.Mark={class:Travian.Game.Map.MapMark.Layer.Mark,title:"",typeId:"player",editable:!0,expanded:!1,color:0,colors:{0:"#C0C0C0",1:"#FF7722",2:"#B15BDB",3:"#DF4E78",4:"#34822F",5:"#3F90C5",6:"#C2AF09",7:"#8B1C1C",8:"#575BD2",9:"#4FE600",min:0,max:9},html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogX",html:'<div class="mapMarkMark"><div class="color {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"></div></div>'},optionsData:{urlLink:"/profile/{markId}",html:'<div class="entry flag {entry}"><div class="marker color"><a href="#" class="{select} {color}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div><div class="clear"></div></div>'}},Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{},Travian.Game.Map.Options.MapMark.Flag={class:Travian.Game.Map.MapMark.Layer.Flag,title:"",editable:!0,expanded:!0,typeId:"flag",index:1,indexes:{min:1,max:20},imgSource:Travian.Helpers.substitute(Travian.Game.Map.Options.Symbols.flag.imgSource,{index:"{index}",zoomLevel:1,width:16,height:16}),html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogText",html:'<div class="mapMarkField"><div class="flag {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"><input id="coordinateDialogText" class="text {inputText}" type="text" /></div><p class="error errorMessage"></p></div>'},optionsData:{html:'<div class="entry flag {entry}"><div class="marker index"><a href="#" class="{select} {index}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div><div class="clear"></div></div>'}},Travian.Game.Map.Options.Default={container:"#mapContainer",containerViewSize:null,tileDisplayInformation:{type:"dialog",optionsPopup:{url:"/position_details.php?x={x}&y={y}",windowOptions:{}},optionsDialog:{buttonOk:!1,data:{x:null,y:null}}},blockOverflow:1,blockSize:{width:170,height:150},mapInitialPosition:{x:0,y:0},grid:{1:"/img/map/grid/grid-1.gif",2:"/img/map/grid/grid-2.gif",3:"/img/map/grid/grid-3.gif",4:!1},speeds:{slow:5,normal:20,fast:40},symbolTypes:Travian.Game.Map.Options.Symbols,onCreate:function(e){},onRender:function(e){if(Travian.Game.Map.Tips.render(e,e.containerMover),e.rulers=new Travian.Game.Map.Rulers(Travian.Game.Map.Options.Rulers,e),e.rulers.render(),e.miniMap=new Travian.Game.Map.MiniMap(Travian.Game.Map.Options.MiniMap,e),e.miniMap.render(),e.mapMarks)for(var t in e.mapMarks)if(e.mapMarks.hasOwnProperty(t)){var i=e.mapMarks[t];!0===i.enabled?e.mapMarks[t]=new Travian.Game.Map.MapMark(i,e):delete e.mapMarks[t]}e.outline=new Travian.Game.Map.Outline(Travian.Game.Map.Options.Outline,e),e.toolbar=new Travian.Game.Map.Toolbar(Travian.Game.Map.Options.Toolbar,e),e.toolbar.render()},onMove:function(e,t){e.rulers&&e.rulers.move(t),e.miniMap&&e.miniMap.move()},onZoom:function(e){e.rulers&&e.rulers.zoom(),e.miniMap&&e.miniMap.zoom(),e.toolbar&&e.toolbar.zoom()}},Travian.Game.Map.Options.Default.contextMenu={targets:"#mapContainer",zIndex:2e3,menu:"#contextmenu",actions:[{element:"#contextMenuSendTroops",displayOn:"did",shouldDisplay:function(e){return void 0!==e[this.displayOn]},fn:function(e,t,i){window.location.href="/build.php?gid=16&tt=2&x="+i.position.x+"&y="+i.position.y}},{element:"#contextMenuSendTraders",displayOn:"uid",shouldDisplay:function(e){var t=void 0!==e[this.displayOn],i="{k.bt}"!==e.title;return t&&i},fn:function(e,t,i){window.location.href="/build.php?gid=17&t=5&x="+i.position.x+"&y="+i.position.y}},{element:"#contextMenuMarkPlayerAlliance",displayOn:"aid",shouldDisplay:function(e){return void 0!==e[this.displayOn]},fn:function(e,t,i){e.parentContainer.mapMarks.player.layers.alliance.showDialog({position:t})}},{element:"#contextMenuMarkPlayerPlayer",displayOn:"uid",shouldDisplay:function(e){return void 0!==e[this.displayOn]},fn:function(e,t,i){e.parentContainer.mapMarks.player.layers.player.showDialog({position:t})}},{element:"#contextMenuFlagPlayer",displayOn:!0,shouldDisplay:function(e){return!0},fn:function(e,t,i){e.parentContainer.mapMarks.player.layers.flag.showDialog({position:t})}},{element:"#contextMenuMarkAllianceAlliance",displayOn:"aid",shouldDisplay:function(e){return void 0!==e[this.displayOn]},fn:function(e,t,i){e.parentContainer.mapMarks.alliance.layers.alliance.showDialog({position:t})}},{element:"#contextMenuMarkAlliancePlayer",displayOn:"uid",shouldDisplay:function(e){return void 0!==e[this.displayOn]},fn:function(e,t,i){e.parentContainer.mapMarks.alliance.layers.player.showDialog({position:t})}},{element:"#contextMenuFlagAlliance",displayOn:!0,shouldDisplay:function(e){return!0},fn:function(e,t,i){e.parentContainer.mapMarks.alliance.layers.flag.showDialog({position:t})}}]},Travian.Game.Map.Options.Default.transition={onCreate:function(e){},onMove:function(e,t){},onZoom:function(e){},zoomOptions:{level:1,sizes:[{x:10,y:10},{x:20,y:20},{x:100,y:100}]},border:Travian.Defaults.Map.Size},Travian.Game.Map.Options.Default.layers=[{id:"loading",styles:{background:"#000000 url(img/loading.gif) center center no-repeat",opacity:.5},class:Travian.Game.Map.Layer.Loading,zIndex:20},{id:"image",src:"/map/block/{x}.{y}.{right}.{top}.png",srcInit:"/img/x.gif",class:Travian.Game.Map.Layer.Image,zIndex:1},{id:"imageMark",src:"/map/mark/{x}.{y}.{right}.{top}.png{suffix}",srcInit:"/img/x.gif",class:Travian.Game.Map.Layer.ImageMark,zIndex:2}],Travian.Game.Map.Options.Default.block={tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span><br />{k.loadingData}'},Travian.Game.Map.Options.Default.updater={maxRequestCount:5,parameters:{multiple:{},position:{}},requestDelayTime:{multiple:100,position:300},elementWorking:"#working",positionOptions:{areaAroundPosition:{1:{left:-5,bottom:-4,right:5,top:4},2:{left:-10,bottom:-8,right:10,top:8},3:{left:-25,bottom:-25,right:25,top:25},4:{left:-25,bottom:-25,right:25,top:25}}}},Travian.Game.Map.Options.Default.keyboard={37:"moveLeft",65:"moveLeft",100:"moveLeft",39:"moveRight",68:"moveRight",102:"moveRight",38:"moveUp",87:"moveUp",104:"moveUp",40:"moveDown",83:"moveDown",98:"moveDown",103:"moveLeftUp",97:"moveLeftDown",105:"moveRightUp",99:"moveRightDown",speed:{slow:"control",fast:"shift"},61:{fn:"zoomIn",periodical:0},107:{fn:"zoomIn",periodical:0},109:{fn:"zoomOut",periodical:0},71:{fn:"toggleGrid",periodical:0},77:{fn:"toggleMiniMap",periodical:0},79:{fn:"toggleOutline",periodical:0}},Travian.Game.Map.Options.Default.dataStore={cachingTimeForType:{blocks:18e5,symbol:6e5,tile:6e5,tooltip:12e4},persistentStorage:!1,useStorageForType:{blocks:!1,symbol:!1,tile:!1,tooltip:!0},clearStorageForType:{blocks:!1,symbol:!1,tile:!1,tooltip:!1}},Travian.Game.Map.Options.Default.data={elements:[]},Travian.Game.Map.Options.Default.mapMarks={player:{enabled:!0,data:[],element:"#tabPlayer",typeId:"player",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:1,max:10}})}},alliance:{enabled:!0,data:[],element:"#tabAlliance",typeId:"alliance",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:11,max:20}})}}};